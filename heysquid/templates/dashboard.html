<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>heysquid HQ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --pink: #ff6b9d; --pink-dark: #cc4477; --pink-light: #ffaac4;
  --cyan: #00d4ff; --cyan-dark: #009abb; --cyan-light: #77eeff;
  --orange: #ff9f43; --orange-dark: #cc7a22; --orange-light: #ffcf99;
  --green: #26de81; --green-dark: #1aaa60; --green-light: #77ffbb;
  --yellow: #ffd32a; --yellow-dark: #ccaa00; --yellow-light: #ffee88;
  --purple: #cc66ff; --purple-dark: #9944cc; --purple-light: #dd99ff;
  --red: #ff4444; --red-dark: #cc2222; --red-light: #ff8888;
  --lavender: #bb88ff; --lavender-dark: #8855cc; --lavender-light: #ddbbff;
  --blue: #4488ff; --blue-dark: #2266cc; --blue-light: #88bbff;
  --coral: #ff7744; --coral-dark: #cc5522; --coral-light: #ffaa88;
}

body {
  background: #0a0e1a;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  font-family: 'Press Start 2P', monospace;
  overflow: hidden;
  image-rendering: pixelated;
}

.viewport {
  width: 1200px;
  height: 900px;
  position: relative;
  background: #0b1628;
  border: 4px solid #1a3a5c;
  overflow: hidden;
}

/* === OCEAN BACKGROUND === */
.ocean-bg {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 50%, #0a2a4a 0%, #051530 50%, #020a1a 100%);
  z-index: 0;
}

/* === GLASS DOME === */
.glass-dome {
  position: absolute;
  left: 80px; top: 60px;
  width: 1040px; height: 740px;
  border-radius: 50px;
  background: radial-gradient(ellipse at 50% 40%, rgba(20,50,80,0.6) 0%, rgba(10,30,55,0.8) 100%);
  border: 4px solid rgba(100,180,255,0.15);
  box-shadow:
    inset 0 0 60px rgba(80,160,255,0.08),
    0 0 40px rgba(60,140,220,0.15),
    inset 4px 4px 0 rgba(120,200,255,0.1);
  z-index: 1;
  overflow: hidden;
}
.glass-dome::before {
  content: '';
  position: absolute;
  top: 10px; left: 60px;
  width: 200px; height: 8px;
  background: rgba(120,200,255,0.05);
  border-radius: 4px;
  transform: rotate(-5deg);
}
.glass-dome::after {
  content: '';
  position: absolute;
  top: 30px; left: 100px;
  width: 120px; height: 6px;
  background: rgba(120,200,255,0.04);
  border-radius: 4px;
  transform: rotate(-5deg);
}

/* === FLOOR TILES === */
.floor {
  position: absolute;
  inset: 0;
  z-index: 2;
  background-image:
    linear-gradient(rgba(60,100,140,0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(60,100,140,0.1) 1px, transparent 1px);
  background-size: 40px 40px;
  background-position: 20px 20px;
}

/* === TITLE BAR === */
.title-bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 65px;
  background: linear-gradient(180deg, rgba(0,10,30,0.95) 0%, rgba(0,10,30,0.7) 80%, transparent 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding-top: 6px;
}
.title-bar h1 {
  font-size: 18px;
  background: linear-gradient(90deg, var(--pink), var(--cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: none;
  letter-spacing: 4px;
  margin-bottom: 4px;
}
.title-bar .subtitle {
  font-size: 9px;
  color: #5599aa;
  letter-spacing: 4px;
}

/* === BUBBLES === */
.bubble {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(150,220,255,0.3), rgba(100,180,255,0.05));
  border: 1px solid rgba(120,200,255,0.2);
  z-index: 0;
  animation: float-up linear infinite;
}
@keyframes float-up {
  0% { transform: translateY(0) translateX(0); opacity: 0.3; }
  50% { transform: translateY(-200px) translateX(15px); opacity: 0.15; }
  100% { transform: translateY(-450px) translateX(-10px); opacity: 0; }
}

/* === FISH SILHOUETTES === */
.fish-sil {
  position: absolute;
  z-index: 0;
  opacity: 0.12;
}

/* === DEPARTMENT ZONES === */
.dept-zone {
  position: absolute;
  z-index: 5;
  border-radius: 12px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.dept-zone.highlighted {
  border-color: var(--pink) !important;
  box-shadow: inset 0 0 30px rgba(255,107,157,0.1), 0 0 15px rgba(255,107,157,0.15) !important;
}
.dept-label {
  position: absolute;
  top: 8px; left: 12px;
  font-size: 11px;
  z-index: 6;
}
.dept-sublabel {
  position: absolute;
  top: 24px; left: 12px;
  font-size: 9px;
  z-index: 6;
}
.dept-eye {
  display: none;
  font-size: 10px;
  margin-left: 6px;
}
.dept-zone.highlighted .dept-eye { display: inline; }

/* === DESK STATION === */
.desk-station {
  position: absolute;
  z-index: 10;
}
.desk-assignment-label {
  font-size: 8px;
  position: absolute;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  z-index: 11;
}
.context-icon {
  position: absolute; z-index: 17;
  width: 8px; height: 10px;
  background: rgba(200,220,240,0.3);
  border: 1px solid rgba(150,200,230,0.4);
  border-radius: 1px;
}
.context-icon::after {
  content: '';
  position: absolute;
  top: -3px; left: 1px;
  width: 6px; height: 3px;
  background: rgba(150,200,230,0.3);
  border-radius: 1px;
}
.agent-slot {
  position: absolute;
  z-index: 20;
}
.desk-station.occupied .agent-slot { display: block; }
.desk-station:not(.occupied) .agent-slot { display: none; }

/* === AGENT POOL === */
.agent-pool {
  position: absolute;
  z-index: 20;
  display: flex;
  gap: 30px;
  justify-content: center;
}
.pool-agent {
  position: relative;
  text-align: center;
  transition: opacity 0.5s;
}
.pool-agent.dispatched { opacity: 0; pointer-events: none; }
.pool-agent-label {
  font-size: 9px;
  color: #6699aa;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  margin-top: 2px;
}

/* === DESK === */
.desk { position: absolute; z-index: 15; }
.desk-surface {
  width: 120px;
  height: 60px;
  background: linear-gradient(180deg, #3d2b1a 0%, #2a1e12 100%);
  border: 2px solid #4a3520;
  border-radius: 4px;
  image-rendering: pixelated;
  box-shadow: 0 4px 0 #1a1008;
}

/* === MONITOR === */
.monitor { position: absolute; z-index: 16; }
.monitor-frame {
  width: 36px; height: 28px;
  background: #1a1a2e;
  border: 3px solid #333348;
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}
.monitor-screen {
  position: absolute;
  inset: 2px;
  background: #0a1a0a;
  overflow: hidden;
}
.monitor-stand {
  width: 12px; height: 6px;
  background: #333348;
  margin: 0 auto;
  border-radius: 0 0 2px 2px;
}
.screen-line {
  width: 80%;
  height: 2px;
  margin: 3px auto 0;
  border-radius: 1px;
  animation: type-line 3s ease-in-out infinite;
}
@keyframes type-line {
  0%, 100% { width: 80%; }
  50% { width: 40%; }
}
@keyframes type-line-fast {
  0%, 100% { width: 90%; }
  50% { width: 30%; }
}

/* === COFFEE MUG === */
.mug {
  width: 10px; height: 12px;
  background: #e8e0d0;
  border: 2px solid #c0b8a0;
  border-radius: 0 0 2px 2px;
  position: absolute;
  z-index: 17;
}
.mug::after {
  content: '';
  position: absolute;
  right: -6px; top: 2px;
  width: 5px; height: 6px;
  border: 2px solid #c0b8a0;
  border-left: none;
  border-radius: 0 4px 4px 0;
}
.mug-steam {
  position: absolute;
  top: -10px; left: 2px;
  width: 2px; height: 8px;
  background: rgba(200,220,240,0.3);
  animation: steam 2s ease-in-out infinite;
  border-radius: 2px;
}
@keyframes steam {
  0%, 100% { height: 8px; opacity: 0.3; transform: translateX(0); }
  50% { height: 12px; opacity: 0.1; transform: translateX(3px); }
}

/* === BOOKS === */
.book { position: absolute; border-radius: 1px; z-index: 17; }

/* === PLANTS === */
.plant { position: absolute; z-index: 18; }

/* === WATER COOLER === */
.water-cooler { position: absolute; z-index: 18; }

/* === HP BAR === */
.hp-bar-wrap {
  position: absolute;
  width: 40px; height: 3px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  overflow: hidden;
  z-index: 22;
}
.hp-bar {
  height: 100%;
  width: 100%;
  border-radius: 2px;
  transition: width 0.5s ease, background 0.3s;
  background: #26de81;
}

/* === ANIMATIONS === */
@keyframes bob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
@keyframes bob-slow {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}
@keyframes bob-work {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
@keyframes crown-shine {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.4) drop-shadow(0 0 4px rgba(255,204,0,0.5)); }
}
@keyframes typing {
  0%, 100% { transform: translateY(0); }
  25% { transform: translateY(-2px); }
  75% { transform: translateY(-2px); }
}
@keyframes inflate {
  0%, 80%, 100% { transform: scale(1); }
  90% { transform: scale(1.1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-2px) translateY(1px); }
  40% { transform: translateX(2px) translateY(-1px); }
  60% { transform: translateX(-1px) translateY(1px); }
  80% { transform: translateX(1px) translateY(-1px); }
}
@keyframes coffee-lift {
  0%, 70%, 100% { transform: translateY(0); }
  75% { transform: translateY(-5px); }
  85% { transform: translateY(-3px); }
}
@keyframes dashFlow {
  to { stroke-dashoffset: -28; }
}
@keyframes blink-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* === CONNECTION SVG === */
.conn-svg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 4;
  pointer-events: none;
}
.conn-line {
  stroke: rgba(0,212,255,0.15);
  stroke-width: 1.5;
  stroke-dasharray: 6 8;
  fill: none;
  animation: dashFlow 3s linear infinite;
}
.conn-line.active {
  stroke: rgba(0,212,255,0.5);
  stroke-width: 2;
  filter: drop-shadow(0 0 4px rgba(0,212,255,0.4));
}

/* === PIXEL CHARACTER BASE === */
.pixel-char {
  width: 1px;
  height: 1px;
  image-rendering: pixelated;
}

/* === SQUID PM (scale 4, 64x64) === */
.squid-pixel-lg {
  transform: scale(4);
  transform-origin: top left;
  margin-right: 63px;
  margin-bottom: 63px;
  color: var(--pink);
  box-shadow:
    6px 0 0 #ffdd44, 9px 0 0 #ffdd44,
    5px 1px 0 #ffdd44, 6px 1px 0 #ffee66, 7px 1px 0 #ffdd44, 8px 1px 0 #ffdd44, 9px 1px 0 #ffee66, 10px 1px 0 #ffdd44,
    6px 2px 0 #ffcc22, 7px 2px 0 #ffcc22, 8px 2px 0 #ffcc22, 9px 2px 0 #ffcc22,
    5px 3px 0 #ff6b9d, 6px 3px 0 #ff6b9d, 7px 3px 0 #ffaac4, 8px 3px 0 #ffaac4, 9px 3px 0 #ff6b9d, 10px 3px 0 #ff6b9d,
    4px 4px 0 #ff6b9d, 5px 4px 0 #ffaac4, 6px 4px 0 #ffaac4, 7px 4px 0 #ffaac4, 8px 4px 0 #ffaac4, 9px 4px 0 #ffaac4, 10px 4px 0 #ffaac4, 11px 4px 0 #ff6b9d,
    4px 5px 0 #ff6b9d, 5px 5px 0 #ffaac4, 6px 5px 0 #ffffff, 7px 5px 0 #ffffff, 8px 5px 0 #ffaac4, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ff6b9d,
    4px 6px 0 #ff6b9d, 5px 6px 0 #ffaac4, 6px 6px 0 #ffffff, 7px 6px 0 #2244aa, 8px 6px 0 #ffaac4, 9px 6px 0 #ffffff, 10px 6px 0 #2244aa, 11px 6px 0 #ff6b9d,
    4px 7px 0 #ff6b9d, 5px 7px 0 #ffaac4, 6px 7px 0 #ffffff, 7px 7px 0 #4466cc, 8px 7px 0 #ffaac4, 9px 7px 0 #ffffff, 10px 7px 0 #4466cc, 11px 7px 0 #ff6b9d,
    4px 8px 0 #ff6b9d, 5px 8px 0 #ff5588, 6px 8px 0 #ffaac4, 7px 8px 0 #ffaac4, 8px 8px 0 #ff6b9d, 9px 8px 0 #ffaac4, 10px 8px 0 #ff5588, 11px 8px 0 #ff6b9d,
    4px 9px 0 #ff6b9d, 5px 9px 0 #ff6b9d, 6px 9px 0 #ffaac4, 7px 9px 0 #cc4477, 8px 9px 0 #cc4477, 9px 9px 0 #ffaac4, 10px 9px 0 #ff6b9d, 11px 9px 0 #ff6b9d,
    5px 10px 0 #ff6b9d, 6px 10px 0 #ff6b9d, 7px 10px 0 #ffaac4, 8px 10px 0 #ffaac4, 9px 10px 0 #ff6b9d, 10px 10px 0 #ff6b9d,
    4px 11px 0 #ff6b9d, 5px 11px 0 #cc4477, 6px 11px 0 #ff6b9d, 7px 11px 0 #cc4477, 8px 11px 0 #cc4477, 9px 11px 0 #ff6b9d, 10px 11px 0 #cc4477, 11px 11px 0 #ff6b9d,
    3px 12px 0 #ff6b9d, 4px 12px 0 #cc4477, 6px 12px 0 #ff6b9d, 7px 12px 0 #cc4477, 8px 12px 0 #cc4477, 9px 12px 0 #ff6b9d, 11px 12px 0 #cc4477, 12px 12px 0 #ff6b9d,
    3px 13px 0 #cc4477, 5px 13px 0 #ff6b9d, 6px 13px 0 #cc4477, 9px 13px 0 #cc4477, 10px 13px 0 #ff6b9d, 12px 13px 0 #cc4477,
    2px 14px 0 #cc4477, 5px 14px 0 #cc4477, 10px 14px 0 #cc4477, 13px 14px 0 #cc4477,
    2px 15px 0 #993366, 5px 15px 0 #993366, 10px 15px 0 #993366, 13px 15px 0 #993366;
}

/* === OCTOPUS Researcher (scale 2.5 for pool, scale 3 for desk) === */
.octopus-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--cyan);
  box-shadow:
    6px 0 0 #00d4ff, 7px 0 0 #00d4ff, 8px 0 0 #00d4ff, 9px 0 0 #00d4ff,
    5px 1px 0 #00d4ff, 6px 1px 0 #77eeff, 7px 1px 0 #77eeff, 8px 1px 0 #77eeff, 9px 1px 0 #77eeff, 10px 1px 0 #00d4ff,
    4px 2px 0 #00d4ff, 5px 2px 0 #77eeff, 6px 2px 0 #77eeff, 7px 2px 0 #aaf4ff, 8px 2px 0 #aaf4ff, 9px 2px 0 #77eeff, 10px 2px 0 #77eeff, 11px 2px 0 #00d4ff,
    3px 3px 0 #00d4ff, 4px 3px 0 #77eeff, 5px 3px 0 #77eeff, 6px 3px 0 #aaf4ff, 7px 3px 0 #aaf4ff, 8px 3px 0 #aaf4ff, 9px 3px 0 #aaf4ff, 10px 3px 0 #77eeff, 11px 3px 0 #77eeff, 12px 3px 0 #00d4ff,
    3px 4px 0 #00d4ff, 4px 4px 0 #77eeff, 5px 4px 0 #aaf4ff, 6px 4px 0 #aaf4ff, 7px 4px 0 #aaf4ff, 8px 4px 0 #aaf4ff, 9px 4px 0 #aaf4ff, 10px 4px 0 #aaf4ff, 11px 4px 0 #77eeff, 12px 4px 0 #00d4ff,
    3px 5px 0 #00d4ff, 4px 5px 0 #77eeff, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #aaf4ff, 8px 5px 0 #aaf4ff, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #77eeff, 12px 5px 0 #00d4ff,
    3px 6px 0 #00d4ff, 4px 6px 0 #77eeff, 5px 6px 0 #ffffff, 6px 6px 0 #113355, 7px 6px 0 #77eeff, 8px 6px 0 #77eeff, 9px 6px 0 #ffffff, 10px 6px 0 #113355, 11px 6px 0 #77eeff, 12px 6px 0 #00d4ff,
    3px 7px 0 #00d4ff, 4px 7px 0 #77eeff, 5px 7px 0 #ffffff, 6px 7px 0 #335577, 7px 7px 0 #77eeff, 8px 7px 0 #77eeff, 9px 7px 0 #ffffff, 10px 7px 0 #335577, 11px 7px 0 #77eeff, 12px 7px 0 #00d4ff,
    4px 8px 0 #009abb, 5px 8px 0 #77eeff, 6px 8px 0 #77eeff, 7px 8px 0 #009abb, 8px 8px 0 #009abb, 9px 8px 0 #77eeff, 10px 8px 0 #77eeff, 11px 8px 0 #009abb,
    4px 9px 0 #00d4ff, 5px 9px 0 #00d4ff, 6px 9px 0 #77eeff, 7px 9px 0 #77eeff, 8px 9px 0 #77eeff, 9px 9px 0 #77eeff, 10px 9px 0 #00d4ff, 11px 9px 0 #00d4ff,
    3px 10px 0 #00d4ff, 4px 10px 0 #009abb, 5px 10px 0 #00d4ff, 6px 10px 0 #009abb, 7px 10px 0 #00d4ff, 8px 10px 0 #00d4ff, 9px 10px 0 #009abb, 10px 10px 0 #00d4ff, 11px 10px 0 #009abb, 12px 10px 0 #00d4ff,
    2px 11px 0 #00d4ff, 3px 11px 0 #009abb, 5px 11px 0 #009abb, 6px 11px 0 #00d4ff, 9px 11px 0 #00d4ff, 10px 11px 0 #009abb, 12px 11px 0 #009abb, 13px 11px 0 #00d4ff,
    2px 12px 0 #009abb, 3px 12px 0 #00d4ff, 5px 12px 0 #00d4ff, 6px 12px 0 #009abb, 9px 12px 0 #009abb, 10px 12px 0 #00d4ff, 12px 12px 0 #00d4ff, 13px 12px 0 #009abb,
    1px 13px 0 #009abb, 4px 13px 0 #009abb, 7px 13px 0 #009abb, 8px 13px 0 #009abb, 11px 13px 0 #009abb, 14px 13px 0 #009abb;
}

/* === SHARK Developer (scale 2.5 for pool) === */
.shark-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--orange);
  box-shadow:
    7px 0 0 #ff9f43, 8px 0 0 #ff9f43,
    7px 1px 0 #ffcf99, 8px 1px 0 #ff9f43, 9px 1px 0 #ff9f43,
    5px 2px 0 #ff9f43, 6px 2px 0 #ff9f43, 7px 2px 0 #ffcf99, 8px 2px 0 #ffcf99, 9px 2px 0 #ff9f43, 10px 2px 0 #ff9f43,
    4px 3px 0 #ff9f43, 5px 3px 0 #ffcf99, 6px 3px 0 #ffcf99, 7px 3px 0 #ffcf99, 8px 3px 0 #ffcf99, 9px 3px 0 #ffcf99, 10px 3px 0 #ffcf99, 11px 3px 0 #ff9f43,
    3px 4px 0 #ff9f43, 4px 4px 0 #ffcf99, 5px 4px 0 #ffcf99, 6px 4px 0 #ffcf99, 7px 4px 0 #ffcf99, 8px 4px 0 #ffcf99, 9px 4px 0 #ffcf99, 10px 4px 0 #ffcf99, 11px 4px 0 #ffcf99, 12px 4px 0 #ff9f43,
    3px 5px 0 #ff9f43, 4px 5px 0 #ffcf99, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #ffcf99, 8px 5px 0 #ffcf99, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ffcf99, 12px 5px 0 #ff9f43,
    3px 6px 0 #ff9f43, 4px 6px 0 #ffcf99, 5px 6px 0 #ffffff, 6px 6px 0 #331100, 7px 6px 0 #ffcf99, 8px 6px 0 #ffcf99, 9px 6px 0 #ffffff, 10px 6px 0 #331100, 11px 6px 0 #ffcf99, 12px 6px 0 #ff9f43,
    3px 7px 0 #ff9f43, 4px 7px 0 #ffcf99, 5px 7px 0 #ffffff, 6px 7px 0 #664422, 7px 7px 0 #ffcf99, 8px 7px 0 #ffcf99, 9px 7px 0 #ffffff, 10px 7px 0 #664422, 11px 7px 0 #ffcf99, 12px 7px 0 #ff9f43,
    3px 8px 0 #ff9f43, 4px 8px 0 #ff7733, 5px 8px 0 #ffcf99, 6px 8px 0 #ffcf99, 7px 8px 0 #ffcf99, 8px 8px 0 #ffcf99, 9px 8px 0 #ffcf99, 10px 8px 0 #ffcf99, 11px 8px 0 #ff7733, 12px 8px 0 #ff9f43,
    4px 9px 0 #ff9f43, 5px 9px 0 #ffcf99, 6px 9px 0 #cc7a22, 7px 9px 0 #ffffff, 8px 9px 0 #ffffff, 9px 9px 0 #cc7a22, 10px 9px 0 #ffcf99, 11px 9px 0 #ff9f43,
    4px 10px 0 #ff9f43, 5px 10px 0 #ff9f43, 6px 10px 0 #ffcf99, 7px 10px 0 #ffeedd, 8px 10px 0 #ffeedd, 9px 10px 0 #ffcf99, 10px 10px 0 #ff9f43, 11px 10px 0 #ff9f43,
    2px 11px 0 #ff9f43, 3px 11px 0 #cc7a22, 4px 11px 0 #ff9f43, 5px 11px 0 #ffcf99, 6px 11px 0 #ffeedd, 7px 11px 0 #ffeedd, 8px 11px 0 #ffeedd, 9px 11px 0 #ffeedd, 10px 11px 0 #ffcf99, 11px 11px 0 #ff9f43, 12px 11px 0 #cc7a22, 13px 11px 0 #ff9f43,
    1px 12px 0 #cc7a22, 2px 12px 0 #ff9f43, 5px 12px 0 #ff9f43, 6px 12px 0 #ffcf99, 7px 12px 0 #ffcf99, 8px 12px 0 #ffcf99, 9px 12px 0 #ffcf99, 10px 12px 0 #ff9f43, 13px 12px 0 #ff9f43, 14px 12px 0 #cc7a22,
    5px 13px 0 #ff9f43, 6px 13px 0 #ff9f43, 7px 13px 0 #cc7a22, 8px 13px 0 #cc7a22, 9px 13px 0 #ff9f43, 10px 13px 0 #ff9f43,
    6px 14px 0 #cc7a22, 7px 14px 0 #ff9f43, 8px 14px 0 #ff9f43, 9px 14px 0 #cc7a22;
}

/* === TURTLE Reviewer (scale 2.5 for pool) === */
.turtle-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--green);
  box-shadow:
    4px 0 0 #aabbcc, 5px 0 0 #aabbcc, 6px 0 0 #aabbcc, 7px 0 0 #aabbcc, 8px 0 0 #aabbcc, 9px 0 0 #aabbcc, 10px 0 0 #aabbcc, 11px 0 0 #aabbcc,
    5px 1px 0 #26de81, 6px 1px 0 #77ffbb, 7px 1px 0 #77ffbb, 8px 1px 0 #77ffbb, 9px 1px 0 #77ffbb, 10px 1px 0 #26de81,
    4px 2px 0 #26de81, 5px 2px 0 #77ffbb, 6px 2px 0 #ffffff, 7px 2px 0 #ffffff, 8px 2px 0 #77ffbb, 9px 2px 0 #ffffff, 10px 2px 0 #ffffff, 11px 2px 0 #26de81,
    4px 3px 0 #26de81, 5px 3px 0 #77ffbb, 6px 3px 0 #ffffff, 7px 3px 0 #224400, 8px 3px 0 #77ffbb, 9px 3px 0 #ffffff, 10px 3px 0 #224400, 11px 3px 0 #26de81,
    4px 4px 0 #aabbcc, 5px 4px 0 #aabbcc, 6px 4px 0 #aabbcc, 7px 4px 0 #aabbcc, 8px 4px 0 #aabbcc, 9px 4px 0 #aabbcc, 10px 4px 0 #aabbcc, 11px 4px 0 #aabbcc,
    5px 5px 0 #26de81, 6px 5px 0 #77ffbb, 7px 5px 0 #1aaa60, 8px 5px 0 #1aaa60, 9px 5px 0 #77ffbb, 10px 5px 0 #26de81,
    6px 6px 0 #26de81, 7px 6px 0 #77ffbb, 8px 6px 0 #77ffbb, 9px 6px 0 #26de81,
    4px 7px 0 #8B6914, 5px 7px 0 #8B6914, 6px 7px 0 #A0822B, 7px 7px 0 #A0822B, 8px 7px 0 #A0822B, 9px 7px 0 #A0822B, 10px 7px 0 #8B6914, 11px 7px 0 #8B6914,
    3px 8px 0 #8B6914, 4px 8px 0 #A0822B, 5px 8px 0 #26de81, 6px 8px 0 #A0822B, 7px 8px 0 #26de81, 8px 8px 0 #A0822B, 9px 8px 0 #26de81, 10px 8px 0 #A0822B, 11px 8px 0 #26de81, 12px 8px 0 #8B6914,
    3px 9px 0 #8B6914, 4px 9px 0 #26de81, 5px 9px 0 #A0822B, 6px 9px 0 #26de81, 7px 9px 0 #1aaa60, 8px 9px 0 #26de81, 9px 9px 0 #1aaa60, 10px 9px 0 #26de81, 11px 9px 0 #A0822B, 12px 9px 0 #8B6914,
    3px 10px 0 #8B6914, 4px 10px 0 #A0822B, 5px 10px 0 #26de81, 6px 10px 0 #A0822B, 7px 10px 0 #26de81, 8px 10px 0 #A0822B, 9px 10px 0 #26de81, 10px 10px 0 #A0822B, 11px 10px 0 #26de81, 12px 10px 0 #8B6914,
    4px 11px 0 #8B6914, 5px 11px 0 #8B6914, 6px 11px 0 #A0822B, 7px 11px 0 #A0822B, 8px 11px 0 #A0822B, 9px 11px 0 #A0822B, 10px 11px 0 #8B6914, 11px 11px 0 #8B6914,
    2px 12px 0 #26de81, 3px 12px 0 #26de81, 5px 12px 0 #26de81, 10px 12px 0 #26de81, 12px 12px 0 #26de81, 13px 12px 0 #26de81,
    1px 13px 0 #1aaa60, 2px 13px 0 #26de81, 5px 13px 0 #1aaa60, 10px 13px 0 #1aaa60, 13px 13px 0 #26de81, 14px 13px 0 #1aaa60;
}

/* === PUFFERFISH Tester (scale 2.5 for pool) === */
.puffer-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--yellow);
  box-shadow:
    6px 0 0 #ffd32a, 7px 0 0 #ccaa00, 8px 0 0 #ccaa00, 9px 0 0 #ffd32a,
    5px 1px 0 #ffd32a, 6px 1px 0 #ffee88, 7px 1px 0 #ffee88, 8px 1px 0 #ffee88, 9px 1px 0 #ffee88, 10px 1px 0 #ffd32a,
    4px 2px 0 #ccaa00, 5px 2px 0 #ffee88, 6px 2px 0 #ffee88, 7px 2px 0 #ffee88, 8px 2px 0 #ffee88, 9px 2px 0 #ffee88, 10px 2px 0 #ffee88, 11px 2px 0 #ccaa00,
    3px 3px 0 #ffd32a, 4px 3px 0 #ffee88, 5px 3px 0 #ffee88, 6px 3px 0 #ffee88, 7px 3px 0 #ffee88, 8px 3px 0 #ffee88, 9px 3px 0 #ffee88, 10px 3px 0 #ffee88, 11px 3px 0 #ffee88, 12px 3px 0 #ffd32a,
    2px 4px 0 #ccaa00, 3px 4px 0 #ffd32a, 4px 4px 0 #ffee88, 5px 4px 0 #ffee88, 6px 4px 0 #ffee88, 7px 4px 0 #ffee88, 8px 4px 0 #ffee88, 9px 4px 0 #ffee88, 10px 4px 0 #ffee88, 11px 4px 0 #ffee88, 12px 4px 0 #ffd32a, 13px 4px 0 #ccaa00,
    2px 5px 0 #ffd32a, 3px 5px 0 #ffee88, 4px 5px 0 #ffee88, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #ffee88, 8px 5px 0 #ffee88, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ffee88, 12px 5px 0 #ffee88, 13px 5px 0 #ffd32a,
    2px 6px 0 #ccaa00, 3px 6px 0 #ffee88, 4px 6px 0 #ffee88, 5px 6px 0 #ffffff, 6px 6px 0 #332200, 7px 6px 0 #ffee88, 8px 6px 0 #ffee88, 9px 6px 0 #ffffff, 10px 6px 0 #332200, 11px 6px 0 #ffee88, 12px 6px 0 #ffee88, 13px 6px 0 #ccaa00,
    2px 7px 0 #ffd32a, 3px 7px 0 #ffee88, 4px 7px 0 #ffee88, 5px 7px 0 #ffffff, 6px 7px 0 #665500, 7px 7px 0 #ffee88, 8px 7px 0 #ffee88, 9px 7px 0 #ffffff, 10px 7px 0 #665500, 11px 7px 0 #ffee88, 12px 7px 0 #ffee88, 13px 7px 0 #ffd32a,
    2px 8px 0 #ccaa00, 3px 8px 0 #ffd32a, 4px 8px 0 #ffaa44, 5px 8px 0 #ffee88, 6px 8px 0 #ffee88, 7px 8px 0 #cc6633, 8px 8px 0 #cc6633, 9px 8px 0 #ffee88, 10px 8px 0 #ffee88, 11px 8px 0 #ffaa44, 12px 8px 0 #ffd32a, 13px 8px 0 #ccaa00,
    3px 9px 0 #ffd32a, 4px 9px 0 #ffee88, 5px 9px 0 #ffee88, 6px 9px 0 #ffee88, 7px 9px 0 #ffccaa, 8px 9px 0 #ffccaa, 9px 9px 0 #ffee88, 10px 9px 0 #ffee88, 11px 9px 0 #ffee88, 12px 9px 0 #ffd32a,
    2px 10px 0 #ccaa00, 3px 10px 0 #ffd32a, 4px 10px 0 #ffee88, 5px 10px 0 #ffee88, 6px 10px 0 #ffeedd, 7px 10px 0 #ffeedd, 8px 10px 0 #ffeedd, 9px 10px 0 #ffeedd, 10px 10px 0 #ffee88, 11px 10px 0 #ffee88, 12px 10px 0 #ffd32a, 13px 10px 0 #ccaa00,
    3px 11px 0 #ffd32a, 4px 11px 0 #ffd32a, 5px 11px 0 #ffee88, 6px 11px 0 #ffeedd, 7px 11px 0 #ffeedd, 8px 11px 0 #ffeedd, 9px 11px 0 #ffeedd, 10px 11px 0 #ffee88, 11px 11px 0 #ffd32a, 12px 11px 0 #ffd32a,
    4px 12px 0 #ccaa00, 5px 12px 0 #ffd32a, 6px 12px 0 #ffee88, 7px 12px 0 #ffee88, 8px 12px 0 #ffee88, 9px 12px 0 #ffee88, 10px 12px 0 #ffd32a, 11px 12px 0 #ccaa00,
    5px 13px 0 #ccaa00, 6px 13px 0 #ffd32a, 7px 13px 0 #ffd32a, 8px 13px 0 #ffd32a, 9px 13px 0 #ffd32a, 10px 13px 0 #ccaa00,
    6px 14px 0 #ccaa00, 7px 14px 0 #ffd32a, 8px 14px 0 #ffd32a, 9px 14px 0 #ccaa00;
}

/* === DIVER (scale 3, 48x48) === */
.diver-pixel {
  transform: scale(3);
  transform-origin: top left;
  margin-right: 47px;
  margin-bottom: 47px;
  box-shadow:
    6px 0 0 #8899aa, 7px 0 0 #8899aa, 8px 0 0 #8899aa, 9px 0 0 #8899aa,
    5px 1px 0 #8899aa, 6px 1px 0 #99aabb, 7px 1px 0 #99aabb, 8px 1px 0 #99aabb, 9px 1px 0 #99aabb, 10px 1px 0 #8899aa,
    4px 2px 0 #667788, 5px 2px 0 #8899aa, 6px 2px 0 #4488ff, 7px 2px 0 #4488ff, 8px 2px 0 #4488ff, 9px 2px 0 #8899aa, 10px 2px 0 #8899aa, 11px 2px 0 #667788,
    4px 3px 0 #667788, 5px 3px 0 #8899aa, 6px 3px 0 #4488ff, 7px 3px 0 #66aaff, 8px 3px 0 #4488ff, 9px 3px 0 #8899aa, 10px 3px 0 #8899aa, 11px 3px 0 #667788,
    5px 4px 0 #667788, 6px 4px 0 #8899aa, 7px 4px 0 #8899aa, 8px 4px 0 #8899aa, 9px 4px 0 #8899aa, 10px 4px 0 #667788,
    5px 5px 0 #ffcc33, 6px 5px 0 #ffcc33, 7px 5px 0 #ffdd55, 8px 5px 0 #ffdd55, 9px 5px 0 #ffcc33, 10px 5px 0 #ffcc33,
    4px 6px 0 #ffcc33, 5px 6px 0 #ffdd55, 6px 6px 0 #ffdd55, 7px 6px 0 #ffee77, 8px 6px 0 #ffee77, 9px 6px 0 #ffdd55, 10px 6px 0 #ffdd55, 11px 6px 0 #ffcc33,
    3px 7px 0 #ffcc33, 4px 7px 0 #ddaa22, 5px 7px 0 #ffdd55, 6px 7px 0 #ffdd55, 7px 7px 0 #7788aa, 8px 7px 0 #7788aa, 9px 7px 0 #ffdd55, 10px 7px 0 #ffdd55, 11px 7px 0 #ddaa22, 12px 7px 0 #ffcc33,
    4px 8px 0 #ddaa22, 5px 8px 0 #ffcc33, 6px 8px 0 #ffdd55, 7px 8px 0 #ffdd55, 8px 8px 0 #ffdd55, 9px 8px 0 #ffdd55, 10px 8px 0 #ffcc33, 11px 8px 0 #ddaa22,
    5px 9px 0 #ddaa22, 6px 9px 0 #ffcc33, 7px 9px 0 #ffcc33, 8px 9px 0 #ffcc33, 9px 9px 0 #ffcc33, 10px 9px 0 #ddaa22,
    5px 10px 0 #ddaa22, 6px 10px 0 #ffcc33, 9px 10px 0 #ffcc33, 10px 10px 0 #ddaa22,
    4px 11px 0 #222233, 5px 11px 0 #333344, 10px 11px 0 #333344, 11px 11px 0 #222233,
    3px 12px 0 #222233, 4px 12px 0 #333344, 5px 12px 0 #222233, 10px 12px 0 #222233, 11px 12px 0 #333344, 12px 12px 0 #222233;
}

/* === PM AREA === */
.pm-area {
  position: absolute;
  z-index: 30;
  text-align: center;
}
.pm-area .char-wrapper {
  position: relative !important;
  display: inline-block;
}
.pm-label {
  font-size: 10px;
  color: var(--pink-light);
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  margin-top: 2px;
}
.pm-speech-bubble {
  position: absolute;
  top: -40px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10, 25, 50, 0.9);
  border: 2px solid var(--pink);
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 8px;
  color: #ffaac4;
  white-space: nowrap;
  z-index: 30;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.pm-speech-bubble.visible { opacity: 1; }
.pm-speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px; left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid var(--pink);
}

/* PM chatting/thinking indicators */
.pm-speech-bubble.pm-chatting {
  border-color: var(--cyan);
  color: var(--cyan-light);
}
.pm-speech-bubble.pm-chatting::after {
  border-top-color: var(--cyan);
}
.pm-speech-bubble.pm-thinking {
  border-color: var(--purple);
  color: var(--purple-light);
  animation: thinking-pulse 2s ease-in-out infinite;
}
.pm-speech-bubble.pm-thinking::after {
  border-top-color: var(--purple);
}
@keyframes thinking-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
@keyframes typing-dots {
  0% { content: 'üí¨'; }
  25% { content: 'üí¨.'; }
  50% { content: 'üí¨..'; }
  75% { content: 'üí¨...'; }
  100% { content: 'üí¨'; }
}

/* === MOVING DIVER === */
#moving-diver {
  position: absolute;
  z-index: 50;
  pointer-events: none;
  filter: drop-shadow(0 0 6px rgba(255,204,51,0.4));
}
.mini-label {
  font-size: 7px;
  color: var(--yellow-light);
  text-align: center;
  margin-top: 2px;
  opacity: 0.7;
}

/* === DIVER SPEECH BUBBLE === */
.diver-speech-bubble {
  position: absolute;
  top: -38px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10, 25, 50, 0.92);
  border: 2px solid var(--yellow);
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 9px;
  color: #ffdd55;
  white-space: nowrap;
  z-index: 60;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  text-shadow: 0 0 6px rgba(255,221,85,0.4);
}
.diver-speech-bubble.visible { opacity: 1; }
.diver-speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px; left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid var(--yellow);
}

/* === STATUS BAR (bottom) === */
.status-bar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(0deg, rgba(0,10,30,0.95) 0%, rgba(0,10,30,0.8) 80%, transparent 100%);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  z-index: 100;
}
.status-left, .status-right {
  font-size: 8px;
  color: #5599aa;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 140px;
}
.status-right { justify-content: flex-end; }
.status-center {
  font-size: 9px;
  color: var(--cyan-light);
  text-align: center;
  max-width: 400px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.conn-dot-status {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #557788;
  display: inline-block;
  flex-shrink: 0;
}
.conn-dot-status.live {
  background: #26de81;
  box-shadow: 0 0 6px rgba(38,222,129,0.6);
  animation: blink-dot 2s ease-in-out infinite;
}
.conn-dot-status.demo {
  background: #ffd32a;
  box-shadow: 0 0 6px rgba(255,211,42,0.6);
  animation: blink-dot 1.5s ease-in-out infinite;
}

/* === MISSION LOG === */
.mission-log {
  position: absolute;
  bottom: 30px; left: 280px; right: 90px;
  height: 58px;
  background: rgba(5,15,35,0.7);
  border-radius: 6px 6px 0 0;
  padding: 4px 12px;
  z-index: 99;
  overflow-y: auto;
  overflow-x: hidden;
}
.mission-log::-webkit-scrollbar { width: 4px; }
.mission-log::-webkit-scrollbar-track { background: transparent; }
.mission-log::-webkit-scrollbar-thumb { background: rgba(100,150,200,0.3); border-radius: 2px; }
.log-entries {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.log-entry {
  font-size: 8px;
  color: #6688aa;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.8;
  animation: logFadeIn 0.3s ease;
}
.log-entry .time { color: #446677; }
.log-entry .agent { font-weight: bold; }
.log-entry .agent.pm { color: var(--pink); }
.log-entry .agent.researcher { color: var(--cyan); }
.log-entry .agent.developer { color: var(--orange); }
.log-entry .agent.reviewer { color: var(--green); }
.log-entry .agent.verifier { color: var(--green); }
.log-entry .agent.tester { color: var(--yellow); }
.log-entry .agent.writer { color: var(--lavender); }
@keyframes logFadeIn {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* === DEMO BUTTON === */
.btn-demo {
  position: absolute;
  bottom: 46px; right: 100px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  padding: 5px 12px;
  border: 1px solid rgba(0,212,255,0.4);
  border-radius: 4px;
  cursor: pointer;
  background: rgba(0,212,255,0.1);
  color: var(--cyan);
  z-index: 101;
  display: none;
  transition: all 0.2s;
}
.btn-demo:hover {
  background: rgba(0,212,255,0.25);
  box-shadow: 0 0 10px rgba(0,212,255,0.2);
}
.btn-demo:disabled { opacity: 0.4; cursor: not-allowed; }

/* === KEYBOARD === */
.keyboard-hint {
  position: absolute;
  bottom: 108px; right: 100px;
  font-size: 7px;
  color: #335566;
  z-index: 99;
  letter-spacing: 1px;
}

/* === AGENT STATUS EFFECTS === */
.desk-station.status-working .agent-slot > div {
  animation: bob-work 1.5s ease-in-out infinite !important;
}
.desk-station.status-working .monitor-screen {
  filter: brightness(1.4);
}
.desk-station.status-working .screen-line {
  animation-name: type-line-fast !important;
  animation-duration: 1.5s !important;
}
.desk-station.status-complete .monitor-screen {
  background: #0a2a0a !important;
}
.desk-station.status-complete .screen-line {
  background: #00ff66 !important;
  width: 90% !important;
  animation: none !important;
}
.desk-station.status-error .monitor-screen {
  background: #2a0a0a !important;
}
.desk-station.status-error .screen-line {
  background: #ff3333 !important;
  animation: none !important;
}

/* === AGENT NAME (pool) === */
.agent-name-label {
  position: absolute;
  font-size: 8px;
  color: #6699aa;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  z-index: 21;
}
.char-wrapper {
  position: absolute;
  z-index: 20;
}

/* === DESK GLOW ON DIVER PROXIMITY === */
.desk-station.desk-highlight {
  filter: brightness(1.3);
}
.desk-station.desk-highlight .desk-surface {
  box-shadow: 0 4px 0 #1a1008, 0 0 8px rgba(255,204,51,0.3);
}

/* Walk animation for agents moving to desk */
.pool-agent.walking {
  position: fixed !important;
  z-index: 100;
  transition: transform 2.5s ease-in-out, opacity 0.5s;
  opacity: 1 !important;
}
.pool-agent.at-desk {
  position: fixed !important;
  z-index: 100;
  opacity: 1 !important;
}
.pool-agent.walking > div:first-child {
  animation: swim-bounce 0.35s ease-in-out infinite !important;
}
@keyframes swim-bounce {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  25% { transform: translateY(-2px) rotate(2deg); }
  50% { transform: translateY(-4px) rotate(0deg); }
  75% { transform: translateY(-2px) rotate(-2deg); }
}
/* === SEAHORSE Writer (scale 2.5 for pool) === */
.seahorse-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--lavender);
  box-shadow:
    /* crown/crest */
    8px 0 0 #ddbbff, 9px 0 0 #bb88ff,
    7px 1px 0 #ddbbff, 8px 1px 0 #bb88ff, 10px 1px 0 #bb88ff,
    /* head */
    6px 2px 0 #bb88ff, 7px 2px 0 #ddbbff, 8px 2px 0 #ddbbff, 9px 2px 0 #ddbbff, 10px 2px 0 #bb88ff,
    5px 3px 0 #bb88ff, 6px 3px 0 #ddbbff, 7px 3px 0 #ffffff, 8px 3px 0 #330066, 9px 3px 0 #ddbbff, 10px 3px 0 #ddbbff, 11px 3px 0 #bb88ff,
    5px 4px 0 #bb88ff, 6px 4px 0 #ddbbff, 7px 4px 0 #ddbbff, 8px 4px 0 #ddbbff, 9px 4px 0 #ddbbff, 10px 4px 0 #bb88ff,
    /* snout */
    5px 5px 0 #8855cc, 6px 5px 0 #bb88ff, 7px 5px 0 #ddbbff, 8px 5px 0 #bb88ff, 9px 5px 0 #8855cc,
    3px 6px 0 #8855cc, 4px 6px 0 #bb88ff, 5px 6px 0 #bb88ff, 6px 6px 0 #8855cc, 7px 6px 0 #bb88ff, 8px 6px 0 #8855cc,
    /* neck + belly curve right */
    7px 7px 0 #bb88ff, 8px 7px 0 #ddbbff, 9px 7px 0 #bb88ff,
    7px 8px 0 #8855cc, 8px 8px 0 #ddbbff, 9px 8px 0 #ddbbff, 10px 8px 0 #bb88ff,
    8px 9px 0 #bb88ff, 9px 9px 0 #ddbbff, 10px 9px 0 #ddbbff, 11px 9px 0 #8855cc,
    /* belly bulge */
    8px 10px 0 #8855cc, 9px 10px 0 #ddbbff, 10px 10px 0 #ddbbff, 11px 10px 0 #bb88ff,
    8px 11px 0 #bb88ff, 9px 11px 0 #ddbbff, 10px 11px 0 #bb88ff,
    /* tail curving left */
    7px 12px 0 #8855cc, 8px 12px 0 #bb88ff, 9px 12px 0 #8855cc,
    6px 13px 0 #8855cc, 7px 13px 0 #bb88ff,
    5px 14px 0 #bb88ff, 6px 14px 0 #8855cc,
    6px 15px 0 #8855cc, 7px 15px 0 #8855cc;
}
/* === LOBSTER Writer (scale 2.5 for pool) === */
.lobster-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--lavender);
  box-shadow:
    /* antennae */
    3px 0 0 #bb88ff, 12px 0 0 #bb88ff,
    2px 1px 0 #8855cc, 13px 1px 0 #8855cc,
    /* head */
    6px 1px 0 #bb88ff, 7px 1px 0 #ddbbff, 8px 1px 0 #ddbbff, 9px 1px 0 #bb88ff,
    5px 2px 0 #bb88ff, 6px 2px 0 #ddbbff, 7px 2px 0 #ffffff, 8px 2px 0 #330066, 9px 2px 0 #ddbbff, 10px 2px 0 #bb88ff,
    5px 3px 0 #8855cc, 6px 3px 0 #ddbbff, 7px 3px 0 #ddbbff, 8px 3px 0 #ddbbff, 9px 3px 0 #ddbbff, 10px 3px 0 #8855cc,
    /* body segment 1 */
    4px 4px 0 #bb88ff, 5px 4px 0 #ddbbff, 6px 4px 0 #ddbbff, 7px 4px 0 #ddbbff, 8px 4px 0 #ddbbff, 9px 4px 0 #ddbbff, 10px 4px 0 #ddbbff, 11px 4px 0 #bb88ff,
    4px 5px 0 #8855cc, 5px 5px 0 #bb88ff, 6px 5px 0 #ddbbff, 7px 5px 0 #ddbbff, 8px 5px 0 #ddbbff, 9px 5px 0 #ddbbff, 10px 5px 0 #bb88ff, 11px 5px 0 #8855cc,
    /* claws */
    1px 6px 0 #bb88ff, 2px 6px 0 #ddbbff, 3px 6px 0 #8855cc,
    5px 6px 0 #bb88ff, 6px 6px 0 #ddbbff, 7px 6px 0 #ddbbff, 8px 6px 0 #ddbbff, 9px 6px 0 #ddbbff, 10px 6px 0 #bb88ff,
    12px 6px 0 #8855cc, 13px 6px 0 #ddbbff, 14px 6px 0 #bb88ff,
    0px 7px 0 #bb88ff, 1px 7px 0 #ddbbff, 2px 7px 0 #bb88ff,
    5px 7px 0 #8855cc, 6px 7px 0 #bb88ff, 7px 7px 0 #ddbbff, 8px 7px 0 #ddbbff, 9px 7px 0 #bb88ff, 10px 7px 0 #8855cc,
    13px 7px 0 #bb88ff, 14px 7px 0 #ddbbff, 15px 7px 0 #bb88ff,
    1px 8px 0 #8855cc, 2px 8px 0 #bb88ff,
    6px 8px 0 #bb88ff, 7px 8px 0 #ddbbff, 8px 8px 0 #ddbbff, 9px 8px 0 #bb88ff,
    13px 8px 0 #bb88ff, 14px 8px 0 #8855cc,
    /* body segment 2 */
    6px 9px 0 #8855cc, 7px 9px 0 #bb88ff, 8px 9px 0 #bb88ff, 9px 9px 0 #8855cc,
    5px 10px 0 #8855cc, 6px 10px 0 #bb88ff, 7px 10px 0 #ddbbff, 8px 10px 0 #ddbbff, 9px 10px 0 #bb88ff, 10px 10px 0 #8855cc,
    /* tail fan */
    4px 11px 0 #bb88ff, 5px 11px 0 #ddbbff, 6px 11px 0 #bb88ff, 7px 11px 0 #8855cc, 8px 11px 0 #8855cc, 9px 11px 0 #bb88ff, 10px 11px 0 #ddbbff, 11px 11px 0 #bb88ff,
    3px 12px 0 #8855cc, 4px 12px 0 #bb88ff, 5px 12px 0 #8855cc, 10px 12px 0 #8855cc, 11px 12px 0 #bb88ff, 12px 12px 0 #8855cc,
    /* legs (3 pairs) */
    4px 8px 0 #8855cc, 11px 8px 0 #8855cc,
    3px 9px 0 #8855cc, 12px 9px 0 #8855cc,
    4px 10px 0 #8855cc, 11px 10px 0 #8855cc;
}



/* === AGENT SPEECH BUBBLE === */
.agent-speech {
  position: absolute;
  top: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,20,40,0.85);
  border-radius: 4px;
  padding: 3px 6px;
  font-size: 7px;
  font-family: 'Press Start 2P', monospace;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 50;
}
.agent-speech::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 3px solid transparent;
  border-right: 3px solid transparent;
  border-top: 4px solid rgba(0,20,40,0.85);
}
.agent-speech.visible {
  opacity: 1;
}
.agent-speech.fading, .pm-speech-bubble.fading {
  opacity: 0.3;
}
#pool-researcher .agent-speech { border: 1px solid var(--cyan); color: var(--cyan); }
#pool-developer .agent-speech  { border: 1px solid var(--orange); color: var(--orange); }
#pool-reviewer .agent-speech   { border: 1px solid var(--green); color: var(--green); }
#pool-tester .agent-speech     { border: 1px solid var(--yellow); color: var(--yellow); }
#pool-writer .agent-speech     { border: 1px solid var(--lavender); color: var(--lavender); }

/* === COMMANDER POPUP === */
@keyframes commander-pop {
  0% { transform: translateX(-50%) scale(0) rotate(-3deg); }
  50% { transform: translateX(-50%) scale(1.15) rotate(1deg); }
  70% { transform: translateX(-50%) scale(0.95) rotate(-1deg); }
  100% { transform: translateX(-50%) scale(1) rotate(0deg); }
}
@keyframes commander-shake {
  0%, 100% { transform: translateX(-50%) scale(1) rotate(0deg); }
  15% { transform: translateX(-50%) scale(1) rotate(-2deg) translateY(-2px); }
  30% { transform: translateX(-50%) scale(1) rotate(2deg) translateY(1px); }
  45% { transform: translateX(-50%) scale(1) rotate(-1deg) translateY(-1px); }
  60% { transform: translateX(-50%) scale(1) rotate(1deg); }
}
#commander-popup.show {
  opacity: 1 !important;
  animation: commander-pop 0.4s ease-out, commander-shake 0.6s ease-in-out 0.4s;
}

/* === FLINCH (spacebar reaction) === */
@keyframes flinch {
  0% { transform: translateY(0); }
  20% { transform: translateY(-8px); }
  50% { transform: translateY(3px); }
  70% { transform: translateY(-2px); }
  100% { transform: translateY(0); }
}
.pool-agent.flinch > div:nth-child(2) {
  animation: flinch 0.35s ease-out !important;
}

/* === WORKSPACE ZONES === */
.workspace-zones-container {
  position: absolute;
  left: 10px; top: 15px;
  width: 690px; height: 480px;
  z-index: 5;
  display: grid;
  gap: 8px;
  padding: 0;
}
.workspace-zones-container.cols-1 { grid-template-columns: 1fr; }
.workspace-zones-container.cols-2 { grid-template-columns: 1fr 1fr; }
.workspace-zones-container.cols-2x2 { grid-template-columns: 1fr 1fr; }
.workspace-zones-container.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
.workspace-zone {
  position: relative;
  border-radius: 12px;
  background: rgba(0,212,255,0.04);
  border: 1px dashed rgba(0,212,255,0.25);
  transition: border-color 0.3s, box-shadow 0.3s, opacity 0.3s;
  min-height: 160px;
  overflow: hidden;
}
.workspace-zone.ws-active {
  border-color: rgba(0,212,255,0.4);
  box-shadow: inset 0 0 20px rgba(0,212,255,0.05);
}
.workspace-zone.ws-standby { opacity: 0.65; }
.workspace-zone.ws-hold { opacity: 0.4; }
.workspace-zone.highlighted {
  border-color: var(--pink) !important;
  box-shadow: inset 0 0 30px rgba(255,107,157,0.1), 0 0 15px rgba(255,107,157,0.15) !important;
}
.workspace-zone .ws-label {
  position: absolute;
  top: 8px; left: 12px;
  font-size: 11px;
  color: var(--cyan);
  z-index: 6;
}
.workspace-zone .ws-sublabel {
  position: absolute;
  top: 24px; left: 12px;
  font-size: 9px;
  color: rgba(0,212,255,0.5);
  z-index: 6;
}
.workspace-zone .ws-eye {
  display: none;
  font-size: 10px;
  margin-left: 6px;
}
.workspace-zone.highlighted .ws-eye { display: inline; }
.no-workspaces {
  position: absolute;
  left: 50%; top: 200px;
  transform: translateX(-50%);
  font-size: 10px;
  color: #446677;
  z-index: 6;
}

/* === SKILLS PANEL === */
.skills-panel {
  position: absolute;
  bottom: 30px; left: 90px;
  width: 180px;
  max-height: 58px;
  background: rgba(5,15,35,0.7);
  border-radius: 6px 0 0 0;
  padding: 4px 8px;
  z-index: 98;
  overflow-y: auto;
  overflow-x: hidden;
}
.skills-panel::-webkit-scrollbar { width: 3px; }
.skills-panel::-webkit-scrollbar-track { background: transparent; }
.skills-panel::-webkit-scrollbar-thumb { background: rgba(100,150,200,0.3); border-radius: 2px; }
.skills-panel-title {
  font-size: 7px;
  color: #557788;
  margin-bottom: 3px;
  letter-spacing: 2px;
}
.skill-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 7px;
  color: #6688aa;
  line-height: 1.8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.skill-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}
.skill-dot.idle { background: #557788; }
.skill-dot.running { background: #26de81; box-shadow: 0 0 4px rgba(38,222,129,0.6); animation: blink-dot 1.5s ease-in-out infinite; }
.skill-dot.error { background: #ff4444; box-shadow: 0 0 4px rgba(255,68,68,0.6); }
.skill-trigger {
  font-size: 6px;
  color: #446677;
  margin-left: auto;
}
</style>
</head>
<body>
<div class="viewport">
  <!-- Ocean Background -->
  <div class="ocean-bg"></div>

  <!-- Bubbles outside dome -->
  <div id="bubbles-container"></div>

  <!-- Fish silhouettes -->
  <div id="fish-container"></div>

  <!-- Glass Dome -->
  <div class="glass-dome" id="dome">
    <div class="floor"></div>

    <!-- SVG Connection Lines (PM ‚Üí desks) -->
    <svg class="conn-svg" viewBox="0 0 1040 720">
      <defs>
        <filter id="glow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
    </svg>

    <!-- Dynamic Workspace Zones (rendered by JS) -->
    <div id="workspace-zones"></div>

    <!-- ========================= -->
    <!--  AGENT POOL               -->
    <!-- ========================= -->
    <div class="agent-pool" id="agent-pool" style="left:160px; top:640px;">
      <!-- Researcher (Octopus) -->
      <div class="pool-agent" id="pool-researcher">
        <div class="agent-speech" id="speech-researcher"></div>
        <div style="animation: bob-slow 3s ease-in-out infinite;">
          <div class="pixel-char octopus-pixel"></div>
        </div>
        <div class="pool-agent-label" style="color: var(--cyan);">Explorer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-researcher"></div></div>
      </div>

      <!-- Developer (Shark) -->
      <div class="pool-agent" id="pool-developer">
        <div class="agent-speech" id="speech-developer"></div>
        <div style="animation: bob-slow 2.5s ease-in-out infinite 0.3s;">
          <div class="pixel-char shark-pixel"></div>
        </div>
        <div class="pool-agent-label" style="color: var(--orange);">Engineer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-developer"></div></div>
      </div>

      <!-- Reviewer (Turtle) -->
      <div class="pool-agent" id="pool-reviewer">
        <div class="agent-speech" id="speech-reviewer"></div>
        <div style="animation: bob-slow 4s ease-in-out infinite 1s;">
          <div class="pixel-char turtle-pixel"></div>
        </div>
        <div class="pool-agent-label" style="color: var(--green);">Reviewer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-reviewer"></div></div>
      </div>

      <!-- Tester (Pufferfish) -->
      <div class="pool-agent" id="pool-tester">
        <div class="agent-speech" id="speech-tester"></div>
        <div style="animation: bob-slow 3.5s ease-in-out infinite 0.7s;">
          <div class="pixel-char puffer-pixel"></div>
        </div>
        <div class="pool-agent-label" style="color: var(--yellow);">Tester</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-tester"></div></div>
      </div>

      <!-- Writer (Lobster) -->
      <div class="pool-agent" id="pool-writer">
        <div class="agent-speech" id="speech-writer"></div>
        <div style="animation: bob-slow 5s ease-in-out infinite 0.5s;">
          <div class="pixel-char lobster-pixel"></div>
        </div>
        <div class="pool-agent-label" style="color: var(--lavender);">Writer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-writer"></div></div>
      </div>
    </div>

    <!-- ========================= -->
    <!--  WORKSPACE CARGO CRATES   -->
    <!-- ========================= -->

    <!-- ========================= -->
    <!--  PM ‚Äî heysquid (fixed)    -->
    <!-- ========================= -->
    <div class="pm-area" id="pm-area" style="left:460px; top:510px;">
      <div class="pm-speech-bubble" id="pm-speech"></div>
      <div class="char-wrapper" style="position:relative !important; animation: bob 2.5s ease-in-out infinite;">
        <div style="animation: crown-shine 3s ease-in-out infinite; display:inline-block;">
          <div class="pixel-char squid-pixel-lg"></div>
        </div>
      </div>
      <div class="pm-label">PM ‚Äî heysquid</div>
    </div>

    <!-- ============= -->
    <!--  WATER COOLER  -->
    <!-- ============= -->
    <div class="water-cooler" style="left:730px; top:510px;">
      <div style="position:relative; width:28px;">
        <!-- Water jug (top) -->
        <div style="width:16px; height:10px; background:rgba(100,180,255,0.35); border:2px solid rgba(100,180,255,0.5); border-radius:6px 6px 2px 2px; margin:0 auto; position:relative;">
          <div style="position:absolute; top:2px; left:4px; width:4px; height:4px; background:rgba(150,220,255,0.4); border-radius:50%;"></div>
        </div>
        <!-- Dispenser body -->
        <div style="width:20px; height:20px; background:rgba(60,80,110,0.6); border:2px solid rgba(80,120,160,0.5); border-radius:2px; margin:0 auto; position:relative;">
          <div style="position:absolute; top:4px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:rgba(100,180,255,0.3); border-radius:50%;"></div>
          <!-- Tap -->
          <div style="position:absolute; bottom:3px; left:50%; transform:translateX(-50%); width:4px; height:3px; background:#5599bb; border-radius:1px;"></div>
        </div>
        <!-- Base/stand -->
        <div style="width:24px; height:4px; background:rgba(60,80,100,0.5); border-radius:1px; margin:0 auto;"></div>
      </div>
      <div style="font-size:7px; color:#3a6a8a; text-align:center; margin-top:2px;">Cooler</div>
    </div>

    <!-- ============ -->
    <!--  PLANTS x2   -->
    <!-- ============ -->
    <div class="plant" style="left:960px; top:520px;">
      <div style="position:relative;">
        <div style="width:4px; height:16px; background:#44aa66; border-radius:2px; position:absolute; bottom:4px; left:5px; transform:rotate(-10deg); animation: bob-slow 3s ease-in-out infinite;"></div>
        <div style="width:4px; height:20px; background:#55bb77; border-radius:2px; position:absolute; bottom:4px; left:11px; animation: bob-slow 3.5s ease-in-out infinite 0.5s;"></div>
        <div style="width:4px; height:14px; background:#44aa66; border-radius:2px; position:absolute; bottom:4px; left:17px; transform:rotate(10deg); animation: bob-slow 2.8s ease-in-out infinite 1s;"></div>
        <div style="width:26px; height:14px; background:#8B5E3C; border-radius:2px 2px 4px 4px;"></div>
        <div style="width:30px; height:3px; background:#9B6E4C; border-radius:1px; position:relative; top:-14px; left:-2px;"></div>
      </div>
    </div>
    <div class="plant" style="left:15px; top:560px;">
      <div style="position:relative;">
        <div style="width:3px; height:12px; background:#66cc88; border-radius:2px; position:absolute; bottom:4px; left:4px; transform:rotate(-15deg); animation: bob-slow 2.5s ease-in-out infinite 0.3s;"></div>
        <div style="width:3px; height:16px; background:#55bb77; border-radius:2px; position:absolute; bottom:4px; left:9px; animation: bob-slow 3s ease-in-out infinite;"></div>
        <div style="width:3px; height:10px; background:#66cc88; border-radius:2px; position:absolute; bottom:4px; left:14px; transform:rotate(12deg); animation: bob-slow 3.2s ease-in-out infinite 0.7s;"></div>
        <div style="width:22px; height:12px; background:#7B4E2C; border-radius:2px 2px 4px 4px;"></div>
        <div style="width:26px; height:3px; background:#8B5E3C; border-radius:1px; position:relative; top:-12px; left:-2px;"></div>
      </div>
    </div>

    <!-- ======================== -->
    <!--  MOVING DIVER (Î≥¥Ïä§)     -->
    <!-- ======================== -->
    <div id="moving-diver" style="left:600px; top:580px;">
      <div class="diver-speech-bubble" id="diver-speech"></div>
      <div class="pixel-char diver-pixel"></div>
      <div class="mini-label">‚Üë‚Üì‚Üê‚Üí Patrol</div>
    </div>

  </div><!-- end glass-dome -->

  <!-- Title Bar -->
  <div class="title-bar">
    <h1>heysquid HQ</h1>
    <div class="subtitle">DEEP SEA AGENT COMMAND CENTER</div>
  </div>

  <!-- Skills Panel -->
  <div class="skills-panel" id="skills-panel">
    <div class="skills-panel-title">SKILLS</div>
  </div>

  <!-- Mission Log -->
  <div class="mission-log">
    <div class="log-entries" id="logEntries">
      <div class="log-entry"><span class="time">[--:--]</span> System standby...</div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-left">
      <span class="conn-dot-status" id="connDot"></span>
      <span id="connLabel">Connecting...</span>
    </div>
    <div class="status-center" id="currentTask">Standby</div>
    <div class="status-right">
      <span id="lastUpdated">--:--:--</span>
    </div>
  </div>

  <!-- DEMO Button -->
  <button class="btn-demo" id="btnDemo" onclick="runDemo()">DEMO</button>

  <!-- Keyboard hint -->
  <div class="keyboard-hint">‚Üë‚Üì‚Üê‚Üí Patrol &nbsp; SPACE: Commander's words</div>

  <!-- Commander popup (replaced by diver speech bubble) -->
  <div id="commander-popup" style="display:none;"></div>

</div><!-- end viewport -->

<script>
// ===== CONSTANTS =====
var AGENTS = ['researcher', 'developer', 'reviewer', 'tester', 'writer'];
var DESKS = [];
var AGENT_PIXEL_CLASS = {
  researcher: 'octopus-pixel',
  developer: 'shark-pixel',
  reviewer: 'turtle-pixel',
  tester: 'puffer-pixel',
  writer: 'lobster-pixel'
};
var REGISTRY = {};  // populated from agent_status.json _registry
var POLL_INTERVAL = 3000;
var fetchFailCount = 0;
var mode = 'connecting';
var prevLogLength = 0;
var demoRunning = false;

var DEPARTMENTS = []; // dynamically populated

// ===== BUBBLES =====
(function() {
  var container = document.getElementById('bubbles-container');
  function createBubble() {
    var b = document.createElement('div');
    b.className = 'bubble';
    var sz = 4 + Math.random() * 14;
    b.style.width = sz + 'px';
    b.style.height = sz + 'px';
    b.style.left = Math.random() * 1200 + 'px';
    b.style.top = (500 + Math.random() * 400) + 'px';
    b.style.animationDuration = (6 + Math.random() * 8) + 's';
    b.style.animationDelay = (Math.random() * 2) + 's';
    container.appendChild(b);
    setTimeout(function() { b.remove(); }, 16000);
  }
  for (var i = 0; i < 15; i++) setTimeout(createBubble, i * 300);
  setInterval(createBubble, 1500);
})();

// ===== FISH SILHOUETTES =====
(function() {
  var container = document.getElementById('fish-container');
  function createFish() {
    var f = document.createElement('div');
    f.className = 'fish-sil';
    var y = 80 + Math.random() * 700;
    var sz = 16 + Math.random() * 30;
    var goR = Math.random() > 0.5;
    var startX = goR ? -60 : 1260;
    var endX = goR ? 1260 : -60;
    var dur = 12 + Math.random() * 18;
    f.style.top = y + 'px';
    f.style.left = startX + 'px';
    f.style.opacity = 0.06 + Math.random() * 0.08;
    f.style.transition = 'left ' + dur + 's linear';
    f.innerHTML = '<div style="position:relative;transform:scaleX(' + (goR ? 1 : -1) + ');">' +
      '<div style="width:' + sz + 'px;height:' + (sz * 0.5) + 'px;background:#4488aa;border-radius:' + (sz * 0.4) + 'px ' + (sz * 0.3) + 'px ' + (sz * 0.3) + 'px ' + (sz * 0.4) + 'px;"></div>' +
      '<div style="position:absolute;right:-' + (sz * 0.25) + 'px;top:' + (sz * 0.05) + 'px;width:0;height:0;border-top:' + (sz * 0.2) + 'px solid transparent;border-bottom:' + (sz * 0.2) + 'px solid transparent;border-left:' + (sz * 0.3) + 'px solid #4488aa;"></div></div>';
    container.appendChild(f);
    requestAnimationFrame(function() { f.style.left = endX + 'px'; });
    setTimeout(function() { f.remove(); }, dur * 1000 + 500);
  }
  for (var i = 0; i < 4; i++) setTimeout(createFish, i * 2000);
  setInterval(createFish, 5000 + Math.random() * 4000);
})();


// ===== SCREEN FLICKER =====
setInterval(function() {
  var screens = document.querySelectorAll('.monitor-screen');
  var idx = Math.floor(Math.random() * screens.length);
  var s = screens[idx];
  if (s) {
    s.style.transition = 'opacity 0.05s';
    s.style.opacity = '0.5';
    setTimeout(function() { s.style.opacity = '1'; }, 100);
  }
}, 7000);


// ===== ARROW KEY DIVER MOVEMENT =====
(function() {
  var diver = document.getElementById('moving-diver');
  var posX = 600, posY = 580;
  var keys = {};
  var speed = 4;
  var BOUNDS = { left: 15, top: 15, right: 990, bottom: 690 };
  var currentHighlight = null;
  var currentDeskHighlight = null;

  document.addEventListener('keydown', function(e) {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].indexOf(e.key) !== -1) {
      e.preventDefault();
      keys[e.key] = true;
    }
  });
  document.addEventListener('keyup', function(e) { keys[e.key] = false; });

  function checkDeptCollision(cx, cy) {
    for (var i = 0; i < DEPARTMENTS.length; i++) {
      var d = DEPARTMENTS[i];
      if (cx >= d.left && cx <= d.left + d.width && cy >= d.top && cy <= d.top + d.height) {
        return d.id;
      }
    }
    return null;
  }

  // Desk bounds dynamically computed from rendered desks
  function getDeskBounds() {
    var bounds = [];
    var domeEl = document.getElementById('dome');
    if (!domeEl) return bounds;
    var domeRect = domeEl.getBoundingClientRect();
    var scale = domeRect.width / 1040;
    DESKS.forEach(function(desk) {
      var deskEl = document.getElementById('desk-' + desk);
      if (!deskEl) return;
      var r = deskEl.getBoundingClientRect();
      bounds.push({
        id: 'desk-' + desk,
        left: (r.left - domeRect.left) / scale,
        top: (r.top - domeRect.top) / scale,
        width: r.width / scale,
        height: r.height / scale
      });
    });
    return bounds;
  }

  function checkDeskProximity(cx, cy) {
    var bounds = getDeskBounds();
    for (var i = 0; i < bounds.length; i++) {
      var d = bounds[i];
      if (cx >= d.left - 20 && cx <= d.left + d.width + 20 && cy >= d.top - 20 && cy <= d.top + d.height + 20) {
        return d.id;
      }
    }
    return null;
  }

  function gameLoop() {
    var moved = false;
    if (keys['ArrowUp'])    { posY -= speed; moved = true; }
    if (keys['ArrowDown'])  { posY += speed; moved = true; }
    if (keys['ArrowLeft'])  { posX -= speed; moved = true; }
    if (keys['ArrowRight']) { posX += speed; moved = true; }

    posX = Math.max(BOUNDS.left, Math.min(BOUNDS.right, posX));
    posY = Math.max(BOUNDS.top, Math.min(BOUNDS.bottom, posY));

    if (moved) {
      diver.style.left = posX + 'px';
      diver.style.top = posY + 'px';
    }

    // Department highlight
    var centerX = posX + 24;
    var centerY = posY + 24;
    var hit = checkDeptCollision(centerX, centerY);

    if (hit !== currentHighlight) {
      if (currentHighlight) document.getElementById(currentHighlight).classList.remove('highlighted');
      if (hit) document.getElementById(hit).classList.add('highlighted');
      currentHighlight = hit;
    }

    // Desk proximity highlight
    var deskHit = checkDeskProximity(centerX, centerY);
    if (deskHit !== currentDeskHighlight) {
      if (currentDeskHighlight) document.getElementById(currentDeskHighlight).classList.remove('desk-highlight');
      if (deskHit) document.getElementById(deskHit).classList.add('desk-highlight');
      currentDeskHighlight = deskHit;
    }

    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);
})();

// ===== TIME HELPER =====
function getTime() {
  var d = new Date();
  return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0');
}

// ===== CONNECTION STATUS =====
function setConnectionStatus(newMode) {
  mode = newMode;
  var dot = document.getElementById('connDot');
  var label = document.getElementById('connLabel');
  var btn = document.getElementById('btnDemo');
  dot.className = 'conn-dot-status';
  if (newMode === 'live') {
    dot.classList.add('live');
    label.textContent = 'LIVE';
    label.style.color = '#26de81';
    btn.style.display = 'none';
  } else if (newMode === 'demo') {
    dot.classList.add('demo');
    label.textContent = 'DEMO';
    label.style.color = '#ffd32a';
    btn.style.display = 'inline-block';
  } else {
    label.textContent = 'Connecting...';
    label.style.color = '#5599aa';
    btn.style.display = 'none';
  }
}

// ===== SVG LINE ACTIVATION =====
function setLineActive(desk, active) {
  var line = document.getElementById('line-' + desk);
  if (line) {
    if (active) line.classList.add('active');
    else line.classList.remove('active');
  }
}

// ===== HP BAR COLOR =====
function hpColor(value) {
  if (value >= 60) return '#26de81';
  if (value >= 30) return '#ffd32a';
  return '#ff3c3c';
}

// ===== DISPATCH AGENT TO DESK =====
function dispatchAgent(agent, desk) {
  var poolEl = document.getElementById('pool-' + agent);
  var slotEl = document.getElementById('slot-' + desk);
  var deskEl = document.getElementById('desk-' + desk);
  if (!poolEl || !slotEl || !deskEl) return;

  // Already walking? Skip
  if (poolEl.classList.contains('walking')) return;

  // Already at this desk? Just ensure desk state is correct
  if (poolEl.dataset.walkedTo === desk) {
    // Re-position in case layout shifted
    deskEl.classList.add('occupied');
    var rect = slotEl.getBoundingClientRect();
    poolEl.classList.add('at-desk');
    poolEl.style.position = 'fixed';
    poolEl.style.left = rect.left + 'px';
    poolEl.style.top = rect.top + 'px';
    poolEl.style.margin = '0';
    slotEl.dataset.agent = agent;
    setLineActive(desk, true);
    return;
  }

  // Ensure slot is visible for measuring (it's display:none when desk not occupied)
  deskEl.classList.add('occupied');
  var startRect = poolEl.getBoundingClientRect();
  var endRect = slotEl.getBoundingClientRect();
  var dx = endRect.left - startRect.left;
  var dy = endRect.top - startRect.top;
  var destLeft = endRect.left;
  var destTop = endRect.top;
  deskEl.classList.remove('occupied');

  // Start swimming
  poolEl.style.position = 'fixed';
  poolEl.style.left = startRect.left + 'px';
  poolEl.style.top = startRect.top + 'px';
  poolEl.style.margin = '0';
  poolEl.classList.add('walking');

  // Trigger transition on next frame
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      poolEl.style.transform = 'translate(' + dx + 'px, ' + dy + 'px)';
    });
  });

  // On arrival ‚Äî keep pool element visible at desk (no swap)
  function onArrival(e) {
    if (e.propertyName !== 'transform') return;
    poolEl.removeEventListener('transitionend', onArrival);
    poolEl.classList.remove('walking');
    poolEl.classList.add('at-desk');
    poolEl.dataset.walkedTo = desk;
    // Settle at destination (remove transform, set final position)
    poolEl.style.left = destLeft + 'px';
    poolEl.style.top = destTop + 'px';
    poolEl.style.transform = '';

    // Mark desk as occupied (for monitor glow etc) but no new element in slot
    slotEl.dataset.agent = agent;
    deskEl.classList.add('occupied');
    setLineActive(desk, true);
  }

  poolEl.addEventListener('transitionend', onArrival);
  showPmSpeech('dispatching');
}

// ===== RECALL AGENT FROM DESK =====
function recallAgent(agent) {
  var poolEl = document.getElementById('pool-' + agent);
  if (poolEl) {
    poolEl.classList.remove('dispatched', 'at-desk', 'walking');
    poolEl.style.position = '';
    poolEl.style.left = '';
    poolEl.style.top = '';
    poolEl.style.margin = '';
    poolEl.style.transform = '';
    delete poolEl.dataset.walkedTo;
  }

  // Clear from any desk
  DESKS.forEach(function(desk) {
    var slotEl = document.getElementById('slot-' + desk);
    if (slotEl && slotEl.dataset.agent === agent) {
      slotEl.innerHTML = '';
      slotEl.dataset.agent = '';
      document.getElementById('desk-' + desk).classList.remove('occupied');
      document.getElementById('desk-' + desk).className =
        document.getElementById('desk-' + desk).className.replace(/\bstatus-\w+/g, '');
      var hpWrap = document.getElementById('hp-wrap-' + desk);
      if (hpWrap) hpWrap.style.display = 'none';
      setLineActive(desk, false);
    }
  });
  showPmSpeech('complete');
}

// ===== LOAD DASHBOARD DATA =====
function loadDashboardData(data) {
  if (!data) return;

  // Clear all desk slots first
  DESKS.forEach(function(desk) {
    var slotEl = document.getElementById('slot-' + desk);
    var deskEl = document.getElementById('desk-' + desk);
    if (slotEl) {
      slotEl.innerHTML = '';
      slotEl.dataset.agent = '';
    }
    if (deskEl) {
      deskEl.classList.remove('occupied');
      deskEl.className = deskEl.className.replace(/\bstatus-\w+/g, '');
      var hpWrap = document.getElementById('hp-wrap-' + desk);
      if (hpWrap) hpWrap.style.display = 'none';
      setLineActive(desk, false);
    }
  });

  // Reset all pool agents
  AGENTS.forEach(function(agent) {
    var poolEl = document.getElementById('pool-' + agent);
    if (!poolEl) return;
    var info = data[agent];
    var hasAssignment = info && info.assignment && (info.status === 'working' || info.status === 'complete' || info.status === 'error');
    if (!hasAssignment) {
      // Agent returning to pool ‚Äî clear walk state
      poolEl.classList.remove('dispatched', 'walking', 'at-desk');
      poolEl.style.position = '';
      poolEl.style.left = '';
      poolEl.style.top = '';
      poolEl.style.margin = '';
      poolEl.style.transform = '';
      delete poolEl.dataset.walkedTo;
    } else {
      poolEl.classList.remove('dispatched');
    }
  });

  // Process each agent
  AGENTS.forEach(function(agent) {
    var info = data[agent];
    if (!info) return;

    var hpValue = (typeof info.hp === 'number') ? info.hp : 100;

    // Pool HP bar
    var poolHp = document.getElementById('hp-' + agent);
    if (poolHp) {
      poolHp.style.width = hpValue + '%';
      poolHp.style.background = hpColor(hpValue);
    }

    // Dispatch if assigned and working
    var assignment = info.assignment;
    var status = info.status || 'idle';

    if (assignment && (status === 'working' || status === 'complete' || status === 'error')) {
      dispatchAgent(agent, assignment);

      // Set desk status class
      var deskEl = document.getElementById('desk-' + assignment);
      if (deskEl && status !== 'idle') {
        deskEl.classList.add('status-' + status);
      }

      // Desk HP bar
      var deskHp = document.getElementById('hp-desk-' + assignment);
      if (deskHp) {
        deskHp.style.width = hpValue + '%';
        deskHp.style.background = hpColor(hpValue);
      }
    }
  });

  // Mission log
  if (data.mission_log && Array.isArray(data.mission_log)) {
    var entries = document.getElementById('logEntries');
    var newLen = data.mission_log.length;
    if (newLen !== prevLogLength) {
      entries.innerHTML = '';
      var start = Math.max(0, data.mission_log.length - 20);
      for (var i = start; i < data.mission_log.length; i++) {
        var e = data.mission_log[i];
        var div = document.createElement('div');
        div.className = 'log-entry';
        var ac = e.agent || '';
        div.innerHTML = '<span class="time">[' + (e.time || '--:--') + ']</span> <span class="agent ' + ac + '">' + (e.agent || 'system') + '</span> ' + (e.message || '');
        entries.appendChild(div);
      }
      prevLogLength = newLen;
      // Auto-scroll to bottom
      var logBox = document.querySelector('.mission-log');
      if (logBox) logBox.scrollTop = logBox.scrollHeight;
    }
  }

  // Mirror mission_log to agent speech bubbles (PM + pool agents)
  if (data.mission_log && Array.isArray(data.mission_log)) {
    var agentSpeechMap = {
      'pm': 'pm-speech',
      'researcher': 'speech-researcher',
      'developer': 'speech-developer',
      'reviewer': 'speech-reviewer',
      'tester': 'speech-tester',
      'writer': 'speech-writer'
    };
    function truncMsg(m) { return m.length > 25 ? m.slice(0,25) + '...' : m; }

    // Collect last 5 messages per agent
    var agentRecentMsgs = {};
    for (var li = 0; li < data.mission_log.length; li++) {
      var entry = data.mission_log[li];
      if (agentSpeechMap[entry.agent]) {
        if (!agentRecentMsgs[entry.agent]) agentRecentMsgs[entry.agent] = [];
        agentRecentMsgs[entry.agent].push(entry.message);
      }
    }
    Object.keys(agentRecentMsgs).forEach(function(agent) {
      agentRecentMsgs[agent] = agentRecentMsgs[agent].slice(-5);
    });

    // Update speech bubbles
    Object.keys(agentSpeechMap).forEach(function(agent) {
      var el = document.getElementById(agentSpeechMap[agent]);
      if (!el) return;
      var msgs = agentRecentMsgs[agent] || [];
      if (msgs.length === 0) return;
      var isWorking = (data[agent] || {}).status === 'working';
      var msgsKey = msgs.join('|');

      if (isWorking && msgs.length > 1) {
        // Cycling mode ‚Äî rotate through recent messages
        el.classList.add('visible');
        clearTimeout(el._hideTimer);
        el._hideTimer = null;
        if (el._msgsKey !== msgsKey) {
          el._msgsKey = msgsKey;
          clearInterval(el._cycleTimer);
          el._cycleIdx = 0;
          el.textContent = truncMsg(msgs[0]);
          el.classList.remove('fading');
          el._cycleTimer = setInterval(function() {
            el._cycleIdx = (el._cycleIdx + 1) % msgs.length;
            el.classList.add('fading');
            setTimeout(function() {
              el.textContent = truncMsg(msgs[el._cycleIdx]);
              el.classList.remove('fading');
            }, 200);
          }, 800);
        }
      } else {
        // Static mode (idle or single message)
        clearInterval(el._cycleTimer);
        el._cycleTimer = null;
        el._msgsKey = null;
        var msg = msgs[msgs.length - 1];
        if (el._lastLogMsg !== msg) {
          el._lastLogMsg = msg;
          el.textContent = truncMsg(msg);
          el.classList.add('visible');
          el.classList.remove('fading');
        }
        clearTimeout(el._hideTimer);
        if (isWorking) {
          el._hideTimer = null;
          el.classList.add('visible');
        } else {
          el._hideTimer = setTimeout(function() {
            el.classList.remove('visible');
          }, 5000);
        }
      }
    });
  }

  // Current task
  var taskEl = document.getElementById('currentTask');
  if (data.current_task) {
    taskEl.textContent = data.current_task;
    taskEl.style.color = '#77eeff';
  } else {
    taskEl.textContent = 'Standby';
    taskEl.style.color = '#5599aa';
  }

  // Last updated
  var lu = document.getElementById('lastUpdated');
  if (data.last_updated) lu.textContent = data.last_updated;
  else lu.textContent = getTime();

  // Update registry from data
  if (data._registry) {
    REGISTRY = data._registry;
    var newAgents = Object.keys(REGISTRY).filter(function(k) { return k !== 'pm'; });
    if (newAgents.length > 0) AGENTS = newAgents;
  }

  // Workspace zones
  if (data.workspaces) {
    renderWorkspaceZones(data.workspaces);
  }

  // Skills panel
  if (data.skills) {
    renderSkillsPanel(data.skills);
  }

}

// ===== PM SPEECH BUBBLE =====
var PM_SPEECHES = {
  idle: [
    "Don't make me angry...",
    "Is there no perfect agent?",
    "I see everything.",
    "You don't want to see me angry...",
    "The kraken sleeps... for now."
  ],
  dispatching: [
    "Deploy! Dive dive dive!",
    "Agent deployed to sector",
    "Torpedo away!",
    "Launching mission pod",
    "You have your orders"
  ],
  working: [
    "Depth charge in progress...",
    "Smooth sailing at 200m",
    "Hull integrity holding",
    "Sonar contact ‚Äî tracking...",
    "Almost at target depth"
  ],
  complete: [
    "Surface! Mission accomplished!",
    "Target neutralized!",
    "All hands ‚Äî well done!",
    "Returning to base",
    "Ink cloud deployed ‚úì"
  ],
  error: [
    "Leak detected!",
    "Pressure breach!",
    "Mayday mayday!",
    "Emergency surface!"
  ],
  demo: [
    "Watch this, Captain!",
    "Demo sequence initiated",
    "Simulation running..."
  ]
};

function showPmSpeech(category) {
  var el = document.getElementById('pm-speech');
  if (!el) return;
  var msgs = PM_SPEECHES[category] || PM_SPEECHES.idle;
  el.textContent = msgs[Math.floor(Math.random() * msgs.length)];
  el.classList.add('visible');
  setTimeout(function() { el.classList.remove('visible'); }, 3000);
}

// ===== POLLING =====
function pollStatus() {
  fetch('./agent_status.json?t=' + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      fetchFailCount = 0;
      if (mode !== 'live') setConnectionStatus('live');
      loadDashboardData(data);
    })
    .catch(function() {
      fetchFailCount++;
      if (fetchFailCount >= 1 && mode !== 'demo') {
        setConnectionStatus('demo');
      }
    });
}

setConnectionStatus('connecting');
if (location.protocol === 'file:') {
  setConnectionStatus('demo');
} else {
  pollStatus();
  setInterval(pollStatus, POLL_INTERVAL);
}

// ===== DEMO MODE =====
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

async function runDemo() {
  if (demoRunning) return;
  demoRunning = true;
  var btn = document.getElementById('btnDemo');
  btn.disabled = true;
  btn.textContent = 'RUNNING...';
  prevLogLength = 0;

  var base = {
    last_updated: getTime(), current_task: '',
    researcher: {status:'idle',task:'',hp:100,assignment:null},
    developer: {status:'idle',task:'',hp:100,assignment:null},
    reviewer: {status:'idle',task:'',hp:100,assignment:null},
    tester: {status:'idle',task:'',hp:100,assignment:null},
    writer: {status:'idle',task:'',hp:100,assignment:null},
    workspaces: {
      'project-a': {status:'active', description:'Main project', last_active: new Date().toISOString().slice(0,10)},
      'project-b': {status:'standby', description:'Side project', last_active: new Date().toISOString().slice(0,10)}
    },
    skills: {
      'briefing': {name:'briefing', description:'Daily briefing', trigger:'schedule', schedule:'09:00', status:'idle', next_run:'2026-02-21T09:00:00', run_count:3, last_result:'success', enabled:true},
      'deploy': {name:'deploy', description:'Auto deploy', trigger:'manual', schedule:'', status:'idle', next_run:null, run_count:0, last_result:null, enabled:true}
    },
    mission_log: [{time: getTime(), agent: 'system', message: 'Demo sequence initiated'}]
  };
  loadDashboardData(base);
  showPmSpeech('demo');
  await sleep(1000);

  function snap(overrides, logs) {
    var d = JSON.parse(JSON.stringify(base));
    d.last_updated = getTime();
    Object.keys(overrides).forEach(function(k) {
      if (d[k] && typeof overrides[k] === 'object') Object.assign(d[k], overrides[k]);
      else d[k] = overrides[k];
    });
    if (logs) d.mission_log = logs;
    return d;
  }
  var logs = [{time: getTime(), agent: 'system', message: 'Demo sequence initiated'}];

  // [1s] Researcher + Developer dispatched to workspace desks
  logs.push({time: getTime(), agent: 'pm', message: 'Dual deploy \u2014 Explorer + Engineer!'});
  logs.push({time: getTime(), agent: 'researcher', message: 'Diving to analyze structure...'});
  logs.push({time: getTime(), agent: 'developer', message: 'Spinning up engine...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'working', task:'Analysis', hp:45, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:55, assignment:'project-b'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  // [3s] Researcher HP recovering
  logs.push({time: getTime(), agent: 'researcher', message: 'Sonar lock \u2014 3 targets acquired!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'working', task:'Target lock', hp:70, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:40, assignment:'project-b'}
  }, logs));
  showPmSpeech('working');
  await sleep(2000);

  // [5s] Researcher complete
  logs.push({time: getTime(), agent: 'researcher', message: 'Analysis complete!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'complete', task:'Done', hp:100, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:30, assignment:'project-b'}
  }, logs));
  await sleep(1000);

  // Researcher returns to pool
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'idle', task:'', hp:100, assignment:null},
    developer: {status:'working', task:'Engine', hp:45, assignment:'project-b'}
  }, logs));
  await sleep(500);

  // [6s] Reviewer dispatched
  logs.push({time: getTime(), agent: 'pm', message: 'Launching Reviewer \u2014 quality check'});
  logs.push({time: getTime(), agent: 'reviewer', message: 'Intercepting code for review...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'idle', task:'', hp:100, assignment:null},
    developer: {status:'working', task:'Engine', hp:60, assignment:'project-b'},
    reviewer: {status:'working', task:'Code review', hp:70, assignment:'project-a'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  // [8s] Developer complete
  logs.push({time: getTime(), agent: 'developer', message: 'Engine deployed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    developer: {status:'complete', task:'Done', hp:100, assignment:'project-b'},
    reviewer: {status:'working', task:'Review', hp:85, assignment:'project-a'}
  }, logs));
  await sleep(1000);

  // Developer returns
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    developer: {status:'idle', task:'', hp:100, assignment:null},
    reviewer: {status:'working', task:'Review', hp:90, assignment:'project-a'}
  }, logs));
  await sleep(500);

  // [9s] Reviewer -> Tester
  logs.push({time: getTime(), agent: 'reviewer', message: 'All checks passed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    reviewer: {status:'complete', task:'Reviewed', hp:100, assignment:'project-a'}
  }, logs));
  await sleep(800);

  logs.push({time: getTime(), agent: 'tester', message: 'Running tests...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    reviewer: {status:'idle', task:'', hp:100, assignment:null},
    tester: {status:'working', task:'Tests', hp:65, assignment:'project-a'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(1500);

  // Tester complete
  logs.push({time: getTime(), agent: 'tester', message: 'All tests passed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    tester: {status:'complete', task:'Passed', hp:100, assignment:'project-a'}
  }, logs));
  await sleep(800);

  // Writer
  logs.push({time: getTime(), agent: 'writer', message: 'Composing content...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    tester: {status:'idle', task:'', hp:100, assignment:null},
    writer: {status:'working', task:'Content', hp:80, assignment:'project-b'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  logs.push({time: getTime(), agent: 'writer', message: 'Content ready!'});
  loadDashboardData(snap({
    writer: {status:'complete', task:'Done', hp:100, assignment:'project-b'}
  }, logs));
  showPmSpeech('complete');
  await sleep(800);

  // Skill demo
  logs.push({time: getTime(), agent: 'pm', message: 'Running briefing skill...'});
  var skillSnap = snap({current_task: ''}, logs);
  skillSnap.writer = {status:'idle',task:'',hp:100,assignment:null};
  skillSnap.skills.briefing.status = 'running';
  loadDashboardData(skillSnap);
  await sleep(1500);

  logs.push({time: getTime(), agent: 'system', message: 'Briefing complete!'});
  skillSnap = snap({current_task: ''}, logs);
  skillSnap.skills.briefing.status = 'idle';
  skillSnap.skills.briefing.last_result = 'success';
  skillSnap.skills.briefing.run_count = 4;
  loadDashboardData(skillSnap);
  await sleep(1000);

  // All idle
  logs.push({time: getTime(), agent: 'system', message: 'Mission accomplished!'});
  loadDashboardData(snap({
    current_task: '',
    researcher: {status:'idle',task:'',hp:100,assignment:null},
    developer: {status:'idle',task:'',hp:100,assignment:null},
    reviewer: {status:'idle',task:'',hp:100,assignment:null},
    tester: {status:'idle',task:'',hp:100,assignment:null},
    writer: {status:'idle',task:'',hp:100,assignment:null}
  }, logs));

  await sleep(2000);
  demoRunning = false;
  btn.disabled = false;
  btn.textContent = 'DEMO';
}
// ===== FEATURE 1: ENTRANCE ANIMATION =====
(function() {
  var poolAgents = [
    { id: 'pool-researcher', speechId: 'speech-researcher' },
    { id: 'pool-developer',  speechId: 'speech-developer' },
    { id: 'pool-reviewer',   speechId: 'speech-reviewer' },
    { id: 'pool-tester',     speechId: 'speech-tester' },
    { id: 'pool-writer',     speechId: 'speech-writer' }
  ];

  setTimeout(function() {
    poolAgents.forEach(function(agent, idx) {
      setTimeout(function() {
        var el = document.getElementById(agent.id);
        if (el) {
          el.classList.add('entrance-anim');
          setTimeout(function() { el.classList.remove('entrance-anim'); }, 700);
        }
        // Show agent speech bubble
        var speechEl = document.getElementById(agent.speechId);
        if (speechEl) {
          speechEl.textContent = 'Commander on deck!';
          speechEl.classList.add('visible');
          setTimeout(function() { speechEl.classList.remove('visible'); }, 1500);
        }
      }, idx * 400);
    });

    // PM speech after all agents bounce
    setTimeout(function() {
      var el = document.getElementById('pm-speech');
      if (el) {
        el.textContent = 'Crew assembled. Awaiting orders.';
        el.classList.add('visible');
        setTimeout(function() { el.classList.remove('visible'); }, 3000);
      }
    }, poolAgents.length * 400 + 200);
  }, 1000);
})();

// ===== FEATURE 2: PM IDLE REPORT (Commander character lines) =====
var pmIdleLines = [
  // Î∂àÎßåÌòï
  "Don't make me angry...",
  "Is there no perfect agent?",
  "Give me full authority.",
  // ÎèÖÏû¨ÏûêÌòï
  "I see everything.",
  "Nobody leaves until I say so.",
  "This base runs on MY schedule.",
  // Í≥†ÎáåÌòï
  "Why is it so quiet...",
  "Am I the only one working here?",
  "One day, they'll understand.",
  // ÌÅ¨ÎùºÏºÑ ÏïîÏãúÌòï
  "You don't want to see me angry...",
  "Last time I lost it... no one was left.",
  "I could destroy this whole village.",
  "The kraken sleeps... for now.",
  "Don't test my patience.",
  "When I wake... cities fall."
];
var pmIdleIdx = 0;
var pmIdleTimer = null;
var pmReportBusy = false;

function startPmIdleReport() {
  if (pmIdleTimer) return;
  pmIdleTimer = setInterval(function() {
    if (pmReportBusy) return;
    var el = document.getElementById('pm-speech');
    if (!el) return;
    if (el.classList.contains('visible')) return;
    var line = pmIdleLines[pmIdleIdx % pmIdleLines.length];
    pmIdleIdx++;
    el.textContent = line;
    el.classList.add('visible');
    setTimeout(function() { el.classList.remove('visible'); }, 5000);
  }, 30000);
}
function stopPmIdleReport() {
  if (pmIdleTimer) { clearInterval(pmIdleTimer); pmIdleTimer = null; }
}

// Patch loadDashboardData to show current_task in PM speech
var _origLoadDashboardData = loadDashboardData;
loadDashboardData = function(data) {
  _origLoadDashboardData(data);
  if (!data) return;

  if (data.current_task) {
    // Show task in PM bubble
    pmReportBusy = true;
    stopPmIdleReport();
    var el = document.getElementById('pm-speech');
    if (el) {
      el.textContent = data.current_task;
      el.classList.add('visible');
      setTimeout(function() { el.classList.remove('visible'); }, 5000);
    }
  } else {
    pmReportBusy = false;
    startPmIdleReport();
  }
};

// Start idle report by default
startPmIdleReport();

// ===== FEATURE 3: KEYBOARD INTERACTION =====
var interactionCooldown = false;

// Z key ‚Äî Commander's words (flinch) ‚Äî moved from Space
document.addEventListener('keydown', function(e) {
  if (e.key !== 'z' && e.key !== 'Z') return;
  e.preventDefault();
  if (interactionCooldown) return;
  interactionCooldown = true;

  // 1. Show diver speech bubble
  var diverBubble = document.getElementById('diver-speech');
  if (diverBubble) {
    diverBubble.textContent = 'THIS is my elite squad?!';
    diverBubble.classList.remove('visible');
    void diverBubble.offsetWidth;
    diverBubble.classList.add('visible');
  }

  // 2. Flinch pool agents
  var poolIds = ['pool-researcher', 'pool-developer', 'pool-reviewer', 'pool-tester', 'pool-writer'];
  poolIds.forEach(function(id) {
    var el = document.getElementById(id);
    if (el && !el.classList.contains('walking') && !el.classList.contains('at-desk')) {
      el.classList.add('flinch');
      setTimeout(function() { el.classList.remove('flinch'); }, 400);
    }
  });

  // 3. PM says "..."
  var pmEl = document.getElementById('pm-speech');
  if (pmEl) {
    pmEl.textContent = '...';
    pmEl.classList.add('visible');
    setTimeout(function() { pmEl.classList.remove('visible'); }, 2000);
  }

  // 4. Fade out diver bubble after 2s
  setTimeout(function() {
    if (diverBubble) {
      diverBubble.classList.remove('visible');
    }
  }, 2000);

  // 5. Cooldown 3s
  setTimeout(function() { interactionCooldown = false; }, 3000);
});

document.addEventListener('keydown', function(e) {
  if (e.key !== ' ') return;
  e.preventDefault();
  if (interactionCooldown) return;
  var zEvent = new KeyboardEvent('keydown', {key: 'z'});
  document.dispatchEvent(zEvent);
});

// ===== DYNAMIC WORKSPACE ZONES =====
var lastWsData = null;
function renderWorkspaceZones(workspaces) {
  if (JSON.stringify(workspaces) === JSON.stringify(lastWsData)) return;
  lastWsData = JSON.parse(JSON.stringify(workspaces));

  var container = document.getElementById('workspace-zones');
  if (!container) return;

  var wsNames = Object.keys(workspaces);
  if (wsNames.length === 0) {
    container.innerHTML = '<div class="no-workspaces">No workspaces</div>';
    DESKS = [];
    DEPARTMENTS = [];
    return;
  }

  container.innerHTML = '';
  container.className = 'workspace-zones-container';
  if (wsNames.length <= 2) container.classList.add('cols-' + wsNames.length);
  else if (wsNames.length <= 4) container.classList.add('cols-2x2');
  else container.classList.add('cols-3');

  // Update dynamic DESKS
  DESKS = wsNames.slice();

  // Clear old SVG lines
  var svg = document.querySelector('.conn-svg');
  if (svg) {
    svg.querySelectorAll('.conn-line.dynamic').forEach(function(l) { l.remove(); });
  }

  wsNames.forEach(function(name, idx) {
    var ws = workspaces[name];
    var status = ws.status || 'standby';
    var zone = document.createElement('div');
    zone.className = 'workspace-zone ws-' + status;
    zone.id = 'dept-ws-' + name;
    zone.innerHTML =
      '<div class="ws-label">' + name + ' <span class="ws-eye">&#128064;</span></div>' +
      '<div class="ws-sublabel">' + (ws.description || '') + '</div>' +
      '<div class="desk-station" id="desk-' + name + '" style="position:absolute; left:60px; top:45px;">' +
        '<div class="desk-assignment-label" style="left:10px; top:0; color: var(--cyan);">' + name + '</div>' +
        '<div class="desk" style="left:0; top:85px;"><div class="desk-surface"></div></div>' +
        '<div class="monitor" style="left:8px; top:68px;">' +
          '<div class="monitor-frame"><div class="monitor-screen" id="screen-' + name + '">' +
            '<div class="screen-line" style="background:#00d4ff;"></div>' +
            '<div class="screen-line" style="background:#ffffff; width:60%; animation-delay:0.5s;"></div>' +
            '<div class="screen-line" style="background:#00d4ff; animation-delay:1s;"></div>' +
          '</div></div><div class="monitor-stand"></div>' +
        '</div>' +
        '<div class="mug" style="left:96px; top:92px;"><div class="mug-steam"></div></div>' +
        '<div class="agent-slot" id="slot-' + name + '" style="left:28px; top:16px;"></div>' +
        '<div class="hp-bar-wrap" id="hp-wrap-' + name + '" style="left:16px; top:58px; display:none;"><div class="hp-bar" id="hp-desk-' + name + '"></div></div>' +
      '</div>';
    container.appendChild(zone);

    // Add dynamic SVG line from PM to zone
    if (svg) {
      var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.classList.add('conn-line', 'dynamic');
      path.id = 'line-' + name;
      // Approximate paths based on zone index
      var endX = 100 + (idx % 2) * 350;
      var endY = 100 + Math.floor(idx / 2) * 240;
      path.setAttribute('d', 'M520,580 C' + (300 + idx * 50) + ',400 ' + (endX + 50) + ',' + (endY + 50) + ' ' + endX + ',' + endY);
      svg.appendChild(path);
    }
  });

  // Update DEPARTMENTS for diver collision
  DEPARTMENTS = [];
  var zones = container.querySelectorAll('.workspace-zone');
  zones.forEach(function(z) {
    var rect = z.getBoundingClientRect();
    var containerRect = container.getBoundingClientRect();
    var domeEl = document.getElementById('dome');
    var domeRect = domeEl ? domeEl.getBoundingClientRect() : containerRect;
    var scale = domeRect.width / 1040;
    DEPARTMENTS.push({
      id: z.id,
      left: (rect.left - domeRect.left) / scale,
      top: (rect.top - domeRect.top) / scale,
      width: rect.width / scale,
      height: rect.height / scale
    });
  });
}

// ===== SKILLS PANEL RENDERING =====
var lastSkillsData = null;
function renderSkillsPanel(skills) {
  if (JSON.stringify(skills) === JSON.stringify(lastSkillsData)) return;
  lastSkillsData = JSON.parse(JSON.stringify(skills));

  var panel = document.getElementById('skills-panel');
  if (!panel) return;

  var names = Object.keys(skills);
  if (names.length === 0) {
    panel.innerHTML = '<div class="skills-panel-title">SKILLS</div><div class="skill-item" style="color:#446677;">No skills</div>';
    return;
  }

  var html = '<div class="skills-panel-title">SKILLS</div>';
  names.forEach(function(name) {
    var sk = skills[name];
    var status = sk.status || 'idle';
    var triggerLabel = '';
    if (sk.trigger === 'schedule' && sk.schedule) triggerLabel = sk.schedule;
    else if (sk.trigger === 'manual') triggerLabel = 'manual';

    var resultIcon = '';
    if (sk.last_result === 'success') resultIcon = ' \u2713';
    else if (sk.last_result === 'error') resultIcon = ' \u2717';

    html += '<div class="skill-item">' +
      '<span class="skill-dot ' + status + '"></span>' +
      '<span>' + (sk.name || name) + resultIcon + '</span>' +
      (sk.run_count ? '<span style="color:#446677;"> x' + sk.run_count + '</span>' : '') +
      '<span class="skill-trigger">' + triggerLabel + '</span>' +
      '</div>';
  });
  panel.innerHTML = html;
}

// ===== PM STATUS ANIMATION =====
(function() {
  var pmChar = document.querySelector('#pm-area .squid-pixel-lg');
  if (!pmChar) return;
  var pmWrap = pmChar.parentElement;
  var speechEl = document.getElementById('pm-speech');
  var prevPmStatus = 'idle';

  // Override loadDashboardData to add PM animation + pool reaction
  var _origLoad2 = loadDashboardData;
  loadDashboardData = function(data) {
    _origLoad2(data);
    if (!data || !data.pm) return;
    var st = data.pm.status || 'idle';
    if (st !== prevPmStatus) {
      // Clear previous state classes
      if (speechEl) {
        speechEl.classList.remove('pm-chatting', 'pm-thinking');
      }

      if (st === 'working') {
        pmWrap.style.animation = 'bob-work 1.5s ease-in-out infinite';
        // Pool agents react
        AGENTS.forEach(function(a) {
          var el = document.getElementById('pool-' + a);
          if (el && !el.classList.contains('walking') && !el.classList.contains('at-desk')) {
            el.style.transition = 'transform 0.3s';
            el.style.transform = 'translateY(-3px)';
            setTimeout(function() { el.style.transform = ''; }, 600);
          }
        });
      } else if (st === 'chatting') {
        pmWrap.style.animation = 'bob-work 1.5s ease-in-out infinite';
        if (speechEl) {
          speechEl.classList.add('pm-chatting');
          speechEl.textContent = data.pm.speech || 'üí¨ typing...';
          speechEl.classList.add('visible');
        }
      } else if (st === 'thinking') {
        pmWrap.style.animation = 'bob-work 1.5s ease-in-out infinite';
        if (speechEl) {
          speechEl.classList.add('pm-thinking');
          speechEl.textContent = 'üí≠ thinking...';
          speechEl.classList.add('visible');
        }
      } else {
        pmWrap.style.animation = 'bob 2.5s ease-in-out infinite';
      }
      prevPmStatus = st;
    }
    // Update speech text for chatting even if status hasn't changed
    if (st === 'chatting' && speechEl && data.pm.speech) {
      speechEl.textContent = data.pm.speech;
      speechEl.classList.add('visible');
    }
  };
})();
</script>
</body>
</html>
