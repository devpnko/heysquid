<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>heysquid HQ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --pink: #ff6b9d; --pink-dark: #cc4477; --pink-light: #ffaac4;
  --cyan: #00d4ff; --cyan-dark: #009abb; --cyan-light: #77eeff;
  --orange: #ff9f43; --orange-dark: #cc7a22; --orange-light: #ffcf99;
  --green: #26de81; --green-dark: #1aaa60; --green-light: #77ffbb;
  --yellow: #ffd32a; --yellow-dark: #ccaa00; --yellow-light: #ffee88;
  --purple: #cc66ff; --purple-dark: #9944cc; --purple-light: #dd99ff;
  --red: #ff4444; --red-dark: #cc2222; --red-light: #ff8888;
  --lavender: #bb88ff; --lavender-dark: #8855cc; --lavender-light: #ddbbff;
  --blue: #4488ff; --blue-dark: #2266cc; --blue-light: #88bbff;
  --coral: #ff7744; --coral-dark: #cc5522; --coral-light: #ffaa88;
}

body {
  background: #0a0e1a;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  font-family: 'Press Start 2P', monospace;
  overflow: hidden;
  image-rendering: pixelated;
}

.viewport {
  width: 1200px;
  height: 900px;
  position: relative;
  background: #0b1628;
  border: 4px solid #1a3a5c;
  overflow: hidden;
}

/* === OCEAN BACKGROUND === */
.ocean-bg {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 50%, #0a2a4a 0%, #051530 50%, #020a1a 100%);
  z-index: 0;
}

/* === GLASS DOME === */
.glass-dome {
  position: absolute;
  left: 80px; top: 60px;
  width: 1040px; height: 740px;
  border-radius: 50px;
  background: radial-gradient(ellipse at 50% 40%, rgba(20,50,80,0.6) 0%, rgba(10,30,55,0.8) 100%);
  border: 4px solid rgba(100,180,255,0.15);
  box-shadow:
    inset 0 0 60px rgba(80,160,255,0.08),
    0 0 40px rgba(60,140,220,0.15),
    inset 4px 4px 0 rgba(120,200,255,0.1);
  z-index: 1;
  overflow: hidden;
}
.glass-dome::before {
  content: '';
  position: absolute;
  top: 10px; left: 60px;
  width: 200px; height: 8px;
  background: rgba(120,200,255,0.05);
  border-radius: 4px;
  transform: rotate(-5deg);
}
.glass-dome::after {
  content: '';
  position: absolute;
  top: 30px; left: 100px;
  width: 120px; height: 6px;
  background: rgba(120,200,255,0.04);
  border-radius: 4px;
  transform: rotate(-5deg);
}

/* === FLOOR TILES === */
.floor {
  position: absolute;
  inset: 0;
  z-index: 2;
  pointer-events: none;   /* Decorative element — pass through mouse events */
  background-image:
    linear-gradient(rgba(60,100,140,0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(60,100,140,0.1) 1px, transparent 1px);
  background-size: 40px 40px;
  background-position: 20px 20px;
}

/* === TITLE BAR === */
.title-bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 65px;
  background: linear-gradient(180deg, rgba(0,10,30,0.95) 0%, rgba(0,10,30,0.7) 80%, transparent 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding-top: 6px;
}
.title-bar h1 {
  font-size: 18px;
  background: linear-gradient(90deg, var(--pink), var(--cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: none;
  letter-spacing: 4px;
  margin-bottom: 4px;
}
.title-bar .subtitle {
  font-size: 9px;
  color: #5599aa;
  letter-spacing: 4px;
}

/* === BUBBLES === */
.bubble {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(150,220,255,0.3), rgba(100,180,255,0.05));
  border: 1px solid rgba(120,200,255,0.2);
  z-index: 0;
  animation: float-up linear infinite;
}
@keyframes float-up {
  0% { transform: translateY(0) translateX(0); opacity: 0.3; }
  50% { transform: translateY(-200px) translateX(15px); opacity: 0.15; }
  100% { transform: translateY(-450px) translateX(-10px); opacity: 0; }
}

/* === FISH SILHOUETTES === */
.fish-sil {
  position: absolute;
  z-index: 0;
  opacity: 0.12;
}

/* === DEPARTMENT ZONES === */
.dept-zone {
  position: absolute;
  z-index: 5;
  border-radius: 12px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.dept-zone.highlighted {
  border-color: var(--pink) !important;
  box-shadow: inset 0 0 30px rgba(255,107,157,0.1), 0 0 15px rgba(255,107,157,0.15) !important;
}
.dept-label {
  position: absolute;
  top: 8px; left: 12px;
  font-size: 11px;
  z-index: 6;
}
.dept-sublabel {
  position: absolute;
  top: 24px; left: 12px;
  font-size: 9px;
  z-index: 6;
}
.dept-eye {
  display: none;
  font-size: 10px;
  margin-left: 6px;
}
.dept-zone.highlighted .dept-eye { display: inline; }

/* === DESK STATION === */
.desk-station {
  position: absolute;
  z-index: 10;
}
.desk-assignment-label {
  font-size: 8px;
  position: absolute;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  z-index: 11;
}
.context-icon {
  position: absolute; z-index: 17;
  width: 8px; height: 10px;
  background: rgba(200,220,240,0.3);
  border: 1px solid rgba(150,200,230,0.4);
  border-radius: 1px;
}
.context-icon::after {
  content: '';
  position: absolute;
  top: -3px; left: 1px;
  width: 6px; height: 3px;
  background: rgba(150,200,230,0.3);
  border-radius: 1px;
}
.agent-slot {
  position: absolute;
  z-index: 20;
}
.desk-station.occupied .agent-slot { display: block; }
.desk-station:not(.occupied) .agent-slot { display: none; }

/* === AGENT POOL === */
.agent-pool {
  position: absolute;
  z-index: 20;
  display: flex;
  gap: 30px;
  justify-content: center;
}
.pool-agent {
  position: relative;
  text-align: center;
  transition: opacity 0.5s;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.pool-agent.dispatched { opacity: 0; pointer-events: none; }
.pool-agent-label {
  font-size: 9px;
  color: #6699aa;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  margin-top: 2px;
}

/* === DESK === */
.desk { position: absolute; z-index: 15; }
.desk-surface {
  width: 120px;
  height: 60px;
  background: linear-gradient(180deg, #3d2b1a 0%, #2a1e12 100%);
  border: 2px solid #4a3520;
  border-radius: 4px;
  image-rendering: pixelated;
  box-shadow: 0 4px 0 #1a1008;
}

/* === MONITOR === */
.monitor { position: absolute; z-index: 16; }
.monitor-frame {
  width: 36px; height: 28px;
  background: #1a1a2e;
  border: 3px solid #333348;
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}
.monitor-screen {
  position: absolute;
  inset: 2px;
  background: #0a1a0a;
  overflow: hidden;
}
.monitor-stand {
  width: 12px; height: 6px;
  background: #333348;
  margin: 0 auto;
  border-radius: 0 0 2px 2px;
}
.screen-line {
  width: 80%;
  height: 2px;
  margin: 3px auto 0;
  border-radius: 1px;
  animation: type-line 3s ease-in-out infinite;
}
@keyframes type-line {
  0%, 100% { width: 80%; }
  50% { width: 40%; }
}
@keyframes type-line-fast {
  0%, 100% { width: 90%; }
  50% { width: 30%; }
}

/* === COFFEE MUG === */
.mug {
  width: 10px; height: 12px;
  background: #e8e0d0;
  border: 2px solid #c0b8a0;
  border-radius: 0 0 2px 2px;
  position: absolute;
  z-index: 17;
}
.mug::after {
  content: '';
  position: absolute;
  right: -6px; top: 2px;
  width: 5px; height: 6px;
  border: 2px solid #c0b8a0;
  border-left: none;
  border-radius: 0 4px 4px 0;
}
.mug-steam {
  position: absolute;
  top: -10px; left: 2px;
  width: 2px; height: 8px;
  background: rgba(200,220,240,0.3);
  animation: steam 2s ease-in-out infinite;
  border-radius: 2px;
}
@keyframes steam {
  0%, 100% { height: 8px; opacity: 0.3; transform: translateX(0); }
  50% { height: 12px; opacity: 0.1; transform: translateX(3px); }
}

/* === BOOKS === */
.book { position: absolute; border-radius: 1px; z-index: 17; }

/* === PLANTS === */
.plant { position: absolute; z-index: 18; }

/* === WATER COOLER === */
.water-cooler { position: absolute; z-index: 18; }

/* === HP BAR === */
.hp-bar-wrap {
  position: absolute;
  width: 40px; height: 3px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  overflow: hidden;
  z-index: 22;
}
.hp-bar {
  height: 100%;
  width: 100%;
  border-radius: 2px;
  transition: width 0.5s ease, background 0.3s;
  background: #26de81;
}

/* === ANIMATIONS === */
@keyframes bob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
@keyframes bob-slow {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}
@keyframes bob-work {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
@keyframes crown-shine {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.4) drop-shadow(0 0 4px rgba(255,204,0,0.5)); }
}
@keyframes typing {
  0%, 100% { transform: translateY(0); }
  25% { transform: translateY(-2px); }
  75% { transform: translateY(-2px); }
}
@keyframes inflate {
  0%, 80%, 100% { transform: scale(1); }
  90% { transform: scale(1.1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-2px) translateY(1px); }
  40% { transform: translateX(2px) translateY(-1px); }
  60% { transform: translateX(-1px) translateY(1px); }
  80% { transform: translateX(1px) translateY(-1px); }
}
@keyframes coffee-lift {
  0%, 70%, 100% { transform: translateY(0); }
  75% { transform: translateY(-5px); }
  85% { transform: translateY(-3px); }
}
@keyframes blink-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* === PIXEL CHARACTER BASE === */
.pixel-char {
  width: 1px;
  height: 1px;
  image-rendering: pixelated;
}

/* === SQUID PM (scale 4, 64x64) === */
.squid-pixel-lg {
  transform: scale(4);
  transform-origin: top left;
  margin-right: 63px;
  margin-bottom: 63px;
  color: var(--pink);
  box-shadow:
    6px 0 0 #ffdd44, 9px 0 0 #ffdd44,
    5px 1px 0 #ffdd44, 6px 1px 0 #ffee66, 7px 1px 0 #ffdd44, 8px 1px 0 #ffdd44, 9px 1px 0 #ffee66, 10px 1px 0 #ffdd44,
    6px 2px 0 #ffcc22, 7px 2px 0 #ffcc22, 8px 2px 0 #ffcc22, 9px 2px 0 #ffcc22,
    5px 3px 0 #ff6b9d, 6px 3px 0 #ff6b9d, 7px 3px 0 #ffaac4, 8px 3px 0 #ffaac4, 9px 3px 0 #ff6b9d, 10px 3px 0 #ff6b9d,
    4px 4px 0 #ff6b9d, 5px 4px 0 #ffaac4, 6px 4px 0 #ffaac4, 7px 4px 0 #ffaac4, 8px 4px 0 #ffaac4, 9px 4px 0 #ffaac4, 10px 4px 0 #ffaac4, 11px 4px 0 #ff6b9d,
    4px 5px 0 #ff6b9d, 5px 5px 0 #ffaac4, 6px 5px 0 #ffffff, 7px 5px 0 #ffffff, 8px 5px 0 #ffaac4, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ff6b9d,
    4px 6px 0 #ff6b9d, 5px 6px 0 #ffaac4, 6px 6px 0 #ffffff, 7px 6px 0 #2244aa, 8px 6px 0 #ffaac4, 9px 6px 0 #ffffff, 10px 6px 0 #2244aa, 11px 6px 0 #ff6b9d,
    4px 7px 0 #ff6b9d, 5px 7px 0 #ffaac4, 6px 7px 0 #ffffff, 7px 7px 0 #4466cc, 8px 7px 0 #ffaac4, 9px 7px 0 #ffffff, 10px 7px 0 #4466cc, 11px 7px 0 #ff6b9d,
    4px 8px 0 #ff6b9d, 5px 8px 0 #ff5588, 6px 8px 0 #ffaac4, 7px 8px 0 #ffaac4, 8px 8px 0 #ff6b9d, 9px 8px 0 #ffaac4, 10px 8px 0 #ff5588, 11px 8px 0 #ff6b9d,
    4px 9px 0 #ff6b9d, 5px 9px 0 #ff6b9d, 6px 9px 0 #ffaac4, 7px 9px 0 #cc4477, 8px 9px 0 #cc4477, 9px 9px 0 #ffaac4, 10px 9px 0 #ff6b9d, 11px 9px 0 #ff6b9d,
    5px 10px 0 #ff6b9d, 6px 10px 0 #ff6b9d, 7px 10px 0 #ffaac4, 8px 10px 0 #ffaac4, 9px 10px 0 #ff6b9d, 10px 10px 0 #ff6b9d,
    4px 11px 0 #ff6b9d, 5px 11px 0 #cc4477, 6px 11px 0 #ff6b9d, 7px 11px 0 #cc4477, 8px 11px 0 #cc4477, 9px 11px 0 #ff6b9d, 10px 11px 0 #cc4477, 11px 11px 0 #ff6b9d,
    3px 12px 0 #ff6b9d, 4px 12px 0 #cc4477, 6px 12px 0 #ff6b9d, 7px 12px 0 #cc4477, 8px 12px 0 #cc4477, 9px 12px 0 #ff6b9d, 11px 12px 0 #cc4477, 12px 12px 0 #ff6b9d,
    3px 13px 0 #cc4477, 5px 13px 0 #ff6b9d, 6px 13px 0 #cc4477, 9px 13px 0 #cc4477, 10px 13px 0 #ff6b9d, 12px 13px 0 #cc4477,
    2px 14px 0 #cc4477, 5px 14px 0 #cc4477, 10px 14px 0 #cc4477, 13px 14px 0 #cc4477,
    2px 15px 0 #993366, 5px 15px 0 #993366, 10px 15px 0 #993366, 13px 15px 0 #993366;
}

/* === OCTOPUS Researcher (scale 2.5 for pool, scale 3 for desk) === */
.octopus-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--cyan);
  box-shadow:
    6px 0 0 #00d4ff, 7px 0 0 #00d4ff, 8px 0 0 #00d4ff, 9px 0 0 #00d4ff,
    5px 1px 0 #00d4ff, 6px 1px 0 #77eeff, 7px 1px 0 #77eeff, 8px 1px 0 #77eeff, 9px 1px 0 #77eeff, 10px 1px 0 #00d4ff,
    4px 2px 0 #00d4ff, 5px 2px 0 #77eeff, 6px 2px 0 #77eeff, 7px 2px 0 #aaf4ff, 8px 2px 0 #aaf4ff, 9px 2px 0 #77eeff, 10px 2px 0 #77eeff, 11px 2px 0 #00d4ff,
    3px 3px 0 #00d4ff, 4px 3px 0 #77eeff, 5px 3px 0 #77eeff, 6px 3px 0 #aaf4ff, 7px 3px 0 #aaf4ff, 8px 3px 0 #aaf4ff, 9px 3px 0 #aaf4ff, 10px 3px 0 #77eeff, 11px 3px 0 #77eeff, 12px 3px 0 #00d4ff,
    3px 4px 0 #00d4ff, 4px 4px 0 #77eeff, 5px 4px 0 #aaf4ff, 6px 4px 0 #aaf4ff, 7px 4px 0 #aaf4ff, 8px 4px 0 #aaf4ff, 9px 4px 0 #aaf4ff, 10px 4px 0 #aaf4ff, 11px 4px 0 #77eeff, 12px 4px 0 #00d4ff,
    3px 5px 0 #00d4ff, 4px 5px 0 #77eeff, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #aaf4ff, 8px 5px 0 #aaf4ff, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #77eeff, 12px 5px 0 #00d4ff,
    3px 6px 0 #00d4ff, 4px 6px 0 #77eeff, 5px 6px 0 #ffffff, 6px 6px 0 #113355, 7px 6px 0 #77eeff, 8px 6px 0 #77eeff, 9px 6px 0 #ffffff, 10px 6px 0 #113355, 11px 6px 0 #77eeff, 12px 6px 0 #00d4ff,
    3px 7px 0 #00d4ff, 4px 7px 0 #77eeff, 5px 7px 0 #ffffff, 6px 7px 0 #335577, 7px 7px 0 #77eeff, 8px 7px 0 #77eeff, 9px 7px 0 #ffffff, 10px 7px 0 #335577, 11px 7px 0 #77eeff, 12px 7px 0 #00d4ff,
    4px 8px 0 #009abb, 5px 8px 0 #77eeff, 6px 8px 0 #77eeff, 7px 8px 0 #009abb, 8px 8px 0 #009abb, 9px 8px 0 #77eeff, 10px 8px 0 #77eeff, 11px 8px 0 #009abb,
    4px 9px 0 #00d4ff, 5px 9px 0 #00d4ff, 6px 9px 0 #77eeff, 7px 9px 0 #77eeff, 8px 9px 0 #77eeff, 9px 9px 0 #77eeff, 10px 9px 0 #00d4ff, 11px 9px 0 #00d4ff,
    3px 10px 0 #00d4ff, 4px 10px 0 #009abb, 5px 10px 0 #00d4ff, 6px 10px 0 #009abb, 7px 10px 0 #00d4ff, 8px 10px 0 #00d4ff, 9px 10px 0 #009abb, 10px 10px 0 #00d4ff, 11px 10px 0 #009abb, 12px 10px 0 #00d4ff,
    2px 11px 0 #00d4ff, 3px 11px 0 #009abb, 5px 11px 0 #009abb, 6px 11px 0 #00d4ff, 9px 11px 0 #00d4ff, 10px 11px 0 #009abb, 12px 11px 0 #009abb, 13px 11px 0 #00d4ff,
    2px 12px 0 #009abb, 3px 12px 0 #00d4ff, 5px 12px 0 #00d4ff, 6px 12px 0 #009abb, 9px 12px 0 #009abb, 10px 12px 0 #00d4ff, 12px 12px 0 #00d4ff, 13px 12px 0 #009abb,
    1px 13px 0 #009abb, 4px 13px 0 #009abb, 7px 13px 0 #009abb, 8px 13px 0 #009abb, 11px 13px 0 #009abb, 14px 13px 0 #009abb;
}

/* === SHARK Developer (scale 2.5 for pool) === */
.shark-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--orange);
  box-shadow:
    7px 0 0 #ff9f43, 8px 0 0 #ff9f43,
    7px 1px 0 #ffcf99, 8px 1px 0 #ff9f43, 9px 1px 0 #ff9f43,
    5px 2px 0 #ff9f43, 6px 2px 0 #ff9f43, 7px 2px 0 #ffcf99, 8px 2px 0 #ffcf99, 9px 2px 0 #ff9f43, 10px 2px 0 #ff9f43,
    4px 3px 0 #ff9f43, 5px 3px 0 #ffcf99, 6px 3px 0 #ffcf99, 7px 3px 0 #ffcf99, 8px 3px 0 #ffcf99, 9px 3px 0 #ffcf99, 10px 3px 0 #ffcf99, 11px 3px 0 #ff9f43,
    3px 4px 0 #ff9f43, 4px 4px 0 #ffcf99, 5px 4px 0 #ffcf99, 6px 4px 0 #ffcf99, 7px 4px 0 #ffcf99, 8px 4px 0 #ffcf99, 9px 4px 0 #ffcf99, 10px 4px 0 #ffcf99, 11px 4px 0 #ffcf99, 12px 4px 0 #ff9f43,
    3px 5px 0 #ff9f43, 4px 5px 0 #ffcf99, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #ffcf99, 8px 5px 0 #ffcf99, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ffcf99, 12px 5px 0 #ff9f43,
    3px 6px 0 #ff9f43, 4px 6px 0 #ffcf99, 5px 6px 0 #ffffff, 6px 6px 0 #331100, 7px 6px 0 #ffcf99, 8px 6px 0 #ffcf99, 9px 6px 0 #ffffff, 10px 6px 0 #331100, 11px 6px 0 #ffcf99, 12px 6px 0 #ff9f43,
    3px 7px 0 #ff9f43, 4px 7px 0 #ffcf99, 5px 7px 0 #ffffff, 6px 7px 0 #664422, 7px 7px 0 #ffcf99, 8px 7px 0 #ffcf99, 9px 7px 0 #ffffff, 10px 7px 0 #664422, 11px 7px 0 #ffcf99, 12px 7px 0 #ff9f43,
    3px 8px 0 #ff9f43, 4px 8px 0 #ff7733, 5px 8px 0 #ffcf99, 6px 8px 0 #ffcf99, 7px 8px 0 #ffcf99, 8px 8px 0 #ffcf99, 9px 8px 0 #ffcf99, 10px 8px 0 #ffcf99, 11px 8px 0 #ff7733, 12px 8px 0 #ff9f43,
    4px 9px 0 #ff9f43, 5px 9px 0 #ffcf99, 6px 9px 0 #cc7a22, 7px 9px 0 #ffffff, 8px 9px 0 #ffffff, 9px 9px 0 #cc7a22, 10px 9px 0 #ffcf99, 11px 9px 0 #ff9f43,
    4px 10px 0 #ff9f43, 5px 10px 0 #ff9f43, 6px 10px 0 #ffcf99, 7px 10px 0 #ffeedd, 8px 10px 0 #ffeedd, 9px 10px 0 #ffcf99, 10px 10px 0 #ff9f43, 11px 10px 0 #ff9f43,
    2px 11px 0 #ff9f43, 3px 11px 0 #cc7a22, 4px 11px 0 #ff9f43, 5px 11px 0 #ffcf99, 6px 11px 0 #ffeedd, 7px 11px 0 #ffeedd, 8px 11px 0 #ffeedd, 9px 11px 0 #ffeedd, 10px 11px 0 #ffcf99, 11px 11px 0 #ff9f43, 12px 11px 0 #cc7a22, 13px 11px 0 #ff9f43,
    1px 12px 0 #cc7a22, 2px 12px 0 #ff9f43, 5px 12px 0 #ff9f43, 6px 12px 0 #ffcf99, 7px 12px 0 #ffcf99, 8px 12px 0 #ffcf99, 9px 12px 0 #ffcf99, 10px 12px 0 #ff9f43, 13px 12px 0 #ff9f43, 14px 12px 0 #cc7a22,
    5px 13px 0 #ff9f43, 6px 13px 0 #ff9f43, 7px 13px 0 #cc7a22, 8px 13px 0 #cc7a22, 9px 13px 0 #ff9f43, 10px 13px 0 #ff9f43,
    6px 14px 0 #cc7a22, 7px 14px 0 #ff9f43, 8px 14px 0 #ff9f43, 9px 14px 0 #cc7a22;
}

/* === TURTLE Reviewer (scale 2.5 for pool) === */
.turtle-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--green);
  box-shadow:
    4px 0 0 #aabbcc, 5px 0 0 #aabbcc, 6px 0 0 #aabbcc, 7px 0 0 #aabbcc, 8px 0 0 #aabbcc, 9px 0 0 #aabbcc, 10px 0 0 #aabbcc, 11px 0 0 #aabbcc,
    5px 1px 0 #26de81, 6px 1px 0 #77ffbb, 7px 1px 0 #77ffbb, 8px 1px 0 #77ffbb, 9px 1px 0 #77ffbb, 10px 1px 0 #26de81,
    4px 2px 0 #26de81, 5px 2px 0 #77ffbb, 6px 2px 0 #ffffff, 7px 2px 0 #ffffff, 8px 2px 0 #77ffbb, 9px 2px 0 #ffffff, 10px 2px 0 #ffffff, 11px 2px 0 #26de81,
    4px 3px 0 #26de81, 5px 3px 0 #77ffbb, 6px 3px 0 #ffffff, 7px 3px 0 #224400, 8px 3px 0 #77ffbb, 9px 3px 0 #ffffff, 10px 3px 0 #224400, 11px 3px 0 #26de81,
    4px 4px 0 #aabbcc, 5px 4px 0 #aabbcc, 6px 4px 0 #aabbcc, 7px 4px 0 #aabbcc, 8px 4px 0 #aabbcc, 9px 4px 0 #aabbcc, 10px 4px 0 #aabbcc, 11px 4px 0 #aabbcc,
    5px 5px 0 #26de81, 6px 5px 0 #77ffbb, 7px 5px 0 #1aaa60, 8px 5px 0 #1aaa60, 9px 5px 0 #77ffbb, 10px 5px 0 #26de81,
    6px 6px 0 #26de81, 7px 6px 0 #77ffbb, 8px 6px 0 #77ffbb, 9px 6px 0 #26de81,
    4px 7px 0 #8B6914, 5px 7px 0 #8B6914, 6px 7px 0 #A0822B, 7px 7px 0 #A0822B, 8px 7px 0 #A0822B, 9px 7px 0 #A0822B, 10px 7px 0 #8B6914, 11px 7px 0 #8B6914,
    3px 8px 0 #8B6914, 4px 8px 0 #A0822B, 5px 8px 0 #26de81, 6px 8px 0 #A0822B, 7px 8px 0 #26de81, 8px 8px 0 #A0822B, 9px 8px 0 #26de81, 10px 8px 0 #A0822B, 11px 8px 0 #26de81, 12px 8px 0 #8B6914,
    3px 9px 0 #8B6914, 4px 9px 0 #26de81, 5px 9px 0 #A0822B, 6px 9px 0 #26de81, 7px 9px 0 #1aaa60, 8px 9px 0 #26de81, 9px 9px 0 #1aaa60, 10px 9px 0 #26de81, 11px 9px 0 #A0822B, 12px 9px 0 #8B6914,
    3px 10px 0 #8B6914, 4px 10px 0 #A0822B, 5px 10px 0 #26de81, 6px 10px 0 #A0822B, 7px 10px 0 #26de81, 8px 10px 0 #A0822B, 9px 10px 0 #26de81, 10px 10px 0 #A0822B, 11px 10px 0 #26de81, 12px 10px 0 #8B6914,
    4px 11px 0 #8B6914, 5px 11px 0 #8B6914, 6px 11px 0 #A0822B, 7px 11px 0 #A0822B, 8px 11px 0 #A0822B, 9px 11px 0 #A0822B, 10px 11px 0 #8B6914, 11px 11px 0 #8B6914,
    2px 12px 0 #26de81, 3px 12px 0 #26de81, 5px 12px 0 #26de81, 10px 12px 0 #26de81, 12px 12px 0 #26de81, 13px 12px 0 #26de81,
    1px 13px 0 #1aaa60, 2px 13px 0 #26de81, 5px 13px 0 #1aaa60, 10px 13px 0 #1aaa60, 13px 13px 0 #26de81, 14px 13px 0 #1aaa60;
}

/* === PUFFERFISH Tester (scale 2.5 for pool) === */
.puffer-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--yellow);
  box-shadow:
    6px 0 0 #ffd32a, 7px 0 0 #ccaa00, 8px 0 0 #ccaa00, 9px 0 0 #ffd32a,
    5px 1px 0 #ffd32a, 6px 1px 0 #ffee88, 7px 1px 0 #ffee88, 8px 1px 0 #ffee88, 9px 1px 0 #ffee88, 10px 1px 0 #ffd32a,
    4px 2px 0 #ccaa00, 5px 2px 0 #ffee88, 6px 2px 0 #ffee88, 7px 2px 0 #ffee88, 8px 2px 0 #ffee88, 9px 2px 0 #ffee88, 10px 2px 0 #ffee88, 11px 2px 0 #ccaa00,
    3px 3px 0 #ffd32a, 4px 3px 0 #ffee88, 5px 3px 0 #ffee88, 6px 3px 0 #ffee88, 7px 3px 0 #ffee88, 8px 3px 0 #ffee88, 9px 3px 0 #ffee88, 10px 3px 0 #ffee88, 11px 3px 0 #ffee88, 12px 3px 0 #ffd32a,
    2px 4px 0 #ccaa00, 3px 4px 0 #ffd32a, 4px 4px 0 #ffee88, 5px 4px 0 #ffee88, 6px 4px 0 #ffee88, 7px 4px 0 #ffee88, 8px 4px 0 #ffee88, 9px 4px 0 #ffee88, 10px 4px 0 #ffee88, 11px 4px 0 #ffee88, 12px 4px 0 #ffd32a, 13px 4px 0 #ccaa00,
    2px 5px 0 #ffd32a, 3px 5px 0 #ffee88, 4px 5px 0 #ffee88, 5px 5px 0 #ffffff, 6px 5px 0 #ffffff, 7px 5px 0 #ffee88, 8px 5px 0 #ffee88, 9px 5px 0 #ffffff, 10px 5px 0 #ffffff, 11px 5px 0 #ffee88, 12px 5px 0 #ffee88, 13px 5px 0 #ffd32a,
    2px 6px 0 #ccaa00, 3px 6px 0 #ffee88, 4px 6px 0 #ffee88, 5px 6px 0 #ffffff, 6px 6px 0 #332200, 7px 6px 0 #ffee88, 8px 6px 0 #ffee88, 9px 6px 0 #ffffff, 10px 6px 0 #332200, 11px 6px 0 #ffee88, 12px 6px 0 #ffee88, 13px 6px 0 #ccaa00,
    2px 7px 0 #ffd32a, 3px 7px 0 #ffee88, 4px 7px 0 #ffee88, 5px 7px 0 #ffffff, 6px 7px 0 #665500, 7px 7px 0 #ffee88, 8px 7px 0 #ffee88, 9px 7px 0 #ffffff, 10px 7px 0 #665500, 11px 7px 0 #ffee88, 12px 7px 0 #ffee88, 13px 7px 0 #ffd32a,
    2px 8px 0 #ccaa00, 3px 8px 0 #ffd32a, 4px 8px 0 #ffaa44, 5px 8px 0 #ffee88, 6px 8px 0 #ffee88, 7px 8px 0 #cc6633, 8px 8px 0 #cc6633, 9px 8px 0 #ffee88, 10px 8px 0 #ffee88, 11px 8px 0 #ffaa44, 12px 8px 0 #ffd32a, 13px 8px 0 #ccaa00,
    3px 9px 0 #ffd32a, 4px 9px 0 #ffee88, 5px 9px 0 #ffee88, 6px 9px 0 #ffee88, 7px 9px 0 #ffccaa, 8px 9px 0 #ffccaa, 9px 9px 0 #ffee88, 10px 9px 0 #ffee88, 11px 9px 0 #ffee88, 12px 9px 0 #ffd32a,
    2px 10px 0 #ccaa00, 3px 10px 0 #ffd32a, 4px 10px 0 #ffee88, 5px 10px 0 #ffee88, 6px 10px 0 #ffeedd, 7px 10px 0 #ffeedd, 8px 10px 0 #ffeedd, 9px 10px 0 #ffeedd, 10px 10px 0 #ffee88, 11px 10px 0 #ffee88, 12px 10px 0 #ffd32a, 13px 10px 0 #ccaa00,
    3px 11px 0 #ffd32a, 4px 11px 0 #ffd32a, 5px 11px 0 #ffee88, 6px 11px 0 #ffeedd, 7px 11px 0 #ffeedd, 8px 11px 0 #ffeedd, 9px 11px 0 #ffeedd, 10px 11px 0 #ffee88, 11px 11px 0 #ffd32a, 12px 11px 0 #ffd32a,
    4px 12px 0 #ccaa00, 5px 12px 0 #ffd32a, 6px 12px 0 #ffee88, 7px 12px 0 #ffee88, 8px 12px 0 #ffee88, 9px 12px 0 #ffee88, 10px 12px 0 #ffd32a, 11px 12px 0 #ccaa00,
    5px 13px 0 #ccaa00, 6px 13px 0 #ffd32a, 7px 13px 0 #ffd32a, 8px 13px 0 #ffd32a, 9px 13px 0 #ffd32a, 10px 13px 0 #ccaa00,
    6px 14px 0 #ccaa00, 7px 14px 0 #ffd32a, 8px 14px 0 #ffd32a, 9px 14px 0 #ccaa00;
}

/* === DIVER (scale 3, 48x48) === */
.diver-pixel {
  transform: scale(3);
  transform-origin: top left;
  margin-right: 47px;
  margin-bottom: 47px;
  box-shadow:
    6px 0 0 #8899aa, 7px 0 0 #8899aa, 8px 0 0 #8899aa, 9px 0 0 #8899aa,
    5px 1px 0 #8899aa, 6px 1px 0 #99aabb, 7px 1px 0 #99aabb, 8px 1px 0 #99aabb, 9px 1px 0 #99aabb, 10px 1px 0 #8899aa,
    4px 2px 0 #667788, 5px 2px 0 #8899aa, 6px 2px 0 #4488ff, 7px 2px 0 #4488ff, 8px 2px 0 #4488ff, 9px 2px 0 #8899aa, 10px 2px 0 #8899aa, 11px 2px 0 #667788,
    4px 3px 0 #667788, 5px 3px 0 #8899aa, 6px 3px 0 #4488ff, 7px 3px 0 #66aaff, 8px 3px 0 #4488ff, 9px 3px 0 #8899aa, 10px 3px 0 #8899aa, 11px 3px 0 #667788,
    5px 4px 0 #667788, 6px 4px 0 #8899aa, 7px 4px 0 #8899aa, 8px 4px 0 #8899aa, 9px 4px 0 #8899aa, 10px 4px 0 #667788,
    5px 5px 0 #ffcc33, 6px 5px 0 #ffcc33, 7px 5px 0 #ffdd55, 8px 5px 0 #ffdd55, 9px 5px 0 #ffcc33, 10px 5px 0 #ffcc33,
    4px 6px 0 #ffcc33, 5px 6px 0 #ffdd55, 6px 6px 0 #ffdd55, 7px 6px 0 #ffee77, 8px 6px 0 #ffee77, 9px 6px 0 #ffdd55, 10px 6px 0 #ffdd55, 11px 6px 0 #ffcc33,
    3px 7px 0 #ffcc33, 4px 7px 0 #ddaa22, 5px 7px 0 #ffdd55, 6px 7px 0 #ffdd55, 7px 7px 0 #7788aa, 8px 7px 0 #7788aa, 9px 7px 0 #ffdd55, 10px 7px 0 #ffdd55, 11px 7px 0 #ddaa22, 12px 7px 0 #ffcc33,
    4px 8px 0 #ddaa22, 5px 8px 0 #ffcc33, 6px 8px 0 #ffdd55, 7px 8px 0 #ffdd55, 8px 8px 0 #ffdd55, 9px 8px 0 #ffdd55, 10px 8px 0 #ffcc33, 11px 8px 0 #ddaa22,
    5px 9px 0 #ddaa22, 6px 9px 0 #ffcc33, 7px 9px 0 #ffcc33, 8px 9px 0 #ffcc33, 9px 9px 0 #ffcc33, 10px 9px 0 #ddaa22,
    5px 10px 0 #ddaa22, 6px 10px 0 #ffcc33, 9px 10px 0 #ffcc33, 10px 10px 0 #ddaa22,
    4px 11px 0 #222233, 5px 11px 0 #333344, 10px 11px 0 #333344, 11px 11px 0 #222233,
    3px 12px 0 #222233, 4px 12px 0 #333344, 5px 12px 0 #222233, 10px 12px 0 #222233, 11px 12px 0 #333344, 12px 12px 0 #222233;
}

/* === PM AREA === */
.pm-area {
  position: absolute;
  z-index: 30;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.pm-area .char-wrapper {
  position: relative !important;
  display: inline-block;
}
.pm-label {
  font-size: 10px;
  color: var(--pink-light);
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  margin-top: 2px;
}
.pm-speech-bubble {
  position: absolute;
  top: -40px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10, 25, 50, 0.9);
  border: 2px solid var(--pink);
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 8px;
  color: #ffaac4;
  white-space: nowrap;
  z-index: 30;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.pm-speech-bubble.visible { opacity: 1; }
.pm-speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px; left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid var(--pink);
}

/* === MOVING DIVER === */
#moving-diver {
  position: absolute;
  z-index: 50;
  pointer-events: none;
  filter: drop-shadow(0 0 6px rgba(255,204,51,0.4));
  display: flex;
  flex-direction: column;
  align-items: center;
}
.mini-label {
  font-size: 7px;
  color: var(--yellow-light);
  text-align: center;
  margin-top: 2px;
  opacity: 0.7;
}

/* === DIVER SPEECH BUBBLE === */
.diver-speech-bubble {
  position: absolute;
  top: -38px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10, 25, 50, 0.92);
  border: 2px solid var(--yellow);
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 9px;
  color: #ffdd55;
  white-space: nowrap;
  z-index: 60;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  text-shadow: 0 0 6px rgba(255,221,85,0.4);
}
.diver-speech-bubble.visible { opacity: 1; }
.diver-speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px; left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid var(--yellow);
}

/* === STATUS BAR (bottom) === */
.status-bar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(0deg, rgba(0,10,30,0.95) 0%, rgba(0,10,30,0.8) 80%, transparent 100%);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  z-index: 100;
}
.status-left, .status-right {
  font-size: 8px;
  color: #5599aa;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 140px;
}
.status-right { justify-content: flex-end; }
.status-center {
  font-size: 9px;
  color: var(--cyan-light);
  text-align: center;
  max-width: 400px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.conn-dot-status {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #557788;
  display: inline-block;
  flex-shrink: 0;
}
.conn-dot-status.live {
  background: #26de81;
  box-shadow: 0 0 6px rgba(38,222,129,0.6);
  animation: blink-dot 2s ease-in-out infinite;
}
.conn-dot-status.demo {
  background: #ffd32a;
  box-shadow: 0 0 6px rgba(255,211,42,0.6);
  animation: blink-dot 1.5s ease-in-out infinite;
}

/* === MISSION LOG === */
/* mission-log panel removed — speech bubbles replace it */

/* === DEMO BUTTON === */
.btn-demo {
  position: absolute;
  bottom: 46px; right: 100px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  padding: 5px 12px;
  border: 1px solid rgba(0,212,255,0.4);
  border-radius: 4px;
  cursor: pointer;
  background: rgba(0,212,255,0.1);
  color: var(--cyan);
  z-index: 101;
  display: none;
  transition: all 0.2s;
}
.btn-demo:hover {
  background: rgba(0,212,255,0.25);
  box-shadow: 0 0 10px rgba(0,212,255,0.2);
}
.btn-demo:disabled { opacity: 0.4; cursor: not-allowed; }

/* === KEYBOARD === */
.keyboard-hint {
  position: absolute;
  bottom: 108px; right: 100px;
  font-size: 7px;
  color: #335566;
  z-index: 99;
  letter-spacing: 1px;
}

/* === AGENT STATUS EFFECTS === */
.desk-station.status-working .agent-slot > div {
  animation: bob-work 1.5s ease-in-out infinite !important;
}
.desk-station.status-working .monitor-screen {
  filter: brightness(1.4);
}
.desk-station.status-working .screen-line {
  animation-name: type-line-fast !important;
  animation-duration: 1.5s !important;
}
.desk-station.status-complete .monitor-screen {
  background: #0a2a0a !important;
}
.desk-station.status-complete .screen-line {
  background: #00ff66 !important;
  width: 90% !important;
  animation: none !important;
}
.desk-station.status-error .monitor-screen {
  background: #2a0a0a !important;
}
.desk-station.status-error .screen-line {
  background: #ff3333 !important;
  animation: none !important;
}

/* === AGENT NAME (pool) === */
.agent-name-label {
  position: absolute;
  font-size: 8px;
  color: #6699aa;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #0a1a2e;
  z-index: 21;
}
.char-wrapper {
  position: absolute;
  z-index: 20;
}

/* === DESK GLOW ON DIVER PROXIMITY === */
.desk-station.desk-highlight {
  filter: brightness(1.3);
}
.desk-station.desk-highlight .desk-surface {
  box-shadow: 0 4px 0 #1a1008, 0 0 8px rgba(255,204,51,0.3);
}

/* Walk animation for agents moving to desk */
.pool-agent.walking {
  position: fixed !important;
  z-index: 100;
  transition: transform 2.5s ease-in-out, opacity 0.5s;
  opacity: 1 !important;
}
.pool-agent.at-desk {
  position: fixed !important;
  z-index: 100;
  opacity: 1 !important;
}
.pool-agent.walking > div:first-child {
  animation: swim-bounce 0.35s ease-in-out infinite !important;
}
@keyframes swim-bounce {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  25% { transform: translateY(-2px) rotate(2deg); }
  50% { transform: translateY(-4px) rotate(0deg); }
  75% { transform: translateY(-2px) rotate(-2deg); }
}
/* === LOBSTER Writer (scale 2.5 for pool) === */
.lobster-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  color: var(--lavender);
  box-shadow:
    /* antennae */
    3px 0 0 #bb88ff, 12px 0 0 #bb88ff,
    2px 1px 0 #8855cc, 13px 1px 0 #8855cc,
    /* head */
    6px 1px 0 #bb88ff, 7px 1px 0 #ddbbff, 8px 1px 0 #ddbbff, 9px 1px 0 #bb88ff,
    5px 2px 0 #bb88ff, 6px 2px 0 #ddbbff, 7px 2px 0 #ffffff, 8px 2px 0 #330066, 9px 2px 0 #ddbbff, 10px 2px 0 #bb88ff,
    5px 3px 0 #8855cc, 6px 3px 0 #ddbbff, 7px 3px 0 #ddbbff, 8px 3px 0 #ddbbff, 9px 3px 0 #ddbbff, 10px 3px 0 #8855cc,
    /* body segment 1 */
    4px 4px 0 #bb88ff, 5px 4px 0 #ddbbff, 6px 4px 0 #ddbbff, 7px 4px 0 #ddbbff, 8px 4px 0 #ddbbff, 9px 4px 0 #ddbbff, 10px 4px 0 #ddbbff, 11px 4px 0 #bb88ff,
    4px 5px 0 #8855cc, 5px 5px 0 #bb88ff, 6px 5px 0 #ddbbff, 7px 5px 0 #ddbbff, 8px 5px 0 #ddbbff, 9px 5px 0 #ddbbff, 10px 5px 0 #bb88ff, 11px 5px 0 #8855cc,
    /* claws */
    1px 6px 0 #bb88ff, 2px 6px 0 #ddbbff, 3px 6px 0 #8855cc,
    5px 6px 0 #bb88ff, 6px 6px 0 #ddbbff, 7px 6px 0 #ddbbff, 8px 6px 0 #ddbbff, 9px 6px 0 #ddbbff, 10px 6px 0 #bb88ff,
    12px 6px 0 #8855cc, 13px 6px 0 #ddbbff, 14px 6px 0 #bb88ff,
    0px 7px 0 #bb88ff, 1px 7px 0 #ddbbff, 2px 7px 0 #bb88ff,
    5px 7px 0 #8855cc, 6px 7px 0 #bb88ff, 7px 7px 0 #ddbbff, 8px 7px 0 #ddbbff, 9px 7px 0 #bb88ff, 10px 7px 0 #8855cc,
    13px 7px 0 #bb88ff, 14px 7px 0 #ddbbff, 15px 7px 0 #bb88ff,
    1px 8px 0 #8855cc, 2px 8px 0 #bb88ff,
    6px 8px 0 #bb88ff, 7px 8px 0 #ddbbff, 8px 8px 0 #ddbbff, 9px 8px 0 #bb88ff,
    13px 8px 0 #bb88ff, 14px 8px 0 #8855cc,
    /* body segment 2 */
    6px 9px 0 #8855cc, 7px 9px 0 #bb88ff, 8px 9px 0 #bb88ff, 9px 9px 0 #8855cc,
    5px 10px 0 #8855cc, 6px 10px 0 #bb88ff, 7px 10px 0 #ddbbff, 8px 10px 0 #ddbbff, 9px 10px 0 #bb88ff, 10px 10px 0 #8855cc,
    /* tail fan */
    4px 11px 0 #bb88ff, 5px 11px 0 #ddbbff, 6px 11px 0 #bb88ff, 7px 11px 0 #8855cc, 8px 11px 0 #8855cc, 9px 11px 0 #bb88ff, 10px 11px 0 #ddbbff, 11px 11px 0 #bb88ff,
    3px 12px 0 #8855cc, 4px 12px 0 #bb88ff, 5px 12px 0 #8855cc, 10px 12px 0 #8855cc, 11px 12px 0 #bb88ff, 12px 12px 0 #8855cc,
    /* legs (3 pairs) */
    4px 8px 0 #8855cc, 11px 8px 0 #8855cc,
    3px 9px 0 #8855cc, 12px 9px 0 #8855cc,
    4px 10px 0 #8855cc, 11px 10px 0 #8855cc;
}



/* === NEW PIXEL ART — Marine (12) === */

/* 7. Whale (Humpback) — scale 2.5, 15x15 */
.whale-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0 0 #3366aa, 6px 0 0 #4488cc, 7px 0 0 #4488cc, 8px 0 0 #4488cc, 9px 0 0 #3366aa,
    4px 1px 0 #3366aa, 5px 1px 0 #4488cc, 6px 1px 0 #6699dd, 7px 1px 0 #6699dd, 8px 1px 0 #6699dd, 9px 1px 0 #4488cc, 10px 1px 0 #3366aa,
    3px 2px 0 #3366aa, 4px 2px 0 #4488cc, 5px 2px 0 #6699dd, 6px 2px 0 #6699dd, 7px 2px 0 #88bbee, 8px 2px 0 #88bbee, 9px 2px 0 #6699dd, 10px 2px 0 #4488cc, 11px 2px 0 #3366aa,
    2px 3px 0 #3366aa, 3px 3px 0 #4488cc, 4px 3px 0 #6699dd, 5px 3px 0 #88bbee, 6px 3px 0 #88bbee, 7px 3px 0 #88bbee, 8px 3px 0 #88bbee, 9px 3px 0 #88bbee, 10px 3px 0 #6699dd, 11px 3px 0 #4488cc, 12px 3px 0 #3366aa,
    2px 4px 0 #3366aa, 3px 4px 0 #6699dd, 4px 4px 0 #88bbee, 5px 4px 0 #ffffff, 6px 4px 0 #112244, 7px 4px 0 #88bbee, 8px 4px 0 #88bbee, 9px 4px 0 #88bbee, 10px 4px 0 #88bbee, 11px 4px 0 #6699dd, 12px 4px 0 #3366aa,
    1px 5px 0 #3366aa, 2px 5px 0 #4488cc, 3px 5px 0 #6699dd, 4px 5px 0 #88bbee, 5px 5px 0 #88bbee, 6px 5px 0 #88bbee, 7px 5px 0 #88bbee, 8px 5px 0 #88bbee, 9px 5px 0 #88bbee, 10px 5px 0 #88bbee, 11px 5px 0 #4488cc, 12px 5px 0 #3366aa,
    1px 6px 0 #3366aa, 2px 6px 0 #6699dd, 3px 6px 0 #88bbee, 4px 6px 0 #88bbee, 5px 6px 0 #6699dd, 6px 6px 0 #88bbee, 7px 6px 0 #88bbee, 8px 6px 0 #88bbee, 9px 6px 0 #6699dd, 10px 6px 0 #88bbee, 11px 6px 0 #6699dd, 12px 6px 0 #3366aa,
    1px 7px 0 #3366aa, 2px 7px 0 #4488cc, 3px 7px 0 #6699dd, 4px 7px 0 #ccddee, 5px 7px 0 #ccddee, 6px 7px 0 #ccddee, 7px 7px 0 #ccddee, 8px 7px 0 #ccddee, 9px 7px 0 #ccddee, 10px 7px 0 #6699dd, 11px 7px 0 #4488cc, 12px 7px 0 #3366aa,
    2px 8px 0 #3366aa, 3px 8px 0 #4488cc, 4px 8px 0 #ccddee, 5px 8px 0 #eeeeff, 6px 8px 0 #ccddee, 7px 8px 0 #ccddee, 8px 8px 0 #eeeeff, 9px 8px 0 #ccddee, 10px 8px 0 #4488cc, 11px 8px 0 #3366aa,
    2px 9px 0 #3366aa, 3px 9px 0 #4488cc, 4px 9px 0 #6699dd, 5px 9px 0 #ccddee, 6px 9px 0 #ccddee, 7px 9px 0 #ccddee, 8px 9px 0 #ccddee, 9px 9px 0 #6699dd, 10px 9px 0 #4488cc, 11px 9px 0 #3366aa,
    3px 10px 0 #3366aa, 4px 10px 0 #4488cc, 5px 10px 0 #6699dd, 6px 10px 0 #6699dd, 7px 10px 0 #6699dd, 8px 10px 0 #6699dd, 9px 10px 0 #4488cc, 10px 10px 0 #3366aa,
    4px 11px 0 #3366aa, 5px 11px 0 #4488cc, 6px 11px 0 #4488cc, 7px 11px 0 #4488cc, 8px 11px 0 #4488cc, 9px 11px 0 #3366aa,
    3px 12px 0 #3366aa, 4px 12px 0 #4488cc, 5px 12px 0 #3366aa, 8px 12px 0 #3366aa, 9px 12px 0 #4488cc, 10px 12px 0 #3366aa,
    2px 13px 0 #3366aa, 3px 13px 0 #4488cc, 10px 13px 0 #4488cc, 11px 13px 0 #3366aa;
}

/* 8. Spouting Whale — scale 2.5, 15x15 */
.spouting-whale-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    6px 0 0 #88ccff, 8px 0 0 #88ccff,
    5px 1px 0 #88ccff, 7px 1px 0 #88ccff, 9px 1px 0 #88ccff,
    5px 2px 0 #5588bb, 6px 2px 0 #6699cc, 7px 2px 0 #6699cc, 8px 2px 0 #6699cc, 9px 2px 0 #5588bb,
    4px 3px 0 #5588bb, 5px 3px 0 #6699cc, 6px 3px 0 #88bbdd, 7px 3px 0 #88bbdd, 8px 3px 0 #88bbdd, 9px 3px 0 #6699cc, 10px 3px 0 #5588bb,
    3px 4px 0 #5588bb, 4px 4px 0 #6699cc, 5px 4px 0 #88bbdd, 6px 4px 0 #88bbdd, 7px 4px 0 #88bbdd, 8px 4px 0 #88bbdd, 9px 4px 0 #88bbdd, 10px 4px 0 #6699cc, 11px 4px 0 #5588bb,
    3px 5px 0 #5588bb, 4px 5px 0 #88bbdd, 5px 5px 0 #ffffff, 6px 5px 0 #112244, 7px 5px 0 #88bbdd, 8px 5px 0 #88bbdd, 9px 5px 0 #88bbdd, 10px 5px 0 #88bbdd, 11px 5px 0 #5588bb,
    2px 6px 0 #5588bb, 3px 6px 0 #6699cc, 4px 6px 0 #88bbdd, 5px 6px 0 #88bbdd, 6px 6px 0 #88bbdd, 7px 6px 0 #88bbdd, 8px 6px 0 #6699cc, 9px 6px 0 #88bbdd, 10px 6px 0 #6699cc, 11px 6px 0 #5588bb,
    2px 7px 0 #5588bb, 3px 7px 0 #6699cc, 4px 7px 0 #ccddee, 5px 7px 0 #ccddee, 6px 7px 0 #ccddee, 7px 7px 0 #ccddee, 8px 7px 0 #ccddee, 9px 7px 0 #ccddee, 10px 7px 0 #6699cc, 11px 7px 0 #5588bb,
    3px 8px 0 #5588bb, 4px 8px 0 #6699cc, 5px 8px 0 #ccddee, 6px 8px 0 #eeeeff, 7px 8px 0 #ccddee, 8px 8px 0 #eeeeff, 9px 8px 0 #6699cc, 10px 8px 0 #5588bb,
    3px 9px 0 #5588bb, 4px 9px 0 #6699cc, 5px 9px 0 #6699cc, 6px 9px 0 #6699cc, 7px 9px 0 #6699cc, 8px 9px 0 #6699cc, 9px 9px 0 #6699cc, 10px 9px 0 #5588bb,
    4px 10px 0 #5588bb, 5px 10px 0 #6699cc, 6px 10px 0 #6699cc, 7px 10px 0 #6699cc, 8px 10px 0 #6699cc, 9px 10px 0 #5588bb,
    3px 11px 0 #5588bb, 4px 11px 0 #6699cc, 5px 11px 0 #5588bb, 8px 11px 0 #5588bb, 9px 11px 0 #6699cc, 10px 11px 0 #5588bb;
}

/* 9. Dolphin — scale 2.5, 15x15 */
.dolphin-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    9px 0 0 #5599cc, 10px 0 0 #5599cc,
    8px 1px 0 #5599cc, 9px 1px 0 #77bbdd, 10px 1px 0 #77bbdd, 11px 1px 0 #5599cc,
    6px 2px 0 #5599cc, 7px 2px 0 #5599cc, 8px 2px 0 #77bbdd, 9px 2px 0 #aaddee, 10px 2px 0 #77bbdd, 11px 2px 0 #5599cc, 12px 2px 0 #5599cc,
    4px 3px 0 #5599cc, 5px 3px 0 #77bbdd, 6px 3px 0 #77bbdd, 7px 3px 0 #aaddee, 8px 3px 0 #aaddee, 9px 3px 0 #aaddee, 10px 3px 0 #aaddee, 11px 3px 0 #77bbdd, 12px 3px 0 #5599cc,
    3px 4px 0 #5599cc, 4px 4px 0 #77bbdd, 5px 4px 0 #aaddee, 6px 4px 0 #aaddee, 7px 4px 0 #aaddee, 8px 4px 0 #ffffff, 9px 4px 0 #112244, 10px 4px 0 #aaddee, 11px 4px 0 #77bbdd, 12px 4px 0 #5599cc, 13px 4px 0 #5599cc,
    2px 5px 0 #5599cc, 3px 5px 0 #77bbdd, 4px 5px 0 #aaddee, 5px 5px 0 #aaddee, 6px 5px 0 #aaddee, 7px 5px 0 #ccddee, 8px 5px 0 #ccddee, 9px 5px 0 #aaddee, 10px 5px 0 #aaddee, 11px 5px 0 #77bbdd, 12px 5px 0 #5599cc, 13px 5px 0 #77bbdd, 14px 5px 0 #5599cc,
    2px 6px 0 #5599cc, 3px 6px 0 #ccddee, 4px 6px 0 #ccddee, 5px 6px 0 #eeeeff, 6px 6px 0 #ccddee, 7px 6px 0 #ccddee, 8px 6px 0 #ccddee, 9px 6px 0 #ccddee, 10px 6px 0 #77bbdd, 11px 6px 0 #5599cc,
    3px 7px 0 #5599cc, 4px 7px 0 #77bbdd, 5px 7px 0 #ccddee, 6px 7px 0 #ccddee, 7px 7px 0 #ccddee, 8px 7px 0 #77bbdd, 9px 7px 0 #77bbdd, 10px 7px 0 #5599cc,
    4px 8px 0 #5599cc, 5px 8px 0 #77bbdd, 6px 8px 0 #77bbdd, 7px 8px 0 #5599cc, 8px 8px 0 #5599cc,
    5px 9px 0 #5599cc, 6px 9px 0 #5599cc,
    3px 10px 0 #5599cc, 4px 10px 0 #77bbdd, 5px 10px 0 #5599cc,
    2px 11px 0 #5599cc, 3px 11px 0 #77bbdd, 4px 11px 0 #5599cc;
}

/* 10. Seal — scale 2.5, 15x15 */
.seal-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0 0 #7788aa, 6px 0 0 #99aabb, 7px 0 0 #99aabb, 8px 0 0 #99aabb, 9px 0 0 #7788aa,
    4px 1px 0 #7788aa, 5px 1px 0 #99aabb, 6px 1px 0 #bbccdd, 7px 1px 0 #bbccdd, 8px 1px 0 #bbccdd, 9px 1px 0 #99aabb, 10px 1px 0 #7788aa,
    4px 2px 0 #7788aa, 5px 2px 0 #bbccdd, 6px 2px 0 #ffffff, 7px 2px 0 #222233, 8px 2px 0 #bbccdd, 9px 2px 0 #ffffff, 10px 2px 0 #222233, 11px 2px 0 #7788aa,
    4px 3px 0 #7788aa, 5px 3px 0 #99aabb, 6px 3px 0 #bbccdd, 7px 3px 0 #bbccdd, 8px 3px 0 #99aabb, 9px 3px 0 #bbccdd, 10px 3px 0 #bbccdd, 11px 3px 0 #7788aa,
    3px 4px 0 #7788aa, 4px 4px 0 #99aabb, 5px 4px 0 #bbccdd, 6px 4px 0 #222233, 7px 4px 0 #99aabb, 8px 4px 0 #222233, 9px 4px 0 #bbccdd, 10px 4px 0 #99aabb, 11px 4px 0 #7788aa,
    4px 5px 0 #7788aa, 5px 5px 0 #99aabb, 6px 5px 0 #99aabb, 7px 5px 0 #99aabb, 8px 5px 0 #99aabb, 9px 5px 0 #99aabb, 10px 5px 0 #7788aa,
    3px 6px 0 #7788aa, 4px 6px 0 #99aabb, 5px 6px 0 #bbccdd, 6px 6px 0 #bbccdd, 7px 6px 0 #bbccdd, 8px 6px 0 #bbccdd, 9px 6px 0 #bbccdd, 10px 6px 0 #99aabb, 11px 6px 0 #7788aa,
    2px 7px 0 #7788aa, 3px 7px 0 #99aabb, 4px 7px 0 #bbccdd, 5px 7px 0 #bbccdd, 6px 7px 0 #ddddee, 7px 7px 0 #ddddee, 8px 7px 0 #ddddee, 9px 7px 0 #bbccdd, 10px 7px 0 #bbccdd, 11px 7px 0 #99aabb, 12px 7px 0 #7788aa,
    2px 8px 0 #7788aa, 3px 8px 0 #99aabb, 4px 8px 0 #bbccdd, 5px 8px 0 #ddddee, 6px 8px 0 #ddddee, 7px 8px 0 #ddddee, 8px 8px 0 #ddddee, 9px 8px 0 #ddddee, 10px 8px 0 #bbccdd, 11px 8px 0 #99aabb, 12px 8px 0 #7788aa,
    3px 9px 0 #7788aa, 4px 9px 0 #99aabb, 5px 9px 0 #bbccdd, 6px 9px 0 #bbccdd, 7px 9px 0 #bbccdd, 8px 9px 0 #bbccdd, 9px 9px 0 #bbccdd, 10px 9px 0 #99aabb, 11px 9px 0 #7788aa,
    4px 10px 0 #7788aa, 5px 10px 0 #99aabb, 6px 10px 0 #99aabb, 7px 10px 0 #99aabb, 8px 10px 0 #99aabb, 9px 10px 0 #99aabb, 10px 10px 0 #7788aa,
    5px 11px 0 #7788aa, 6px 11px 0 #99aabb, 7px 11px 0 #99aabb, 8px 11px 0 #99aabb, 9px 11px 0 #7788aa,
    4px 12px 0 #7788aa, 5px 12px 0 #99aabb, 9px 12px 0 #99aabb, 10px 12px 0 #7788aa,
    3px 13px 0 #7788aa, 4px 13px 0 #99aabb, 10px 13px 0 #99aabb, 11px 13px 0 #7788aa;
}

/* 11. Shrimp — scale 2.5, 15x15 */
.shrimp-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    3px 0 0 #ff6644, 12px 0 0 #ff6644,
    2px 1px 0 #cc4422, 13px 1px 0 #cc4422,
    6px 1px 0 #ff8866, 7px 1px 0 #ff8866, 8px 1px 0 #ff8866, 9px 1px 0 #ff8866,
    5px 2px 0 #ff6644, 6px 2px 0 #ffaa88, 7px 2px 0 #ffffff, 8px 2px 0 #331100, 9px 2px 0 #ffaa88, 10px 2px 0 #ff6644,
    5px 3px 0 #cc4422, 6px 3px 0 #ff8866, 7px 3px 0 #ff8866, 8px 3px 0 #ff8866, 9px 3px 0 #ff8866, 10px 3px 0 #cc4422,
    4px 4px 0 #ff6644, 5px 4px 0 #ff8866, 6px 4px 0 #ffaa88, 7px 4px 0 #ffaa88, 8px 4px 0 #ffaa88, 9px 4px 0 #ffaa88, 10px 4px 0 #ff8866, 11px 4px 0 #ff6644,
    4px 5px 0 #cc4422, 5px 5px 0 #ff6644, 6px 5px 0 #ff8866, 7px 5px 0 #ff8866, 8px 5px 0 #ff8866, 9px 5px 0 #ff8866, 10px 5px 0 #ff6644, 11px 5px 0 #cc4422,
    5px 6px 0 #cc4422, 6px 6px 0 #ff6644, 7px 6px 0 #ff8866, 8px 6px 0 #ff8866, 9px 6px 0 #ff6644, 10px 6px 0 #cc4422,
    6px 7px 0 #cc4422, 7px 7px 0 #ff6644, 8px 7px 0 #ff6644, 9px 7px 0 #cc4422,
    5px 8px 0 #cc4422, 6px 8px 0 #ff6644, 7px 8px 0 #ff8866, 8px 8px 0 #ff8866, 9px 8px 0 #ff6644, 10px 8px 0 #cc4422,
    4px 9px 0 #cc4422, 5px 9px 0 #ff8866, 6px 9px 0 #ff8866, 9px 9px 0 #ff8866, 10px 9px 0 #ff8866, 11px 9px 0 #cc4422,
    3px 10px 0 #cc4422, 4px 10px 0 #ff6644, 5px 10px 0 #cc4422, 10px 10px 0 #cc4422, 11px 10px 0 #ff6644, 12px 10px 0 #cc4422,
    5px 11px 0 #ff6644, 6px 11px 0 #ffaa88, 7px 11px 0 #ffaa88, 8px 11px 0 #ffaa88, 9px 11px 0 #ffaa88, 10px 11px 0 #ff6644,
    6px 12px 0 #ff6644, 7px 12px 0 #cc4422, 8px 12px 0 #cc4422, 9px 12px 0 #ff6644;
}

/* 12. Crab — scale 2.5, 15x15 */
.crab-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    1px 0px 0 #cc3300, 2px 0px 0 #ee5522, 12px 0px 0 #ee5522, 13px 0px 0 #cc3300,
    0px 1px 0 #cc3300, 1px 1px 0 #ee5522, 2px 1px 0 #cc3300, 12px 1px 0 #cc3300, 13px 1px 0 #ee5522, 14px 1px 0 #cc3300,
    1px 2px 0 #cc3300, 2px 2px 0 #ee5522, 12px 2px 0 #ee5522, 13px 2px 0 #cc3300,
    5px 2px 0 #ee5522, 6px 2px 0 #ff7744, 7px 2px 0 #ff7744, 8px 2px 0 #ff7744, 9px 2px 0 #ee5522,
    4px 3px 0 #ee5522, 5px 3px 0 #ff7744, 6px 3px 0 #ff9966, 7px 3px 0 #ff9966, 8px 3px 0 #ff9966, 9px 3px 0 #ff7744, 10px 3px 0 #ee5522,
    3px 4px 0 #ee5522, 4px 4px 0 #ff7744, 5px 4px 0 #ffffff, 6px 4px 0 #221100, 7px 4px 0 #ff9966, 8px 4px 0 #ffffff, 9px 4px 0 #221100, 10px 4px 0 #ff7744, 11px 4px 0 #ee5522,
    3px 5px 0 #cc3300, 4px 5px 0 #ff7744, 5px 5px 0 #ff9966, 6px 5px 0 #ff9966, 7px 5px 0 #ff9966, 8px 5px 0 #ff9966, 9px 5px 0 #ff9966, 10px 5px 0 #ff7744, 11px 5px 0 #cc3300,
    2px 6px 0 #ee5522, 3px 6px 0 #ff7744, 4px 6px 0 #ff9966, 5px 6px 0 #ff9966, 6px 6px 0 #ff9966, 7px 6px 0 #ff9966, 8px 6px 0 #ff9966, 9px 6px 0 #ff9966, 10px 6px 0 #ff9966, 11px 6px 0 #ff7744, 12px 6px 0 #ee5522,
    1px 7px 0 #ee5522, 2px 7px 0 #ff7744, 3px 7px 0 #cc3300, 4px 7px 0 #ff7744, 5px 7px 0 #ff9966, 6px 7px 0 #ff9966, 7px 7px 0 #ee5522, 8px 7px 0 #ff9966, 9px 7px 0 #ff9966, 10px 7px 0 #ff7744, 11px 7px 0 #cc3300, 12px 7px 0 #ff7744, 13px 7px 0 #ee5522,
    0px 8px 0 #cc3300, 1px 8px 0 #ee5522, 5px 8px 0 #ee5522, 6px 8px 0 #ff7744, 7px 8px 0 #ff9966, 8px 8px 0 #ff7744, 9px 8px 0 #ee5522, 13px 8px 0 #ee5522, 14px 8px 0 #cc3300,
    5px 9px 0 #cc3300, 6px 9px 0 #ee5522, 7px 9px 0 #ff7744, 8px 9px 0 #ee5522, 9px 9px 0 #cc3300,
    4px 10px 0 #cc3300, 5px 10px 0 #ee5522, 9px 10px 0 #ee5522, 10px 10px 0 #cc3300,
    3px 11px 0 #cc3300, 4px 11px 0 #ee5522, 10px 11px 0 #ee5522, 11px 11px 0 #cc3300;
}

/* 13. Jellyfish — scale 2.5, 15x15 */
.jellyfish-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0px 0 #cc88ee, 6px 0px 0 #dd99ff, 7px 0px 0 #dd99ff, 8px 0px 0 #dd99ff, 9px 0px 0 #cc88ee,
    4px 1px 0 #cc88ee, 5px 1px 0 #dd99ff, 6px 1px 0 #eeccff, 7px 1px 0 #eeccff, 8px 1px 0 #eeccff, 9px 1px 0 #dd99ff, 10px 1px 0 #cc88ee,
    3px 2px 0 #cc88ee, 4px 2px 0 #dd99ff, 5px 2px 0 #eeccff, 6px 2px 0 #eeccff, 7px 2px 0 #eeccff, 8px 2px 0 #eeccff, 9px 2px 0 #eeccff, 10px 2px 0 #dd99ff, 11px 2px 0 #cc88ee,
    3px 3px 0 #cc88ee, 4px 3px 0 #eeccff, 5px 3px 0 #ffffff, 6px 3px 0 #662299, 7px 3px 0 #eeccff, 8px 3px 0 #ffffff, 9px 3px 0 #662299, 10px 3px 0 #eeccff, 11px 3px 0 #cc88ee,
    3px 4px 0 #cc88ee, 4px 4px 0 #dd99ff, 5px 4px 0 #eeccff, 6px 4px 0 #eeccff, 7px 4px 0 #eeccff, 8px 4px 0 #eeccff, 9px 4px 0 #eeccff, 10px 4px 0 #dd99ff, 11px 4px 0 #cc88ee,
    4px 5px 0 #cc88ee, 5px 5px 0 #dd99ff, 6px 5px 0 #dd99ff, 7px 5px 0 #dd99ff, 8px 5px 0 #dd99ff, 9px 5px 0 #dd99ff, 10px 5px 0 #cc88ee,
    3px 6px 0 #9966bb, 4px 6px 0 #cc88ee, 5px 6px 0 #cc88ee, 6px 6px 0 #dd99ff, 7px 6px 0 #cc88ee, 8px 6px 0 #dd99ff, 9px 6px 0 #cc88ee, 10px 6px 0 #cc88ee, 11px 6px 0 #9966bb,
    4px 7px 0 #9966bb, 5px 7px 0 #cc88ee, 7px 7px 0 #cc88ee, 9px 7px 0 #cc88ee, 10px 7px 0 #9966bb,
    3px 8px 0 #9966bb, 5px 8px 0 #cc88ee, 7px 8px 0 #cc88ee, 9px 8px 0 #cc88ee, 11px 8px 0 #9966bb,
    4px 9px 0 #9966bb, 6px 9px 0 #cc88ee, 8px 9px 0 #cc88ee, 10px 9px 0 #9966bb,
    3px 10px 0 #9966bb, 5px 10px 0 #cc88ee, 7px 10px 0 #9966bb, 9px 10px 0 #cc88ee, 11px 10px 0 #9966bb,
    4px 11px 0 #9966bb, 6px 11px 0 #9966bb, 8px 11px 0 #9966bb, 10px 11px 0 #9966bb,
    5px 12px 0 #9966bb, 7px 12px 0 #9966bb, 9px 12px 0 #9966bb;
}

/* 14. Tropical Fish — scale 2.5, 15x15 */
.tropical-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    6px 1px 0 #ff6633, 7px 1px 0 #ff9900, 8px 1px 0 #ff6633,
    5px 2px 0 #ff6633, 6px 2px 0 #ff9900, 7px 2px 0 #ffcc33, 8px 2px 0 #ff9900, 9px 2px 0 #ff6633,
    4px 3px 0 #ff6633, 5px 3px 0 #ff9900, 6px 3px 0 #ffcc33, 7px 3px 0 #ffffff, 8px 3px 0 #ffcc33, 9px 3px 0 #ff9900, 10px 3px 0 #ff6633,
    3px 4px 0 #ff6633, 4px 4px 0 #ff9900, 5px 4px 0 #ffcc33, 6px 4px 0 #ffffff, 7px 4px 0 #ffffff, 8px 4px 0 #ffffff, 9px 4px 0 #ffcc33, 10px 4px 0 #ff9900, 11px 4px 0 #ff6633,
    2px 5px 0 #ff6633, 3px 5px 0 #ff9900, 4px 5px 0 #ffcc33, 5px 5px 0 #ffffff, 6px 5px 0 #ffcc33, 7px 5px 0 #ffcc33, 8px 5px 0 #ffffff, 9px 5px 0 #ffcc33, 10px 5px 0 #ff9900, 11px 5px 0 #ff6633, 12px 5px 0 #ff6633,
    1px 6px 0 #ff6633, 2px 6px 0 #ff9900, 3px 6px 0 #ffcc33, 4px 6px 0 #ffffff, 5px 6px 0 #222200, 6px 6px 0 #ffcc33, 7px 6px 0 #ff9900, 8px 6px 0 #ffcc33, 9px 6px 0 #ffcc33, 10px 6px 0 #ff9900, 11px 6px 0 #ff6633, 12px 6px 0 #ff9900, 13px 6px 0 #ff6633,
    1px 7px 0 #ff6633, 2px 7px 0 #ff9900, 3px 7px 0 #ffcc33, 4px 7px 0 #ffcc33, 5px 7px 0 #ffcc33, 6px 7px 0 #ff9900, 7px 7px 0 #ff9900, 8px 7px 0 #ff9900, 9px 7px 0 #ffcc33, 10px 7px 0 #ff9900, 11px 7px 0 #ff6633, 12px 7px 0 #ff9900, 13px 7px 0 #ff6633,
    2px 8px 0 #ff6633, 3px 8px 0 #ff9900, 4px 8px 0 #ffcc33, 5px 8px 0 #ffffff, 6px 8px 0 #ffcc33, 7px 8px 0 #ffcc33, 8px 8px 0 #ffffff, 9px 8px 0 #ffcc33, 10px 8px 0 #ff9900, 11px 8px 0 #ff6633, 12px 8px 0 #ff6633,
    3px 9px 0 #ff6633, 4px 9px 0 #ff9900, 5px 9px 0 #ffcc33, 6px 9px 0 #ffffff, 7px 9px 0 #ffffff, 8px 9px 0 #ffffff, 9px 9px 0 #ffcc33, 10px 9px 0 #ff9900, 11px 9px 0 #ff6633,
    4px 10px 0 #ff6633, 5px 10px 0 #ff9900, 6px 10px 0 #ffcc33, 7px 10px 0 #ffcc33, 8px 10px 0 #ffcc33, 9px 10px 0 #ff9900, 10px 10px 0 #ff6633,
    5px 11px 0 #ff6633, 6px 11px 0 #ff9900, 7px 11px 0 #ff9900, 8px 11px 0 #ff9900, 9px 11px 0 #ff6633,
    6px 12px 0 #ff6633, 7px 12px 0 #ff6633, 8px 12px 0 #ff6633;
}

/* 15. Fish — scale 2.5, 15x15 */
.fish-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    6px 2px 0 #4488cc, 7px 2px 0 #5599dd, 8px 2px 0 #4488cc,
    5px 3px 0 #4488cc, 6px 3px 0 #5599dd, 7px 3px 0 #77bbee, 8px 3px 0 #5599dd, 9px 3px 0 #4488cc,
    4px 4px 0 #4488cc, 5px 4px 0 #5599dd, 6px 4px 0 #77bbee, 7px 4px 0 #77bbee, 8px 4px 0 #77bbee, 9px 4px 0 #5599dd, 10px 4px 0 #4488cc,
    2px 5px 0 #4488cc, 3px 5px 0 #5599dd, 4px 5px 0 #77bbee, 5px 5px 0 #77bbee, 6px 5px 0 #77bbee, 7px 5px 0 #77bbee, 8px 5px 0 #77bbee, 9px 5px 0 #77bbee, 10px 5px 0 #5599dd, 11px 5px 0 #4488cc,
    1px 6px 0 #4488cc, 2px 6px 0 #5599dd, 3px 6px 0 #77bbee, 4px 6px 0 #77bbee, 5px 6px 0 #ffffff, 6px 6px 0 #112244, 7px 6px 0 #77bbee, 8px 6px 0 #77bbee, 9px 6px 0 #77bbee, 10px 6px 0 #5599dd, 11px 6px 0 #4488cc, 12px 6px 0 #4488cc,
    1px 7px 0 #4488cc, 2px 7px 0 #5599dd, 3px 7px 0 #77bbee, 4px 7px 0 #ccddee, 5px 7px 0 #ccddee, 6px 7px 0 #77bbee, 7px 7px 0 #77bbee, 8px 7px 0 #77bbee, 9px 7px 0 #ccddee, 10px 7px 0 #5599dd, 11px 7px 0 #4488cc, 12px 7px 0 #5599dd, 13px 7px 0 #4488cc,
    2px 8px 0 #4488cc, 3px 8px 0 #5599dd, 4px 8px 0 #77bbee, 5px 8px 0 #77bbee, 6px 8px 0 #77bbee, 7px 8px 0 #77bbee, 8px 8px 0 #77bbee, 9px 8px 0 #77bbee, 10px 8px 0 #5599dd, 11px 8px 0 #4488cc, 12px 8px 0 #4488cc,
    4px 9px 0 #4488cc, 5px 9px 0 #5599dd, 6px 9px 0 #77bbee, 7px 9px 0 #77bbee, 8px 9px 0 #77bbee, 9px 9px 0 #5599dd, 10px 9px 0 #4488cc,
    5px 10px 0 #4488cc, 6px 10px 0 #5599dd, 7px 10px 0 #5599dd, 8px 10px 0 #5599dd, 9px 10px 0 #4488cc,
    6px 11px 0 #4488cc, 7px 11px 0 #4488cc, 8px 11px 0 #4488cc;
}

/* 16. Shell — scale 2.5, 15x15 */
.shell-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    7px 1px 0 #cc8855, 8px 1px 0 #cc8855,
    6px 2px 0 #cc8855, 7px 2px 0 #ddaa77, 8px 2px 0 #ddaa77, 9px 2px 0 #cc8855,
    5px 3px 0 #cc8855, 6px 3px 0 #ddaa77, 7px 3px 0 #eebb88, 8px 3px 0 #eebb88, 9px 3px 0 #ddaa77, 10px 3px 0 #cc8855,
    4px 4px 0 #cc8855, 5px 4px 0 #ddaa77, 6px 4px 0 #eebb88, 7px 4px 0 #ffddaa, 8px 4px 0 #eebb88, 9px 4px 0 #ddaa77, 10px 4px 0 #cc8855,
    4px 5px 0 #aa6633, 5px 5px 0 #cc8855, 6px 5px 0 #eebb88, 7px 5px 0 #eebb88, 8px 5px 0 #cc8855, 9px 5px 0 #eebb88, 10px 5px 0 #cc8855, 11px 5px 0 #aa6633,
    3px 6px 0 #cc8855, 4px 6px 0 #ddaa77, 5px 6px 0 #eebb88, 6px 6px 0 #ffddaa, 7px 6px 0 #ddaa77, 8px 6px 0 #eebb88, 9px 6px 0 #ffddaa, 10px 6px 0 #ddaa77, 11px 6px 0 #cc8855,
    3px 7px 0 #aa6633, 4px 7px 0 #cc8855, 5px 7px 0 #ddaa77, 6px 7px 0 #eebb88, 7px 7px 0 #eebb88, 8px 7px 0 #eebb88, 9px 7px 0 #eebb88, 10px 7px 0 #ddaa77, 11px 7px 0 #cc8855, 12px 7px 0 #aa6633,
    4px 8px 0 #cc8855, 5px 8px 0 #ddaa77, 6px 8px 0 #eebb88, 7px 8px 0 #ffddaa, 8px 8px 0 #ffddaa, 9px 8px 0 #eebb88, 10px 8px 0 #ddaa77, 11px 8px 0 #cc8855,
    4px 9px 0 #aa6633, 5px 9px 0 #cc8855, 6px 9px 0 #ddaa77, 7px 9px 0 #eebb88, 8px 9px 0 #eebb88, 9px 9px 0 #ddaa77, 10px 9px 0 #cc8855, 11px 9px 0 #aa6633,
    5px 10px 0 #cc8855, 6px 10px 0 #ddaa77, 7px 10px 0 #ddaa77, 8px 10px 0 #ddaa77, 9px 10px 0 #ddaa77, 10px 10px 0 #cc8855,
    6px 11px 0 #cc8855, 7px 11px 0 #cc8855, 8px 11px 0 #cc8855, 9px 11px 0 #cc8855,
    6px 12px 0 #ffddaa, 7px 12px 0 #ffddaa, 8px 12px 0 #ffddaa, 9px 12px 0 #ffddaa;
}

/* 17. Oyster — scale 2.5, 15x15 */
.oyster-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 2px 0 #889988, 6px 2px 0 #99aa99, 7px 2px 0 #99aa99, 8px 2px 0 #99aa99, 9px 2px 0 #889988,
    4px 3px 0 #889988, 5px 3px 0 #99aa99, 6px 3px 0 #aabbaa, 7px 3px 0 #aabbaa, 8px 3px 0 #aabbaa, 9px 3px 0 #99aa99, 10px 3px 0 #889988,
    3px 4px 0 #889988, 4px 4px 0 #99aa99, 5px 4px 0 #aabbaa, 6px 4px 0 #bbccbb, 7px 4px 0 #bbccbb, 8px 4px 0 #bbccbb, 9px 4px 0 #aabbaa, 10px 4px 0 #99aa99, 11px 4px 0 #889988,
    3px 5px 0 #667766, 4px 5px 0 #889988, 5px 5px 0 #bbccbb, 6px 5px 0 #ddeedd, 7px 5px 0 #ddeedd, 8px 5px 0 #bbccbb, 9px 5px 0 #889988, 10px 5px 0 #667766, 11px 5px 0 #889988,
    3px 6px 0 #eeeeff, 4px 6px 0 #ffffff, 5px 6px 0 #eeeeff, 6px 6px 0 #ddeedd, 7px 6px 0 #bbccbb, 8px 6px 0 #eeeeff, 9px 6px 0 #ffffff, 10px 6px 0 #eeeeff, 11px 6px 0 #889988,
    4px 7px 0 #eeeeff, 5px 7px 0 #ffffff, 6px 7px 0 #aabbcc, 7px 7px 0 #eeeeff, 8px 7px 0 #ffffff, 9px 7px 0 #aabbcc, 10px 7px 0 #eeeeff,
    3px 8px 0 #667766, 4px 8px 0 #889988, 5px 8px 0 #99aa99, 6px 8px 0 #aabbaa, 7px 8px 0 #aabbaa, 8px 8px 0 #99aa99, 9px 8px 0 #889988, 10px 8px 0 #667766, 11px 8px 0 #889988,
    3px 9px 0 #889988, 4px 9px 0 #99aa99, 5px 9px 0 #aabbaa, 6px 9px 0 #bbccbb, 7px 9px 0 #bbccbb, 8px 9px 0 #bbccbb, 9px 9px 0 #aabbaa, 10px 9px 0 #99aa99, 11px 9px 0 #889988,
    4px 10px 0 #889988, 5px 10px 0 #99aa99, 6px 10px 0 #aabbaa, 7px 10px 0 #aabbaa, 8px 10px 0 #aabbaa, 9px 10px 0 #99aa99, 10px 10px 0 #889988,
    5px 11px 0 #889988, 6px 11px 0 #889988, 7px 11px 0 #889988, 8px 11px 0 #889988, 9px 11px 0 #889988;
}

/* 18. Coral — scale 2.5, 15x15 */
.coral-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    3px 0px 0 #ff6688, 7px 0px 0 #ff6688, 11px 0px 0 #ff6688,
    3px 1px 0 #ff88aa, 7px 1px 0 #ff88aa, 11px 1px 0 #ff88aa,
    2px 2px 0 #ff6688, 3px 2px 0 #ffaacc, 4px 2px 0 #ff6688, 6px 2px 0 #ff6688, 7px 2px 0 #ffaacc, 8px 2px 0 #ff6688, 10px 2px 0 #ff6688, 11px 2px 0 #ffaacc, 12px 2px 0 #ff6688,
    2px 3px 0 #ff88aa, 3px 3px 0 #ffaacc, 4px 3px 0 #ff88aa, 6px 3px 0 #ff88aa, 7px 3px 0 #ffaacc, 8px 3px 0 #ff88aa, 10px 3px 0 #ff88aa, 11px 3px 0 #ffaacc, 12px 3px 0 #ff88aa,
    2px 4px 0 #cc4466, 3px 4px 0 #ff88aa, 4px 4px 0 #cc4466, 6px 4px 0 #cc4466, 7px 4px 0 #ff88aa, 8px 4px 0 #cc4466, 10px 4px 0 #cc4466, 11px 4px 0 #ff88aa, 12px 4px 0 #cc4466,
    3px 5px 0 #ff6688, 7px 5px 0 #ff6688, 11px 5px 0 #ff6688,
    3px 6px 0 #ff6688, 4px 6px 0 #ff6688, 6px 6px 0 #ff6688, 7px 6px 0 #ff6688, 8px 6px 0 #ff6688, 10px 6px 0 #ff6688, 11px 6px 0 #ff6688,
    3px 7px 0 #cc4466, 4px 7px 0 #ff6688, 5px 7px 0 #ff6688, 6px 7px 0 #ff6688, 7px 7px 0 #ff6688, 8px 7px 0 #ff6688, 9px 7px 0 #ff6688, 10px 7px 0 #ff6688, 11px 7px 0 #cc4466,
    4px 8px 0 #cc4466, 5px 8px 0 #ff6688, 6px 8px 0 #ff6688, 7px 8px 0 #ff88aa, 8px 8px 0 #ff6688, 9px 8px 0 #ff6688, 10px 8px 0 #cc4466,
    5px 9px 0 #cc4466, 6px 9px 0 #ff6688, 7px 9px 0 #ff6688, 8px 9px 0 #ff6688, 9px 9px 0 #cc4466,
    5px 10px 0 #993344, 6px 10px 0 #cc4466, 7px 10px 0 #cc4466, 8px 10px 0 #cc4466, 9px 10px 0 #993344,
    6px 11px 0 #993344, 7px 11px 0 #993344, 8px 11px 0 #993344,
    6px 12px 0 #664433, 7px 12px 0 #664433, 8px 12px 0 #664433;
}

/* === NEW PIXEL ART — Semi-Aquatic (5) === */

/* 19. Otter — scale 2.5, 15x15 */
.otter-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0px 0 #664422, 6px 0px 0 #885533, 7px 0px 0 #885533, 8px 0px 0 #885533, 9px 0px 0 #664422,
    4px 1px 0 #664422, 5px 1px 0 #885533, 6px 1px 0 #aa7744, 7px 1px 0 #aa7744, 8px 1px 0 #aa7744, 9px 1px 0 #885533, 10px 1px 0 #664422,
    4px 2px 0 #664422, 5px 2px 0 #aa7744, 6px 2px 0 #ffffff, 7px 2px 0 #221100, 8px 2px 0 #aa7744, 9px 2px 0 #ffffff, 10px 2px 0 #221100, 11px 2px 0 #664422,
    4px 3px 0 #885533, 5px 3px 0 #aa7744, 6px 3px 0 #aa7744, 7px 3px 0 #ddbb88, 8px 3px 0 #ddbb88, 9px 3px 0 #aa7744, 10px 3px 0 #aa7744, 11px 3px 0 #885533,
    3px 4px 0 #664422, 4px 4px 0 #885533, 5px 4px 0 #ddbb88, 6px 4px 0 #221100, 7px 4px 0 #ddbb88, 8px 4px 0 #221100, 9px 4px 0 #ddbb88, 10px 4px 0 #885533, 11px 4px 0 #664422,
    4px 5px 0 #664422, 5px 5px 0 #885533, 6px 5px 0 #aa7744, 7px 5px 0 #aa7744, 8px 5px 0 #aa7744, 9px 5px 0 #885533, 10px 5px 0 #664422,
    3px 6px 0 #664422, 4px 6px 0 #885533, 5px 6px 0 #aa7744, 6px 6px 0 #aa7744, 7px 6px 0 #aa7744, 8px 6px 0 #aa7744, 9px 6px 0 #aa7744, 10px 6px 0 #885533, 11px 6px 0 #664422,
    3px 7px 0 #664422, 4px 7px 0 #aa7744, 5px 7px 0 #ddbb88, 6px 7px 0 #ddbb88, 7px 7px 0 #ddbb88, 8px 7px 0 #ddbb88, 9px 7px 0 #ddbb88, 10px 7px 0 #aa7744, 11px 7px 0 #664422,
    3px 8px 0 #664422, 4px 8px 0 #885533, 5px 8px 0 #ddbb88, 6px 8px 0 #eeddaa, 7px 8px 0 #ddbb88, 8px 8px 0 #eeddaa, 9px 8px 0 #ddbb88, 10px 8px 0 #885533, 11px 8px 0 #664422,
    4px 9px 0 #664422, 5px 9px 0 #885533, 6px 9px 0 #aa7744, 7px 9px 0 #aa7744, 8px 9px 0 #aa7744, 9px 9px 0 #885533, 10px 9px 0 #664422,
    5px 10px 0 #664422, 6px 10px 0 #885533, 7px 10px 0 #885533, 8px 10px 0 #885533, 9px 10px 0 #664422,
    4px 11px 0 #664422, 5px 11px 0 #885533, 6px 11px 0 #664422, 8px 11px 0 #664422, 9px 11px 0 #885533, 10px 11px 0 #664422,
    3px 12px 0 #664422, 4px 12px 0 #885533, 10px 12px 0 #885533, 11px 12px 0 #664422;
}

/* 20. Beaver — scale 2.5, 15x15 */
.beaver-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0px 0 #884422, 6px 0px 0 #995533, 7px 0px 0 #995533, 8px 0px 0 #995533, 9px 0px 0 #884422,
    4px 1px 0 #884422, 5px 1px 0 #995533, 6px 1px 0 #bb7744, 7px 1px 0 #bb7744, 8px 1px 0 #bb7744, 9px 1px 0 #995533, 10px 1px 0 #884422,
    4px 2px 0 #884422, 5px 2px 0 #bb7744, 6px 2px 0 #ffffff, 7px 2px 0 #221100, 8px 2px 0 #bb7744, 9px 2px 0 #ffffff, 10px 2px 0 #221100, 11px 2px 0 #884422,
    4px 3px 0 #884422, 5px 3px 0 #995533, 6px 3px 0 #bb7744, 7px 3px 0 #bb7744, 8px 3px 0 #bb7744, 9px 3px 0 #bb7744, 10px 3px 0 #995533, 11px 3px 0 #884422,
    3px 4px 0 #884422, 4px 4px 0 #995533, 5px 4px 0 #bb7744, 6px 4px 0 #ffffff, 7px 4px 0 #ffffff, 8px 4px 0 #ffffff, 9px 4px 0 #bb7744, 10px 4px 0 #995533, 11px 4px 0 #884422,
    3px 5px 0 #884422, 4px 5px 0 #995533, 5px 5px 0 #bb7744, 6px 5px 0 #bb7744, 7px 5px 0 #bb7744, 8px 5px 0 #bb7744, 9px 5px 0 #bb7744, 10px 5px 0 #995533, 11px 5px 0 #884422,
    3px 6px 0 #884422, 4px 6px 0 #bb7744, 5px 6px 0 #ddaa66, 6px 6px 0 #ddaa66, 7px 6px 0 #ddaa66, 8px 6px 0 #ddaa66, 9px 6px 0 #ddaa66, 10px 6px 0 #bb7744, 11px 6px 0 #884422,
    3px 7px 0 #884422, 4px 7px 0 #995533, 5px 7px 0 #ddaa66, 6px 7px 0 #eebb77, 7px 7px 0 #ddaa66, 8px 7px 0 #eebb77, 9px 7px 0 #ddaa66, 10px 7px 0 #995533, 11px 7px 0 #884422,
    4px 8px 0 #884422, 5px 8px 0 #995533, 6px 8px 0 #bb7744, 7px 8px 0 #bb7744, 8px 8px 0 #bb7744, 9px 8px 0 #995533, 10px 8px 0 #884422,
    4px 9px 0 #884422, 5px 9px 0 #995533, 6px 9px 0 #995533, 7px 9px 0 #995533, 8px 9px 0 #995533, 9px 9px 0 #995533, 10px 9px 0 #884422,
    3px 10px 0 #884422, 4px 10px 0 #995533, 10px 10px 0 #995533, 11px 10px 0 #884422,
    5px 11px 0 #663311, 6px 11px 0 #884422, 7px 11px 0 #884422, 8px 11px 0 #884422, 9px 11px 0 #663311,
    5px 12px 0 #663311, 6px 12px 0 #884422, 7px 12px 0 #884422, 8px 12px 0 #884422, 9px 12px 0 #663311,
    5px 13px 0 #663311, 6px 13px 0 #663311, 7px 13px 0 #663311, 8px 13px 0 #663311, 9px 13px 0 #663311;
}

/* 21. Hippo — scale 2.5, 15x15 */
.hippo-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    4px 0px 0 #8877aa, 5px 0px 0 #9988bb, 9px 0px 0 #9988bb, 10px 0px 0 #8877aa,
    4px 1px 0 #9988bb, 5px 1px 0 #aabbcc, 6px 1px 0 #9988bb, 7px 1px 0 #9988bb, 8px 1px 0 #9988bb, 9px 1px 0 #aabbcc, 10px 1px 0 #9988bb,
    3px 2px 0 #8877aa, 4px 2px 0 #9988bb, 5px 2px 0 #aabbcc, 6px 2px 0 #aabbcc, 7px 2px 0 #aabbcc, 8px 2px 0 #aabbcc, 9px 2px 0 #aabbcc, 10px 2px 0 #9988bb, 11px 2px 0 #8877aa,
    3px 3px 0 #8877aa, 4px 3px 0 #aabbcc, 5px 3px 0 #ffffff, 6px 3px 0 #221133, 7px 3px 0 #aabbcc, 8px 3px 0 #ffffff, 9px 3px 0 #221133, 10px 3px 0 #aabbcc, 11px 3px 0 #8877aa,
    3px 4px 0 #8877aa, 4px 4px 0 #9988bb, 5px 4px 0 #aabbcc, 6px 4px 0 #aabbcc, 7px 4px 0 #aabbcc, 8px 4px 0 #aabbcc, 9px 4px 0 #aabbcc, 10px 4px 0 #9988bb, 11px 4px 0 #8877aa,
    4px 5px 0 #8877aa, 5px 5px 0 #ccbbdd, 6px 5px 0 #ccbbdd, 7px 5px 0 #ddccee, 8px 5px 0 #ccbbdd, 9px 5px 0 #ccbbdd, 10px 5px 0 #8877aa,
    3px 6px 0 #8877aa, 4px 6px 0 #ccbbdd, 5px 6px 0 #221133, 6px 6px 0 #ccbbdd, 7px 6px 0 #ccbbdd, 8px 6px 0 #ccbbdd, 9px 6px 0 #221133, 10px 6px 0 #ccbbdd, 11px 6px 0 #8877aa,
    3px 7px 0 #8877aa, 4px 7px 0 #9988bb, 5px 7px 0 #9988bb, 6px 7px 0 #9988bb, 7px 7px 0 #9988bb, 8px 7px 0 #9988bb, 9px 7px 0 #9988bb, 10px 7px 0 #9988bb, 11px 7px 0 #8877aa,
    2px 8px 0 #8877aa, 3px 8px 0 #9988bb, 4px 8px 0 #aabbcc, 5px 8px 0 #aabbcc, 6px 8px 0 #aabbcc, 7px 8px 0 #aabbcc, 8px 8px 0 #aabbcc, 9px 8px 0 #aabbcc, 10px 8px 0 #aabbcc, 11px 8px 0 #9988bb, 12px 8px 0 #8877aa,
    2px 9px 0 #8877aa, 3px 9px 0 #9988bb, 4px 9px 0 #aabbcc, 5px 9px 0 #aabbcc, 6px 9px 0 #aabbcc, 7px 9px 0 #aabbcc, 8px 9px 0 #aabbcc, 9px 9px 0 #aabbcc, 10px 9px 0 #aabbcc, 11px 9px 0 #9988bb, 12px 9px 0 #8877aa,
    3px 10px 0 #8877aa, 4px 10px 0 #9988bb, 5px 10px 0 #9988bb, 6px 10px 0 #9988bb, 7px 10px 0 #9988bb, 8px 10px 0 #9988bb, 9px 10px 0 #9988bb, 10px 10px 0 #9988bb, 11px 10px 0 #8877aa,
    3px 11px 0 #8877aa, 4px 11px 0 #9988bb, 5px 11px 0 #8877aa, 9px 11px 0 #8877aa, 10px 11px 0 #9988bb, 11px 11px 0 #8877aa,
    3px 12px 0 #665577, 4px 12px 0 #8877aa, 10px 12px 0 #8877aa, 11px 12px 0 #665577;
}

/* 22. Crocodile — scale 2.5, 15x15 */
.croc-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    9px 1px 0 #336633, 10px 1px 0 #447744, 11px 1px 0 #336633,
    8px 2px 0 #336633, 9px 2px 0 #447744, 10px 2px 0 #66aa66, 11px 2px 0 #447744, 12px 2px 0 #336633,
    6px 3px 0 #336633, 7px 3px 0 #447744, 8px 3px 0 #66aa66, 9px 3px 0 #66aa66, 10px 3px 0 #88cc88, 11px 3px 0 #66aa66, 12px 3px 0 #447744, 13px 3px 0 #336633,
    4px 4px 0 #336633, 5px 4px 0 #447744, 6px 4px 0 #66aa66, 7px 4px 0 #66aa66, 8px 4px 0 #88cc88, 9px 4px 0 #ffffff, 10px 4px 0 #112200, 11px 4px 0 #88cc88, 12px 4px 0 #66aa66, 13px 4px 0 #336633,
    2px 5px 0 #336633, 3px 5px 0 #447744, 4px 5px 0 #66aa66, 5px 5px 0 #66aa66, 6px 5px 0 #88cc88, 7px 5px 0 #88cc88, 8px 5px 0 #88cc88, 9px 5px 0 #88cc88, 10px 5px 0 #88cc88, 11px 5px 0 #66aa66, 12px 5px 0 #447744, 13px 5px 0 #336633,
    1px 6px 0 #336633, 2px 6px 0 #447744, 3px 6px 0 #66aa66, 4px 6px 0 #88cc88, 5px 6px 0 #aaddaa, 6px 6px 0 #88cc88, 7px 6px 0 #66aa66, 8px 6px 0 #aaddaa, 9px 6px 0 #88cc88, 10px 6px 0 #66aa66, 11px 6px 0 #447744, 12px 6px 0 #336633,
    1px 7px 0 #336633, 2px 7px 0 #66aa66, 3px 7px 0 #ffffff, 4px 7px 0 #ffffff, 5px 7px 0 #66aa66, 6px 7px 0 #ffffff, 7px 7px 0 #ffffff, 8px 7px 0 #66aa66, 9px 7px 0 #66aa66, 10px 7px 0 #447744, 11px 7px 0 #336633,
    2px 8px 0 #336633, 3px 8px 0 #447744, 4px 8px 0 #66aa66, 5px 8px 0 #66aa66, 6px 8px 0 #66aa66, 7px 8px 0 #88cc88, 8px 8px 0 #66aa66, 9px 8px 0 #447744, 10px 8px 0 #336633,
    3px 9px 0 #336633, 4px 9px 0 #447744, 5px 9px 0 #66aa66, 6px 9px 0 #66aa66, 7px 9px 0 #66aa66, 8px 9px 0 #447744, 9px 9px 0 #336633,
    4px 10px 0 #336633, 5px 10px 0 #447744, 6px 10px 0 #447744, 7px 10px 0 #447744, 8px 10px 0 #336633,
    3px 11px 0 #336633, 4px 11px 0 #447744, 5px 11px 0 #336633, 7px 11px 0 #336633, 8px 11px 0 #447744, 9px 11px 0 #336633,
    3px 12px 0 #224422, 4px 12px 0 #336633, 8px 12px 0 #336633, 9px 12px 0 #224422;
}

/* 23. Frog — scale 2.5, 15x15 */
.frog-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    3px 0px 0 #22aa44, 4px 0px 0 #33cc55, 5px 0px 0 #22aa44, 9px 0px 0 #22aa44, 10px 0px 0 #33cc55, 11px 0px 0 #22aa44,
    3px 1px 0 #33cc55, 4px 1px 0 #ffffff, 5px 1px 0 #112200, 6px 1px 0 #33cc55, 8px 1px 0 #33cc55, 9px 1px 0 #ffffff, 10px 1px 0 #112200, 11px 1px 0 #33cc55,
    3px 2px 0 #22aa44, 4px 2px 0 #33cc55, 5px 2px 0 #33cc55, 6px 2px 0 #33cc55, 7px 2px 0 #33cc55, 8px 2px 0 #33cc55, 9px 2px 0 #33cc55, 10px 2px 0 #33cc55, 11px 2px 0 #22aa44,
    4px 3px 0 #22aa44, 5px 3px 0 #55dd77, 6px 3px 0 #55dd77, 7px 3px 0 #55dd77, 8px 3px 0 #55dd77, 9px 3px 0 #55dd77, 10px 3px 0 #22aa44,
    3px 4px 0 #22aa44, 4px 4px 0 #55dd77, 5px 4px 0 #77ee99, 6px 4px 0 #77ee99, 7px 4px 0 #55dd77, 8px 4px 0 #77ee99, 9px 4px 0 #77ee99, 10px 4px 0 #55dd77, 11px 4px 0 #22aa44,
    3px 5px 0 #22aa44, 4px 5px 0 #55dd77, 5px 5px 0 #55dd77, 6px 5px 0 #55dd77, 7px 5px 0 #ff4444, 8px 5px 0 #55dd77, 9px 5px 0 #55dd77, 10px 5px 0 #55dd77, 11px 5px 0 #22aa44,
    4px 6px 0 #22aa44, 5px 6px 0 #33cc55, 6px 6px 0 #55dd77, 7px 6px 0 #55dd77, 8px 6px 0 #55dd77, 9px 6px 0 #33cc55, 10px 6px 0 #22aa44,
    3px 7px 0 #22aa44, 4px 7px 0 #33cc55, 5px 7px 0 #55dd77, 6px 7px 0 #88ffaa, 7px 7px 0 #88ffaa, 8px 7px 0 #88ffaa, 9px 7px 0 #55dd77, 10px 7px 0 #33cc55, 11px 7px 0 #22aa44,
    3px 8px 0 #22aa44, 4px 8px 0 #33cc55, 5px 8px 0 #88ffaa, 6px 8px 0 #88ffaa, 7px 8px 0 #88ffaa, 8px 8px 0 #88ffaa, 9px 8px 0 #88ffaa, 10px 8px 0 #33cc55, 11px 8px 0 #22aa44,
    4px 9px 0 #22aa44, 5px 9px 0 #33cc55, 6px 9px 0 #33cc55, 7px 9px 0 #33cc55, 8px 9px 0 #33cc55, 9px 9px 0 #33cc55, 10px 9px 0 #22aa44,
    5px 10px 0 #22aa44, 6px 10px 0 #33cc55, 7px 10px 0 #22aa44, 8px 10px 0 #33cc55, 9px 10px 0 #22aa44,
    2px 11px 0 #22aa44, 3px 11px 0 #33cc55, 4px 11px 0 #22aa44, 10px 11px 0 #22aa44, 11px 11px 0 #33cc55, 12px 11px 0 #22aa44,
    1px 12px 0 #22aa44, 2px 12px 0 #33cc55, 3px 12px 0 #33cc55, 11px 12px 0 #33cc55, 12px 12px 0 #33cc55, 13px 12px 0 #22aa44;
}

/* === NEW PIXEL ART — Water Birds (5) === */

/* 24. Penguin — scale 2.5, 15x15 */
.penguin-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    6px 0px 0 #223344, 7px 0px 0 #334455, 8px 0px 0 #223344,
    5px 1px 0 #223344, 6px 1px 0 #334455, 7px 1px 0 #445566, 8px 1px 0 #334455, 9px 1px 0 #223344,
    4px 2px 0 #223344, 5px 2px 0 #334455, 6px 2px 0 #ffffff, 7px 2px 0 #112233, 8px 2px 0 #334455, 9px 2px 0 #ffffff, 10px 2px 0 #112233,
    4px 3px 0 #223344, 5px 3px 0 #334455, 6px 3px 0 #445566, 7px 3px 0 #445566, 8px 3px 0 #445566, 9px 3px 0 #445566, 10px 3px 0 #223344,
    4px 4px 0 #223344, 5px 4px 0 #334455, 6px 4px 0 #ff8833, 7px 4px 0 #ff6611, 8px 4px 0 #ff8833, 9px 4px 0 #334455, 10px 4px 0 #223344,
    3px 5px 0 #223344, 4px 5px 0 #334455, 5px 5px 0 #eeeeff, 6px 5px 0 #eeeeff, 7px 5px 0 #eeeeff, 8px 5px 0 #eeeeff, 9px 5px 0 #eeeeff, 10px 5px 0 #334455, 11px 5px 0 #223344,
    3px 6px 0 #223344, 4px 6px 0 #eeeeff, 5px 6px 0 #eeeeff, 6px 6px 0 #ffffff, 7px 6px 0 #ffffff, 8px 6px 0 #ffffff, 9px 6px 0 #eeeeff, 10px 6px 0 #eeeeff, 11px 6px 0 #223344,
    3px 7px 0 #223344, 4px 7px 0 #eeeeff, 5px 7px 0 #ffffff, 6px 7px 0 #ffffff, 7px 7px 0 #ffffff, 8px 7px 0 #ffffff, 9px 7px 0 #ffffff, 10px 7px 0 #eeeeff, 11px 7px 0 #223344,
    3px 8px 0 #223344, 4px 8px 0 #334455, 5px 8px 0 #eeeeff, 6px 8px 0 #ffffff, 7px 8px 0 #ffffff, 8px 8px 0 #ffffff, 9px 8px 0 #eeeeff, 10px 8px 0 #334455, 11px 8px 0 #223344,
    4px 9px 0 #223344, 5px 9px 0 #334455, 6px 9px 0 #eeeeff, 7px 9px 0 #eeeeff, 8px 9px 0 #eeeeff, 9px 9px 0 #334455, 10px 9px 0 #223344,
    4px 10px 0 #223344, 5px 10px 0 #334455, 6px 10px 0 #334455, 7px 10px 0 #334455, 8px 10px 0 #334455, 9px 10px 0 #334455, 10px 10px 0 #223344,
    5px 11px 0 #223344, 6px 11px 0 #334455, 7px 11px 0 #334455, 8px 11px 0 #334455, 9px 11px 0 #223344,
    4px 12px 0 #ff8833, 5px 12px 0 #ff6611, 6px 12px 0 #ff8833, 8px 12px 0 #ff8833, 9px 12px 0 #ff6611, 10px 12px 0 #ff8833;
}

/* 25. Duck — scale 2.5, 15x15 */
.duck-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    5px 0px 0 #336633, 6px 0px 0 #448844, 7px 0px 0 #448844, 8px 0px 0 #448844, 9px 0px 0 #336633,
    4px 1px 0 #336633, 5px 1px 0 #448844, 6px 1px 0 #55aa55, 7px 1px 0 #55aa55, 8px 1px 0 #55aa55, 9px 1px 0 #448844, 10px 1px 0 #336633,
    4px 2px 0 #336633, 5px 2px 0 #55aa55, 6px 2px 0 #ffffff, 7px 2px 0 #112200, 8px 2px 0 #55aa55, 9px 2px 0 #ffffff, 10px 2px 0 #112200, 11px 2px 0 #336633,
    4px 3px 0 #336633, 5px 3px 0 #448844, 6px 3px 0 #55aa55, 7px 3px 0 #55aa55, 8px 3px 0 #55aa55, 9px 3px 0 #55aa55, 10px 3px 0 #448844, 11px 3px 0 #336633,
    5px 4px 0 #336633, 6px 4px 0 #ffaa22, 7px 4px 0 #ff8800, 8px 4px 0 #ffaa22, 9px 4px 0 #336633,
    3px 5px 0 #774411, 4px 5px 0 #996622, 5px 5px 0 #bb8833, 6px 5px 0 #bb8833, 7px 5px 0 #ddaa44, 8px 5px 0 #bb8833, 9px 5px 0 #bb8833, 10px 5px 0 #996622, 11px 5px 0 #774411,
    3px 6px 0 #774411, 4px 6px 0 #bb8833, 5px 6px 0 #ddaa44, 6px 6px 0 #ddaa44, 7px 6px 0 #eebb55, 8px 6px 0 #ddaa44, 9px 6px 0 #ddaa44, 10px 6px 0 #bb8833, 11px 6px 0 #774411,
    3px 7px 0 #774411, 4px 7px 0 #996622, 5px 7px 0 #ddaa44, 6px 7px 0 #eebb55, 7px 7px 0 #eebb55, 8px 7px 0 #eebb55, 9px 7px 0 #ddaa44, 10px 7px 0 #996622, 11px 7px 0 #774411,
    4px 8px 0 #774411, 5px 8px 0 #996622, 6px 8px 0 #bb8833, 7px 8px 0 #ddaa44, 8px 8px 0 #bb8833, 9px 8px 0 #996622, 10px 8px 0 #774411,
    4px 9px 0 #774411, 5px 9px 0 #996622, 6px 9px 0 #996622, 7px 9px 0 #bb8833, 8px 9px 0 #996622, 9px 9px 0 #996622, 10px 9px 0 #774411,
    5px 10px 0 #774411, 6px 10px 0 #996622, 7px 10px 0 #996622, 8px 10px 0 #996622, 9px 10px 0 #774411,
    4px 11px 0 #ff8800, 5px 11px 0 #ffaa22, 9px 11px 0 #ffaa22, 10px 11px 0 #ff8800,
    4px 12px 0 #ff8800, 5px 12px 0 #ff8800, 9px 12px 0 #ff8800, 10px 12px 0 #ff8800;
}

/* 26. Swan — scale 2.5, 15x15 */
.swan-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    10px 0px 0 #ff6633, 11px 0px 0 #ff8844,
    9px 1px 0 #ff6633, 10px 1px 0 #ff8844, 11px 1px 0 #ddddee, 12px 1px 0 #ccccdd,
    9px 2px 0 #ddddee, 10px 2px 0 #ffffff, 11px 2px 0 #112233, 12px 2px 0 #ddddee,
    9px 3px 0 #ccccdd, 10px 3px 0 #ddddee, 11px 3px 0 #ddddee, 12px 3px 0 #ccccdd,
    8px 4px 0 #ccccdd, 9px 4px 0 #ddddee,
    7px 5px 0 #ccccdd, 8px 5px 0 #ddddee,
    6px 6px 0 #ccccdd, 7px 6px 0 #ddddee,
    5px 7px 0 #ccccdd, 6px 7px 0 #ddddee, 7px 7px 0 #ddddee, 8px 7px 0 #ddddee, 9px 7px 0 #ddddee, 10px 7px 0 #ccccdd,
    4px 8px 0 #ccccdd, 5px 8px 0 #ddddee, 6px 8px 0 #ffffff, 7px 8px 0 #ffffff, 8px 8px 0 #ffffff, 9px 8px 0 #ffffff, 10px 8px 0 #ddddee, 11px 8px 0 #ccccdd,
    3px 9px 0 #ccccdd, 4px 9px 0 #ddddee, 5px 9px 0 #ffffff, 6px 9px 0 #ffffff, 7px 9px 0 #ffffff, 8px 9px 0 #ffffff, 9px 9px 0 #ffffff, 10px 9px 0 #ffffff, 11px 9px 0 #ddddee, 12px 9px 0 #ccccdd,
    3px 10px 0 #ccccdd, 4px 10px 0 #ddddee, 5px 10px 0 #ffffff, 6px 10px 0 #ffffff, 7px 10px 0 #ffffff, 8px 10px 0 #ffffff, 9px 10px 0 #ffffff, 10px 10px 0 #ddddee, 11px 10px 0 #ccccdd,
    4px 11px 0 #ccccdd, 5px 11px 0 #ddddee, 6px 11px 0 #ddddee, 7px 11px 0 #ddddee, 8px 11px 0 #ddddee, 9px 11px 0 #ddddee, 10px 11px 0 #ccccdd;
}

/* 27. Flamingo — scale 2.5, 15x15 */
.flamingo-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    6px 0px 0 #ff6688, 7px 0px 0 #ff88aa, 8px 0px 0 #ff6688,
    5px 1px 0 #ff6688, 6px 1px 0 #ff88aa, 7px 1px 0 #ffaacc, 8px 1px 0 #ff88aa, 9px 1px 0 #ff6688,
    5px 2px 0 #ff6688, 6px 2px 0 #ffffff, 7px 2px 0 #331122, 8px 2px 0 #ffaacc, 9px 2px 0 #ff6688,
    5px 3px 0 #ff6688, 6px 3px 0 #ff88aa, 7px 3px 0 #ff88aa, 8px 3px 0 #ff88aa, 9px 3px 0 #ff6688,
    6px 4px 0 #222222, 7px 4px 0 #333333, 8px 4px 0 #222222,
    7px 5px 0 #ff6688,
    7px 6px 0 #ff88aa,
    6px 7px 0 #ff6688, 7px 7px 0 #ffaacc, 8px 7px 0 #ff6688,
    5px 8px 0 #ff6688, 6px 8px 0 #ff88aa, 7px 8px 0 #ffaacc, 8px 8px 0 #ff88aa, 9px 8px 0 #ff6688,
    5px 9px 0 #cc4466, 6px 9px 0 #ff88aa, 7px 9px 0 #ffaacc, 8px 9px 0 #ff88aa, 9px 9px 0 #cc4466,
    5px 10px 0 #ff6688, 6px 10px 0 #ff88aa, 7px 10px 0 #ff88aa, 8px 10px 0 #ff88aa, 9px 10px 0 #ff6688,
    6px 11px 0 #cc4466, 7px 11px 0 #ff6688, 8px 11px 0 #cc4466,
    5px 12px 0 #cc4466, 6px 12px 0 #ff6688, 8px 12px 0 #ff6688, 9px 12px 0 #cc4466,
    5px 13px 0 #cc4466, 9px 13px 0 #cc4466;
}

/* 28. Goose — scale 2.5, 15x15 */
.goose-pixel {
  transform: scale(2.5);
  transform-origin: top left;
  margin-right: 39px;
  margin-bottom: 39px;
  box-shadow:
    8px 0px 0 #ff7733, 9px 0px 0 #ff9944,
    7px 1px 0 #ddddee, 8px 1px 0 #ff9944, 9px 1px 0 #ddddee,
    7px 2px 0 #ccccdd, 8px 2px 0 #ffffff, 9px 2px 0 #112233, 10px 2px 0 #ccccdd,
    7px 3px 0 #ccccdd, 8px 3px 0 #ddddee, 9px 3px 0 #ccccdd,
    7px 4px 0 #ccccdd, 8px 4px 0 #ddddee,
    6px 5px 0 #ccccdd, 7px 5px 0 #ddddee,
    5px 6px 0 #ccccdd, 6px 6px 0 #ddddee, 7px 6px 0 #ddddee, 8px 6px 0 #ddddee, 9px 6px 0 #ccccdd,
    4px 7px 0 #ccccdd, 5px 7px 0 #ddddee, 6px 7px 0 #ffffff, 7px 7px 0 #ffffff, 8px 7px 0 #ffffff, 9px 7px 0 #ddddee, 10px 7px 0 #ccccdd,
    3px 8px 0 #ccccdd, 4px 8px 0 #ddddee, 5px 8px 0 #ffffff, 6px 8px 0 #ffffff, 7px 8px 0 #ffffff, 8px 8px 0 #ffffff, 9px 8px 0 #ffffff, 10px 8px 0 #ddddee, 11px 8px 0 #ccccdd,
    3px 9px 0 #ccccdd, 4px 9px 0 #ddddee, 5px 9px 0 #ffffff, 6px 9px 0 #ffffff, 7px 9px 0 #ffffff, 8px 9px 0 #ffffff, 9px 9px 0 #ddddee, 10px 9px 0 #ccccdd,
    4px 10px 0 #ccccdd, 5px 10px 0 #ddddee, 6px 10px 0 #ddddee, 7px 10px 0 #ddddee, 8px 10px 0 #ddddee, 9px 10px 0 #ccccdd,
    5px 11px 0 #ff7733, 6px 11px 0 #ff9944, 8px 11px 0 #ff9944, 9px 11px 0 #ff7733,
    5px 12px 0 #ff7733, 6px 12px 0 #ff7733, 8px 12px 0 #ff7733, 9px 12px 0 #ff7733;
}

/* === AGENT SPEECH BUBBLE === */
.agent-speech {
  position: absolute;
  top: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,20,40,0.85);
  border-radius: 4px;
  padding: 3px 6px;
  font-size: 7px;
  font-family: 'Press Start 2P', monospace;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 50;
}
.agent-speech::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 3px solid transparent;
  border-right: 3px solid transparent;
  border-top: 4px solid rgba(0,20,40,0.85);
}
.agent-speech.visible {
  opacity: 1;
}
.agent-speech.fading, .pm-speech-bubble.fading {
  opacity: 0.3;
}
#pool-researcher .agent-speech { border: 1px solid var(--cyan); color: var(--cyan); }
#pool-developer .agent-speech  { border: 1px solid var(--orange); color: var(--orange); }
#pool-reviewer .agent-speech   { border: 1px solid var(--green); color: var(--green); }
#pool-tester .agent-speech     { border: 1px solid var(--yellow); color: var(--yellow); }
#pool-writer .agent-speech     { border: 1px solid var(--lavender); color: var(--lavender); }

/* commander-popup removed — diver speech bubble replaces it */

/* === FLINCH (spacebar reaction) === */
@keyframes flinch {
  0% { transform: translateY(0); }
  20% { transform: translateY(-8px); }
  50% { transform: translateY(3px); }
  70% { transform: translateY(-2px); }
  100% { transform: translateY(0); }
}
.pool-agent.flinch > div:nth-child(2) {
  animation: flinch 0.35s ease-out !important;
}

/* === WORKSPACE ZONES === */
.workspace-zones-container {
  position: absolute;
  left: 10px; top: 15px;
  width: 660px; height: 360px;
  z-index: 5;
  display: grid;
  gap: 8px;
  padding: 0;
}
.workspace-zones-container.cols-1 { grid-template-columns: 1fr; }
.workspace-zones-container.cols-2 { grid-template-columns: 1fr 1fr; }
.workspace-zones-container.cols-2x2 { grid-template-columns: 1fr 1fr; }
.workspace-zones-container.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
/* -- Submarine Compartment -- */
.workspace-zone {
  position: relative;
  border-radius: 6px;
  background: #1a2535;
  border: 2px solid #3a4a5a;
  transition: border-color 0.3s, box-shadow 0.3s, opacity 0.3s;
  min-height: 160px;
  overflow: hidden;
  box-shadow: inset 0 0 12px rgba(0,0,0,0.4);
}
/* rivets — 4 corners */
.workspace-zone::before, .workspace-zone::after {
  content: '';
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: radial-gradient(circle, #6a7a8a 30%, #3a4a5a 70%);
  box-shadow: 0 0 2px rgba(0,0,0,0.6);
  z-index: 10;
}
.workspace-zone::before { top: 4px; left: 4px; box-shadow: 0 0 2px rgba(0,0,0,0.6), calc(100% - 14px) 0 0 0 #3a4a5a; }
.workspace-zone::after { bottom: 4px; right: 4px; }
/* extra rivets via inner element */
.workspace-zone .rivet-tl, .workspace-zone .rivet-br { display: none; }
.workspace-zone .compartment-rivets {
  position: absolute; inset: 0; pointer-events: none; z-index: 10;
}
.workspace-zone .compartment-rivets::before {
  content: ''; position: absolute; top: 4px; right: 4px;
  width: 6px; height: 6px; border-radius: 50%;
  background: radial-gradient(circle, #6a7a8a 30%, #3a4a5a 70%);
  box-shadow: 0 0 2px rgba(0,0,0,0.6);
}
.workspace-zone .compartment-rivets::after {
  content: ''; position: absolute; bottom: 4px; left: 4px;
  width: 6px; height: 6px; border-radius: 50%;
  background: radial-gradient(circle, #6a7a8a 30%, #3a4a5a 70%);
  box-shadow: 0 0 2px rgba(0,0,0,0.6);
}
/* porthole */
.workspace-zone .porthole {
  position: absolute;
  top: 10px; right: 14px;
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid #4a5a6a;
  background: radial-gradient(circle, #0a1520 40%, #0d1a28 100%);
  box-shadow: inset 0 0 6px rgba(0,0,0,0.5), 0 0 3px rgba(0,0,0,0.3);
  z-index: 10;
}
.workspace-zone.ws-active .porthole {
  background: radial-gradient(circle, #0a2520 20%, #0d3028 60%, #0a1520 100%);
  box-shadow: inset 0 0 6px rgba(0,0,0,0.3), 0 0 8px rgba(38,222,129,0.25);
}
.workspace-zone.ws-active .porthole::after {
  content: '';
  position: absolute; top: 3px; left: 5px;
  width: 5px; height: 3px;
  border-radius: 50%;
  background: rgba(38,222,129,0.3);
}
/* compartment light strip */
.workspace-zone .compartment-light {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
  background: #2a3a4a;
  z-index: 10;
}
.workspace-zone.ws-active .compartment-light {
  background: linear-gradient(90deg, transparent 5%, #26de81 20%, #26de81 80%, transparent 95%);
  opacity: 0.6;
  animation: compartment-pulse 3s ease-in-out infinite;
}
@keyframes compartment-pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}
/* metal monitor frame override */
.workspace-zone .monitor-frame {
  border-color: #4a5a6a !important;
  background: #2a3545 !important;
}
/* states */
.workspace-zone.ws-active {
  border-color: #4a6a7a;
  box-shadow: inset 0 0 15px rgba(0,0,0,0.3), 0 0 8px rgba(0,212,255,0.08);
}
.workspace-zone.ws-standby { opacity: 0.65; }
.workspace-zone.ws-hold { opacity: 0.4; }
.workspace-zone.highlighted {
  border-color: var(--pink) !important;
  box-shadow: inset 0 0 20px rgba(255,107,157,0.08), 0 0 12px rgba(255,107,157,0.15) !important;
}
.workspace-zone .ws-label {
  position: absolute;
  top: 8px; left: 14px;
  font-size: 11px;
  color: var(--cyan);
  z-index: 11;
}
.workspace-zone .ws-sublabel {
  position: absolute;
  top: 24px; left: 14px;
  font-size: 9px;
  color: rgba(0,212,255,0.5);
  z-index: 11;
}
.workspace-zone .ws-eye {
  display: none;
  font-size: 10px;
  margin-left: 6px;
}
.workspace-zone.highlighted .ws-eye { display: inline; }
.ws-agents {
  position: absolute;
  top: 7px; right: 12px;
  display: flex; gap: 3px;
  z-index: 11;
  cursor: default;
}
.ws-agent-badge {
  font-size: 12px;
  filter: saturate(0.8);
  transition: transform 0.15s;
}
.ws-agent-badge:hover { transform: scale(1.3); }
body.deco-mode .ws-agents { cursor: pointer; }
body.deco-mode .ws-agents:hover { outline: 1px dashed var(--orange); border-radius: 4px; }
body.deco-mode .ws-label { cursor: pointer; }
body.deco-mode .ws-label:hover { outline: 1px dashed var(--orange); }
body.deco-mode .ws-sublabel { cursor: pointer; }
body.deco-mode .ws-sublabel:hover { outline: 1px dashed var(--orange); }
body.deco-mode #moving-diver { pointer-events: auto; cursor: pointer; }
.ws-edit-input {
  background: rgba(0,20,40,0.9);
  border: 1px solid var(--orange);
  color: var(--cyan);
  font-family: 'Press Start 2P', monospace;
  font-size: inherit;
  padding: 1px 4px;
  outline: none;
  width: 120px;
}
.ws-edit-input.sublabel { color: rgba(0,212,255,0.7); width: 180px; }
.agent-assign-popup {
  position: absolute;
  z-index: 500;
  background: rgba(5,15,40,0.95);
  border: 2px solid var(--orange);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 10px;
  box-shadow: 0 0 15px rgba(255,159,67,0.25);
}
.agent-assign-popup label {
  display: block;
  padding: 3px 0;
  cursor: pointer;
  color: #aabbcc;
}
.agent-assign-popup label:hover { color: var(--cyan); }
.agent-assign-popup input[type="checkbox"] { margin-right: 6px; }
.agent-assign-popup .aap-save {
  margin-top: 6px;
  background: rgba(255,159,67,0.2);
  border: 1px solid var(--orange);
  color: var(--orange);
  padding: 3px 10px;
  cursor: pointer;
  border-radius: 3px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
}
.agent-assign-popup .aap-save:hover { background: rgba(255,159,67,0.35); }
.no-workspaces {
  position: absolute;
  left: 50%; top: 200px;
  transform: translateX(-50%);
  font-size: 10px;
  color: #446677;
  z-index: 6;
}

/* === PIXEL SKILL MACHINES === */
.ws-machines {
  position: absolute;
  right: 8px; bottom: 12px;
  display: flex; gap: 6px;
  z-index: 12;
}
#pm-machines {
  display: flex; gap: 6px;
}
.skill-machine {
  display: flex; flex-direction: column; align-items: center; gap: 1px;
  position: relative;
  width: 36px;
}
.machine-pixel-wrap {
  width: 24px; height: 24px;
  position: relative;
  overflow: visible;
}
.machine-pixel {
  width: 1px; height: 1px;
  transform: scale(2);
  transform-origin: top left;
  image-rendering: pixelated;
  position: absolute;
  top: 0; left: 0;
}
/* --- Gear (Cogwheel) --- */
.machine-gear {
  box-shadow:
    /* center hub */
    5px 5px 0 #8a7a5a, 6px 5px 0 #8a7a5a, 5px 6px 0 #8a7a5a, 6px 6px 0 #8a7a5a,
    /* top tooth */
    5px 2px 0 #6a5a3a, 6px 2px 0 #6a5a3a,
    /* bottom tooth */
    5px 9px 0 #6a5a3a, 6px 9px 0 #6a5a3a,
    /* left tooth */
    2px 5px 0 #6a5a3a, 2px 6px 0 #6a5a3a,
    /* right tooth */
    9px 5px 0 #6a5a3a, 9px 6px 0 #6a5a3a,
    /* diag teeth */
    3px 3px 0 #6a5a3a, 8px 3px 0 #6a5a3a,
    3px 8px 0 #6a5a3a, 8px 8px 0 #6a5a3a,
    /* inner ring */
    4px 4px 0 #9a8a6a, 7px 4px 0 #9a8a6a,
    4px 7px 0 #9a8a6a, 7px 7px 0 #9a8a6a,
    4px 5px 0 #aa9a7a, 4px 6px 0 #aa9a7a,
    7px 5px 0 #aa9a7a, 7px 6px 0 #aa9a7a,
    5px 4px 0 #aa9a7a, 6px 4px 0 #aa9a7a,
    5px 7px 0 #aa9a7a, 6px 7px 0 #aa9a7a;
  animation: gear-idle 4s ease-in-out infinite;
}
.machine-gear.running { animation: gear-run 0.6s ease-in-out infinite; }
@keyframes gear-idle { 0%, 100% { transform: scale(2); filter: brightness(1); } 50% { transform: scale(2); filter: brightness(1.2); } }
@keyframes gear-run { 0%, 100% { transform: scale(2) translateX(-0.3px); filter: brightness(1.3); } 50% { transform: scale(2) translateX(0.3px); filter: brightness(1.5); } }

/* --- Boiler (Boiler + Steam) --- */
.machine-boiler {
  box-shadow:
    /* body */
    3px 4px 0 #5a3a2a, 4px 4px 0 #6a4a3a, 5px 4px 0 #6a4a3a, 6px 4px 0 #6a4a3a, 7px 4px 0 #6a4a3a, 8px 4px 0 #5a3a2a,
    3px 5px 0 #7a5a4a, 4px 5px 0 #8a6a5a, 5px 5px 0 #9a7a6a, 6px 5px 0 #9a7a6a, 7px 5px 0 #8a6a5a, 8px 5px 0 #7a5a4a,
    3px 6px 0 #7a5a4a, 4px 6px 0 #8a6a5a, 5px 6px 0 #aa8a7a, 6px 6px 0 #aa8a7a, 7px 6px 0 #8a6a5a, 8px 6px 0 #7a5a4a,
    3px 7px 0 #7a5a4a, 4px 7px 0 #8a6a5a, 5px 7px 0 #9a7a6a, 6px 7px 0 #9a7a6a, 7px 7px 0 #8a6a5a, 8px 7px 0 #7a5a4a,
    3px 8px 0 #5a3a2a, 4px 8px 0 #6a4a3a, 5px 8px 0 #6a4a3a, 6px 8px 0 #6a4a3a, 7px 8px 0 #6a4a3a, 8px 8px 0 #5a3a2a,
    /* base */
    2px 9px 0 #4a3a2a, 3px 9px 0 #5a4a3a, 4px 9px 0 #5a4a3a, 5px 9px 0 #5a4a3a, 6px 9px 0 #5a4a3a, 7px 9px 0 #5a4a3a, 8px 9px 0 #5a4a3a, 9px 9px 0 #4a3a2a,
    /* chimney */
    5px 2px 0 #5a4a3a, 6px 2px 0 #5a4a3a,
    5px 3px 0 #6a5a4a, 6px 3px 0 #6a5a4a,
    /* fire glow */
    4px 10px 0 #ff6622, 5px 10px 0 #ff9933, 6px 10px 0 #ff9933, 7px 10px 0 #ff6622;
  animation: boiler-idle 3s ease-in-out infinite;
}
.machine-boiler.running { animation: boiler-run 0.3s ease-in-out infinite; }
@keyframes boiler-idle { 0%, 100% { transform: scale(2) translateY(0); } 50% { transform: scale(2) translateY(-0.3px); } }
@keyframes boiler-run { 0%, 100% { transform: scale(2) translateX(0); } 25% { transform: scale(2) translateX(-0.4px); } 75% { transform: scale(2) translateX(0.4px); } }

/* --- Radar (Antenna) --- */
.machine-radar {
  box-shadow:
    /* base */
    3px 9px 0 #3a4a5a, 4px 9px 0 #4a5a6a, 5px 9px 0 #4a5a6a, 6px 9px 0 #4a5a6a, 7px 9px 0 #4a5a6a, 8px 9px 0 #3a4a5a,
    /* pole */
    5px 5px 0 #5a6a7a, 6px 5px 0 #5a6a7a,
    5px 6px 0 #5a6a7a, 6px 6px 0 #5a6a7a,
    5px 7px 0 #5a6a7a, 6px 7px 0 #5a6a7a,
    5px 8px 0 #5a6a7a, 6px 8px 0 #5a6a7a,
    /* dish */
    2px 3px 0 #4a8aaa, 3px 2px 0 #5a9abb, 4px 2px 0 #6aaacc, 5px 3px 0 #6abadd,
    6px 3px 0 #5a9abb, 7px 2px 0 #5a9abb, 8px 2px 0 #4a8aaa, 9px 3px 0 #3a7a9a,
    3px 3px 0 #5a9abb, 4px 3px 0 #6abadd, 7px 3px 0 #5a9abb, 8px 3px 0 #4a8aaa,
    3px 4px 0 #4a8aaa, 4px 4px 0 #5a9abb, 5px 4px 0 #5a9abb, 6px 4px 0 #5a9abb, 7px 4px 0 #4a8aaa, 8px 4px 0 #3a7a9a,
    /* signal dot */
    5px 1px 0 #00d4ff;
  animation: radar-idle 5s ease-in-out infinite;
}
.machine-radar.running { animation: radar-run 0.8s ease-in-out infinite; }
@keyframes radar-idle { 0%, 100% { transform: scale(2); } 50% { transform: scale(2) translateY(-0.3px); filter: brightness(1.15); } }
@keyframes radar-run { 0% { transform: scale(2); filter: brightness(1.2); } 50% { transform: scale(2) translateY(-0.5px); filter: brightness(1.6); } 100% { transform: scale(2); filter: brightness(1.2); } }

/* --- Printer (Printer + Paper) --- */
.machine-printer {
  box-shadow:
    /* body */
    2px 4px 0 #4a4a5a, 3px 4px 0 #5a5a6a, 4px 4px 0 #5a5a6a, 5px 4px 0 #5a5a6a, 6px 4px 0 #5a5a6a, 7px 4px 0 #5a5a6a, 8px 4px 0 #5a5a6a, 9px 4px 0 #4a4a5a,
    2px 5px 0 #5a5a6a, 3px 5px 0 #6a6a7a, 4px 5px 0 #7a7a8a, 5px 5px 0 #7a7a8a, 6px 5px 0 #7a7a8a, 7px 5px 0 #7a7a8a, 8px 5px 0 #6a6a7a, 9px 5px 0 #5a5a6a,
    2px 6px 0 #5a5a6a, 3px 6px 0 #6a6a7a, 4px 6px 0 #7a7a8a, 5px 6px 0 #7a7a8a, 6px 6px 0 #7a7a8a, 7px 6px 0 #7a7a8a, 8px 6px 0 #6a6a7a, 9px 6px 0 #5a5a6a,
    2px 7px 0 #4a4a5a, 3px 7px 0 #5a5a6a, 4px 7px 0 #5a5a6a, 5px 7px 0 #5a5a6a, 6px 7px 0 #5a5a6a, 7px 7px 0 #5a5a6a, 8px 7px 0 #5a5a6a, 9px 7px 0 #4a4a5a,
    /* paper slot */
    3px 3px 0 #2a2a3a, 4px 3px 0 #2a2a3a, 5px 3px 0 #2a2a3a, 6px 3px 0 #2a2a3a, 7px 3px 0 #2a2a3a, 8px 3px 0 #2a2a3a,
    /* output tray */
    3px 8px 0 #3a3a4a, 4px 8px 0 #4a4a5a, 5px 8px 0 #4a4a5a, 6px 8px 0 #4a4a5a, 7px 8px 0 #4a4a5a, 8px 8px 0 #3a3a4a,
    /* paper coming out */
    4px 9px 0 #dddde8, 5px 9px 0 #eeeef4, 6px 9px 0 #eeeef4, 7px 9px 0 #dddde8,
    4px 10px 0 #ccccdd, 5px 10px 0 #dddde8, 6px 10px 0 #dddde8, 7px 10px 0 #ccccdd,
    /* LED */
    3px 5px 0 #44ff66;
  animation: printer-idle 4s ease-in-out infinite;
}
.machine-printer.running { animation: printer-run 0.8s steps(2) infinite; }
@keyframes printer-idle { 0%, 100% { transform: scale(2); } 50% { transform: scale(2) translateY(-0.2px); } }
@keyframes printer-run { 0% { transform: scale(2) translateY(0); } 50% { transform: scale(2) translateY(0.5px); } }

/* --- Clock --- */
.machine-clock {
  box-shadow:
    /* clock face circle */
    4px 2px 0 #5a5a6a, 5px 2px 0 #5a5a6a, 6px 2px 0 #5a5a6a, 7px 2px 0 #5a5a6a,
    3px 3px 0 #5a5a6a, 8px 3px 0 #5a5a6a,
    2px 4px 0 #5a5a6a, 9px 4px 0 #5a5a6a,
    2px 5px 0 #5a5a6a, 9px 5px 0 #5a5a6a,
    2px 6px 0 #5a5a6a, 9px 6px 0 #5a5a6a,
    2px 7px 0 #5a5a6a, 9px 7px 0 #5a5a6a,
    3px 8px 0 #5a5a6a, 8px 8px 0 #5a5a6a,
    4px 9px 0 #5a5a6a, 5px 9px 0 #5a5a6a, 6px 9px 0 #5a5a6a, 7px 9px 0 #5a5a6a,
    /* face fill */
    4px 3px 0 #1a1a2a, 5px 3px 0 #1a1a2a, 6px 3px 0 #1a1a2a, 7px 3px 0 #1a1a2a,
    3px 4px 0 #1a1a2a, 4px 4px 0 #1a1a2a, 5px 4px 0 #1a1a2a, 6px 4px 0 #1a1a2a, 7px 4px 0 #1a1a2a, 8px 4px 0 #1a1a2a,
    3px 5px 0 #1a1a2a, 4px 5px 0 #1a1a2a, 5px 5px 0 #1a1a2a, 6px 5px 0 #1a1a2a, 7px 5px 0 #1a1a2a, 8px 5px 0 #1a1a2a,
    3px 6px 0 #1a1a2a, 4px 6px 0 #1a1a2a, 5px 6px 0 #1a1a2a, 6px 6px 0 #1a1a2a, 7px 6px 0 #1a1a2a, 8px 6px 0 #1a1a2a,
    3px 7px 0 #1a1a2a, 4px 7px 0 #1a1a2a, 5px 7px 0 #1a1a2a, 6px 7px 0 #1a1a2a, 7px 7px 0 #1a1a2a, 8px 7px 0 #1a1a2a,
    4px 8px 0 #1a1a2a, 5px 8px 0 #1a1a2a, 6px 8px 0 #1a1a2a, 7px 8px 0 #1a1a2a,
    /* hour hand */
    5px 5px 0 #ff9f43, 5px 4px 0 #ff9f43,
    /* minute hand */
    6px 5px 0 #00d4ff, 7px 5px 0 #00d4ff, 8px 5px 0 #00d4ff,
    /* 12 marker */
    5px 2px 0 #ffffff, 6px 2px 0 #ffffff,
    /* center dot */
    5px 5px 0 #ffdd44, 6px 5px 0 #ffdd44, 5px 6px 0 #ffdd44, 6px 6px 0 #ffdd44;
  animation: clock-idle 3s ease-in-out infinite;
}
.machine-clock.running { animation: clock-run 0.5s ease-in-out infinite; }
@keyframes clock-idle { 0%, 100% { transform: scale(2); } 50% { transform: scale(2); filter: brightness(1.1); } }
@keyframes clock-run { 0%, 100% { transform: scale(2); filter: brightness(1.2); } 50% { transform: scale(2); filter: brightness(1.6); } }

/* Machine status lamp dot */
.machine-lamp-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: #3a3a3a;
  border: 1px solid #4a4a4a;
  margin-top: 1px;
}
.machine-lamp-dot.running {
  background: #26de81;
  border-color: #1a9a5a;
  box-shadow: 0 0 6px rgba(38,222,129,0.6);
  animation: blink-dot 1.5s ease-in-out infinite;
}
.machine-lamp-dot.error {
  background: #ff4444;
  border-color: #aa2222;
  box-shadow: 0 0 6px rgba(255,68,68,0.6);
}
/* Machine name label */
.skill-label {
  font-size: 5px;
  color: var(--orange-light);
  text-align: center;
  max-width: 32px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
/* Steam particles for running boiler */
.steam-particle {
  position: absolute;
  width: 2px; height: 2px;
  background: rgba(200,200,220,0.5);
  border-radius: 50%;
  animation: steam-rise 1.2s ease-out infinite;
}
.steam-particle:nth-child(2) { left: 4px; animation-delay: 0.4s; }
.steam-particle:nth-child(3) { left: 8px; animation-delay: 0.8s; }
@keyframes steam-rise {
  0% { transform: translateY(0) scale(1); opacity: 0.6; }
  100% { transform: translateY(-10px) scale(1.5); opacity: 0; }
}
/* Drop zone highlight when dragging */
.drop-highlight {
  outline: 2px dashed rgba(255,159,67,0.5) !important;
  outline-offset: 2px;
  background: rgba(255,159,67,0.05);
  min-height: 28px;
  min-width: 28px;
  border-radius: 4px;
  transition: outline-color 0.2s, background 0.2s;
}
.skill-machine {
  cursor: grab;
  transition: transform 0.15s;
}
.skill-machine:hover {
  transform: scale(1.15);
  z-index: 20;
}
.skill-machine:active {
  cursor: grabbing;
}

/* === WS STATUS === */
.ws-status-dot {
  display: inline-block; width: 6px; height: 6px;
  border-radius: 50%; margin-right: 4px; vertical-align: middle;
}
.ws-status-dot.active {
  background: #26de81; box-shadow: 0 0 4px rgba(38,222,129,0.6);
  animation: blink-dot 2s ease-in-out infinite;
}
.ws-status-dot.standby { background: #557788; }
.ws-meta {
  position: absolute; top: 36px; left: 12px;
  font-size: 7px; color: #446677; z-index: 6;
}
.workspace-zone.ws-standby .monitor-screen { background: #0a1018 !important; }
.workspace-zone.ws-standby .monitor-screen .screen-line { display: none; }

/* === WS POPUP === */
.ws-popup {
  position: absolute; z-index: 200;
  background: rgba(5,15,40,0.95);
  border: 2px solid var(--cyan);
  border-radius: 8px;
  padding: 12px;
  min-width: 240px; max-width: 320px;
  box-shadow: 0 0 20px rgba(0,212,255,0.2);
  font-size: 8px; color: #aaccdd;
}
.ws-popup-title { font-size: 10px; color: var(--cyan); margin-bottom: 6px; font-family: 'Press Start 2P', monospace; }
.ws-popup-agents { margin: 6px 0; color: var(--pink-light); }
.ws-popup-log {
  margin-top: 6px; max-height: 80px; overflow-y: auto;
  font-size: 7px; color: #667788;
}
.ws-popup-close { font-size: 7px; color: #446677; margin-top: 6px; text-align: center; }

/* === EDITABLE === */
.editable { cursor: pointer; transition: opacity 0.2s; }
.editable:hover { opacity: 0.8; text-decoration: underline dashed; }

/* === THEME PRESETS === */
.theme-deep-blue .ocean-bg { background: radial-gradient(ellipse at 50% 50%, #0a2a4a 0%, #051530 50%, #020a1a 100%); }
.theme-dark-purple .ocean-bg { background: radial-gradient(ellipse at 50% 50%, #1a0a2e 0%, #0d0520 50%, #050210 100%); }
.theme-dark-purple .glass-dome { border-color: rgba(180,100,255,0.15); box-shadow: inset 0 0 60px rgba(150,80,255,0.08), 0 0 40px rgba(120,60,220,0.15); }
.theme-dark-green .ocean-bg { background: radial-gradient(ellipse at 50% 50%, #0a1e0a 0%, #051505 50%, #020a02 100%); }
.theme-dark-green .glass-dome { border-color: rgba(100,255,100,0.15); box-shadow: inset 0 0 60px rgba(80,255,80,0.08), 0 0 40px rgba(60,220,60,0.15); }
.theme-midnight .ocean-bg { background: radial-gradient(ellipse at 50% 50%, #050510 0%, #030308 50%, #010104 100%); }
.theme-midnight .glass-dome { border-color: rgba(100,100,180,0.15); box-shadow: inset 0 0 60px rgba(80,80,160,0.08), 0 0 40px rgba(60,60,140,0.15); }

/* === DECO MODE === */
.btn-deco {
  position: absolute;
  bottom: 64px; right: 100px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  padding: 5px 12px;
  border: 1px solid rgba(255,159,67,0.4);
  border-radius: 4px;
  cursor: pointer;
  background: rgba(255,159,67,0.1);
  color: var(--orange);
  z-index: 101;
  transition: all 0.2s;
}
.btn-deco:hover {
  background: rgba(255,159,67,0.25);
  box-shadow: 0 0 10px rgba(255,159,67,0.2);
}
.btn-deco:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-deco.active {
  background: rgba(255,159,67,0.3);
  border-color: var(--orange);
  box-shadow: 0 0 12px rgba(255,159,67,0.3);
}
.btn-deco-reset {
  position: absolute;
  bottom: 64px; right: 24px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  padding: 5px 12px;
  border: 1px solid rgba(255,80,80,0.4);
  border-radius: 4px;
  cursor: pointer;
  background: rgba(255,80,80,0.1);
  color: #ff5050;
  z-index: 101;
  transition: all 0.2s;
}
.btn-deco-reset:hover {
  background: rgba(255,80,80,0.25);
  box-shadow: 0 0 10px rgba(255,80,80,0.2);
}
body.deco-mode .deco-draggable {
  outline: 1px dashed rgba(255,159,67,0.3);
  cursor: move;
}
body.deco-mode .deco-draggable:hover {
  outline-color: rgba(255,159,67,0.7);
  box-shadow: 0 0 6px rgba(255,159,67,0.15);
}
.ws-resize-handle {
  display: none;
  position: absolute;
  right: -4px; bottom: -4px;
  width: 12px; height: 12px;
  cursor: nwse-resize;
  z-index: 20;
  background: linear-gradient(135deg, transparent 50%, var(--orange) 50%);
  border-radius: 0 0 4px 0;
  opacity: 0.7;
}
.ws-resize-handle:hover { opacity: 1; }
body.deco-mode .ws-resize-handle { display: block; }

/* === KANBAN BOARD === */
.btn-kanban {
  position: absolute;
  bottom: 64px; right: 170px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  padding: 5px 12px;
  border: 1px solid rgba(0,212,255,0.4);
  border-radius: 4px;
  cursor: pointer;
  background: rgba(0,212,255,0.1);
  color: var(--cyan);
  z-index: 101;
  transition: all 0.2s;
}
.btn-kanban:hover {
  background: rgba(0,212,255,0.25);
  box-shadow: 0 0 10px rgba(0,212,255,0.2);
}
.btn-kanban.active {
  background: rgba(0,212,255,0.3);
  border-color: var(--cyan);
  box-shadow: 0 0 12px rgba(0,212,255,0.3);
}

/* --- Kanban Overlay (clean UI, not pixel) --- */
.kanban-overlay {
  display: none;
  position: absolute;
  inset: 0;
  z-index: 200;
  background: #141821;
  padding: 0;
  flex-direction: column;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.kanban-overlay.visible { display: flex; }

/* Top bar */
.kanban-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: #1a1f2e;
  border-bottom: 1px solid #2a3040;
  flex-shrink: 0;
}
.kanban-topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.kanban-brand {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.3px;
}
.kanban-brand span { color: #00d4ff; }
.kanban-live {
  font-size: 11px;
  color: #4ade80;
  display: flex;
  align-items: center;
  gap: 4px;
}
.kanban-live::before {
  content: '';
  width: 6px; height: 6px;
  background: #4ade80;
  border-radius: 50%;
  display: inline-block;
}
.kanban-topbar-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
  color: #8892a4;
}
.kanban-topbar-stats strong { color: #fff; font-weight: 600; }
.kanban-close-btn {
  background: none;
  border: 1px solid #3a4050;
  color: #8892a4;
  padding: 5px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-family: inherit;
  transition: all 0.15s;
}
.kanban-close-btn:hover { color: #fff; border-color: #5a6070; background: rgba(255,255,255,0.05); }

/* Columns container */
.kanban-columns {
  display: flex;
  gap: 0;
  flex: 1;
  min-height: 0;
  padding: 16px 12px;
  gap: 10px;
}

/* Single column */
.kanban-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #1e2231;
  border-radius: 10px;
  overflow: hidden;
  min-width: 0;
}

/* Column header — colored bar */
.kanban-col-header {
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.kanban-col-header .col-count {
  font-size: 11px;
  font-weight: 700;
  background: rgba(255,255,255,0.2);
  padding: 1px 8px;
  border-radius: 10px;
  min-width: 22px;
  text-align: center;
}
.col-automation .kanban-col-header { background: #6b3fa0; }
.col-todo .kanban-col-header { background: #334155; }
.col-in_progress .kanban-col-header { background: #16a34a; }
.col-waiting .kanban-col-header { background: #d97706; }
.col-done .kanban-col-header { background: #1e6f3f; }

/* Column body */
.kanban-col-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.kanban-col-body::-webkit-scrollbar { width: 5px; }
.kanban-col-body::-webkit-scrollbar-track { background: transparent; }
.kanban-col-body::-webkit-scrollbar-thumb { background: #3a4050; border-radius: 3px; }
.kanban-col-empty {
  color: #4a5568;
  font-size: 12px;
  text-align: center;
  padding: 24px 8px;
}
.kanban-done-toggle {
  font-size: 11px;
  color: #6b7a8d;
  text-align: center;
  padding: 8px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.15s;
}
.kanban-done-toggle:hover { color: #e2e8f0; background: #252a3a; }

/* Task card */
.kanban-card {
  background: #252a3a;
  border: 1px solid #2e3546;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}
.kanban-card:hover {
  border-color: #4a5580;
  background: #2a3048;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.kanban-card-title {
  font-size: 12px;
  font-weight: 500;
  color: #e2e8f0;
  line-height: 1.4;
  word-break: break-word;
}
.kanban-card-tags {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.kanban-tag {
  font-size: 10px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 4px;
  background: #1a3a5c;
  color: #60a5fa;
}
.kanban-tag.tag-dev { background: #1a3a2c; color: #4ade80; }
.kanban-tag.tag-docs { background: #3a2a1a; color: #fbbf24; }
.kanban-tag.tag-config { background: #2a1a3a; color: #c084fc; }
.kanban-card-meta {
  margin-top: 8px;
  font-size: 10px;
  color: #5a6578;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.kanban-card-meta .meta-logs { color: #6b7a8d; }
.kanban-card-agent {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  margin-right: 4px;
}

/* Automation card (Automation column) */
.kanban-skill-card {
  background: #252a3a;
  border: 1px solid #2e3546;
  border-radius: 8px;
  padding: 10px 12px;
  font-family: inherit;
}
.kanban-skill-card .skill-name {
  font-size: 12px;
  font-weight: 600;
  color: #d8b4fe;
}
.kanban-skill-card .skill-info {
  font-size: 10px;
  color: #5a6578;
  margin-top: 4px;
}
.kanban-skill-card .skill-status {
  display: inline-block;
  font-size: 10px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 4px;
  margin-top: 6px;
}
.kanban-skill-card .skill-status.s-idle { background: #1e293b; color: #64748b; }
.kanban-skill-card .skill-status.s-running { background: #422006; color: #fb923c; }
.kanban-skill-card .skill-status.s-error { background: #450a0a; color: #f87171; }

/* --- Kanban Modal --- */
.kanban-modal-backdrop {
  display: none;
  position: absolute;
  inset: 0;
  z-index: 210;
  background: rgba(0,0,0,0.65);
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(2px);
}
.kanban-modal-backdrop.visible { display: flex; }

.kanban-modal {
  background: #1e2231;
  border: 1px solid #2e3546;
  border-radius: 12px;
  width: 520px;
  max-height: 660px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
}
.kanban-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.kanban-modal-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.kanban-modal-status {
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #3a4050;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background: #252a3a url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%236b7a8d'/%3E%3C/svg%3E") no-repeat right 6px center;
  padding-right: 20px;
  color: #e2e8f0;
  transition: all 0.15s;
}
.kanban-modal-status:hover { border-color: #5a6070; }
.kanban-modal-status.st-automation { background-color: #2e1065; color: #a78bfa; border-color: #6b3fa0; }
.kanban-modal-status.st-todo { background-color: #1e293b; color: #94a3b8; border-color: #334155; }
.kanban-modal-status.st-in_progress { background-color: #172554; color: #60a5fa; border-color: #1e40af; }
.kanban-modal-status.st-waiting { background-color: #422006; color: #fb923c; border-color: #92400e; }
.kanban-modal-status.st-done { background-color: #052e16; color: #4ade80; border-color: #166534; }
.kanban-modal-close-x {
  background: none;
  border: none;
  color: #5a6578;
  font-size: 22px;
  cursor: pointer;
  padding: 0 4px;
  line-height: 1;
  transition: color 0.15s;
}
.kanban-modal-close-x:hover { color: #e2e8f0; }
.kanban-modal-title {
  font-size: 15px;
  font-weight: 600;
  color: #e2e8f0;
  line-height: 1.4;
}
.kanban-modal-info {
  font-size: 12px;
  color: #6b7a8d;
  display: flex;
  flex-direction: column;
  gap: 3px;
  line-height: 1.5;
}
.kanban-modal-section-title {
  font-size: 11px;
  font-weight: 600;
  color: #5a6578;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.kanban-log-count {
  font-size: 10px;
  background: #2e3546;
  color: #8892a4;
  padding: 1px 6px;
  border-radius: 8px;
  font-weight: 500;
}
.kanban-modal-comment {
  font-size: 12px;
  color: #4ade80;
  background: rgba(74,222,128,0.08);
  border: 1px solid rgba(74,222,128,0.15);
  border-radius: 6px;
  padding: 10px 12px;
  line-height: 1.5;
  word-break: break-word;
}
.kanban-activity-log {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 220px;
}
.kanban-activity-log::-webkit-scrollbar { width: 5px; }
.kanban-activity-log::-webkit-scrollbar-thumb { background: #3a4050; border-radius: 3px; }
.kanban-log-entry {
  font-size: 11px;
  color: #8892a4;
  padding: 8px 10px;
  background: #252a3a;
  border-radius: 6px;
  line-height: 1.4;
  display: flex;
  gap: 10px;
  align-items: flex-start;
}
.kanban-log-entry .log-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
  text-transform: uppercase;
  margin-top: 1px;
}
.kanban-log-entry .log-body { flex: 1; min-width: 0; }
.kanban-log-entry .log-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 3px;
}
.kanban-log-entry .log-agent { font-weight: 600; font-size: 12px; }
.kanban-log-entry .log-time { color: #4a5568; font-size: 10px; }
.kanban-log-entry .log-message { color: #94a3b8; word-break: break-word; }
.kanban-log-entry.log-long {
  border-left: 3px solid;
  padding-left: 8px;
}
.kanban-log-entry.log-long .log-message {
  color: #e2e8f0;
  font-size: 12px;
  line-height: 1.5;
}
.kanban-modal-feedback {
  display: flex;
  gap: 6px;
}
.kanban-modal-feedback input {
  flex: 1;
  font-family: inherit;
  font-size: 12px;
  background: #252a3a;
  border: 1px solid #3a4050;
  border-radius: 6px;
  color: #e2e8f0;
  padding: 7px 10px;
  outline: none;
  transition: border-color 0.15s;
}
.kanban-modal-feedback input:focus { border-color: #f97316; }
.kanban-modal-feedback input::placeholder { color: #4a5568; }
.kanban-modal-feedback button {
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  background: #f97316;
  border: none;
  color: #fff;
  cursor: pointer;
  padding: 7px 14px;
  border-radius: 6px;
  white-space: nowrap;
  transition: background 0.15s;
}
.kanban-modal-feedback button:hover { background: #ea580c; }
.kanban-modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.kanban-modal-btn-delete {
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  color: #ef4444;
  cursor: pointer;
  padding: 6px 16px;
  border-radius: 6px;
  transition: all 0.15s;
}
.kanban-modal-btn-delete:hover { background: rgba(239,68,68,0.2); border-color: #ef4444; }
.kanban-modal-close {
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  background: #252a3a;
  border: 1px solid #3a4050;
  color: #8892a4;
  cursor: pointer;
  padding: 6px 16px;
  border-radius: 6px;
  transition: all 0.15s;
}
.kanban-modal-close:hover { color: #fff; border-color: #5a6070; background: #2a3048; }
.kanban-modal-btn-merge {
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  background: rgba(99,102,241,0.1);
  border: 1px solid rgba(99,102,241,0.3);
  color: #818cf8;
  cursor: pointer;
  padding: 6px 16px;
  border-radius: 6px;
  transition: all 0.15s;
  margin-right: auto;
}
.kanban-modal-btn-merge:hover { background: rgba(99,102,241,0.2); border-color: #818cf8; }
.merge-target-list {
  margin-top: 8px;
  max-height: 160px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.merge-target-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: #1a1f2e;
  border: 1px solid #2a3040;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 12px;
  color: #c8d0dc;
}
.merge-target-item:hover { border-color: #818cf8; background: #1e2340; }
.merge-target-col {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 3px;
  color: #fff;
  flex-shrink: 0;
}
.merge-target-col.c-in_progress { background: #16a34a; }
.merge-target-col.c-todo { background: #334155; }
.merge-target-col.c-waiting { background: #d97706; }
.merge-target-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Kanban merge mode */
.kanban-merge-toggle {
  font-family: inherit; font-size: 12px; font-weight: 500;
  background: transparent; border: 1px solid #3a4050;
  color: #8892a4; cursor: pointer; padding: 4px 12px;
  border-radius: 6px; transition: all 0.15s;
}
.kanban-merge-toggle:hover { border-color: #818cf8; color: #818cf8; }
.kanban-merge-toggle.active { background: #818cf8; color: #fff; border-color: #818cf8; }
.kanban-merge-bar {
  display: none; position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
  background: #1e2340; border: 1px solid #818cf8; border-radius: 10px;
  padding: 8px 16px; gap: 12px; align-items: center; z-index: 20;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.kanban-merge-bar.visible { display: flex; }
.kanban-merge-bar span { color: #c8d0dc; font-size: 13px; }
.merge-bar-btn {
  font-family: inherit; font-size: 12px; font-weight: 600;
  background: #818cf8; border: none; color: #fff; cursor: pointer;
  padding: 6px 16px; border-radius: 6px; transition: background 0.15s;
}
.merge-bar-btn:hover { background: #6366f1; }
.merge-bar-cancel {
  font-family: inherit; font-size: 12px;
  background: transparent; border: 1px solid #3a4050;
  color: #8892a4; cursor: pointer; padding: 6px 12px; border-radius: 6px;
}
.merge-bar-cancel:hover { border-color: #5a6070; color: #c8d0dc; }
.kanban-card.merge-selected { border-color: #818cf8; background: rgba(129,140,248,0.1); }
.kanban-card .merge-check {
  display: none; position: absolute; top: 6px; right: 6px;
  width: 18px; height: 18px; border-radius: 4px; border: 2px solid #4a5060;
  background: transparent; cursor: pointer; z-index: 5;
}
body.merge-mode .kanban-card { position: relative; }
body.merge-mode .kanban-card .merge-check { display: block; }
body.merge-mode .kanban-card.merge-selected .merge-check {
  background: #818cf8; border-color: #818cf8;
}
body.merge-mode .kanban-card.merge-selected .merge-check::after {
  content: '\\2713'; color: #fff; font-size: 12px;
  position: absolute; top: -1px; left: 2px;
}

/* Automation edit form */
.km-edit-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
.km-edit-row label:first-child { width: 90px; color: #9ca3af; font-size: 13px; flex-shrink: 0; }
.km-edit-row input[type="time"],
.km-edit-row input[type="text"] {
  flex: 1; background: #1a2332; border: 1px solid #374151;
  color: #e5e7eb; padding: 6px 10px; border-radius: 6px; font-family: inherit; font-size: 13px;
}
.km-edit-row input[type="time"]:focus,
.km-edit-row input[type="text"]:focus { border-color: #ff6b9d; outline: none; }
.km-toggle { position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; }
.km-toggle input { opacity: 0; width: 0; height: 0; }
.km-toggle-slider {
  position: absolute; inset: 0; background: #374151; border-radius: 12px; transition: .3s;
}
.km-toggle-slider:before {
  content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px;
  background: white; border-radius: 50%; transition: .3s;
}
.km-toggle input:checked + .km-toggle-slider { background: #26de81; }
.km-toggle input:checked + .km-toggle-slider:before { transform: translateX(20px); }
.km-save-btn {
  width: 100%; margin-top: 12px; padding: 8px; background: #ff6b9d;
  color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
  font-family: inherit; font-size: 13px; transition: background 0.15s;
}
.km-save-btn:hover { background: #ff4785; }

.machine-picker {
  position: absolute;
  z-index: 300;
  background: rgba(5,15,40,0.95);
  border: 2px solid var(--orange);
  border-radius: 6px;
  padding: 8px;
  display: none;
  gap: 4px;
  flex-wrap: wrap;
  box-shadow: 0 0 15px rgba(255,159,67,0.2);
}
.machine-picker.show { display: flex; }
.machine-picker-item {
  width: 40px; height: 44px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 2px;
  border: 1px solid rgba(255,159,67,0.2);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  padding: 2px;
}
.machine-picker-item:hover {
  border-color: var(--orange);
  background: rgba(255,159,67,0.15);
}
.machine-picker-item.selected {
  border-color: var(--orange);
  background: rgba(255,159,67,0.25);
}
.machine-picker-item .mp-icon { font-size: 16px; }
.machine-picker-item .mp-label {
  font-size: 5px;
  color: var(--orange-light);
  font-family: 'Press Start 2P', monospace;
}
body.deco-mode .skill-machine { cursor: pointer; }
body.deco-mode .skill-machine::after {
  content: '\1F527';
  position: absolute;
  top: -8px; right: -8px;
  font-size: 8px;
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
}
body.deco-mode .skill-machine:hover::after { opacity: 1; }

/* === CHARACTER PICKER === */
.char-picker-popup {
  position: absolute;
  z-index: 600;
  background: rgba(5,15,40,0.95);
  border: 2px solid var(--pink);
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 0 20px rgba(255,107,157,0.3);
  font-size: 8px;
  color: #aabbcc;
  width: 240px;
}
.char-picker-popup .cp-title {
  font-size: 9px;
  color: var(--pink);
  margin-bottom: 6px;
}
.char-picker-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 8px;
}
.char-picker-item {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(30,50,80,0.6);
  border: 1px solid rgba(100,150,200,0.2);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  transition: border-color 0.2s, background 0.2s;
}
.char-picker-item:hover { border-color: var(--cyan); background: rgba(0,212,255,0.1); }
.char-picker-item.selected { border-color: var(--pink); background: rgba(255,107,157,0.15); }
.char-picker-hue {
  display: flex; align-items: center; gap: 6px;
  margin-bottom: 8px;
}
.char-picker-hue input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  height: 6px;
  border-radius: 3px;
  background: linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
  outline: none;
}
.char-picker-hue input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid var(--pink);
  cursor: pointer;
}
.char-picker-hue .hue-value { font-size: 8px; color: var(--cyan); min-width: 30px; }
.char-picker-apply {
  background: rgba(255,107,157,0.2);
  border: 1px solid var(--pink);
  color: var(--pink);
  padding: 3px 12px;
  cursor: pointer;
  border-radius: 3px;
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
}
.char-picker-apply:hover { background: rgba(255,107,157,0.35); }
/* Agent hue-rotate */
.pool-agent .pixel-char { filter: hue-rotate(var(--agent-hue, 0deg)); }
</style>
</head>
<body>
<div class="viewport">
  <!-- Ocean Background -->
  <div class="ocean-bg"></div>

  <!-- Bubbles outside dome -->
  <div id="bubbles-container"></div>

  <!-- Fish silhouettes -->
  <div id="fish-container"></div>

  <!-- Glass Dome -->
  <div class="glass-dome" id="dome">
    <div class="floor"></div>

    <!-- SVG Connection Lines removed (v6.1) -->

    <!-- Dynamic Workspace Zones (rendered by JS) -->
    <div id="workspace-zones"></div>

    <!-- ========================= -->
    <!--  AGENT POOL               -->
    <!-- ========================= -->
    <div class="agent-pool" id="agent-pool" style="left:160px; top:640px;">
      <!-- Researcher (Octopus) -->
      <div class="pool-agent" id="pool-researcher">
        <div class="agent-speech" id="speech-researcher"></div>
        <div style="animation: bob-slow 3s ease-in-out infinite;">
          <div class="pixel-char octopus-pixel"></div>
        </div>
        <div class="pool-agent-label editable" data-config-key="agents.researcher.label" style="color:#00d4ff;">Explorer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-researcher"></div></div>
      </div>
      <!-- Developer (Shark) -->
      <div class="pool-agent" id="pool-developer">
        <div class="agent-speech" id="speech-developer"></div>
        <div style="animation: bob-slow 2.5s ease-in-out infinite 0.3s;">
          <div class="pixel-char shark-pixel"></div>
        </div>
        <div class="pool-agent-label editable" data-config-key="agents.developer.label" style="color:#ff9f43;">Engineer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-developer"></div></div>
      </div>
      <!-- Reviewer (Turtle) -->
      <div class="pool-agent" id="pool-reviewer">
        <div class="agent-speech" id="speech-reviewer"></div>
        <div style="animation: bob-slow 4s ease-in-out infinite 1s;">
          <div class="pixel-char turtle-pixel"></div>
        </div>
        <div class="pool-agent-label editable" data-config-key="agents.reviewer.label" style="color:#26de81;">Reviewer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-reviewer"></div></div>
      </div>
      <!-- Tester (Pufferfish) -->
      <div class="pool-agent" id="pool-tester">
        <div class="agent-speech" id="speech-tester"></div>
        <div style="animation: bob-slow 3.5s ease-in-out infinite 0.7s;">
          <div class="pixel-char puffer-pixel"></div>
        </div>
        <div class="pool-agent-label editable" data-config-key="agents.tester.label" style="color:#ffd32a;">Tester</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-tester"></div></div>
      </div>
      <!-- Writer (Lobster) -->
      <div class="pool-agent" id="pool-writer">
        <div class="agent-speech" id="speech-writer"></div>
        <div style="animation: bob-slow 5s ease-in-out infinite 0.5s;">
          <div class="pixel-char lobster-pixel"></div>
        </div>
        <div class="pool-agent-label editable" data-config-key="agents.writer.label" style="color:#bb88ff;">Writer</div>
        <div class="hp-bar-wrap" style="left:2px; top:6px; position:relative;"><div class="hp-bar" id="hp-writer"></div></div>
      </div>
    </div>

    <!-- ========================= -->
    <!--  WORKSPACE CARGO CRATES   -->
    <!-- ========================= -->

    <!-- ========================= -->
    <!--  PM — heysquid (fixed)    -->
    <!-- ========================= -->
    <div class="pm-area" id="pm-area" style="left:460px; top:510px;">
      <div class="pm-speech-bubble" id="pm-speech"></div>
      <div class="char-wrapper" style="position:relative !important; animation: bob 2.5s ease-in-out infinite;">
        <div style="animation: crown-shine 3s ease-in-out infinite; display:inline-block;">
          <div class="pixel-char squid-pixel-lg"></div>
        </div>
      </div>
      <div class="pm-label editable" data-config-key="pm_label">PM — heysquid</div>
    </div>

    <!-- ============= -->
    <!--  WATER COOLER  -->
    <!-- ============= -->
    <div class="water-cooler" style="left:730px; top:510px;">
      <div style="position:relative; width:28px;">
        <!-- Water jug (top) -->
        <div style="width:16px; height:10px; background:rgba(100,180,255,0.35); border:2px solid rgba(100,180,255,0.5); border-radius:6px 6px 2px 2px; margin:0 auto; position:relative;">
          <div style="position:absolute; top:2px; left:4px; width:4px; height:4px; background:rgba(150,220,255,0.4); border-radius:50%;"></div>
        </div>
        <!-- Dispenser body -->
        <div style="width:20px; height:20px; background:rgba(60,80,110,0.6); border:2px solid rgba(80,120,160,0.5); border-radius:2px; margin:0 auto; position:relative;">
          <div style="position:absolute; top:4px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:rgba(100,180,255,0.3); border-radius:50%;"></div>
          <!-- Tap -->
          <div style="position:absolute; bottom:3px; left:50%; transform:translateX(-50%); width:4px; height:3px; background:#5599bb; border-radius:1px;"></div>
        </div>
        <!-- Base/stand -->
        <div style="width:24px; height:4px; background:rgba(60,80,100,0.5); border-radius:1px; margin:0 auto;"></div>
      </div>
      <div style="font-size:7px; color:#3a6a8a; text-align:center; margin-top:2px;">Cooler</div>
    </div>

    <!-- ============ -->
    <!--  PLANTS x2   -->
    <!-- ============ -->
    <div class="plant" style="left:960px; top:520px;">
      <div style="position:relative;">
        <div style="width:4px; height:16px; background:#44aa66; border-radius:2px; position:absolute; bottom:4px; left:5px; transform:rotate(-10deg); animation: bob-slow 3s ease-in-out infinite;"></div>
        <div style="width:4px; height:20px; background:#55bb77; border-radius:2px; position:absolute; bottom:4px; left:11px; animation: bob-slow 3.5s ease-in-out infinite 0.5s;"></div>
        <div style="width:4px; height:14px; background:#44aa66; border-radius:2px; position:absolute; bottom:4px; left:17px; transform:rotate(10deg); animation: bob-slow 2.8s ease-in-out infinite 1s;"></div>
        <div style="width:26px; height:14px; background:#8B5E3C; border-radius:2px 2px 4px 4px;"></div>
        <div style="width:30px; height:3px; background:#9B6E4C; border-radius:1px; position:relative; top:-14px; left:-2px;"></div>
      </div>
    </div>
    <div class="plant" style="left:15px; top:560px;">
      <div style="position:relative;">
        <div style="width:3px; height:12px; background:#66cc88; border-radius:2px; position:absolute; bottom:4px; left:4px; transform:rotate(-15deg); animation: bob-slow 2.5s ease-in-out infinite 0.3s;"></div>
        <div style="width:3px; height:16px; background:#55bb77; border-radius:2px; position:absolute; bottom:4px; left:9px; animation: bob-slow 3s ease-in-out infinite;"></div>
        <div style="width:3px; height:10px; background:#66cc88; border-radius:2px; position:absolute; bottom:4px; left:14px; transform:rotate(12deg); animation: bob-slow 3.2s ease-in-out infinite 0.7s;"></div>
        <div style="width:22px; height:12px; background:#7B4E2C; border-radius:2px 2px 4px 4px;"></div>
        <div style="width:26px; height:3px; background:#8B5E3C; border-radius:1px; position:relative; top:-12px; left:-2px;"></div>
      </div>
    </div>

    <!-- PM Machines (unassigned skills) -->
    <div id="pm-machines" style="position:absolute; left:560px; top:540px; z-index:5;"></div>

    <!-- ======================== -->
    <!--  MOVING DIVER (Boss)     -->
    <!-- ======================== -->
    <div id="moving-diver" style="left:600px; top:580px;">
      <div class="diver-speech-bubble" id="diver-speech"></div>
      <div class="pixel-char diver-pixel"></div>
      <div class="mini-label">↑↓←→ Patrol</div>
    </div>

  </div><!-- end glass-dome -->

  <!-- Title Bar -->
  <div class="title-bar">
    <h1 class="editable" data-config-key="title">heysquid HQ</h1>
    <div class="subtitle editable" data-config-key="subtitle">DEEP SEA AGENT COMMAND CENTER</div>
  </div>

  <!-- Mission log panel removed — speech bubbles replace it -->

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-left">
      <span class="conn-dot-status" id="connDot"></span>
      <span id="connLabel">Connecting...</span>
    </div>
    <div class="status-center" id="currentTask">Standby</div>
    <div class="status-right">
      <span id="lastUpdated">--:--:--</span>
      <span class="editable" style="margin-left:8px; cursor:pointer; font-size:10px;" onclick="takeScreenshot()" title="Screenshot">📸</span>
    </div>
  </div>

  <!-- DEMO Button -->
  <button class="btn-demo" id="btnDemo" onclick="runDemo()">DEMO</button>

  <!-- KANBAN Button -->
  <button class="btn-kanban" id="btnKanban" onclick="toggleKanbanView()">📋 KANBAN</button>

  <!-- DECO Button -->
  <button class="btn-deco" id="btnDeco" onclick="toggleDecoMode()">🎨 DECO</button>
  <button class="btn-deco-reset" id="btnDecoReset" onclick="resetDecoLayout()" style="display:none">🗑 RESET</button>

  <!-- Kanban Overlay -->
  <div class="kanban-overlay" id="kanbanOverlay">
    <div class="kanban-topbar">
      <div class="kanban-topbar-left">
        <div class="kanban-brand">SQUID<span>.Board</span></div>
        <div class="kanban-live" id="kanbanLive">Live</div>
      </div>
      <div class="kanban-topbar-stats" id="kanbanStats">
        Total: <strong id="kbStatTotal">0</strong>
        Active: <strong id="kbStatActive">0</strong>
        Done: <strong id="kbStatDone">0</strong>
      </div>
      <button class="kanban-merge-toggle" id="kanbanMergeToggle" onclick="toggleMergeMode()">Merge</button>
      <button class="kanban-close-btn" onclick="toggleKanbanView()">✕ Close</button>
    </div>
    <div class="kanban-columns">
      <div class="kanban-column col-automation">
        <div class="kanban-col-header">Automation <span class="col-count" id="countAutomation">0</span></div>
        <div class="kanban-col-body" id="colAutomation"></div>
      </div>
      <div class="kanban-column col-todo">
        <div class="kanban-col-header">To Do <span class="col-count" id="countTodo">0</span></div>
        <div class="kanban-col-body" id="colTodo"></div>
      </div>
      <div class="kanban-column col-in_progress">
        <div class="kanban-col-header">In Progress <span class="col-count" id="countInProgress">0</span></div>
        <div class="kanban-col-body" id="colInProgress"></div>
      </div>
      <div class="kanban-column col-waiting">
        <div class="kanban-col-header">Waiting <span class="col-count" id="countWaiting">0</span></div>
        <div class="kanban-col-body" id="colWaiting"></div>
      </div>
      <div class="kanban-column col-done">
        <div class="kanban-col-header">Done <span class="col-count" id="countDone">0</span></div>
        <div class="kanban-col-body" id="colDone"></div>
      </div>
    </div>
    <!-- Merge floating bar -->
    <div class="kanban-merge-bar" id="kanbanMergeBar">
      <span id="mergeBarCount">0 selected</span>
      <button class="merge-bar-btn" onclick="executeMergeSelected()">Merge Selected</button>
      <button class="merge-bar-cancel" onclick="toggleMergeMode()">Cancel</button>
    </div>
  </div>

  <!-- Kanban Modal -->
  <div class="kanban-modal-backdrop" id="kanbanModalBackdrop" onclick="closeKanbanModal(event)">
    <div class="kanban-modal" id="kanbanModal" onclick="event.stopPropagation()">
      <!-- Header: status dropdown + tags + X -->
      <div class="kanban-modal-header">
        <div class="kanban-modal-header-left">
          <select class="kanban-modal-status" id="kanbanModalStatus" onchange="moveKanbanTask()">
            <option value="automation">Automation</option>
            <option value="todo">To Do</option>
            <option value="in_progress">In Progress</option>
            <option value="waiting">Waiting</option>
            <option value="done">Done</option>
          </select>
          <span id="kanbanModalTags"></span>
        </div>
        <button class="kanban-modal-close-x" onclick="closeKanbanModal()">&times;</button>
      </div>
      <!-- Title -->
      <div class="kanban-modal-title" id="kanbanModalTitle"></div>
      <!-- Info -->
      <div class="kanban-modal-info" id="kanbanModalInfo"></div>
      <!-- Automation Edit Form -->
      <div id="kanbanModalEditWrap" style="display:none">
        <div class="km-edit-row" id="kmEditScheduleRow">
          <label>Schedule</label>
          <input type="time" id="kmEditSchedule" value="09:00">
        </div>
        <div class="km-edit-row">
          <label>Enabled</label>
          <label class="km-toggle">
            <input type="checkbox" id="kmEditEnabled" checked>
            <span class="km-toggle-slider"></span>
          </label>
        </div>
        <div class="km-edit-row">
          <label>Description</label>
          <input type="text" id="kmEditDescription" value="">
        </div>
        <div class="km-edit-row">
          <label>Workspace</label>
          <input type="text" id="kmEditWorkspace" value="" placeholder="(none)">
        </div>
        <button class="km-save-btn" onclick="saveAutomationConfig()">💾 Save Changes</button>
      </div>
      <!-- Comment (result) -->
      <div id="kanbanModalCommentWrap" style="display:none">
        <div class="kanban-modal-section-title">Comment</div>
        <div class="kanban-modal-comment" id="kanbanModalComment"></div>
      </div>
      <!-- Activity Log -->
      <div class="kanban-modal-section-title">Activity Log <span class="kanban-log-count" id="kanbanLogCount">0</span></div>
      <div class="kanban-activity-log" id="kanbanModalLog"></div>
      <!-- Feedback input -->
      <div class="kanban-modal-feedback">
        <input type="text" id="kanbanFeedbackInput" placeholder="Write PM feedback..." onkeydown="if(event.key==='Enter')sendKanbanFeedback()">
        <button onclick="sendKanbanFeedback()">Send Feedback</button>
      </div>
      <!-- Bottom actions -->
      <!-- Merge target picker (hidden by default) -->
      <div id="kanbanMergeWrap" style="display:none">
        <div class="kanban-modal-section-title">Merge into...</div>
        <div class="merge-target-list" id="kanbanMergeList"></div>
      </div>
      <div class="kanban-modal-actions">
        <button class="kanban-modal-btn-merge" id="kanbanBtnMerge" onclick="toggleMergePicker()">Merge</button>
        <button class="kanban-modal-btn-delete" onclick="deleteKanbanTask()">Delete</button>
        <button class="kanban-modal-close" onclick="closeKanbanModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Keyboard hint -->
  <div class="keyboard-hint">↑↓←→ Patrol &nbsp; SPACE: Inspect &nbsp; Z: Commander</div>

  <!-- Commander popup removed — diver speech bubble replaces it -->

</div><!-- end viewport -->

<script>
// ===== CONSTANTS =====
var AGENTS = ['researcher', 'developer', 'reviewer', 'tester', 'writer'];
var DESKS = [];
var REGISTRY = {
  pm: {emoji:'\uD83E\uDD91', animal:'squid', color:'pink', color_hex:'#ff6b9d', label:'SQUID', css_class:'squid-pixel-lg'},
  researcher: {emoji:'\uD83D\uDC19', animal:'octopus', color:'cyan', color_hex:'#00d4ff', label:'Explorer', css_class:'octopus-pixel'},
  developer: {emoji:'\uD83E\uDD88', animal:'shark', color:'orange', color_hex:'#ff9f43', label:'Engineer', css_class:'shark-pixel'},
  reviewer: {emoji:'\uD83D\uDC22', animal:'turtle', color:'green', color_hex:'#26de81', label:'Reviewer', css_class:'turtle-pixel'},
  tester: {emoji:'\uD83D\uDC21', animal:'pufferfish', color:'yellow', color_hex:'#ffd32a', label:'Tester', css_class:'puffer-pixel'},
  writer: {emoji:'\uD83E\uDD9E', animal:'lobster', color:'lavender', color_hex:'#bb88ff', label:'Writer', css_class:'lobster-pixel'}
};
var DASHBOARD_CONFIG = null;  // loaded from localStorage or _config
var CONFIG_KEY = 'heysquid_dashboard_config';
var SKILL_MACHINE_DEFAULTS = {schedule:'clock', interval:'boiler', manual:'gear', webhook:'radar', event:'boiler'};
var SKILL_POSITIONS_KEY = 'heysquid_skill_positions'; // localStorage key
var POLL_INTERVAL = 3000;
var fetchFailCount = 0;
var mode = 'connecting';
var demoRunning = false;
var _prevPmAnimStatus = 'idle';
var wsPopupEl = null;
var wsPopupStage = 0; // 0=closed, 1=summary, 2=detail
var wsPopupName = null;
var currentHighlight = null;

var DEPARTMENTS = []; // dynamically populated

// ===== CONFIG MANAGEMENT =====
function loadConfig() {
  var stored = localStorage.getItem(CONFIG_KEY);
  if (stored) { try { return JSON.parse(stored); } catch(e) {} }
  return null;
}
function saveConfig(key, value) {
  var config = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
  setNestedValue(config, key, value);
  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  DASHBOARD_CONFIG = config;
}
function setNestedValue(obj, path, value) {
  var keys = path.split('.');
  var cur = obj;
  for (var i = 0; i < keys.length - 1; i++) {
    if (!cur[keys[i]] || typeof cur[keys[i]] !== 'object') cur[keys[i]] = {};
    cur = cur[keys[i]];
  }
  cur[keys[keys.length - 1]] = value;
}
function applyConfig(config) {
  if (!config) return;
  if (config.title) { var h1 = document.querySelector('.title-bar h1'); if (h1) h1.textContent = config.title; }
  if (config.subtitle) { var st = document.querySelector('.subtitle'); if (st) st.textContent = config.subtitle; }
  if (config.pm_label) { var pl = document.querySelector('.pm-label'); if (pl) pl.textContent = config.pm_label; }
  if (config.theme) applyTheme(config.theme);
  loadPmIdleSpeeches();
}
function applyTheme(theme) {
  var vp = document.querySelector('.viewport');
  if (!vp) return;
  vp.className = vp.className.replace(/\btheme-\S+/g, '');
  if (theme) vp.classList.add('theme-' + theme);
}
function takeScreenshot() {
  var btn = document.getElementById('btnScreenshot');
  if (btn) { btn.disabled = true; btn.textContent = '⏳'; }
  fetch('/api/screenshot', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok && data.image) {
        var a = document.createElement('a');
        a.href = 'data:image/png;base64,' + data.image;
        var ts = new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
        a.download = 'heysquid-hq-' + ts + '.png';
        a.click();
      } else {
        alert('Screenshot failed: ' + (data.error || 'unknown error'));
      }
    })
    .catch(function(err) {
      alert('Screenshot failed: ' + err.message);
    })
    .finally(function() {
      if (btn) { btn.disabled = false; btn.textContent = '📸'; }
    });
}

// ===== EDITABLE CLICK HANDLERS =====
function initEditables() {
  document.querySelectorAll('.editable[data-config-key]').forEach(function(el) {
    el.addEventListener('click', function(e) {
      e.stopPropagation();
      var key = el.dataset.configKey;
      var current = el.textContent;
      var newVal = prompt('Edit value:', current);
      if (newVal !== null && newVal !== current) {
        el.textContent = newVal;
        saveConfig(key, newVal);
      }
    });
  });
}

// ===== DYNAMIC AGENT POOL RENDERING =====
function renderAgentPool(registry) {
  var pool = document.getElementById('agent-pool');
  if (!pool || !registry) return;
  if (pool.dataset.rendered === 'true') return;
  var agents = Object.keys(registry).filter(function(k) { return k !== 'pm'; });
  if (agents.length === 0) return;

  // Skip re-creation if all agents already exist in DOM (static HTML + DECO dome move included)
  var allExist = agents.every(function(name) { return document.getElementById('pool-' + name); });
  if (allExist) {
    pool.dataset.rendered = 'true';
    return;
  }

  var bobSpeeds = [3, 2.5, 4, 3.5, 5];
  var bobDelays = [0, 0.3, 1, 0.7, 0.5];
  var html = '';
  agents.forEach(function(name, i) {
    var reg = registry[name];
    var config = DASHBOARD_CONFIG || {};
    var agentConfig = (config.agents || {})[name] || {};
    var label = agentConfig.label || reg.label || name;
    var colorHex = agentConfig.color_hex || reg.color_hex || '#ffffff';
    html +=
      '<div class="pool-agent" id="pool-' + name + '">' +
        '<div class="agent-speech" id="speech-' + name + '"></div>' +
        '<div style="animation: bob-slow ' + bobSpeeds[i % 5] + 's ease-in-out infinite ' + bobDelays[i % 5] + 's;">' +
          '<div class="pixel-char ' + (reg.css_class || '') + '"></div>' +
        '</div>' +
        '<div class="pool-agent-label editable" data-config-key="agents.' + name + '.label" style="color:' + colorHex + ';">' + label + '</div>' +
        '<div class="hp-bar-wrap" style="top:6px; position:relative;"><div class="hp-bar" id="hp-' + name + '"></div></div>' +
      '</div>';
  });
  pool.innerHTML = html;
  pool.dataset.rendered = 'true';

  // Bind click handlers for agent labels
  pool.querySelectorAll('.pool-agent-label.editable').forEach(function(el) {
    el.addEventListener('click', function(e) {
      e.stopPropagation();
      var key = el.dataset.configKey;
      var current = el.textContent;
      var newVal = prompt('Edit label:', current);
      if (newVal !== null && newVal !== current) {
        el.textContent = newVal;
        saveConfig(key, newVal);
      }
    });
  });

  // Agent positions in DECO mode are handled by initDecoTargets/applyDecoLayout — skip here
  try {
    var layout = JSON.parse(localStorage.getItem('heysquid_dashboard_layout')) || {};
    // Apply saved skins (character + hue) regardless of DECO mode
    if (layout.agentSkin) {
      Object.keys(layout.agentSkin).forEach(function(agentName) {
        var skin = layout.agentSkin[agentName];
        var el = document.getElementById('pool-' + agentName);
        if (!el) return;
        var charEl = el.querySelector('.pixel-char');
        if (!charEl) return;
        if (skin.char) {
          var classes = charEl.className.split(' ').filter(function(c) { return c === 'pixel-char'; });
          charEl.className = classes.join(' ') + ' ' + skin.char;
        }
        if (skin.hue !== undefined) {
          charEl.style.setProperty('--agent-hue', skin.hue + 'deg');
        }
      });
    }
  } catch(e) {}
}

// ===== SKILL MACHINES RENDERING (reconcile — create once, update in-place) =====
var lastAutomationsData = null;
var _skillElements = {};  // { skillName: DOM element } — reconcile registry

function loadSkillPositions() {
  try { return JSON.parse(localStorage.getItem(SKILL_POSITIONS_KEY)) || {}; } catch(e) { return {}; }
}
function saveSkillPositions(pos) {
  localStorage.setItem(SKILL_POSITIONS_KEY, JSON.stringify(pos));
}

// --- Reconcile helpers ---
function createSkillMachineEl(name, sk, machineType) {
  var status = sk.status || 'idle';
  var el = document.createElement('div');
  el.className = 'skill-machine';
  el.draggable = true;
  el.dataset.skill = name;
  el.dataset.status = status;
  el.title = (sk.name || name) + (sk.trigger ? ' [' + sk.trigger + ']' : '') + (sk.schedule ? ' ' + sk.schedule : '');

  var steamHtml = '';
  if (status === 'running' && machineType === 'boiler') {
    steamHtml = '<div style="position:absolute;top:-8px;left:2px;pointer-events:none;">' +
      '<div class="steam-particle"></div><div class="steam-particle"></div><div class="steam-particle"></div></div>';
  }

  el.innerHTML =
    '<div class="machine-pixel-wrap">' + steamHtml +
      '<div class="machine-pixel machine-' + machineType + ' ' + status + '"></div>' +
    '</div>' +
    '<div class="machine-lamp-dot ' + status + '"></div>' +
    '<div class="skill-label">' + (sk.name || name) + '</div>';

  return el;
}

function updateSkillMachineEl(el, sk, machineType) {
  var status = sk.status || 'idle';
  var name = el.dataset.skill;
  el.dataset.status = status;
  el.title = (sk.name || name) + (sk.trigger ? ' [' + sk.trigger + ']' : '') + (sk.schedule ? ' ' + sk.schedule : '');

  var pixel = el.querySelector('.machine-pixel');
  if (pixel) pixel.className = 'machine-pixel machine-' + machineType + ' ' + status;

  var lamp = el.querySelector('.machine-lamp-dot');
  if (lamp) lamp.className = 'machine-lamp-dot ' + status;

  var label = el.querySelector('.skill-label');
  if (label) label.textContent = sk.name || name;

  // Toggle steam for boiler
  var wrap = el.querySelector('.machine-pixel-wrap');
  if (wrap) {
    var existingSteam = wrap.querySelector('.steam-particle');
    if (status === 'running' && machineType === 'boiler' && !existingSteam) {
      var steamDiv = document.createElement('div');
      steamDiv.style.cssText = 'position:absolute;top:-8px;left:2px;pointer-events:none;';
      steamDiv.innerHTML = '<div class="steam-particle"></div><div class="steam-particle"></div><div class="steam-particle"></div>';
      wrap.insertBefore(steamDiv, wrap.firstChild);
    } else if (!(status === 'running' && machineType === 'boiler') && existingSteam) {
      var steamParent = existingSteam.parentElement;
      if (steamParent && steamParent !== wrap) steamParent.remove();
    }
  }
}

function placeSkillInContainer(el, name, positions, pmContainer) {
  var zone = positions[name] || 'pm';
  var targetContainer = null;
  if (zone !== 'pm') {
    targetContainer = document.getElementById('machines-' + zone);
  }
  if (!targetContainer) {
    targetContainer = pmContainer;
    if (zone !== 'pm') { positions[name] = 'pm'; }
  }
  if (targetContainer) targetContainer.appendChild(el);
}

function attachSkillDragHandlers(el, name) {
  var pmContainer = document.getElementById('pm-machines');
  el.addEventListener('dragstart', function(e) {
    e.dataTransfer.setData('text/plain', name);
    el.style.opacity = '0.5';
    document.querySelectorAll('.ws-machines').forEach(function(z) { z.classList.add('drop-highlight'); });
    if (pmContainer) pmContainer.classList.add('drop-highlight');
  });
  el.addEventListener('dragend', function(e) {
    el.style.opacity = '1';
    document.querySelectorAll('.ws-machines').forEach(function(z) { z.classList.remove('drop-highlight'); });
    if (pmContainer) pmContainer.classList.remove('drop-highlight');
  });
}

function initSingleDecoSkillMachine(m) {
  if (m.dataset.decoSkillDrag) return;
  m.dataset.decoSkillDrag = 'true';
  m.draggable = false;
  var skillName = m.dataset.skill;
  if (!skillName) return;

  var dome = document.getElementById('dome');
  if (!dome) return;
  var domeRect = dome.getBoundingClientRect();
  var scale = domeRect.width / 1040;
  var mRect = m.getBoundingClientRect();
  var domeLeft = Math.round((mRect.left - domeRect.left) / scale);
  var domeTop = Math.round((mRect.top - domeRect.top) / scale);

  m._originalParentId = m.parentElement ? m.parentElement.id : 'pm-machines';
  dome.appendChild(m);
  m.style.position = 'absolute';
  m.style.left = domeLeft + 'px';
  m.style.top = domeTop + 'px';
  m.style.zIndex = '150';

  decoMakeDraggable(m, 'skillPos.' + skillName);
}

// --- Main reconcile render ---
function renderSkillMachines(skills) {
  // Apply DECO machine type overrides
  var layout = loadDecoLayout();
  if (layout.skillMachineTypes) {
    Object.keys(layout.skillMachineTypes).forEach(function(name) {
      if (skills[name]) skills[name].machine = layout.skillMachineTypes[name];
    });
  }

  // Change detection
  var newData = JSON.stringify(skills);
  if (newData === JSON.stringify(lastAutomationsData)) return;
  lastAutomationsData = JSON.parse(newData);

  var positions = loadSkillPositions();
  var pmContainer = document.getElementById('pm-machines');
  var currentNames = Object.keys(skills);
  var existingNames = Object.keys(_skillElements);

  // 1. Remove deleted skills
  existingNames.forEach(function(name) {
    if (!skills[name]) {
      var el = _skillElements[name];
      if (el && el.parentElement) el.remove();
      delete _skillElements[name];
    }
  });

  // 2. Update existing / create new
  currentNames.forEach(function(name) {
    var sk = skills[name];
    var machineType = sk.machine || SKILL_MACHINE_DEFAULTS[sk.trigger] || 'boiler';

    if (_skillElements[name]) {
      // Existing — in-place update (no DOM destruction)
      updateSkillMachineEl(_skillElements[name], sk, machineType);
    } else {
      // New — create, place, attach handlers
      var el = createSkillMachineEl(name, sk, machineType);
      placeSkillInContainer(el, name, positions, pmContainer);
      attachSkillDragHandlers(el, name);
      _skillElements[name] = el;

      // If DECO is active, register new element for DECO drag
      if (decoInitialized) {
        initSingleDecoSkillMachine(el);
      }
    }
  });

  // 3. Apply saved DECO positions for newly created elements
  applyDecoSkillPositions();

  saveSkillPositions(positions);
}

// Drop zone handlers — delegated setup
function setupSkillDropZones() {
  function handleDrop(zoneName) {
    return function(e) {
      e.preventDefault();
      var skillName = e.dataTransfer.getData('text/plain');
      if (!skillName) return;
      var positions = loadSkillPositions();
      positions[skillName] = zoneName;
      saveSkillPositions(positions);
      // Re-render with current data
      lastAutomationsData = null; // force re-render
      if (window._lastAutomationsRaw) renderSkillMachines(window._lastAutomationsRaw);
    };
  }
  function allowDrop(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

  // PM machines drop zone
  var pmC = document.getElementById('pm-machines');
  if (pmC) {
    pmC.addEventListener('dragover', allowDrop);
    pmC.addEventListener('drop', handleDrop('pm'));
  }

  // Observe new ws-machines zones (created dynamically by renderWorkspaceZones)
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(m) {
      m.addedNodes.forEach(function(node) {
        if (node.nodeType !== 1) return;
        var zones = node.classList && node.classList.contains('ws-machines') ? [node] : (node.querySelectorAll ? Array.from(node.querySelectorAll('.ws-machines')) : []);
        zones.forEach(function(z) {
          var zn = z.dataset.zone;
          if (zn) {
            z.addEventListener('dragover', allowDrop);
            z.addEventListener('drop', handleDrop(zn));
          }
        });
      });
    });
  });
  observer.observe(document.body, { childList: true, subtree: true });
}
setupSkillDropZones();

// ===== WS POPUP =====
function showWorkspacePopup(deptId) {
  var wsName = deptId.replace('dept-ws-', '');
  if (!lastWsData || !lastWsData[wsName]) return;

  // If already showing summary for same workspace → upgrade to detail
  if (wsPopupEl && wsPopupStage === 1 && wsPopupName === wsName) {
    showWorkspaceDetail(wsName);
    return;
  }

  // Close any existing popup first
  hideWorkspacePopup();
  wsPopupName = wsName;
  wsPopupStage = 1;

  var ws = lastWsData[wsName];

  // Find agents assigned (via data or walking state)
  var assignedAgents = [];
  if (ws.agents && ws.agents.length > 0) {
    var emojiMap = {researcher:'🐙',developer:'🦈',reviewer:'🐢',tester:'🐡',writer:'🦞'};
    ws.agents.forEach(function(a) {
      var reg = REGISTRY[a] || {};
      assignedAgents.push((reg.emoji || emojiMap[a] || '') + ' ' + (reg.label || a));
    });
  }

  // Find skills in this workspace
  var wsSkills = [];
  if (window._lastAutomationsRaw) {
    Object.keys(window._lastAutomationsRaw).forEach(function(sk) {
      var s = window._lastAutomationsRaw[sk];
      if (s.workspace === wsName) {
        var statusIcon = s.status === 'running' ? '🔥' : '⚙️';
        wsSkills.push(statusIcon + ' ' + sk);
      }
    });
  }

  // Build summary popup (Stage 1)
  var popup = document.createElement('div');
  popup.className = 'ws-popup';
  popup.id = 'ws-popup-active';

  var desc = ws.description || wsName;
  var config = DASHBOARD_CONFIG || {};
  var wsConfig = (config.workspaces || {})[wsName] || {};
  if (wsConfig.description) desc = wsConfig.description;

  var statusLabel = (ws.status === 'active') ? '🟢 Active' : '⚫ Standby';
  var html = '<div class="ws-popup-title">' + (ws.label || wsName) + '</div>' +
    '<div style="font-size:7px;color:#88aacc;">' + desc + '</div>' +
    '<div style="margin-top:4px;">' + statusLabel + '</div>' +
    '<div style="font-size:7px;color:#446677;">last: ' + (ws.last_active || '-') + '</div>';

  if (assignedAgents.length > 0) {
    html += '<div class="ws-popup-agents">Agents: ' + assignedAgents.join(', ') + '</div>';
  } else {
    html += '<div class="ws-popup-agents" style="color:#557788;">No agents assigned</div>';
  }

  if (wsSkills.length > 0) {
    html += '<div style="margin-top:4px;font-size:7px;color:#88aacc;">Skills: ' + wsSkills.join(', ') + '</div>';
  }

  html += '<div class="ws-popup-close">[SPACE: detail] [ESC: close]</div>';
  popup.innerHTML = html;

  // Position near the diver
  var diver = document.getElementById('moving-diver');
  if (diver) {
    popup.style.left = (parseInt(diver.style.left) + 40) + 'px';
    popup.style.top = (parseInt(diver.style.top) - 60) + 'px';
  } else {
    popup.style.left = '400px';
    popup.style.top = '300px';
  }

  var dome = document.getElementById('dome');
  if (dome) dome.appendChild(popup);
  wsPopupEl = popup;
}

function showWorkspaceDetail(wsName) {
  if (!wsPopupEl) return;
  wsPopupStage = 2;

  var ws = lastWsData[wsName] || {};
  var config = DASHBOARD_CONFIG || {};
  var wsConfig = (config.workspaces || {})[wsName] || {};
  var desc = wsConfig.description || ws.description || wsName;

  // Expand popup with detail content
  var detailHtml = '<div class="ws-popup-title">' + (ws.label || wsName) + ' — Detail</div>' +
    '<div style="font-size:7px;color:#88aacc;">' + desc + '</div>' +
    '<div style="margin-top:6px;display:flex;gap:8px;">' +
    '<span class="editable" style="color:var(--cyan);font-size:7px;cursor:pointer;" onclick="editWsDescription(\'' + wsName + '\')">Edit description</span>' +
    '</div>' +
    '<div style="margin-top:8px;font-size:8px;color:var(--orange);font-family:\'Press Start 2P\',monospace;">context.md</div>' +
    '<div id="context-editor-area"><div style="font-size:7px;color:#446677;margin-top:4px;">Loading...</div></div>' +
    '<div class="ws-popup-close">[ESC: back to summary]</div>';

  wsPopupEl.innerHTML = detailHtml;

  // Load context.md
  showContextEditor(wsName);
}

function hideWorkspacePopup() {
  if (wsPopupEl) { wsPopupEl.remove(); wsPopupEl = null; }
  wsPopupStage = 0;
  wsPopupName = null;
}
function editWsDescription(wsName) {
  var current = '';
  if (DASHBOARD_CONFIG && DASHBOARD_CONFIG.workspaces && DASHBOARD_CONFIG.workspaces[wsName]) {
    current = DASHBOARD_CONFIG.workspaces[wsName].description || '';
  }
  var newDesc = prompt('Edit workspace description:', current);
  if (newDesc !== null) {
    saveConfig('workspaces.' + wsName + '.description', newDesc);
    hideWorkspacePopup();
    showWorkspacePopup('dept-ws-' + wsName);
  }
}
function showContextEditor(wsName) {
  var area = document.getElementById('context-editor-area');
  if (!area) return;
  area.innerHTML = '<div style="font-size:7px;color:#446677;margin-top:4px;">Loading...</div>';
  fetch('/api/workspace-context?name=' + encodeURIComponent(wsName))
    .then(function(r) { return r.json(); })
    .then(function(data) {
      area.innerHTML =
        '<textarea id="ctx-textarea" style="width:100%;height:80px;margin-top:4px;background:rgba(0,20,40,0.9);' +
        'border:1px solid var(--orange);color:#aabbcc;font-family:monospace;font-size:8px;padding:4px;resize:vertical;">' +
        (data.content || '').replace(/</g, '&lt;') + '</textarea>' +
        '<button onclick="saveContextMd(\'' + wsName + '\')" style="margin-top:3px;background:rgba(255,159,67,0.2);' +
        'border:1px solid var(--orange);color:var(--orange);padding:2px 8px;cursor:pointer;font-family:\'Press Start 2P\',monospace;font-size:6px;border-radius:2px;">Save</button>';
    })
    .catch(function(err) {
      area.innerHTML = '<div style="font-size:7px;color:#ff4466;margin-top:4px;">Failed to load: ' + err.message + '</div>';
    });
}
function saveContextMd(wsName) {
  var ta = document.getElementById('ctx-textarea');
  if (!ta) return;
  fetch('/api/save-workspace-context', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: wsName, content: ta.value})
  }).then(function(r) { return r.json(); }).then(function(d) {
    if (d.ok) {
      var area = document.getElementById('context-editor-area');
      if (area) area.innerHTML = '<div style="font-size:7px;color:var(--green);margin-top:4px;">Saved!</div>';
    }
  }).catch(function(err) {
    alert('Failed to save context.md: ' + err.message);
  });
}

// ===== BUBBLES =====
(function() {
  var container = document.getElementById('bubbles-container');
  function createBubble() {
    var b = document.createElement('div');
    b.className = 'bubble';
    var sz = 4 + Math.random() * 14;
    b.style.width = sz + 'px';
    b.style.height = sz + 'px';
    b.style.left = Math.random() * 1200 + 'px';
    b.style.top = (500 + Math.random() * 400) + 'px';
    b.style.animationDuration = (6 + Math.random() * 8) + 's';
    b.style.animationDelay = (Math.random() * 2) + 's';
    container.appendChild(b);
    setTimeout(function() { b.remove(); }, 16000);
  }
  for (var i = 0; i < 15; i++) setTimeout(createBubble, i * 300);
  setInterval(createBubble, 1500);
})();

// ===== FISH SILHOUETTES =====
(function() {
  var container = document.getElementById('fish-container');
  function createFish() {
    var f = document.createElement('div');
    f.className = 'fish-sil';
    var y = 80 + Math.random() * 700;
    var sz = 16 + Math.random() * 30;
    var goR = Math.random() > 0.5;
    var startX = goR ? -60 : 1260;
    var endX = goR ? 1260 : -60;
    var dur = 12 + Math.random() * 18;
    f.style.top = y + 'px';
    f.style.left = startX + 'px';
    f.style.opacity = 0.06 + Math.random() * 0.08;
    f.style.transition = 'left ' + dur + 's linear';
    f.innerHTML = '<div style="position:relative;transform:scaleX(' + (goR ? 1 : -1) + ');">' +
      '<div style="width:' + sz + 'px;height:' + (sz * 0.5) + 'px;background:#4488aa;border-radius:' + (sz * 0.4) + 'px ' + (sz * 0.3) + 'px ' + (sz * 0.3) + 'px ' + (sz * 0.4) + 'px;"></div>' +
      '<div style="position:absolute;right:-' + (sz * 0.25) + 'px;top:' + (sz * 0.05) + 'px;width:0;height:0;border-top:' + (sz * 0.2) + 'px solid transparent;border-bottom:' + (sz * 0.2) + 'px solid transparent;border-left:' + (sz * 0.3) + 'px solid #4488aa;"></div></div>';
    container.appendChild(f);
    requestAnimationFrame(function() { f.style.left = endX + 'px'; });
    setTimeout(function() { f.remove(); }, dur * 1000 + 500);
  }
  for (var i = 0; i < 4; i++) setTimeout(createFish, i * 2000);
  setInterval(createFish, 5000 + Math.random() * 4000);
})();


// ===== SCREEN FLICKER =====
setInterval(function() {
  var screens = document.querySelectorAll('.monitor-screen');
  var idx = Math.floor(Math.random() * screens.length);
  var s = screens[idx];
  if (s) {
    s.style.transition = 'opacity 0.05s';
    s.style.opacity = '0.5';
    setTimeout(function() { s.style.opacity = '1'; }, 100);
  }
}, 7000);


// ===== ARROW KEY DIVER MOVEMENT =====
(function() {
  var diver = document.getElementById('moving-diver');
  var posX = 600, posY = 580;
  var keys = {};
  var speed = 4;
  var BOUNDS = { left: 15, top: 15, right: 990, bottom: 690 };
  // currentHighlight is global (for WS popup)
  var currentDeskHighlight = null;

  document.addEventListener('keydown', function(e) {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].indexOf(e.key) !== -1) {
      e.preventDefault();
      keys[e.key] = true;
    }
  });
  document.addEventListener('keyup', function(e) { keys[e.key] = false; });

  function checkDeptCollision(cx, cy) {
    for (var i = 0; i < DEPARTMENTS.length; i++) {
      var d = DEPARTMENTS[i];
      if (cx >= d.left && cx <= d.left + d.width && cy >= d.top && cy <= d.top + d.height) {
        return d.id;
      }
    }
    return null;
  }

  // Desk bounds dynamically computed from rendered desks
  function getDeskBounds() {
    var bounds = [];
    var domeEl = document.getElementById('dome');
    if (!domeEl) return bounds;
    var domeRect = domeEl.getBoundingClientRect();
    var scale = domeRect.width / 1040;
    DESKS.forEach(function(desk) {
      var deskEl = document.getElementById('desk-' + desk);
      if (!deskEl) return;
      var r = deskEl.getBoundingClientRect();
      bounds.push({
        id: 'desk-' + desk,
        left: (r.left - domeRect.left) / scale,
        top: (r.top - domeRect.top) / scale,
        width: r.width / scale,
        height: r.height / scale
      });
    });
    return bounds;
  }

  function checkDeskProximity(cx, cy) {
    var bounds = getDeskBounds();
    for (var i = 0; i < bounds.length; i++) {
      var d = bounds[i];
      if (cx >= d.left - 20 && cx <= d.left + d.width + 20 && cy >= d.top - 20 && cy <= d.top + d.height + 20) {
        return d.id;
      }
    }
    return null;
  }

  function gameLoop() {
    var moved = false;
    if (keys['ArrowUp'])    { posY -= speed; moved = true; }
    if (keys['ArrowDown'])  { posY += speed; moved = true; }
    if (keys['ArrowLeft'])  { posX -= speed; moved = true; }
    if (keys['ArrowRight']) { posX += speed; moved = true; }

    posX = Math.max(BOUNDS.left, Math.min(BOUNDS.right, posX));
    posY = Math.max(BOUNDS.top, Math.min(BOUNDS.bottom, posY));

    if (moved) {
      diver.style.left = posX + 'px';
      diver.style.top = posY + 'px';
    }

    // Department highlight
    var centerX = posX + 24;
    var centerY = posY + 24;
    var hit = checkDeptCollision(centerX, centerY);

    if (hit !== currentHighlight) {
      if (currentHighlight) document.getElementById(currentHighlight).classList.remove('highlighted');
      if (hit) document.getElementById(hit).classList.add('highlighted');
      currentHighlight = hit;
      // Close WS popup if diver moved away
      if (!hit && wsPopupEl) hideWorkspacePopup();
    }

    // Desk proximity highlight
    var deskHit = checkDeskProximity(centerX, centerY);
    if (deskHit !== currentDeskHighlight) {
      if (currentDeskHighlight) document.getElementById(currentDeskHighlight).classList.remove('desk-highlight');
      if (deskHit) document.getElementById(deskHit).classList.add('desk-highlight');
      currentDeskHighlight = deskHit;
    }

    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);
})();

// ===== TIME HELPER =====
function getTime() {
  var d = new Date();
  return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0');
}

// ===== CONNECTION STATUS =====
function setConnectionStatus(newMode) {
  mode = newMode;
  var dot = document.getElementById('connDot');
  var label = document.getElementById('connLabel');
  var btn = document.getElementById('btnDemo');
  dot.className = 'conn-dot-status';
  if (newMode === 'live') {
    dot.classList.add('live');
    label.textContent = 'LIVE';
    label.style.color = '#26de81';
    btn.style.display = 'none';
  } else if (newMode === 'demo') {
    dot.classList.add('demo');
    label.textContent = 'DEMO';
    label.style.color = '#ffd32a';
    btn.style.display = 'inline-block';
  } else {
    label.textContent = 'Connecting...';
    label.style.color = '#5599aa';
    btn.style.display = 'none';
  }
}

// ===== SVG LINE ACTIVATION =====
function setLineActive() {} // dead code — connection lines removed

// ===== HP BAR COLOR =====
function hpColor(value) {
  if (value >= 60) return '#26de81';
  if (value >= 30) return '#ffd32a';
  return '#ff3c3c';
}

// ===== DISPATCH AGENT TO DESK =====
function dispatchAgent(agent, desk) {
  var poolEl = document.getElementById('pool-' + agent);
  var slotEl = document.getElementById('slot-' + desk);
  var deskEl = document.getElementById('desk-' + desk);
  if (!poolEl || !slotEl || !deskEl) return;

  // Skip dispatch in DECO mode
  if (poolEl.dataset.decoDrag) return;

  // Already walking? Skip
  if (poolEl.classList.contains('walking')) return;

  // Already at this desk? Just ensure desk state is correct
  if (poolEl.dataset.walkedTo === desk) {
    // Re-position in case layout shifted
    deskEl.classList.add('occupied');
    var rect = slotEl.getBoundingClientRect();
    poolEl.classList.add('at-desk');
    poolEl.style.position = 'fixed';
    poolEl.style.left = rect.left + 'px';
    poolEl.style.top = rect.top + 'px';
    poolEl.style.margin = '0';
    slotEl.dataset.agent = agent;
    setLineActive(desk, true);
    return;
  }

  // Ensure slot is visible for measuring (it's display:none when desk not occupied)
  deskEl.classList.add('occupied');
  var startRect = poolEl.getBoundingClientRect();
  var endRect = slotEl.getBoundingClientRect();
  var dx = endRect.left - startRect.left;
  var dy = endRect.top - startRect.top;
  var destLeft = endRect.left;
  var destTop = endRect.top;
  deskEl.classList.remove('occupied');

  // Start swimming
  poolEl.style.position = 'fixed';
  poolEl.style.left = startRect.left + 'px';
  poolEl.style.top = startRect.top + 'px';
  poolEl.style.margin = '0';
  poolEl.classList.add('walking');

  // Trigger transition on next frame
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      poolEl.style.transform = 'translate(' + dx + 'px, ' + dy + 'px)';
    });
  });

  // On arrival — keep pool element visible at desk (no swap)
  function onArrival(e) {
    if (e.propertyName !== 'transform') return;
    poolEl.removeEventListener('transitionend', onArrival);
    poolEl.classList.remove('walking');
    poolEl.classList.add('at-desk');
    poolEl.dataset.walkedTo = desk;
    // Settle at destination (remove transform, set final position)
    poolEl.style.left = destLeft + 'px';
    poolEl.style.top = destTop + 'px';
    poolEl.style.transform = '';

    // Mark desk as occupied (for monitor glow etc) but no new element in slot
    slotEl.dataset.agent = agent;
    deskEl.classList.add('occupied');
    setLineActive(desk, true);
  }

  poolEl.addEventListener('transitionend', onArrival);
  showPmSpeech('dispatching');
}

// ===== RECALL AGENT FROM DESK =====
function recallAgent(agent) {
  var poolEl = document.getElementById('pool-' + agent);
  if (poolEl) {
    poolEl.classList.remove('dispatched', 'at-desk', 'walking');
    // Skip position reset in DECO mode
    if (poolEl.dataset.decoDrag) return;
    // Normal mode: restore flex (DECO position only applies in DECO mode)
    poolEl.style.position = '';
    poolEl.style.left = '';
    poolEl.style.top = '';
    poolEl.style.margin = '';
    poolEl.style.transform = '';
    delete poolEl.dataset.walkedTo;
  }

  // Clear from any desk
  DESKS.forEach(function(desk) {
    var slotEl = document.getElementById('slot-' + desk);
    if (slotEl && slotEl.dataset.agent === agent) {
      slotEl.innerHTML = '';
      slotEl.dataset.agent = '';
      document.getElementById('desk-' + desk).classList.remove('occupied');
      document.getElementById('desk-' + desk).className =
        document.getElementById('desk-' + desk).className.replace(/\bstatus-\w+/g, '');
      var hpWrap = document.getElementById('hp-wrap-' + desk);
      if (hpWrap) hpWrap.style.display = 'none';
      setLineActive(desk, false);
    }
  });
  showPmSpeech('complete');
}

// ===== LOAD DASHBOARD DATA =====
function loadDashboardData(data) {
  if (!data) return;

  // Update registry FIRST (defines AGENTS list)
  if (data._registry) {
    REGISTRY = data._registry;
    var newAgents = Object.keys(REGISTRY).filter(function(k) { return k !== 'pm'; });
    if (newAgents.length > 0) AGENTS = newAgents;
    renderAgentPool(REGISTRY);
  }

  // Apply config from data or localStorage
  if (!DASHBOARD_CONFIG) {
    DASHBOARD_CONFIG = loadConfig();
    if (!DASHBOARD_CONFIG && data._config) {
      DASHBOARD_CONFIG = data._config;
    }
    applyConfig(DASHBOARD_CONFIG);
    initEditables();
  }

  // Render workspace zones BEFORE agent dispatch (creates desk DOM elements)
  if (data.workspaces) {
    renderWorkspaceZones(data.workspaces);
  }

  // Skill machines
  if (data.automations) {
    window._lastAutomationsRaw = data.automations;
    renderSkillMachines(data.automations);
  }

  // Clear all desk slots
  DESKS.forEach(function(desk) {
    var slotEl = document.getElementById('slot-' + desk);
    var deskEl = document.getElementById('desk-' + desk);
    if (slotEl) {
      slotEl.innerHTML = '';
      slotEl.dataset.agent = '';
    }
    if (deskEl) {
      deskEl.classList.remove('occupied');
      deskEl.className = deskEl.className.replace(/\bstatus-\w+/g, '');
      var hpWrap = document.getElementById('hp-wrap-' + desk);
      if (hpWrap) hpWrap.style.display = 'none';
      setLineActive(desk, false);
    }
  });

  // Reset all pool agents
  var _decoSaved = loadDecoLayout();
  AGENTS.forEach(function(agent) {
    var poolEl = document.getElementById('pool-' + agent);
    if (!poolEl) return;
    var info = data[agent];
    var hasAssignment = info && info.assignment && (info.status === 'working' || info.status === 'complete' || info.status === 'error');
    if (!hasAssignment) {
      // Agent returning to pool — clear walk state
      poolEl.classList.remove('dispatched', 'walking', 'at-desk');
      // Do not modify position for agents placed in DECO layout
      if (poolEl.dataset.decoDrag) return;
      poolEl.style.position = '';
      poolEl.style.left = '';
      poolEl.style.top = '';
      poolEl.style.margin = '';
      poolEl.style.transform = '';
      delete poolEl.dataset.walkedTo;
    } else {
      poolEl.classList.remove('dispatched');
    }
  });

  // Process each agent
  AGENTS.forEach(function(agent) {
    var info = data[agent];
    if (!info) return;

    var hpValue = (typeof info.hp === 'number') ? info.hp : 100;

    // Pool HP bar
    var poolHp = document.getElementById('hp-' + agent);
    if (poolHp) {
      poolHp.style.width = hpValue + '%';
      poolHp.style.background = hpColor(hpValue);
    }

    // Dispatch if assigned and working
    var assignment = info.assignment;
    var status = info.status || 'idle';

    if (assignment && (status === 'working' || status === 'complete' || status === 'error')) {
      dispatchAgent(agent, assignment);

      // Set desk status class
      var deskEl = document.getElementById('desk-' + assignment);
      if (deskEl && status !== 'idle') {
        deskEl.classList.add('status-' + status);
      }

      // Desk HP bar
      var deskHp = document.getElementById('hp-desk-' + assignment);
      if (deskHp) {
        deskHp.style.width = hpValue + '%';
        deskHp.style.background = hpColor(hpValue);
      }
    }
  });

  // Mission log → agent speech bubbles (PM + pool agents)
  if (data.mission_log && Array.isArray(data.mission_log)) {
    var agentSpeechMap = {
      'pm': 'pm-speech',
      'researcher': 'speech-researcher',
      'developer': 'speech-developer',
      'reviewer': 'speech-reviewer',
      'tester': 'speech-tester',
      'writer': 'speech-writer'
    };
    function truncMsg(m) { return m.length > 25 ? m.slice(0,25) + '...' : m; }

    // Collect last 5 messages per agent (with spam filter)
    var agentRecentMsgs = {};
    for (var li = 0; li < data.mission_log.length; li++) {
      var entry = data.mission_log[li];
      if (agentSpeechMap[entry.agent]) {
        // Skip spam messages
        if (entry.message.indexOf('python3 -c') !== -1) continue;
        if (entry.message.indexOf('python3 -u -c') !== -1) continue;
        if (/💻\s*(python3|wc|cat|head|tail|ls)\s/.test(entry.message)) continue;
        if (!agentRecentMsgs[entry.agent]) agentRecentMsgs[entry.agent] = [];
        agentRecentMsgs[entry.agent].push(entry.message);
      }
    }
    Object.keys(agentRecentMsgs).forEach(function(agent) {
      agentRecentMsgs[agent] = agentRecentMsgs[agent].slice(-5);
    });

    // Update speech bubbles
    Object.keys(agentSpeechMap).forEach(function(agent) {
      var el = document.getElementById(agentSpeechMap[agent]);
      if (!el) return;
      var msgs = agentRecentMsgs[agent] || [];
      if (msgs.length === 0) return;
      var isWorking = (data[agent] || {}).status === 'working';
      var msgsKey = msgs.join('|');

      if (isWorking && msgs.length > 1) {
        // Cycling mode — rotate through recent messages
        el.classList.add('visible');
        clearTimeout(el._hideTimer);
        el._hideTimer = null;
        if (el._msgsKey !== msgsKey) {
          el._msgsKey = msgsKey;
          clearInterval(el._cycleTimer);
          el._cycleIdx = 0;
          el.textContent = truncMsg(msgs[0]);
          el.classList.remove('fading');
          el._cycleTimer = setInterval(function() {
            el._cycleIdx = (el._cycleIdx + 1) % msgs.length;
            el.classList.add('fading');
            setTimeout(function() {
              el.textContent = truncMsg(msgs[el._cycleIdx]);
              el.classList.remove('fading');
            }, 200);
          }, 800);
        }
      } else {
        // Static mode (idle or single message)
        clearInterval(el._cycleTimer);
        el._cycleTimer = null;
        el._msgsKey = null;
        var msg = msgs[msgs.length - 1];
        if (el._lastLogMsg !== msg) {
          el._lastLogMsg = msg;
          el.textContent = truncMsg(msg);
          el.classList.add('visible');
          el.classList.remove('fading');
        }
        clearTimeout(el._hideTimer);
        if (isWorking) {
          el._hideTimer = null;
          el.classList.add('visible');
        } else {
          el._hideTimer = setTimeout(function() {
            el.classList.remove('visible');
          }, 5000);
        }
      }
    });
  }

  // Current task
  var taskEl = document.getElementById('currentTask');
  if (data.current_task) {
    taskEl.textContent = data.current_task;
    taskEl.style.color = '#77eeff';
  } else {
    taskEl.textContent = 'Standby';
    taskEl.style.color = '#5599aa';
  }

  // Last updated
  var lu = document.getElementById('lastUpdated');
  if (data.last_updated) lu.textContent = data.last_updated;
  else lu.textContent = getTime();

  // (registry, config, workspaces, skills already rendered at top of function)

  // --- Integrated: PM current_task speech (was monkey-patch 1) ---
  if (data.current_task) {
    pmReportBusy = true;
    stopPmIdleReport();
    var pmSpeechEl = document.getElementById('pm-speech');
    if (pmSpeechEl) {
      pmSpeechEl.textContent = data.current_task;
      pmSpeechEl.classList.add('visible');
      setTimeout(function() { pmSpeechEl.classList.remove('visible'); }, 5000);
    }
  } else {
    pmReportBusy = false;
    startPmIdleReport();
  }

  // --- Integrated: PM status animation (was monkey-patch 2) ---
  if (data.pm) {
    var st = data.pm.status || 'idle';
    if (st !== _prevPmAnimStatus) {
      var pmChar = document.querySelector('#pm-area .squid-pixel-lg');
      var pmWrap = pmChar ? pmChar.parentElement : null;
      if (pmWrap) {
        if (st === 'working') {
          pmWrap.style.animation = 'bob-work 1.5s ease-in-out infinite';
          AGENTS.forEach(function(a) {
            var el = document.getElementById('pool-' + a);
            if (el && !el.classList.contains('walking') && !el.classList.contains('at-desk')) {
              el.style.transition = 'transform 0.3s';
              el.style.transform = 'translateY(-3px)';
              setTimeout(function() { el.style.transform = ''; }, 600);
            }
          });
        } else {
          pmWrap.style.animation = 'bob 2.5s ease-in-out infinite';
        }
      }
      _prevPmAnimStatus = st;
    }
  }

  // --- Squad discussion visualization ---
  if (data.squad_log && data.squad_log.status === 'active' && data.squad_log.entries) {
    var entries = data.squad_log.entries;
    var typeIcons = {opinion:'💬', agree:'👍', disagree:'👎', risk:'⚠️', proposal:'💡', conclusion:'🏁'};
    // Show last entry per agent as speech bubble
    var lastPerAgent = {};
    entries.forEach(function(e) {
      lastPerAgent[e.agent] = e;
    });
    Object.keys(lastPerAgent).forEach(function(agent) {
      var e = lastPerAgent[agent];
      var icon = typeIcons[e.type] || '💬';
      var bubbleId = null;
      // Map agent to speech bubble
      if (agent === 'pm') bubbleId = 'pm-speech';
      else if (agent.indexOf('kraken:') === 0) return; // Kraken crew — skip for now
      else bubbleId = 'speech-' + agent;
      var el = document.getElementById(bubbleId);
      if (el) {
        el.textContent = icon + ' ' + (e.message.length > 30 ? e.message.slice(0,30) + '...' : e.message);
        el.classList.add('visible');
      }
    });
  }
}

// ===== PM SPEECH BUBBLE =====
var PM_SPEECHES = {
  idle: [
    "Don't make me angry...",
    "Is there no perfect agent?",
    "I see everything.",
    "You don't want to see me angry...",
    "The kraken sleeps... for now."
  ],
  dispatching: [
    "Deploy! Dive dive dive!",
    "Agent deployed to sector",
    "Torpedo away!",
    "Launching mission pod",
    "You have your orders"
  ],
  working: [
    "Depth charge in progress...",
    "Smooth sailing at 200m",
    "Hull integrity holding",
    "Sonar contact — tracking...",
    "Almost at target depth"
  ],
  complete: [
    "Surface! Mission accomplished!",
    "Target neutralized!",
    "All hands — well done!",
    "Returning to base",
    "Ink cloud deployed ✓"
  ],
  error: [
    "Leak detected!",
    "Pressure breach!",
    "Mayday mayday!",
    "Emergency surface!"
  ],
  demo: [
    "Watch this, Captain!",
    "Demo sequence initiated",
    "Simulation running..."
  ]
};

function showPmSpeech(category) {
  var el = document.getElementById('pm-speech');
  if (!el) return;
  var msgs = PM_SPEECHES[category] || PM_SPEECHES.idle;
  el.textContent = msgs[Math.floor(Math.random() * msgs.length)];
  el.classList.add('visible');
  setTimeout(function() { el.classList.remove('visible'); }, 3000);
}

// ===== SKILL MACHINE STATUS POPUP (normal mode) =====
var _skillPopupEl = null;
document.addEventListener('click', function(e) {
  // Close existing popup on any click
  if (_skillPopupEl && !e.target.closest('.skill-status-popup')) {
    _skillPopupEl.remove(); _skillPopupEl = null;
  }
  // Only in normal mode (not DECO)
  if (decoMode) return;
  var machine = e.target.closest('.skill-machine');
  if (!machine) return;
  var skillName = machine.dataset.skill;
  if (!skillName || !window._lastAutomationsRaw || !window._lastAutomationsRaw[skillName]) return;

  var skill = window._lastAutomationsRaw[skillName];
  var popup = document.createElement('div');
  popup.className = 'skill-status-popup';
  popup.style.cssText = 'position:absolute;z-index:300;background:rgba(5,15,40,0.95);border:1px solid var(--orange);border-radius:6px;padding:10px;min-width:200px;font-size:8px;color:#aabbcc;box-shadow:0 0 15px rgba(255,159,67,0.2);';

  var statusIcon = skill.status === 'running' ? '🔥 Running' : skill.status === 'error' ? '❌ Error' : '⚙️ Idle';
  var html = '<div style="font-size:9px;color:var(--orange);margin-bottom:6px;font-family:\'Press Start 2P\',monospace;">' + skillName + '</div>' +
    '<div>Status: ' + statusIcon + '</div>' +
    '<div>Trigger: ' + (skill.trigger || '-') + '</div>';
  if (skill.schedule) html += '<div>Schedule: ' + skill.schedule + '</div>';
  if (skill.last_run) html += '<div>Last run: ' + skill.last_run + '</div>';
  if (skill.next_run) html += '<div>Next run: ' + skill.next_run + '</div>';
  if (skill.last_result) html += '<div>Result: ' + (skill.last_result === 'success' ? '✅' : '❌') + ' ' + skill.last_result + '</div>';
  if (skill.last_error) html += '<div style="color:#ff4466;">Error: ' + skill.last_error + '</div>';
  html += '<div>Run count: ' + (skill.run_count || 0) + '</div>';
  html += '<div style="font-size:6px;color:#446677;margin-top:4px;">[click elsewhere to close]</div>';

  popup.innerHTML = html;

  // Position near the machine
  var dome = document.getElementById('dome');
  var domeRect = dome.getBoundingClientRect();
  var mRect = machine.getBoundingClientRect();
  var scale = domeRect.width / 1040;
  popup.style.left = Math.round((mRect.left - domeRect.left) / scale) + 'px';
  popup.style.top = Math.round((mRect.top - domeRect.top) / scale - 100) + 'px';

  dome.appendChild(popup);
  _skillPopupEl = popup;
  e.stopPropagation();
});

// ===== POLLING =====
function pollStatus() {
  fetch('./agent_status.json?t=' + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      fetchFailCount = 0;
      if (mode !== 'live') setConnectionStatus('live');
      loadDashboardData(data);
    })
    .catch(function() {
      fetchFailCount++;
      if (fetchFailCount >= 1 && mode !== 'demo') {
        setConnectionStatus('demo');
      }
    });
}

setConnectionStatus('connecting');
pollStatus();
setInterval(pollStatus, POLL_INTERVAL);

// ===== DEMO MODE =====
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

async function runDemo() {
  if (demoRunning) return;
  demoRunning = true;
  var btn = document.getElementById('btnDemo');
  btn.disabled = true;
  btn.textContent = 'RUNNING...';

  var base = {
    last_updated: getTime(), current_task: '',
    researcher: {status:'idle',task:'',hp:100,assignment:null},
    developer: {status:'idle',task:'',hp:100,assignment:null},
    reviewer: {status:'idle',task:'',hp:100,assignment:null},
    tester: {status:'idle',task:'',hp:100,assignment:null},
    writer: {status:'idle',task:'',hp:100,assignment:null},
    workspaces: {
      'project-a': {status:'active', description:'Main project', last_active: new Date().toISOString().slice(0,10)},
      'project-b': {status:'standby', description:'Side project', last_active: new Date().toISOString().slice(0,10)}
    },
    automations: {
      'briefing': {name:'briefing', description:'Daily briefing', trigger:'schedule', schedule:'09:00', status:'idle', next_run:'2026-02-21T09:00:00', run_count:3, last_result:'success', enabled:true, machine:'clock'},
      'deploy': {name:'deploy', description:'Auto deploy', trigger:'manual', schedule:'', status:'idle', next_run:null, run_count:0, last_result:null, enabled:true, machine:'gear'},
      'webhook': {name:'webhook', description:'Webhook listener', trigger:'webhook', schedule:'', status:'idle', next_run:null, run_count:5, last_result:'success', enabled:true, machine:'radar'},
      'report': {name:'report', description:'Generate report', trigger:'manual', schedule:'', status:'idle', next_run:null, run_count:2, last_result:'success', enabled:true, machine:'printer'},
      'monitor': {name:'monitor', description:'Health check', trigger:'schedule', schedule:'*/30 *', status:'idle', next_run:null, run_count:10, last_result:'success', enabled:true, machine:'boiler'}
    },
    mission_log: [{time: getTime(), agent: 'system', message: 'Demo sequence initiated'}],
    _registry: REGISTRY
  };
  loadDashboardData(base);
  showPmSpeech('demo');
  await sleep(1000);

  function snap(overrides, logs) {
    var d = JSON.parse(JSON.stringify(base));
    d.last_updated = getTime();
    Object.keys(overrides).forEach(function(k) {
      if (d[k] && typeof overrides[k] === 'object') Object.assign(d[k], overrides[k]);
      else d[k] = overrides[k];
    });
    if (logs) d.mission_log = logs;
    return d;
  }
  var logs = [{time: getTime(), agent: 'system', message: 'Demo sequence initiated'}];

  // [1s] Researcher + Developer dispatched to workspace desks
  logs.push({time: getTime(), agent: 'pm', message: 'Dual deploy \u2014 Explorer + Engineer!'});
  logs.push({time: getTime(), agent: 'researcher', message: 'Diving to analyze structure...'});
  logs.push({time: getTime(), agent: 'developer', message: 'Spinning up engine...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'working', task:'Analysis', hp:45, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:55, assignment:'project-b'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  // [3s] Researcher HP recovering
  logs.push({time: getTime(), agent: 'researcher', message: 'Sonar lock \u2014 3 targets acquired!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'working', task:'Target lock', hp:70, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:40, assignment:'project-b'}
  }, logs));
  showPmSpeech('working');
  await sleep(2000);

  // [5s] Researcher complete
  logs.push({time: getTime(), agent: 'researcher', message: 'Analysis complete!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'complete', task:'Done', hp:100, assignment:'project-a'},
    developer: {status:'working', task:'Engine', hp:30, assignment:'project-b'}
  }, logs));
  await sleep(1000);

  // Researcher returns to pool
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'idle', task:'', hp:100, assignment:null},
    developer: {status:'working', task:'Engine', hp:45, assignment:'project-b'}
  }, logs));
  await sleep(500);

  // [6s] Reviewer dispatched
  logs.push({time: getTime(), agent: 'pm', message: 'Launching Reviewer \u2014 quality check'});
  logs.push({time: getTime(), agent: 'reviewer', message: 'Intercepting code for review...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    researcher: {status:'idle', task:'', hp:100, assignment:null},
    developer: {status:'working', task:'Engine', hp:60, assignment:'project-b'},
    reviewer: {status:'working', task:'Code review', hp:70, assignment:'project-a'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  // [8s] Developer complete
  logs.push({time: getTime(), agent: 'developer', message: 'Engine deployed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    developer: {status:'complete', task:'Done', hp:100, assignment:'project-b'},
    reviewer: {status:'working', task:'Review', hp:85, assignment:'project-a'}
  }, logs));
  await sleep(1000);

  // Developer returns
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    developer: {status:'idle', task:'', hp:100, assignment:null},
    reviewer: {status:'working', task:'Review', hp:90, assignment:'project-a'}
  }, logs));
  await sleep(500);

  // [9s] Reviewer -> Tester
  logs.push({time: getTime(), agent: 'reviewer', message: 'All checks passed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    reviewer: {status:'complete', task:'Reviewed', hp:100, assignment:'project-a'}
  }, logs));
  await sleep(800);

  logs.push({time: getTime(), agent: 'tester', message: 'Running tests...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    reviewer: {status:'idle', task:'', hp:100, assignment:null},
    tester: {status:'working', task:'Tests', hp:65, assignment:'project-a'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(1500);

  // Tester complete
  logs.push({time: getTime(), agent: 'tester', message: 'All tests passed!'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    tester: {status:'complete', task:'Passed', hp:100, assignment:'project-a'}
  }, logs));
  await sleep(800);

  // Writer
  logs.push({time: getTime(), agent: 'writer', message: 'Composing content...'});
  loadDashboardData(snap({
    current_task: 'Project-A automation',
    tester: {status:'idle', task:'', hp:100, assignment:null},
    writer: {status:'working', task:'Content', hp:80, assignment:'project-b'}
  }, logs));
  showPmSpeech('dispatching');
  await sleep(2000);

  logs.push({time: getTime(), agent: 'writer', message: 'Content ready!'});
  loadDashboardData(snap({
    writer: {status:'complete', task:'Done', hp:100, assignment:'project-b'}
  }, logs));
  showPmSpeech('complete');
  await sleep(800);

  // Skill demo
  logs.push({time: getTime(), agent: 'pm', message: 'Running briefing skill...'});
  var skillSnap = snap({current_task: ''}, logs);
  skillSnap.writer = {status:'idle',task:'',hp:100,assignment:null};
  skillSnap.skills.briefing.status = 'running';
  loadDashboardData(skillSnap);
  await sleep(1500);

  logs.push({time: getTime(), agent: 'system', message: 'Briefing complete!'});
  skillSnap = snap({current_task: ''}, logs);
  skillSnap.skills.briefing.status = 'idle';
  skillSnap.skills.briefing.last_result = 'success';
  skillSnap.skills.briefing.run_count = 4;
  loadDashboardData(skillSnap);
  await sleep(1000);

  // All idle
  logs.push({time: getTime(), agent: 'system', message: 'Mission accomplished!'});
  loadDashboardData(snap({
    current_task: '',
    researcher: {status:'idle',task:'',hp:100,assignment:null},
    developer: {status:'idle',task:'',hp:100,assignment:null},
    reviewer: {status:'idle',task:'',hp:100,assignment:null},
    tester: {status:'idle',task:'',hp:100,assignment:null},
    writer: {status:'idle',task:'',hp:100,assignment:null}
  }, logs));

  await sleep(2000);
  demoRunning = false;
  btn.disabled = false;
  btn.textContent = 'DEMO';
}
// ===== FEATURE 1: ENTRANCE ANIMATION =====
(function() {
  var poolAgents = [
    { id: 'pool-researcher', speechId: 'speech-researcher' },
    { id: 'pool-developer',  speechId: 'speech-developer' },
    { id: 'pool-reviewer',   speechId: 'speech-reviewer' },
    { id: 'pool-tester',     speechId: 'speech-tester' },
    { id: 'pool-writer',     speechId: 'speech-writer' }
  ];

  setTimeout(function() {
    poolAgents.forEach(function(agent, idx) {
      setTimeout(function() {
        var el = document.getElementById(agent.id);
        if (el) {
          el.classList.add('entrance-anim');
          setTimeout(function() { el.classList.remove('entrance-anim'); }, 700);
        }
        // Show agent speech bubble
        var speechEl = document.getElementById(agent.speechId);
        if (speechEl) {
          speechEl.textContent = 'Commander on deck!';
          speechEl.classList.add('visible');
          setTimeout(function() { speechEl.classList.remove('visible'); }, 1500);
        }
      }, idx * 400);
    });

    // PM speech after all agents bounce
    setTimeout(function() {
      var el = document.getElementById('pm-speech');
      if (el) {
        el.textContent = 'Crew assembled. Awaiting orders.';
        el.classList.add('visible');
        setTimeout(function() { el.classList.remove('visible'); }, 3000);
      }
    }, poolAgents.length * 400 + 200);
  }, 1000);
})();

// ===== FEATURE 2: PM IDLE REPORT (Commander character lines) =====
// PM idle speeches — loaded from config, with hardcoded fallback
var PM_IDLE_DEFAULTS = [
  "Don't make me angry...",
  "Is there no perfect agent?",
  "I see everything.",
  "The kraken sleeps... for now.",
  "Don't test my patience."
];
var pmIdleLines = PM_IDLE_DEFAULTS;
function loadPmIdleSpeeches() {
  var config = DASHBOARD_CONFIG || loadConfig();
  if (config && config.pm_idle_speeches && config.pm_idle_speeches.length > 0) {
    pmIdleLines = config.pm_idle_speeches;
  }
}
// Will be called after config is loaded
var pmIdleIdx = 0;
var pmIdleTimer = null;
var pmReportBusy = false;

function startPmIdleReport() {
  if (pmIdleTimer) return;
  pmIdleTimer = setInterval(function() {
    if (pmReportBusy) return;
    var el = document.getElementById('pm-speech');
    if (!el) return;
    if (el.classList.contains('visible')) return;
    var line = pmIdleLines[pmIdleIdx % pmIdleLines.length];
    pmIdleIdx++;
    el.textContent = line;
    el.classList.add('visible');
    setTimeout(function() { el.classList.remove('visible'); }, 5000);
  }, 30000);
}
function stopPmIdleReport() {
  if (pmIdleTimer) { clearInterval(pmIdleTimer); pmIdleTimer = null; }
}

// Start idle report by default
startPmIdleReport();

// ===== FEATURE 3: KEYBOARD INTERACTION =====
var interactionCooldown = false;

// Z key — Commander's words (flinch) — moved from Space
document.addEventListener('keydown', function(e) {
  if (e.key !== 'z' && e.key !== 'Z') return;
  e.preventDefault();
  if (interactionCooldown) return;
  interactionCooldown = true;

  // Read diver effects from config
  var config = DASHBOARD_CONFIG || {};
  var effects = config.diver_effects || {};
  var bubbleDuration = effects.bubble_duration || 2000;
  var flinchEnabled = effects.flinch_enabled !== false;
  var pmReaction = effects.pm_reaction || '...';

  // 1. Show diver speech bubble
  var diverBubble = document.getElementById('diver-speech');
  if (diverBubble) {
    diverBubble.textContent = getDiverQuote();
    diverBubble.classList.remove('visible');
    void diverBubble.offsetWidth;
    diverBubble.classList.add('visible');
  }

  // 2. Flinch pool agents (configurable)
  if (flinchEnabled) {
    var poolIds = AGENTS.map(function(a) { return 'pool-' + a; });
    poolIds.forEach(function(id) {
      var el = document.getElementById(id);
      if (el && !el.classList.contains('walking') && !el.classList.contains('at-desk')) {
        el.classList.add('flinch');
        setTimeout(function() { el.classList.remove('flinch'); }, 400);
      }
    });
  }

  // 3. PM reaction (configurable)
  var pmEl = document.getElementById('pm-speech');
  if (pmEl) {
    pmEl.textContent = pmReaction;
    pmEl.classList.add('visible');
    setTimeout(function() { pmEl.classList.remove('visible'); }, bubbleDuration);
  }

  // 4. Fade out diver bubble
  setTimeout(function() {
    if (diverBubble) diverBubble.classList.remove('visible');
  }, bubbleDuration);

  // 5. Cooldown 3s
  setTimeout(function() { interactionCooldown = false; }, 3000);
});

document.addEventListener('keydown', function(e) {
  if (e.key !== ' ') return;
  e.preventDefault();
  // Stage 2 (detail) → close
  if (wsPopupEl && wsPopupStage === 2) { hideWorkspacePopup(); return; }
  // Stage 1 (summary) → upgrade to detail
  if (wsPopupEl && wsPopupStage === 1 && wsPopupName) { showWorkspaceDetail(wsPopupName); return; }
  // No popup → open summary if near workspace
  if (currentHighlight) { showWorkspacePopup(currentHighlight); return; }
});
// ESC — step back: detail→summary→close
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Escape' || !wsPopupEl) return;
  if (wsPopupStage === 2 && wsPopupName) {
    // Back to summary
    wsPopupEl.remove(); wsPopupEl = null; wsPopupStage = 0;
    showWorkspacePopup('dept-ws-' + wsPopupName);
  } else {
    hideWorkspacePopup();
  }
});

// ===== DYNAMIC WORKSPACE ZONES =====
var lastWsData = null;
function _updateDecoWsStatus(workspaces) {
  var wsNames = Object.keys(workspaces);
  wsNames.forEach(function(name) {
    var ws = workspaces[name];
    var status = ws.status || 'standby';
    var zone = document.getElementById('dept-ws-' + name);
    if (!zone) return;
    // Update status class (ws-active, ws-standby, etc.)
    zone.className = zone.className.replace(/\bws-\w+/g, '').trim();
    zone.classList.add('workspace-zone', 'ws-' + status);
    // Update status dot
    var dot = zone.querySelector('.ws-status-dot');
    if (dot) { dot.className = 'ws-status-dot ' + status; }
    // Update meta
    var meta = zone.querySelector('.ws-meta');
    if (meta) { meta.textContent = 'last: ' + (ws.last_active || '-'); }
  });
}

function renderWorkspaceZones(workspaces) {
  if (JSON.stringify(workspaces) === JSON.stringify(lastWsData)) return;
  lastWsData = JSON.parse(JSON.stringify(workspaces));

  var container = document.getElementById('workspace-zones');
  if (!container) return;

  var wsNames = Object.keys(workspaces);
  if (wsNames.length === 0) {
    container.innerHTML = '<div class="no-workspaces">No workspaces</div>';
    DESKS = [];
    DEPARTMENTS = [];
    return;
  }

  container.innerHTML = '';
  var wasDraggable = container.classList.contains('deco-draggable');
  container.className = 'workspace-zones-container';
  if (wasDraggable) container.classList.add('deco-draggable');
  if (wsNames.length <= 2) container.classList.add('cols-' + wsNames.length);
  else if (wsNames.length <= 4) container.classList.add('cols-2x2');
  else container.classList.add('cols-3');

  // Update dynamic DESKS
  DESKS = wsNames.slice();

  wsNames.forEach(function(name, idx) {
    var ws = workspaces[name];
    var status = ws.status || 'standby';
    var displayName = ws.label || name;
    var agentBadgesHtml = '';
    if (ws.agents && ws.agents.length > 0) {
      var emojiMap = {researcher:'🐙',developer:'🦈',reviewer:'🐢',tester:'🐡',writer:'🦞'};
      agentBadgesHtml = '<div class="ws-agents" data-ws="' + name + '">' +
        ws.agents.map(function(a) { return '<span class="ws-agent-badge" title="' + a + '">' + (emojiMap[a]||a) + '</span>'; }).join('') +
        '</div>';
    }
    var zone = document.createElement('div');
    zone.className = 'workspace-zone ws-' + status;
    zone.id = 'dept-ws-' + name;
    zone.innerHTML =
      '<div class="compartment-rivets"></div>' +
      '<div class="porthole"></div>' +
      '<div class="compartment-light"></div>' +
      '<div class="ws-label" data-ws="' + name + '"><span class="ws-status-dot ' + status + '"></span>' + displayName + ' <span class="ws-eye">&#128064;</span></div>' +
      '<div class="ws-sublabel" data-ws="' + name + '">' + (ws.description || '') + '</div>' +
      agentBadgesHtml +
      '<div class="ws-meta">last: ' + (ws.last_active || '-') + '</div>' +
      '<div class="desk-station" id="desk-' + name + '" style="position:absolute; left:60px; top:45px;">' +
        '<div class="desk-assignment-label" style="left:10px; top:0; color: var(--cyan);">' + displayName + '</div>' +
        '<div class="desk" style="left:0; top:85px;"><div class="desk-surface"></div></div>' +
        '<div class="monitor" style="left:8px; top:68px;">' +
          '<div class="monitor-frame"><div class="monitor-screen" id="screen-' + name + '">' +
            '<div class="screen-line" style="background:#00d4ff;"></div>' +
            '<div class="screen-line" style="background:#ffffff; width:60%; animation-delay:0.5s;"></div>' +
            '<div class="screen-line" style="background:#00d4ff; animation-delay:1s;"></div>' +
          '</div></div><div class="monitor-stand"></div>' +
        '</div>' +
        '<div class="mug" style="left:96px; top:92px;"><div class="mug-steam"></div></div>' +
        '<div class="agent-slot" id="slot-' + name + '" style="left:28px; top:16px;"></div>' +
        '<div class="hp-bar-wrap" id="hp-wrap-' + name + '" style="left:16px; top:58px; display:none;"><div class="hp-bar" id="hp-desk-' + name + '"></div></div>' +
      '</div>' +
      '<div class="ws-machines" id="machines-' + name + '" data-zone="' + name + '"></div>';
    container.appendChild(zone);
  });

  // Update DEPARTMENTS for diver collision
  DEPARTMENTS = [];
  var zones = container.querySelectorAll('.workspace-zone');
  zones.forEach(function(z) {
    var rect = z.getBoundingClientRect();
    var containerRect = container.getBoundingClientRect();
    var domeEl = document.getElementById('dome');
    var domeRect = domeEl ? domeEl.getBoundingClientRect() : containerRect;
    var scale = domeRect.width / 1040;
    DEPARTMENTS.push({
      id: z.id,
      left: (rect.left - domeRect.left) / scale,
      top: (rect.top - domeRect.top) / scale,
      width: rect.width / scale,
      height: rect.height / scale
    });
  });
}

// PM animation integrated into loadDashboardData — no monkey-patch needed

// ===== DECO MODE (Decoration / Room Customization) =====
var LAYOUT_KEY = 'heysquid_dashboard_layout';
var decoMode = false;
var decoInitialized = false;
var MACHINE_TYPE_LIST = [
  {type: 'gear', icon: '\u2699\uFE0F', label: 'gear'},
  {type: 'boiler', icon: '\uD83D\uDD25', label: 'boiler'},
  {type: 'radar', icon: '\uD83D\uDCE1', label: 'radar'},
  {type: 'printer', icon: '\uD83D\uDDA8\uFE0F', label: 'print'},
  {type: 'clock', icon: '\uD83D\uDD50', label: 'clock'}
];

// --- Layout Storage (server = SSoT, localStorage = cache) ---
var DECO_LAYOUT_VERSION = 4;  // Increment when coordinate system changes
var _decoLayoutCache = null;
var _decoSaveTimer = null;
var DECO_SAVE_DEBOUNCE = 1000; // 1s debounce for server saves

function loadDecoLayout() {
  if (_decoLayoutCache) return _decoLayoutCache;
  try { _decoLayoutCache = JSON.parse(localStorage.getItem(LAYOUT_KEY)) || {}; } catch(e) { _decoLayoutCache = {}; }
  // Remove stale agent coordinates on version mismatch
  if (_decoLayoutCache._v !== DECO_LAYOUT_VERSION) {
    delete _decoLayoutCache.agents;
    _decoLayoutCache._v = DECO_LAYOUT_VERSION;
    localStorage.setItem(LAYOUT_KEY, JSON.stringify(_decoLayoutCache));
  }
  return _decoLayoutCache;
}
function saveDecoLayoutFull(layout) {
  _decoLayoutCache = layout;
  localStorage.setItem(LAYOUT_KEY, JSON.stringify(layout));
  // Debounced server save
  if (_decoSaveTimer) clearTimeout(_decoSaveTimer);
  _decoSaveTimer = setTimeout(function() {
    fetch('/api/save-deco-layout', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(layout)
    }).catch(function(){});
  }, DECO_SAVE_DEBOUNCE);
}
function saveDecoLayout(key, value) {
  var layout = loadDecoLayout();
  var parts = key.split('.');
  var cur = layout;
  for (var i = 0; i < parts.length - 1; i++) {
    if (!cur[parts[i]] || typeof cur[parts[i]] !== 'object') cur[parts[i]] = {};
    cur = cur[parts[i]];
  }
  cur[parts[parts.length - 1]] = value;
  saveDecoLayoutFull(layout);
}

// --- Coordinate Clamping ---
// Clamp position so element stays within dome viewport (1040x740 base, minus element size)
function clampCoords(left, top, el) {
  var maxW = 1040, maxH = 740;
  var elW = el ? (el.offsetWidth || 60) : 60;
  var elH = el ? (el.offsetHeight || 60) : 60;
  return {
    left: Math.max(0, Math.min(left, maxW - elW)),
    top: Math.max(0, Math.min(top, maxH - elH))
  };
}

// --- Draggable Engine ---
function decoMakeDraggable(el, storageKey) {
  if (el._decoMousedownAttached) return;
  el._decoMousedownAttached = true;
  var isDragging = false;
  var startMouseX, startMouseY, startElLeft, startElTop, dragScale;

  function onMouseDown(e) {
    if (!document.body.classList.contains('deco-mode')) return;
    if (e.button !== 0) return;
    if (e.target.closest('.machine-picker')) return;
    if (e.target.closest('.ws-resize-handle')) return;
    e.preventDefault();
    e.stopPropagation();
    isDragging = true;
    startMouseX = e.clientX;
    startMouseY = e.clientY;
    var parsedLeft = parseInt(el.style.left);
    var parsedTop = parseInt(el.style.top);
    startElLeft = isNaN(parsedLeft) ? el.offsetLeft : parsedLeft;
    startElTop = isNaN(parsedTop) ? el.offsetTop : parsedTop;
    var dome = document.getElementById('dome');
    dragScale = dome ? dome.getBoundingClientRect().width / 1040 : 1;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  function onMouseMove(e) {
    if (!isDragging) return;
    var dx = (e.clientX - startMouseX) / dragScale;
    var dy = (e.clientY - startMouseY) / dragScale;
    el.style.left = Math.round(startElLeft + dx) + 'px';
    el.style.top = Math.round(startElTop + dy) + 'px';
    el.style.right = 'auto';
    el.style.bottom = 'auto';
  }

  function onMouseUp() {
    if (!isDragging) return;
    isDragging = false;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    // Clamp within viewport before saving
    var clamped = clampCoords(parseInt(el.style.left), parseInt(el.style.top), el);
    el.style.left = clamped.left + 'px';
    el.style.top = clamped.top + 'px';
    saveDecoLayout(storageKey, clamped);
  }

  el.classList.add('deco-draggable');
  el.addEventListener('mousedown', onMouseDown);
}

// --- Workspace Container Resize ---
function setupWsResize() {
  var wsc = document.getElementById('workspace-zones');
  if (!wsc) return;
  var old = wsc.querySelector('.ws-resize-handle');
  if (old) old.remove();
  var handle = document.createElement('div');
  handle.className = 'ws-resize-handle';
  wsc.appendChild(handle);

  handle.addEventListener('mousedown', function(e) {
    if (!document.body.classList.contains('deco-mode')) return;
    e.preventDefault();
    e.stopPropagation();
    var startW = wsc.offsetWidth;
    var startH = wsc.offsetHeight;
    var smX = e.clientX;
    var smY = e.clientY;
    var dome = document.getElementById('dome');
    var scale = dome ? dome.getBoundingClientRect().width / 1040 : 1;

    function onMove(ev) {
      var dw = (ev.clientX - smX) / scale;
      var dh = (ev.clientY - smY) / scale;
      wsc.style.width = Math.min(1100, Math.max(200, Math.round(startW + dw))) + 'px';
      wsc.style.height = Math.min(800, Math.max(160, Math.round(startH + dh))) + 'px';
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      saveDecoLayout('wsContainer', {w: parseInt(wsc.style.width), h: parseInt(wsc.style.height)});
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// --- Machine Type Picker ---
function showMachinePicker(machineEl, skillName) {
  hideMachinePicker();
  var picker = document.createElement('div');
  picker.className = 'machine-picker show';
  picker.id = 'active-machine-picker';
  var currentType = getCurrentMachineType(skillName);

  MACHINE_TYPE_LIST.forEach(function(mt) {
    var item = document.createElement('div');
    item.className = 'machine-picker-item' + (mt.type === currentType ? ' selected' : '');
    item.innerHTML = '<span class="mp-icon">' + mt.icon + '</span><span class="mp-label">' + mt.label + '</span>';
    item.addEventListener('click', function(e) {
      e.stopPropagation();
      changeMachineType(skillName, mt.type);
      hideMachinePicker();
    });
    picker.appendChild(item);
  });

  var dome = document.getElementById('dome');
  var domeRect = dome.getBoundingClientRect();
  var machineRect = machineEl.getBoundingClientRect();
  var scale = domeRect.width / 1040;
  var left = (machineRect.left - domeRect.left) / scale - 40;
  var top = (machineRect.top - domeRect.top) / scale - 55;
  picker.style.left = Math.max(5, Math.round(left)) + 'px';
  picker.style.top = Math.max(5, Math.round(top)) + 'px';
  dome.appendChild(picker);
}
function hideMachinePicker() {
  var existing = document.getElementById('active-machine-picker');
  if (existing) existing.remove();
}
function getCurrentMachineType(skillName) {
  var layout = loadDecoLayout();
  if (layout.skillMachineTypes && layout.skillMachineTypes[skillName]) {
    return layout.skillMachineTypes[skillName];
  }
  if (window._lastAutomationsRaw && window._lastAutomationsRaw[skillName]) {
    return window._lastAutomationsRaw[skillName].machine || 'boiler';
  }
  return 'boiler';
}
function changeMachineType(skillName, newType) {
  var layout = loadDecoLayout();
  if (!layout.skillMachineTypes) layout.skillMachineTypes = {};
  layout.skillMachineTypes[skillName] = newType;
  saveDecoLayoutFull(layout);
  if (window._lastAutomationsRaw && window._lastAutomationsRaw[skillName]) {
    window._lastAutomationsRaw[skillName].machine = newType;
    lastAutomationsData = null;
    renderSkillMachines(window._lastAutomationsRaw);
  }
}

// --- Apply Saved Layout ---
function applyDecoLayout() {
  var layout = loadDecoLayout();
  if (!layout || Object.keys(layout).length === 0) return;

  if (layout.wsContainer) {
    var wsc = document.getElementById('workspace-zones');
    if (wsc) {
      if (layout.wsContainer.w) wsc.style.width = layout.wsContainer.w + 'px';
      if (layout.wsContainer.h) wsc.style.height = layout.wsContainer.h + 'px';
    }
  }

  if (layout.objects) {
    // wsContainer position
    if (layout.objects.wsContainer) {
      var wsc2 = document.getElementById('workspace-zones');
      if (wsc2) {
        var wscPos = clampCoords(layout.objects.wsContainer.left, layout.objects.wsContainer.top, wsc2);
        wsc2.style.left = wscPos.left + 'px';
        wsc2.style.top = wscPos.top + 'px';
      }
    }
    var objMap = {pm: 'pm-area', pmMachines: 'pm-machines', pool: 'agent-pool'};
    Object.keys(objMap).forEach(function(key) {
      var pos = layout.objects[key];
      var el = document.getElementById(objMap[key]);
      if (pos && el) {
        var c = clampCoords(pos.left, pos.top, el);
        el.style.left = c.left + 'px';
        el.style.top = c.top + 'px';
      }
    });
    if (layout.objects.cooler) {
      var cooler = document.querySelector('.water-cooler');
      if (cooler) {
        var c = clampCoords(layout.objects.cooler.left, layout.objects.cooler.top, cooler);
        cooler.style.left = c.left + 'px';
        cooler.style.top = c.top + 'px';
      }
    }
    var plants = document.querySelectorAll('.plant');
    if (layout.objects.plant1 && plants[0]) {
      var c = clampCoords(layout.objects.plant1.left, layout.objects.plant1.top, plants[0]);
      plants[0].style.left = c.left + 'px';
      plants[0].style.top = c.top + 'px';
    }
    if (layout.objects.plant2 && plants[1]) {
      var c = clampCoords(layout.objects.plant2.left, layout.objects.plant2.top, plants[1]);
      plants[1].style.left = c.left + 'px';
      plants[1].style.top = c.top + 'px';
    }
  }

  if (layout.skillMachineTypes && window._lastAutomationsRaw) {
    Object.keys(layout.skillMachineTypes).forEach(function(name) {
      if (window._lastAutomationsRaw[name]) {
        window._lastAutomationsRaw[name].machine = layout.skillMachineTypes[name];
      }
    });
  }

  // Individual agent positions — always apply saved layout
  if (layout.agents) {
    var dome = document.getElementById('dome');
    Object.keys(layout.agents).forEach(function(agentName) {
      var pos = layout.agents[agentName];
      var el = document.getElementById('pool-' + agentName);
      if (pos && pos.left != null && pos.top != null && el && dome) {
        var c = clampCoords(pos.left, pos.top, el);
        el.style.position = 'absolute';
        el.style.left = c.left + 'px';
        el.style.top = c.top + 'px';
        el.style.zIndex = '20';
        el.dataset.decoDrag = 'true';
        if (el.parentElement !== dome) {
          el._originalParentId = el.parentElement ? el.parentElement.id : 'agent-pool';
          dome.appendChild(el);
        }
      }
    });
  }

  // Apply saved skill machine positions (dome-relative, free placement) — only in DECO
  if (layout.skillPos) {
    var dome = document.getElementById('dome');
    Object.keys(layout.skillPos).forEach(function(skillName) {
      var pos = layout.skillPos[skillName];
      var el = document.querySelector('.skill-machine[data-skill="' + skillName + '"]');
      if (pos && el && dome) {
        var c = clampCoords(pos.left || 0, pos.top || 0, el);
        if (el.parentElement !== dome) {
          el._originalParentId = el.parentElement ? el.parentElement.id : 'pm-machines';
          dome.appendChild(el);
        }
        el.style.position = 'absolute';
        el.style.left = c.left + 'px';
        el.style.top = c.top + 'px';
        el.style.zIndex = '150';
        el.dataset.decoSkillDrag = 'true';
      }
    });
  }

  // Apply saved agent skins (character + hue)
  if (layout.agentSkin) {
    Object.keys(layout.agentSkin).forEach(function(agentName) {
      var skin = layout.agentSkin[agentName];
      var el = document.getElementById('pool-' + agentName);
      if (!el) return;
      var charEl = el.querySelector('.pixel-char');
      if (!charEl) return;
      if (skin.char) {
        // Remove all pixel classes, add new one
        var classes = charEl.className.split(' ').filter(function(c) { return c === 'pixel-char'; });
        charEl.className = classes.join(' ') + ' ' + skin.char;
      }
      if (skin.hue !== undefined) {
        charEl.style.setProperty('--agent-hue', skin.hue + 'deg');
      }
    });
  }
}

// Apply saved skill machine positions (extracted for reuse after re-render)
function applyDecoSkillPositions() {
  var layout = loadDecoLayout();
  if (!layout || !layout.skillPos) return;
  var dome = document.getElementById('dome');
  Object.keys(layout.skillPos).forEach(function(skillName) {
    var pos = layout.skillPos[skillName];
    var el = document.querySelector('.skill-machine[data-skill="' + skillName + '"]');
    if (pos && el && dome) {
      var c = clampCoords(pos.left || 0, pos.top || 0, el);
      if (el.parentElement !== dome) {
        el._originalParentId = el.parentElement ? el.parentElement.id : 'pm-machines';
        dome.appendChild(el);
      }
      el.style.position = 'absolute';
      el.style.left = c.left + 'px';
      el.style.top = c.top + 'px';
      el.style.zIndex = '150';
      el.dataset.decoSkillDrag = 'true';
    }
  });
}

function applyDecoZoneLayout() {
  var layout = loadDecoLayout();
  if (!layout.zones) return;
  Object.keys(layout.zones).forEach(function(zoneName) {
    var zl = layout.zones[zoneName];
    if (zl.desk) {
      var desk = document.getElementById('desk-' + zoneName);
      if (desk) {
        desk.style.left = Math.max(-20, zl.desk.left) + 'px';
        desk.style.top = Math.max(-40, zl.desk.top) + 'px';
      }
    }
    if (zl.machines) {
      var machines = document.getElementById('machines-' + zoneName);
      if (machines) {
        machines.style.left = Math.max(-20, zl.machines.left) + 'px';
        machines.style.top = Math.max(-40, zl.machines.top) + 'px';
        machines.style.right = 'auto';
        machines.style.bottom = 'auto';
      }
    }
  });
}

// --- Character Picker ---
var CHAR_MAP = [
  {cls:'octopus-pixel', emoji:'\uD83D\uDC19'},
  {cls:'shark-pixel', emoji:'\uD83E\uDD88'},
  {cls:'turtle-pixel', emoji:'\uD83D\uDC22'},
  {cls:'puffer-pixel', emoji:'\uD83D\uDC21'},
  {cls:'lobster-pixel', emoji:'\uD83E\uDD9E'},
  {cls:'whale-pixel', emoji:'\uD83D\uDC0B'},
  {cls:'spouting-whale-pixel', emoji:'\uD83D\uDC33'},
  {cls:'dolphin-pixel', emoji:'\uD83D\uDC2C'},
  {cls:'seal-pixel', emoji:'\uD83E\uDDAD'},
  {cls:'shrimp-pixel', emoji:'\uD83E\uDD90'},
  {cls:'crab-pixel', emoji:'\uD83E\uDD80'},
  {cls:'jellyfish-pixel', emoji:'\uD83E\uDEBC'},
  {cls:'tropical-pixel', emoji:'\uD83D\uDC20'},
  {cls:'fish-pixel', emoji:'\uD83D\uDC1F'},
  {cls:'shell-pixel', emoji:'\uD83D\uDC1A'},
  {cls:'oyster-pixel', emoji:'\uD83E\uDDAA'},
  {cls:'coral-pixel', emoji:'\uD83E\uDEB8'},
  {cls:'otter-pixel', emoji:'\uD83E\uDDA6'},
  {cls:'beaver-pixel', emoji:'\uD83E\uDDAB'},
  {cls:'hippo-pixel', emoji:'\uD83E\uDD9B'},
  {cls:'croc-pixel', emoji:'\uD83D\uDC0A'},
  {cls:'frog-pixel', emoji:'\uD83D\uDC38'},
  {cls:'penguin-pixel', emoji:'\uD83D\uDC27'},
  {cls:'duck-pixel', emoji:'\uD83E\uDD86'},
  {cls:'swan-pixel', emoji:'\uD83E\uDDA2'},
  {cls:'flamingo-pixel', emoji:'\uD83E\uDDA9'},
  {cls:'goose-pixel', emoji:'\uD83E\uDEBF'},
  {cls:'squid-pixel-lg', emoji:'\uD83E\uDD91'}
];

function showCharPicker(agentEl, agentName) {
  hideCharPicker();
  var layout = loadDecoLayout();
  var currentSkin = (layout.agentSkin && layout.agentSkin[agentName]) || {};
  var currentChar = currentSkin.char || REGISTRY[agentName].css_class;
  var currentHue = currentSkin.hue || 0;

  var popup = document.createElement('div');
  popup.className = 'char-picker-popup';
  popup.id = 'active-char-picker';

  var gridHtml = CHAR_MAP.map(function(c) {
    var sel = c.cls === currentChar ? ' selected' : '';
    return '<div class="char-picker-item' + sel + '" data-cls="' + c.cls + '" title="' + c.cls + '">' + c.emoji + '</div>';
  }).join('');

  popup.innerHTML =
    '<div class="cp-title">Character</div>' +
    '<div class="char-picker-grid">' + gridHtml + '</div>' +
    '<div class="char-picker-hue">' +
      '<span>Hue:</span>' +
      '<input type="range" min="0" max="360" value="' + currentHue + '" id="cp-hue-slider">' +
      '<span class="hue-value" id="cp-hue-val">' + currentHue + '\u00B0</span>' +
    '</div>' +
    '<button class="char-picker-apply" id="cp-apply">Apply</button>';

  // Position relative to agent
  var poolEl = document.getElementById('agent-pool');
  var rect = agentEl.getBoundingClientRect();
  var domeRect = document.getElementById('dome').getBoundingClientRect();
  var scale = domeRect.width / 1040;
  popup.style.left = Math.round((rect.left - domeRect.left) / scale - 40) + 'px';
  popup.style.top = Math.round((rect.top - domeRect.top) / scale - 200) + 'px';

  var dome = document.getElementById('dome');
  dome.appendChild(popup);

  // Selection handling
  var selectedCls = currentChar;
  popup.querySelectorAll('.char-picker-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.stopPropagation();
      popup.querySelectorAll('.char-picker-item').forEach(function(i) { i.classList.remove('selected'); });
      item.classList.add('selected');
      selectedCls = item.dataset.cls;
      // Live preview
      var charEl = agentEl.querySelector('.pixel-char');
      if (charEl) {
        charEl.className = 'pixel-char ' + selectedCls;
      }
    });
  });

  // Hue slider
  var slider = popup.querySelector('#cp-hue-slider');
  var hueVal = popup.querySelector('#cp-hue-val');
  slider.addEventListener('input', function() {
    hueVal.textContent = slider.value + '\u00B0';
    var charEl = agentEl.querySelector('.pixel-char');
    if (charEl) charEl.style.setProperty('--agent-hue', slider.value + 'deg');
  });

  // Apply button
  popup.querySelector('#cp-apply').addEventListener('click', function(e) {
    e.stopPropagation();
    var layout = loadDecoLayout();
    if (!layout.agentSkin) layout.agentSkin = {};
    layout.agentSkin[agentName] = { char: selectedCls, hue: parseInt(slider.value) };
    saveDecoLayoutFull(layout);
    hideCharPicker();
  });
}

function hideCharPicker() {
  var existing = document.getElementById('active-char-picker');
  if (existing) existing.remove();
}

// --- Init Draggable Targets ---
function initDecoTargets() {
  if (decoInitialized) return;
  decoInitialized = true;

  var pm = document.getElementById('pm-area');
  if (pm) decoMakeDraggable(pm, 'objects.pm');

  var pmMachines = document.getElementById('pm-machines');
  if (pmMachines) decoMakeDraggable(pmMachines, 'objects.pmMachines');

  var pool = document.getElementById('agent-pool');
  if (pool) decoMakeDraggable(pool, 'objects.pool');

  var cooler = document.querySelector('.water-cooler');
  if (cooler) decoMakeDraggable(cooler, 'objects.cooler');

  var plants = document.querySelectorAll('.plant');
  if (plants[0]) decoMakeDraggable(plants[0], 'objects.plant1');
  if (plants[1]) decoMakeDraggable(plants[1], 'objects.plant2');

  // Workspace container draggable
  var wsContainer = document.getElementById('workspace-zones');
  if (wsContainer && !wsContainer.dataset.decoDrag) {
    wsContainer.dataset.decoDrag = 'true';
    wsContainer.classList.add('deco-draggable');
    decoMakeDraggable(wsContainer, 'objects.wsContainer');
  }

  setupWsResize();

  // Attach drag handlers to agents already positioned by applyDecoLayout
  document.querySelectorAll('.pool-agent').forEach(function(a) {
    if (a.dataset.decoDrag) {
      a.classList.add('deco-draggable');
      var agentName = a.id.replace('pool-','');
      decoMakeDraggable(a, 'agents.' + agentName);
    }
  });

  // Attach drag handlers to skill machines already positioned by applyDecoSkillPositions
  document.querySelectorAll('.skill-machine').forEach(function(m) {
    if (m.dataset.decoSkillDrag) {
      m.draggable = false;
      var skillName = m.dataset.skill;
      if (skillName) decoMakeDraggable(m, 'skillPos.' + skillName);
    }
  });

  // Individual agent draggable — re-parent to dome for free movement (two-pass)
  var agentNodes = Array.from(document.querySelectorAll('.pool-agent'))
    .filter(function(a) { return !a.dataset.decoDrag; });
  var dome = document.getElementById('dome');
  var pool = document.getElementById('agent-pool');
  var poolLeft = parseInt(pool.style.left) || 0;
  var poolTop = parseInt(pool.style.top) || 0;
  var layout = loadDecoLayout();

  // Pass 1: Capture agent offsets within pool (before any re-parenting)
  var positions = [];
  agentNodes.forEach(function(a) {
    positions.push({ el: a, offLeft: a.offsetLeft, offTop: a.offsetTop });
  });

  // Pass 2: Re-parent to dome with correct dome-relative coordinates
  positions.forEach(function(p) {
    var a = p.el;
    a.dataset.decoDrag = 'true';
    a.classList.add('deco-draggable');
    var agentName = a.id.replace('pool-','');

    // Saved dome-relative position > pool-based calculation
    var savedPos = layout.agents && layout.agents[agentName];
    if (savedPos && savedPos.left != null && savedPos.top != null) {
      var c = clampCoords(savedPos.left, savedPos.top, a);
      a.style.left = c.left + 'px';
      a.style.top = c.top + 'px';
    } else {
      // pool position + offset within pool = dome-relative coordinates
      a.style.left = (poolLeft + p.offLeft) + 'px';
      a.style.top = (poolTop + p.offTop) + 'px';
    }

    a.style.position = 'absolute';
    a.style.zIndex = '20';
    a._originalParentId = a.parentElement ? a.parentElement.id : 'agent-pool';
    if (dome) dome.appendChild(a);
    decoMakeDraggable(a, 'agents.' + agentName);
  });

  // Machine click handler for type change (event delegation)
  document.addEventListener('click', function(e) {
    if (!decoMode) return;
    var machine = e.target.closest('.skill-machine');
    if (machine) {
      e.stopPropagation();
      var skillName = machine.dataset.skill;
      if (skillName) showMachinePicker(machine, skillName);
      return;
    }
    if (!e.target.closest('.machine-picker')) {
      hideMachinePicker();
    }
  });

  // Individual skill machine draggable in Deco mode
  initDecoSkillMachines();

  initDecoZoneTargets();
}

function initDecoSkillMachines() {
  document.querySelectorAll('.skill-machine').forEach(initSingleDecoSkillMachine);
}

function initDecoZoneTargets() {
  var zones = document.querySelectorAll('.workspace-zone');
  zones.forEach(function(zone) {
    var zoneName = zone.id.replace('dept-ws-', '');

    var desk = document.getElementById('desk-' + zoneName);
    if (desk && !desk.dataset.decoInit) {
      desk.dataset.decoInit = 'true';
      decoMakeDraggable(desk, 'zones.' + zoneName + '.desk');
    }

    var machines = document.getElementById('machines-' + zoneName);
    if (machines && !machines.dataset.decoInit) {
      machines.dataset.decoInit = 'true';
      // Convert right/bottom to left/top if not yet set
      var hasLeft = machines.style.left && machines.style.left !== '' && machines.style.left !== 'auto';
      if (!hasLeft) {
        var parent = machines.parentElement;
        if (parent && parent.clientWidth > 0) {
          var cRight = parseFloat(getComputedStyle(machines).right) || 8;
          var cBottom = parseFloat(getComputedStyle(machines).bottom) || 12;
          machines.style.left = Math.round(parent.clientWidth - machines.offsetWidth - cRight) + 'px';
          machines.style.top = Math.round(parent.clientHeight - machines.offsetHeight - cBottom) + 'px';
          machines.style.right = 'auto';
          machines.style.bottom = 'auto';
        }
      }
      decoMakeDraggable(machines, 'zones.' + zoneName + '.machines');
    }
  });
}

// --- Inline Editable Labels (Deco Mode) ---
function makeEditableWsField(el, wsName, field) {
  if (!document.body.classList.contains('deco-mode')) return;
  if (el.querySelector('input')) return;
  var currentText = el.textContent.replace(/[\uD83D\uDC40\s●🟢🟠⚪]/g, '').trim();
  var input = document.createElement('input');
  input.className = 'ws-edit-input' + (field === 'description' ? ' sublabel' : '');
  input.value = currentText;
  input.style.fontSize = getComputedStyle(el).fontSize;

  function save() {
    var newVal = input.value.trim();
    if (!newVal) newVal = currentText;
    saveWorkspaceField(wsName, field, newVal);
  }
  input.addEventListener('blur', save);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { input.value = currentText; input.blur(); }
  });

  if (field === 'label') {
    var dot = el.querySelector('.ws-status-dot');
    var eye = el.querySelector('.ws-eye');
    el.textContent = '';
    if (dot) el.appendChild(dot);
    el.appendChild(input);
    if (eye) el.appendChild(eye);
  } else {
    el.textContent = '';
    el.appendChild(input);
  }
  input.focus();
  input.select();
}

function saveWorkspaceField(wsName, field, value) {
  if (!lastWsData || !lastWsData[wsName]) return;
  lastWsData[wsName][field] = value;
  // Force re-render
  var saved = JSON.parse(JSON.stringify(lastWsData));
  lastWsData = null;
  renderWorkspaceZones(saved);
  // Save to server
  fetch('/api/save-workspace', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(saved)
  }).catch(function(){});
}

// --- Agent Assignment Popup (Deco Mode) ---
var activeAssignPopup = null;
function showAgentAssignPopup(el, wsName) {
  if (!document.body.classList.contains('deco-mode')) return;
  hideAgentAssignPopup();
  var allAgents = ['researcher','developer','reviewer','tester','writer'];
  var emojiMap = {researcher:'🐙',developer:'🦈',reviewer:'🐢',tester:'🐡',writer:'🦞'};
  var current = (lastWsData && lastWsData[wsName] && lastWsData[wsName].agents) || [];

  var popup = document.createElement('div');
  popup.className = 'agent-assign-popup';
  popup.innerHTML = '<div style="margin-bottom:6px;color:var(--orange);">Assign Agent</div>' +
    allAgents.map(function(a) {
      var checked = current.indexOf(a) >= 0 ? ' checked' : '';
      return '<label><input type="checkbox" value="' + a + '"' + checked + '> ' + emojiMap[a] + ' ' + a + '</label>';
    }).join('') +
    '<button class="aap-save">Save</button>';

  var rect = el.getBoundingClientRect();
  var dome = document.getElementById('dome');
  var domeRect = dome ? dome.getBoundingClientRect() : {left:0, top:0};
  var scale = dome ? dome.getBoundingClientRect().width / 1040 : 1;
  popup.style.left = Math.round((rect.left - domeRect.left) / scale) + 'px';
  popup.style.top = Math.round((rect.bottom - domeRect.top) / scale + 4) + 'px';

  popup.querySelector('.aap-save').addEventListener('click', function() {
    var selected = [];
    popup.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) {
      selected.push(cb.value);
    });
    saveWorkspaceField(wsName, 'agents', selected);
    hideAgentAssignPopup();
  });

  popup.addEventListener('mousedown', function(e) { e.stopPropagation(); });
  popup.addEventListener('click', function(e) { e.stopPropagation(); });

  dome.appendChild(popup);
  activeAssignPopup = popup;
}
function hideAgentAssignPopup() {
  if (activeAssignPopup) { activeAssignPopup.remove(); activeAssignPopup = null; }
}

// --- Diver Quote Customization ---
function getDiverQuote() {
  return localStorage.getItem('heysquid_diver_quote') || 'THIS is my elite squad?!';
}
function setDiverQuote(q) {
  if (q && q.trim()) localStorage.setItem('heysquid_diver_quote', q.trim());
  else localStorage.removeItem('heysquid_diver_quote');
}
// --- PM Idle Speech Editor (DECO mode) ---
function showPmIdleSpeechEditor() {
  var existing = document.getElementById('pm-speech-editor');
  if (existing) { existing.remove(); return; }

  var popup = document.createElement('div');
  popup.id = 'pm-speech-editor';
  popup.className = 'deco-editor-popup';
  popup.style.cssText = 'position:absolute;left:300px;top:350px;width:340px;background:rgba(5,15,35,0.95);border:1px solid var(--pink);border-radius:6px;padding:10px;z-index:2000;font-size:8px;color:#aabbcc;';

  var speeches = pmIdleLines.slice();
  function render() {
    var html = '<div style="color:var(--pink);font-size:9px;margin-bottom:6px;font-family:\'Press Start 2P\',monospace;">PM Idle Speeches</div>';
    html += '<div style="max-height:200px;overflow-y:auto;">';
    speeches.forEach(function(s, i) {
      html += '<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px;">' +
        '<input class="pm-speech-input" data-idx="' + i + '" value="' + s.replace(/"/g, '&quot;') + '" style="flex:1;background:rgba(0,20,40,0.9);border:1px solid #334455;color:#aabbcc;padding:2px 4px;font-size:7px;font-family:monospace;">' +
        '<span class="pm-speech-del" data-idx="' + i + '" style="color:#ff4466;cursor:pointer;font-size:9px;" title="Delete">✕</span>' +
        '</div>';
    });
    html += '</div>';
    html += '<div style="margin-top:6px;display:flex;gap:6px;">' +
      '<button id="pm-speech-add" style="background:rgba(0,100,150,0.3);border:1px solid var(--cyan);color:var(--cyan);padding:2px 8px;cursor:pointer;font-size:7px;font-family:\'Press Start 2P\',monospace;border-radius:2px;">+ Add</button>' +
      '<button id="pm-speech-save" style="background:rgba(255,107,157,0.2);border:1px solid var(--pink);color:var(--pink);padding:2px 8px;cursor:pointer;font-size:7px;font-family:\'Press Start 2P\',monospace;border-radius:2px;">Save</button>' +
      '<button id="pm-speech-close" style="background:rgba(50,60,80,0.3);border:1px solid #556677;color:#778899;padding:2px 8px;cursor:pointer;font-size:7px;font-family:\'Press Start 2P\',monospace;border-radius:2px;">Close</button>' +
      '</div>';
    popup.innerHTML = html;

    // Event listeners
    popup.querySelectorAll('.pm-speech-del').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        speeches.splice(parseInt(btn.dataset.idx), 1);
        render();
      });
    });
    popup.querySelectorAll('.pm-speech-input').forEach(function(inp) {
      inp.addEventListener('input', function() {
        speeches[parseInt(inp.dataset.idx)] = inp.value;
      });
      inp.addEventListener('click', function(e) { e.stopPropagation(); });
    });
    var addBtn = popup.querySelector('#pm-speech-add');
    if (addBtn) addBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      speeches.push('New speech...');
      render();
    });
    var saveBtn = popup.querySelector('#pm-speech-save');
    if (saveBtn) saveBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      var filtered = speeches.filter(function(s) { return s.trim().length > 0; });
      saveConfig('pm_idle_speeches', filtered);
      pmIdleLines = filtered;
      popup.remove();
    });
    var closeBtn = popup.querySelector('#pm-speech-close');
    if (closeBtn) closeBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      popup.remove();
    });
  }
  render();
  document.getElementById('dome').appendChild(popup);
}

// --- Diver Effects Editor (DECO mode) ---
function showDiverEffectsEditor() {
  var existing = document.getElementById('diver-effects-editor');
  if (existing) { existing.remove(); return; }

  var config = DASHBOARD_CONFIG || {};
  var effects = config.diver_effects || {};
  var quote = effects.quote || getDiverQuote();
  var pmReaction = effects.pm_reaction || '...';
  var flinch = effects.flinch_enabled !== false;
  var duration = effects.bubble_duration || 2000;

  var popup = document.createElement('div');
  popup.id = 'diver-effects-editor';
  popup.className = 'deco-editor-popup';
  popup.style.cssText = 'position:absolute;left:500px;top:400px;width:280px;background:rgba(5,15,35,0.95);border:1px solid var(--cyan);border-radius:6px;padding:10px;z-index:2000;font-size:8px;color:#aabbcc;';

  popup.innerHTML =
    '<div style="color:var(--cyan);font-size:9px;margin-bottom:8px;font-family:\'Press Start 2P\',monospace;">Diver Effects (Z key)</div>' +
    '<div style="margin-bottom:6px;"><label>Quote:</label><br>' +
    '<input id="de-quote" value="' + quote.replace(/"/g, '&quot;') + '" style="width:100%;background:rgba(0,20,40,0.9);border:1px solid #334455;color:#aabbcc;padding:3px;font-size:7px;font-family:monospace;box-sizing:border-box;"></div>' +
    '<div style="margin-bottom:6px;"><label>PM reaction:</label><br>' +
    '<input id="de-pm-reaction" value="' + pmReaction.replace(/"/g, '&quot;') + '" style="width:100%;background:rgba(0,20,40,0.9);border:1px solid #334455;color:#aabbcc;padding:3px;font-size:7px;font-family:monospace;box-sizing:border-box;"></div>' +
    '<div style="margin-bottom:6px;"><label><input type="checkbox" id="de-flinch" ' + (flinch ? 'checked' : '') + '> Flinch agents</label></div>' +
    '<div style="margin-bottom:6px;"><label>Bubble duration (ms):</label><br>' +
    '<input id="de-duration" type="number" value="' + duration + '" min="500" max="10000" step="500" style="width:80px;background:rgba(0,20,40,0.9);border:1px solid #334455;color:#aabbcc;padding:3px;font-size:7px;font-family:monospace;"></div>' +
    '<div style="display:flex;gap:6px;">' +
    '<button id="de-save" style="background:rgba(0,200,255,0.2);border:1px solid var(--cyan);color:var(--cyan);padding:2px 8px;cursor:pointer;font-size:7px;font-family:\'Press Start 2P\',monospace;border-radius:2px;">Save</button>' +
    '<button id="de-close" style="background:rgba(50,60,80,0.3);border:1px solid #556677;color:#778899;padding:2px 8px;cursor:pointer;font-size:7px;font-family:\'Press Start 2P\',monospace;border-radius:2px;">Close</button>' +
    '</div>';

  // Prevent drag
  popup.addEventListener('mousedown', function(e) { e.stopPropagation(); });
  popup.addEventListener('click', function(e) { e.stopPropagation(); });

  popup.querySelector('#de-save').addEventListener('click', function() {
    var newEffects = {
      quote: popup.querySelector('#de-quote').value.trim() || 'THIS is my elite squad?!',
      pm_reaction: popup.querySelector('#de-pm-reaction').value.trim() || '...',
      flinch_enabled: popup.querySelector('#de-flinch').checked,
      bubble_duration: parseInt(popup.querySelector('#de-duration').value) || 2000
    };
    saveConfig('diver_effects', newEffects);
    setDiverQuote(newEffects.quote);
    popup.remove();
  });
  popup.querySelector('#de-close').addEventListener('click', function() { popup.remove(); });

  document.getElementById('dome').appendChild(popup);
}

// --- Save Deco Layout to Server (immediate, non-debounced) ---
function saveDecoToServer() {
  var layout = loadDecoLayout();
  fetch('/api/save-deco-layout', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(layout)
  }).catch(function(){});
}

// --- Load Deco Layout from Server (server = SSoT, localStorage = fallback) ---
function loadDecoFromServer() {
  fetch('/api/deco-layout').then(function(r) { return r.json(); }).then(function(serverLayout) {
    if (serverLayout && Object.keys(serverLayout).length > 0) {
      // Server is SSoT — preserve local-only keys if server doesn't have them
      var local = _decoLayoutCache || {};
      if (!serverLayout.agentSkin && local.agentSkin) {
        serverLayout.agentSkin = local.agentSkin;
      }
      if (!serverLayout.skillMachineTypes && local.skillMachineTypes) {
        serverLayout.skillMachineTypes = local.skillMachineTypes;
      }
      _decoLayoutCache = serverLayout;
      localStorage.setItem(LAYOUT_KEY, JSON.stringify(serverLayout));
      applyDecoLayout();
      applyDecoZoneLayout();
    }
  }).catch(function(){
    // Server unreachable — fall back to localStorage
    applyDecoLayout();
    applyDecoZoneLayout();
  });
}

// --- Reset Deco Layout (clear all customizations) ---
function resetDecoLayout() {
  if (!confirm('Reset layout?\nAll placements, skins, and machine types will revert to defaults.')) return;

  // 1. Clear localStorage cache
  localStorage.removeItem(LAYOUT_KEY);
  _decoLayoutCache = null;

  // 2. Save empty layout to server, then reload
  decoMode = false;
  document.body.classList.remove('deco-mode');
  var btn = document.getElementById('btnDeco');
  if (btn) { btn.classList.remove('active'); btn.textContent = '\uD83C\uDFA8 DECO'; }
  var resetBtn = document.getElementById('btnDecoReset');
  if (resetBtn) resetBtn.style.display = 'none';

  fetch('/api/save-deco-layout', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({})
  }).finally(function() {
    location.reload();
  });
}

// --- Toggle Deco Mode ---
function toggleDecoMode() {
  if (demoRunning) return;
  decoMode = !decoMode;
  var btn = document.getElementById('btnDeco');
  var resetBtn = document.getElementById('btnDecoReset');

  if (decoMode) {
    document.body.classList.add('deco-mode');
    btn.classList.add('active');
    btn.textContent = '\uD83C\uDFA8 ON';
    if (resetBtn) resetBtn.style.display = '';
    var demoBtn = document.getElementById('btnDemo');
    if (demoBtn) demoBtn.disabled = true;
    initDecoTargets();
  } else {
    document.body.classList.remove('deco-mode');
    btn.classList.remove('active');
    btn.textContent = '\uD83C\uDFA8 DECO';
    if (resetBtn) resetBtn.style.display = 'none';
    var demoBtn = document.getElementById('btnDemo');
    if (demoBtn) demoBtn.disabled = false;
    hideMachinePicker();
    hideAgentAssignPopup();
    hideCharPicker();
    saveDecoToServer();
  }
}

// --- Deco Mode Click Delegation (ws-label, ws-sublabel, ws-agents, diver) ---
document.addEventListener('click', function(e) {
  if (!decoMode) return;
  // ws-label inline edit
  var wsLabel = e.target.closest('.ws-label[data-ws]');
  if (wsLabel) {
    e.stopPropagation();
    makeEditableWsField(wsLabel, wsLabel.dataset.ws, 'label');
    return;
  }
  // ws-sublabel inline edit
  var wsSub = e.target.closest('.ws-sublabel[data-ws]');
  if (wsSub) {
    e.stopPropagation();
    makeEditableWsField(wsSub, wsSub.dataset.ws, 'description');
    return;
  }
  // ws-agents assignment popup
  var wsAgents = e.target.closest('.ws-agents[data-ws]');
  if (wsAgents) {
    e.stopPropagation();
    showAgentAssignPopup(wsAgents, wsAgents.dataset.ws);
    return;
  }
  // PM idle speech editor
  var pmArea = e.target.closest('#pm-area');
  if (pmArea && !e.target.closest('.skill-machine')) {
    e.stopPropagation();
    showPmIdleSpeechEditor();
    return;
  }
  // Diver effects editor
  var diver = e.target.closest('#moving-diver');
  if (diver) {
    e.stopPropagation();
    showDiverEffectsEditor();
    return;
  }
  // Close agent assign popup + char picker on outside click
  if (!e.target.closest('.agent-assign-popup')) {
    hideAgentAssignPopup();
  }
  if (!e.target.closest('.char-picker-popup') && !e.target.closest('.pool-agent')) {
    hideCharPicker();
  }
});

// --- Deco Mode: Double-click agent → Character Picker ---
document.addEventListener('dblclick', function(e) {
  if (!decoMode) return;
  var agent = e.target.closest('.pool-agent');
  if (agent) {
    e.stopPropagation();
    e.preventDefault();
    var agentName = agent.id.replace('pool-', '');
    showCharPicker(agent, agentName);
  }
});

// --- Patch renderWorkspaceZones to re-apply layout after re-render ---
var _origRenderWsZonesDeco = renderWorkspaceZones;
renderWorkspaceZones = function(workspaces) {
  if (decoMode) { _updateDecoWsStatus(workspaces); return; }
  _origRenderWsZonesDeco(workspaces);
  applyDecoZoneLayout();
  if (decoInitialized) {
    // Re-add wsContainer draggable (className gets reset by re-render)
    var wsContainer = document.getElementById('workspace-zones');
    if (wsContainer) {
      wsContainer.classList.add('deco-draggable');
      if (!wsContainer.dataset.decoDrag) {
        wsContainer.dataset.decoDrag = 'true';
        decoMakeDraggable(wsContainer, 'objects.wsContainer');
      }
    }
    initDecoZoneTargets();
    setupWsResize();
  }
};

// (Skill monkey-patch removed — reconcile logic is now in renderSkillMachines itself)

// --- Patch runDemo to disable DECO during demo ---
var _origRunDemoDeco = runDemo;
runDemo = async function() {
  var decoBtn = document.getElementById('btnDeco');
  if (decoBtn) decoBtn.disabled = true;
  await _origRunDemoDeco();
  if (decoBtn) decoBtn.disabled = false;
};

// --- Apply saved layout on page load ---
applyDecoLayout();
loadDecoFromServer();

// ===== KANBAN BOARD =====
var _kanbanVisible = false;
var _lastKanbanJSON = '';
var _lastKanbanData = null;

function toggleKanbanView() {
  _kanbanVisible = !_kanbanVisible;
  var overlay = document.getElementById('kanbanOverlay');
  var btn = document.getElementById('btnKanban');
  if (_kanbanVisible) {
    overlay.classList.add('visible');
    btn.classList.add('active');
    btn.textContent = '\uD83D\uDCCB ON';
    // Render immediately with cached data
    if (_lastKanbanData) renderKanbanBoard(_lastKanbanData, window._lastAutomationsRaw);
  } else {
    overlay.classList.remove('visible');
    btn.classList.remove('active');
    btn.textContent = '\uD83D\uDCCB KANBAN';
    closeKanbanModal();
  }
}

function _tagColorClass(tag) {
  var t = tag.toLowerCase();
  if (t.indexOf('dev') !== -1 || t.indexOf('code') !== -1 || t.indexOf('fix') !== -1) return 'tag-dev';
  if (t.indexOf('doc') !== -1 || t.indexOf('write') !== -1 || t.indexOf('blog') !== -1) return 'tag-docs';
  if (t.indexOf('config') !== -1 || t.indexOf('infra') !== -1 || t.indexOf('deploy') !== -1) return 'tag-config';
  return '';
}

var _CARD_AGENT_COLORS = {
  pm: '#f97316', researcher: '#8b5cf6', developer: '#3b82f6',
  reviewer: '#10b981', tester: '#f472b6', writer: '#ef4444'
};

function _buildCardInnerHTML(task) {
  var timeStr = (task.updated_at || task.created_at || '').split(' ')[1] || '';
  if (timeStr) timeStr = timeStr.slice(0, 5);

  var tagsHtml = '';
  if (task.tags && task.tags.length) {
    tagsHtml = '<div class="kanban-card-tags">';
    task.tags.forEach(function(tag) {
      var cls = 'kanban-tag ' + _tagColorClass(tag);
      tagsHtml += '<span class="' + cls.trim() + '">' + escHtml(tag) + '</span>';
    });
    tagsHtml += '</div>';
  }

  // Last non-pm/system agent from activity_log
  var agentHtml = '';
  if (task.activity_log && task.activity_log.length) {
    for (var i = task.activity_log.length - 1; i >= 0; i--) {
      var logAgent = task.activity_log[i].agent;
      if (logAgent && logAgent !== 'pm' && logAgent !== 'system' && _CARD_AGENT_COLORS[logAgent]) {
        agentHtml = '<span class="kanban-card-agent" style="color:' + _CARD_AGENT_COLORS[logAgent] + '">' + logAgent + '</span>';
        break;
      }
    }
  }

  var logsHtml = task.activity_log ? '<span class="meta-logs">' + task.activity_log.length + ' logs</span>' : '';

  return '<div class="merge-check"></div>' +
    '<div class="kanban-card-title">' + escHtml(task.title || '') + '</div>' +
    tagsHtml +
    '<div class="kanban-card-meta">' +
      agentHtml +
      '<span>' + timeStr + '</span>' +
      logsHtml +
    '</div>';
}

function renderKanbanBoard(kanbanData, automationsData) {
  if (!_kanbanVisible) return;

  // Change detection
  var newJSON = JSON.stringify(kanbanData) + JSON.stringify(automationsData || {});
  if (newJSON === _lastKanbanJSON) return;
  _lastKanbanJSON = newJSON;

  var tasks = (kanbanData && kanbanData.tasks) || [];

  // Group tasks by column
  var groups = { todo: [], in_progress: [], waiting: [], done: [] };
  tasks.forEach(function(t) {
    if (groups[t.column]) groups[t.column].push(t);
  });

  // Stats
  var totalTasks = tasks.length;
  var activeTasks = groups.in_progress.length + groups.waiting.length;
  var doneTasks = groups.done.length;
  var statTotal = document.getElementById('kbStatTotal');
  var statActive = document.getElementById('kbStatActive');
  var statDone = document.getElementById('kbStatDone');
  if (statTotal) statTotal.textContent = totalTasks;
  if (statActive) statActive.textContent = activeTasks;
  if (statDone) statDone.textContent = doneTasks;

  // Render Automation column (from automations data)
  var colAuto = document.getElementById('colAutomation');
  colAuto.innerHTML = '';
  var autoCount = 0;
  if (automationsData) {
    Object.keys(automationsData).forEach(function(name) {
      var sk = automationsData[name];
      if (!sk.enabled) return;
      autoCount++;
      var card = document.createElement('div');
      card.className = 'kanban-skill-card';

      var statusClass = 's-' + (sk.status || 'idle');
      var statusText = sk.status || 'idle';
      var schedule = sk.schedule ? ' \u23F0 ' + sk.schedule : '';
      var nextRun = sk.next_run ? sk.next_run.split('T')[1] || '' : '';
      var lastRun = sk.last_run ? sk.last_run.split('T')[1] || '' : '';

      card.innerHTML =
        '<div class="skill-name">' + escHtml(sk.name || name) + '</div>' +
        '<div class="skill-info">' +
          (sk.trigger || '') + schedule +
          (lastRun ? ' | last: ' + lastRun.slice(0,5) : '') +
          (nextRun ? ' | next: ' + nextRun.slice(0,5) : '') +
          ' | runs: ' + (sk.run_count || 0) +
        '</div>' +
        '<span class="skill-status ' + statusClass + '">' + statusText + '</span>' +
        (sk.last_error ? '<div style="font-size:10px;color:#f87171;margin-top:4px">' + escHtml(String(sk.last_error).slice(0,80)) + '</div>' : '');
      card.style.cursor = 'pointer';
      (function(skillName, skillData) {
        card.onclick = function() {
          openKanbanModal({
            id: 'skill-' + skillName,
            title: skillData.name || skillName,
            column: 'automation',
            tags: [skillData.trigger || 'manual', skillData.status || 'idle'],
            created_at: skillData.last_run || '',
            updated_at: skillData.last_run || '',
            result: skillData.last_result || (skillData.last_error ? 'Error: ' + skillData.last_error : null),
            activity_log: _buildAutomationLog(skillData),
            _isSkill: true,
            _skillName: skillName,
          });
        };
      })(name, sk);
      colAuto.appendChild(card);
    });
  }
  if (!autoCount) colAuto.innerHTML = '<div class="kanban-col-empty">No automations</div>';
  document.getElementById('countAutomation').textContent = autoCount;

  // Render task columns
  var colMap = {
    todo: { el: 'colTodo', count: 'countTodo', empty: 'No tasks' },
    in_progress: { el: 'colInProgress', count: 'countInProgress', empty: 'Nothing in progress' },
    waiting: { el: 'colWaiting', count: 'countWaiting', empty: 'Nothing waiting' },
    done: { el: 'colDone', count: 'countDone', empty: 'No completed tasks' },
  };

  Object.keys(colMap).forEach(function(col) {
    var cfg = colMap[col];
    var container = document.getElementById(cfg.el);
    var items = groups[col] || [];
    // Sort: newest first for done, oldest first for others
    if (col === 'done') {
      items.sort(function(a,b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });
    } else {
      items.sort(function(a,b) { return (a.created_at || '').localeCompare(b.created_at || ''); });
    }
    document.getElementById(cfg.count).textContent = items.length;

    if (!items.length) {
      container.innerHTML = '<div class="kanban-col-empty">' + cfg.empty + '</div>';
      return;
    }

    var DONE_FOLD_LIMIT = 10;
    var folded = (col === 'done' && items.length > DONE_FOLD_LIMIT);

    // --- Keyed DOM diffing ---
    // Build map of existing DOM cards by task ID
    var existingCards = {};
    var existingEls = container.querySelectorAll('.kanban-card[data-task-id]');
    existingEls.forEach(function(el) {
      existingCards[el.getAttribute('data-task-id')] = el;
    });

    // Set of new task IDs
    var newIds = {};
    items.forEach(function(t) { newIds[t.id] = true; });

    // Remove cards no longer in data
    Object.keys(existingCards).forEach(function(id) {
      if (!newIds[id]) existingCards[id].remove();
    });
    // Remove empty-state and old toggle
    var emptyEl = container.querySelector('.kanban-col-empty');
    if (emptyEl) emptyEl.remove();
    var oldToggle = container.querySelector('.kanban-done-toggle');
    if (oldToggle) oldToggle.remove();

    // Build/update cards in order
    items.forEach(function(task, idx) {
      var cardHtml = _buildCardInnerHTML(task);
      var existing = existingCards[task.id];

      if (existing) {
        // Update content only if changed
        if (existing._lastHTML !== cardHtml) {
          existing.innerHTML = cardHtml;
          existing._lastHTML = cardHtml;
          // Rebind click
          existing.onclick = function() { _onCardClick(this, task); };
        }
        // Ensure correct position
        if (container.children[idx] !== existing) {
          container.insertBefore(existing, container.children[idx] || null);
        }
      } else {
        // Create new card
        var card = document.createElement('div');
        card.className = 'kanban-card';
        card.setAttribute('data-task-id', task.id);
        card.innerHTML = cardHtml;
        card._lastHTML = cardHtml;
        card.onclick = function() { _onCardClick(this, task); };
        container.insertBefore(card, container.children[idx] || null);
      }

      // Done folding visibility
      var el = container.children[idx];
      if (folded && idx >= DONE_FOLD_LIMIT) {
        el.style.display = 'none';
        el.classList.add('done-folded');
      } else {
        el.style.display = '';
        el.classList.remove('done-folded');
      }
    });

    // Done column: fold toggle button
    if (folded) {
      var moreCount = items.length - DONE_FOLD_LIMIT;
      var toggle = document.createElement('div');
      toggle.className = 'kanban-done-toggle';
      toggle.innerHTML = '&#9660; ' + moreCount + ' more';
      toggle.onclick = function() {
        var hidden = container.querySelectorAll('.done-folded');
        var isExpanded = toggle.classList.contains('expanded');
        hidden.forEach(function(el) { el.style.display = isExpanded ? 'none' : ''; });
        toggle.classList.toggle('expanded');
        toggle.innerHTML = isExpanded
          ? '&#9660; ' + moreCount + ' more'
          : '&#9650; collapse';
      };
      container.appendChild(toggle);
    }
  });
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

var _currentModalTask = null;

var _AGENT_LOG_COLORS = {
  pm: '#f97316', researcher: '#8b5cf6', developer: '#3b82f6',
  reviewer: '#10b981', tester: '#f472b6', writer: '#ef4444', system: '#6b7280'
};

function _relativeTime(dateStr) {
  if (!dateStr) return '';
  try {
    var d = new Date(dateStr.replace(' ', 'T'));
    var now = new Date();
    var diff = Math.floor((now - d) / 1000);
    if (diff < 60) return diff + 's ago';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  } catch(e) { return dateStr; }
}

function openKanbanModal(task) {
  _currentModalTask = task;
  var backdrop = document.getElementById('kanbanModalBackdrop');

  // Status dropdown
  var sel = document.getElementById('kanbanModalStatus');
  sel.value = task.column || 'todo';
  sel.className = 'kanban-modal-status st-' + (task.column || 'todo');

  // Tags
  var tagsEl = document.getElementById('kanbanModalTags');
  if (task.tags && task.tags.length) {
    tagsEl.innerHTML = task.tags.map(function(t) {
      var cls = 'kanban-tag ' + _tagColorClass(t);
      return '<span class="' + cls.trim() + '" style="font-size:11px">' + escHtml(t) + '</span>';
    }).join(' ');
  } else {
    tagsEl.innerHTML = '';
  }

  // Title
  document.getElementById('kanbanModalTitle').textContent = task.title || '';

  // Info
  var infoHtml = '';
  infoHtml += '<div>Created: ' + escHtml(task.created_at || '') + '</div>';
  if (task.updated_at && task.updated_at !== task.created_at) {
    infoHtml += '<div>Updated: ' + _relativeTime(task.updated_at) + '</div>';
  }
  if (task.source_message_ids && task.source_message_ids.length) {
    infoHtml += '<div>Messages: ' + escHtml(task.source_message_ids.join(', ')) + '</div>';
  }
  document.getElementById('kanbanModalInfo').innerHTML = infoHtml;

  // Comment (result)
  var commentWrap = document.getElementById('kanbanModalCommentWrap');
  var commentEl = document.getElementById('kanbanModalComment');
  if (task.result) {
    commentEl.textContent = task.result;
    commentWrap.style.display = '';
  } else {
    commentWrap.style.display = 'none';
  }

  // Activity Log
  _renderModalLog(task.activity_log || []);

  // Skill cards: disable move dropdown + hide delete + show edit form
  var isSkill = !!task._isSkill;
  var sel = document.getElementById('kanbanModalStatus');
  sel.disabled = isSkill;
  sel.style.opacity = isSkill ? '0.7' : '1';
  document.querySelector('.kanban-modal-btn-delete').style.display = isSkill ? 'none' : '';
  document.getElementById('kanbanBtnMerge').style.display = isSkill ? 'none' : '';
  document.getElementById('kanbanMergeWrap').style.display = 'none';

  // Automation edit form
  var editWrap = document.getElementById('kanbanModalEditWrap');
  if (isSkill && task._skillName && window._lastAutomationsRaw) {
    var sk = window._lastAutomationsRaw[task._skillName];
    if (sk) {
      editWrap.style.display = 'block';
      document.getElementById('kmEditSchedule').value = sk.schedule || '';
      document.getElementById('kmEditEnabled').checked = sk.enabled !== false;
      document.getElementById('kmEditDescription').value = sk.description || '';
      document.getElementById('kmEditWorkspace').value = sk.workspace || '';
      document.getElementById('kmEditScheduleRow').style.display =
        sk.trigger === 'schedule' ? '' : 'none';
      // Reset save button
      var btn = document.querySelector('.km-save-btn');
      if (btn) btn.textContent = '\uD83D\uDCBE Save Changes';
    } else {
      editWrap.style.display = 'none';
    }
  } else {
    editWrap.style.display = 'none';
  }

  // Clear feedback input
  document.getElementById('kanbanFeedbackInput').value = '';

  backdrop.classList.add('visible');
  document.getElementById('kanbanFeedbackInput').focus();
}

function saveAutomationConfig() {
  if (!_currentModalTask || !_currentModalTask._isSkill) return;
  var name = _currentModalTask._skillName;
  if (!name) return;
  var sk = window._lastAutomationsRaw && window._lastAutomationsRaw[name];
  if (!sk) return;
  var payload = { name: name };
  if (sk.trigger === 'schedule') {
    payload.schedule = document.getElementById('kmEditSchedule').value;
  }
  payload.enabled = document.getElementById('kmEditEnabled').checked;
  payload.description = document.getElementById('kmEditDescription').value;
  payload.workspace = document.getElementById('kmEditWorkspace').value;
  var btn = document.querySelector('.km-save-btn');
  btn.textContent = 'Saving...';
  fetch('/api/automation/config', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  }).then(function(r) { return r.json(); }).then(function(resp) {
    if (resp.ok) {
      // Update local cache
      Object.assign(window._lastAutomationsRaw[name], payload);
      delete window._lastAutomationsRaw[name].name;
      // Update tags
      var tags = [sk.trigger || 'manual', payload.enabled ? (sk.status || 'idle') : 'disabled'];
      var tagsEl = document.getElementById('kanbanModalTags');
      tagsEl.innerHTML = tags.map(function(t) {
        var cls = 'kanban-tag ' + _tagColorClass(t);
        return '<span class="' + cls.trim() + '" style="font-size:11px">' + escHtml(t) + '</span>';
      }).join(' ');
      // Success feedback
      btn.textContent = '\u2705 Saved!';
      setTimeout(function() { btn.textContent = '\uD83D\uDCBE Save Changes'; }, 2000);
    } else {
      btn.textContent = '\u274C Error';
      setTimeout(function() { btn.textContent = '\uD83D\uDCBE Save Changes'; }, 2000);
    }
  }).catch(function() {
    btn.textContent = '\u274C Error';
    setTimeout(function() { btn.textContent = '\uD83D\uDCBE Save Changes'; }, 2000);
  });
}

function _buildAutomationLog(sk) {
  var log = [];
  if (sk.last_run) {
    var t = (sk.last_run || '').split('T')[1] || '';
    log.push({time: t.slice(0,8), agent: 'system', message: 'Last run: ' + sk.last_run});
  }
  if (sk.last_result) {
    log.push({time: '', agent: sk.name || 'skill', message: String(sk.last_result)});
  }
  if (sk.last_error) {
    log.push({time: '', agent: 'system', message: 'Error: ' + String(sk.last_error)});
  }
  if (!log.length) {
    log.push({time: '', agent: 'system', message: 'No runs yet. Trigger: ' + (sk.trigger || 'manual') + (sk.schedule ? ' @ ' + sk.schedule : '')});
  }
  return log;
}

function _renderModalLog(log) {
  document.getElementById('kanbanLogCount').textContent = log.length;
  var logEl = document.getElementById('kanbanModalLog');
  logEl.innerHTML = '';
  if (log.length) {
    log.forEach(function(entry) {
      var color = _AGENT_LOG_COLORS[entry.agent] || '#6b7280';
      var msg = entry.message || '';
      var isLong = msg.length > 80;
      var el = document.createElement('div');
      el.className = 'kanban-log-entry' + (isLong ? ' log-long' : '');
      if (isLong) el.style.borderLeftColor = color;

      var initial = (entry.agent || '?')[0].toUpperCase();
      var timeStr = entry.time || '';

      el.innerHTML =
        '<div class="log-avatar" style="background:' + color + '">' + initial + '</div>' +
        '<div class="log-body">' +
          '<div class="log-header">' +
            '<span class="log-agent" style="color:' + color + '">' + escHtml(entry.agent || '') + '</span>' +
            '<span class="log-time">' + escHtml(timeStr) + '</span>' +
          '</div>' +
          '<div class="log-message">' + escHtml(msg) + '</div>' +
        '</div>';
      logEl.appendChild(el);
    });
    logEl.scrollTop = logEl.scrollHeight;
  } else {
    logEl.innerHTML = '<div class="kanban-col-empty">No activity yet</div>';
  }
}

function closeKanbanModal(e) {
  if (e && e.target && e.target !== document.getElementById('kanbanModalBackdrop')) return;
  document.getElementById('kanbanModalBackdrop').classList.remove('visible');
  _currentModalTask = null;
}

function sendKanbanFeedback() {
  if (!_currentModalTask) return;
  var input = document.getElementById('kanbanFeedbackInput');
  var msg = input.value.trim();
  if (!msg) return;

  var taskId = _currentModalTask.id;
  fetch('/api/kanban/feedback', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({task_id: taskId, message: msg, title: _currentModalTask.title || ''})
  }).then(function() {
    // Add to local log immediately
    var entry = {time: new Date().toTimeString().slice(0,8), agent: 'pm', message: msg};
    if (!_currentModalTask.activity_log) _currentModalTask.activity_log = [];
    _currentModalTask.activity_log.push(entry);
    _renderModalLog(_currentModalTask.activity_log);
    input.value = '';
  });
}

function deleteKanbanTask() {
  if (!_currentModalTask) return;
  if (!confirm('Delete this task?')) return;

  var taskId = _currentModalTask.id;
  fetch('/api/kanban/delete', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({task_id: taskId})
  }).then(function() {
    closeKanbanModal();
    // Force board refresh
    _lastKanbanJSON = '';
    if (_lastKanbanData) {
      _lastKanbanData.tasks = (_lastKanbanData.tasks || []).filter(function(t) { return t.id !== taskId; });
      renderKanbanBoard(_lastKanbanData, window._lastAutomationsRaw);
    }
  });
}

function toggleMergePicker() {
  var wrap = document.getElementById('kanbanMergeWrap');
  if (wrap.style.display !== 'none') {
    wrap.style.display = 'none';
    return;
  }
  if (!_currentModalTask || !_lastKanbanData) return;
  var list = document.getElementById('kanbanMergeList');
  list.innerHTML = '';
  var cur = _currentModalTask;
  var candidates = (_lastKanbanData.tasks || []).filter(function(t) {
    return t.id !== cur.id && t.column !== 'done' && !t._isSkill;
  });
  if (!candidates.length) {
    list.innerHTML = '<div class="kanban-col-empty">No other cards to merge into</div>';
    wrap.style.display = '';
    return;
  }
  var colLabel = {in_progress: 'PROG', todo: 'TODO', waiting: 'WAIT', automation: 'AUTO'};
  candidates.forEach(function(t) {
    var item = document.createElement('div');
    item.className = 'merge-target-item';
    item.innerHTML = '<span class="merge-target-col c-' + t.column + '">' +
      (colLabel[t.column] || t.column) + '</span>' +
      '<span class="merge-target-title">' + escHtml(t.title || '') + '</span>';
    item.onclick = function() { executeMerge(cur.id, t.id, t.title); };
    list.appendChild(item);
  });
  wrap.style.display = '';
}

function executeMerge(sourceId, targetId, targetTitle) {
  if (!confirm('Merge this card into [' + targetTitle.slice(0,40) + ']?')) return;
  fetch('/api/kanban/merge', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({source_id: sourceId, target_id: targetId})
  }).then(function() {
    closeKanbanModal();
    _lastKanbanJSON = '';
    if (_lastKanbanData) {
      _lastKanbanData.tasks = (_lastKanbanData.tasks || []).filter(function(t) { return t.id !== sourceId; });
      renderKanbanBoard(_lastKanbanData, window._lastAutomationsRaw);
    }
  });
}

// --- Merge Mode (multi-select) ---
var _mergeMode = false;
var _mergeSelected = new Set();

function _onCardClick(cardEl, task) {
  if (_mergeMode && task.column !== 'done') {
    var tid = task.id;
    if (_mergeSelected.has(tid)) {
      _mergeSelected.delete(tid);
      cardEl.classList.remove('merge-selected');
    } else {
      _mergeSelected.add(tid);
      cardEl.classList.add('merge-selected');
    }
    _updateMergeBar();
    return;
  }
  openKanbanModal(task);
}

function toggleMergeMode() {
  _mergeMode = !_mergeMode;
  _mergeSelected.clear();
  document.body.classList.toggle('merge-mode', _mergeMode);
  document.getElementById('kanbanMergeToggle').classList.toggle('active', _mergeMode);
  // Clear selections
  document.querySelectorAll('.kanban-card.merge-selected').forEach(function(el) {
    el.classList.remove('merge-selected');
  });
  _updateMergeBar();
}

function _updateMergeBar() {
  var bar = document.getElementById('kanbanMergeBar');
  var count = _mergeSelected.size;
  if (_mergeMode && count >= 2) {
    document.getElementById('mergeBarCount').textContent = count + ' selected';
    bar.classList.add('visible');
  } else {
    bar.classList.remove('visible');
  }
}

function executeMergeSelected() {
  if (_mergeSelected.size < 2) return;
  var ids = Array.from(_mergeSelected);
  // Find oldest card as target (earliest created_at)
  var tasks = (_lastKanbanData && _lastKanbanData.tasks) || [];
  var selected = tasks.filter(function(t) { return ids.indexOf(t.id) >= 0; });
  selected.sort(function(a, b) { return (a.created_at || '').localeCompare(b.created_at || ''); });
  var target = selected[0];
  var sources = selected.slice(1);

  if (!confirm('Merge ' + sources.length + ' card(s) into [' + (target.title || '').slice(0,40) + ']?')) return;

  // Sequential merge (source → target)
  var chain = Promise.resolve();
  sources.forEach(function(src) {
    chain = chain.then(function() {
      return fetch('/api/kanban/merge', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({source_id: src.id, target_id: target.id})
      });
    });
  });
  chain.then(function() {
    toggleMergeMode();
    _lastKanbanJSON = '';
    var sourceIds = sources.map(function(s) { return s.id; });
    if (_lastKanbanData) {
      _lastKanbanData.tasks = _lastKanbanData.tasks.filter(function(t) {
        return sourceIds.indexOf(t.id) < 0;
      });
      renderKanbanBoard(_lastKanbanData, window._lastAutomationsRaw);
    }
  });
}

function moveKanbanTask() {
  if (!_currentModalTask) return;
  var sel = document.getElementById('kanbanModalStatus');
  var newCol = sel.value;
  var taskId = _currentModalTask.id;

  sel.className = 'kanban-modal-status st-' + newCol;

  fetch('/api/kanban/move', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({task_id: taskId, column: newCol})
  }).then(function() {
    // Update local state
    var oldCol = _currentModalTask.column;
    _currentModalTask.column = newCol;
    var entry = {time: new Date().toTimeString().slice(0,8), agent: 'pm', message: 'Moved from ' + oldCol + ' to ' + newCol};
    if (!_currentModalTask.activity_log) _currentModalTask.activity_log = [];
    _currentModalTask.activity_log.push(entry);
    _renderModalLog(_currentModalTask.activity_log);
    // Force board refresh
    _lastKanbanJSON = '';
    if (_lastKanbanData) {
      var t = _lastKanbanData.tasks.find(function(t) { return t.id === taskId; });
      if (t) t.column = newCol;
      renderKanbanBoard(_lastKanbanData, window._lastAutomationsRaw);
    }
  });
}

// ESC key to close kanban
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    var modalBd = document.getElementById('kanbanModalBackdrop');
    if (modalBd && modalBd.classList.contains('visible')) {
      modalBd.classList.remove('visible');
      e.stopPropagation();
      return;
    }
    if (_kanbanVisible) {
      toggleKanbanView();
      e.stopPropagation();
    }
  }
});

// Hook into loadDashboardData: save kanban data and render
var _origLoadDashboard = loadDashboardData;
loadDashboardData = function(data) {
  _origLoadDashboard(data);
  if (data && data.kanban) {
    _lastKanbanData = data.kanban;
  }
  if (_kanbanVisible) {
    renderKanbanBoard(_lastKanbanData || {tasks:[]}, window._lastAutomationsRaw);
  }
};

</script>
</body>
</html>
